<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Yade-commits] r1454 - in trunk: extra gui gui/py gui/qt3 scripts
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/yade-commits/2008/index.html" >
   <LINK REL="made" HREF="mailto:yade-commits%40lists.berlios.de?Subject=Re%3A%20%5BYade-commits%5D%20r1454%20-%20in%20trunk%3A%20extra%20gui%20gui/py%20gui/qt3%20scripts&In-Reply-To=%3C200807281925.m6SJP4qA026316%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000413.html">
   <LINK REL="Next"  HREF="000415.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Yade-commits] r1454 - in trunk: extra gui gui/py gui/qt3 scripts</H1>
    <B>eudoxos at BerliOS</B> 
    <A HREF="mailto:yade-commits%40lists.berlios.de?Subject=Re%3A%20%5BYade-commits%5D%20r1454%20-%20in%20trunk%3A%20extra%20gui%20gui/py%20gui/qt3%20scripts&In-Reply-To=%3C200807281925.m6SJP4qA026316%40sheep.berlios.de%3E"
       TITLE="[Yade-commits] r1454 - in trunk: extra gui gui/py gui/qt3 scripts">eudoxos at mail.berlios.de
       </A><BR>
    <I>Mon Jul 28 21:25:04 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000413.html">[Yade-commits] r1453 - trunk/pkg/dem
</A></li>
        <LI>Next message: <A HREF="000415.html">[Yade-commits] r1455 - in trunk: core extra gui/py gui/qt3	lib/miniWm3 pkg/common/Engine/DeusExMachina	pkg/common/Engine/StandAloneEngine
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#414">[ date ]</a>
              <a href="thread.html#414">[ thread ]</a>
              <a href="subject.html#414">[ subject ]</a>
              <a href="author.html#414">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: eudoxos
Date: 2008-07-28 21:25:02 +0200 (Mon, 28 Jul 2008)
New Revision: 1454

Added:
   trunk/gui/qt3/qt.py
Removed:
   trunk/gui/py/GLViewer4.cpp
   trunk/gui/py/GLViewer4.hpp
Modified:
   trunk/extra/Brefcom.hpp
   trunk/gui/SConscript
   trunk/gui/py/utils.py
   trunk/gui/qt3/GLViewer.cpp
   trunk/gui/qt3/GLViewer.hpp
   trunk/gui/qt3/QtGUI-python.cpp
   trunk/gui/qt3/YadeQtMainWindow.cpp
   trunk/gui/qt3/YadeQtMainWindow.hpp
   trunk/scripts/simple-scene-player.py
Log:
1. Remove unused GLViewer4
2. Add fairly straightforward GLViewer wrapper (manually wrapped)
3. Fix scripts/simple-scene-player.py that generates video
4. yade.qt module is now in python and imports * from yade._qt for the binary wrappers
5. importing qt if qt not running raises ImportError
6. utils.qtCreateVideo moved to qt.CreateVideo
7. Exponential softening in brefcom (untested)



Modified: trunk/extra/Brefcom.hpp
===================================================================
--- trunk/extra/Brefcom.hpp	2008-07-27 11:52:50 UTC (rev 1453)
+++ trunk/extra/Brefcom.hpp	2008-07-28 19:25:02 UTC (rev 1454)
@@ -112,10 +112,12 @@
 		inline Real funcH(Real kappaD){ return 1-funcG(kappaD); }
 		/*! Damage evolution law */
 		inline Real funcG(Real kappaD){
-			const Real&amp; expBending=BC-&gt;expBending, epsCrackOnset=BC-&gt;epsCrackOnset, epsFracture=BC-&gt;epsFracture; const bool&amp; neverDamage=BC-&gt;neverDamage; // shorthands
+			//const Real&amp; expBending=BC-&gt;expBending, 
+			const Real&amp; epsCrackOnset=BC-&gt;epsCrackOnset, epsFracture=BC-&gt;epsFracture; const bool&amp; neverDamage=BC-&gt;neverDamage; // shorthands
 			if(kappaD&lt;epsCrackOnset || neverDamage) return 0;
-			if(kappaD&gt;epsFracture) return 1;
-			return (1/(1-exp(-expBending)))*(1-exp(-expBending*(kappaD-epsCrackOnset)/(epsFracture-epsCrackOnset)));
+			return 1.-(epsCrackOnset/kappaD)*exp(-(kappaD-epsCrackOnset)/epsFracture);
+			//if(kappaD&gt;epsFracture) return 1;
+			//return (1/(1-exp(-expBending)))*(1-exp(-expBending*(kappaD-epsCrackOnset)/(epsFracture-epsCrackOnset)));
 		}
 		
 	public:

Modified: trunk/gui/SConscript
===================================================================
--- trunk/gui/SConscript	2008-07-27 11:52:50 UTC (rev 1453)
+++ trunk/gui/SConscript	2008-07-28 19:25:02 UTC (rev 1454)
@@ -42,11 +42,15 @@
 		env.SharedLibrary('PythonUI',['py/PythonUI.cpp']),
 		env.SharedLibrary('PeriodicPythonRunner',['py/PeriodicPythonRunner.cpp']),
 		env.File('PythonUI_rc.py','py'),
-		# env.SharedLibrary('PlotDataGetter',['py/PlotDataGetter.cpp']),
 	])
+	if 'qt3' not in env['exclude']:
+		env.Install('$PREFIX/lib/yade$SUFFIX/gui/yade',[
+			env.SharedLibrary('_qt',['qt3/QtGUI-python.cpp'],SHLIBPREFIX='',LIBS=env['LIBS']+['QtGUI'],CPPPATH=env['CPPPATH']+[env['buildDir']+'/gui/qt3']), # CPPPATH is for files generated by moc which are indirectly included
+			env.File('qt.py','qt3'),
+		])
+
 	# python modules are one level deeper so that you can say: from yade.wrapper import *
 	env.Install('$PREFIX/lib/yade$SUFFIX/gui/yade',[
-		env.SharedLibrary('qt',['qt3/QtGUI-python.cpp'],SHLIBPREFIX='',LIBS=env['LIBS']+['QtGUI'],CPPPATH=env['CPPPATH']+[env['buildDir']+'/gui/qt3']), # CPPPATH is for files generated by moc which are indirectly included
 		env.SharedLibrary('wrapper',['py/yadeControl.cpp'],SHLIBPREFIX='',
 			LIBS=env['LIBS']+['yade-base','libboost_python','XMLFormatManager','yade-factory','yade-serialization','Shop',
 				'BoundingVolumeMetaEngine',

Deleted: trunk/gui/py/GLViewer4.cpp
===================================================================
--- trunk/gui/py/GLViewer4.cpp	2008-07-27 11:52:50 UTC (rev 1453)
+++ trunk/gui/py/GLViewer4.cpp	2008-07-28 19:25:02 UTC (rev 1454)
@@ -1,268 +0,0 @@
-/*************************************************************************
-*  Copyright (C) 2004 by Olivier Galizzi                                 *
-*  <A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">olivier.galizzi at imag.fr</A>                                               *
-*  Copyright (C) 2005 by Janek Kozicki                                   *
-*  <A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">cosurgi at berlios.de</A>                                                    *
-*                                                                        *
-* qt4 port V&#225;clav &#352;milauer 2008
-*/                                                                        
-#ifdef USE_QGLVIEWER //skip the whole file
-
-
-#include&quot;GLViewer4.hpp&quot;
-#include&lt;GL/glut.h&gt;
-#include&lt;yade/lib-opengl/FpsTracker.hpp&gt;
-#include&lt;yade/core/Body.hpp&gt;
-#include&lt;yade/core/Interaction.hpp&gt;
-#include&lt;QKeyEvent&gt;
-#include&lt;QMouseEvent&gt;
-
-
-GLViewer4::GLViewer4(int id, shared_ptr&lt;RenderingEngine&gt; rendererInit, const QGLFormat&amp; format, QWidget * parent, QGLWidget * shareWidget) : QGLViewer(format,parent,shareWidget)//, qglThread(this,rendererInit)
-{
-	isMoving=false;
-	renderer=rendererInit;
-	drawGrid = false;
-	viewId = id;
-	resize(320, 240);
-
-	// if (id==0) setCaption(&quot;Primary View (not closable)&quot;);	else setCaption(&quot;Secondary View number &quot;+lexical_cast&lt;string&gt;(id));
-	
-	show();
-	
-	notMoving();
-
-	if(manipulatedFrame() == 0 )
-		setManipulatedFrame(new qglviewer::ManipulatedFrame());
-}
-
-void GLViewer4::notMoving()
-{
-	camera()-&gt;frame()-&gt;setWheelSensitivity(-1.0f);
-	setMouseBinding(Qt::LeftButton + Qt::RightButton, CAMERA, ZOOM);
-	setMouseBinding(Qt::LeftButton, CAMERA, ROTATE);
-	setMouseBinding(Qt::MidButton, CAMERA, TRANSLATE);
-	setMouseBinding(Qt::RightButton, CAMERA, TRANSLATE);
-	setWheelBinding(Qt::NoModifier, CAMERA, ZOOM);
-	setMouseBinding(Qt::SHIFT + Qt::LeftButton, SELECT);
-	//setMouseBinding(Qt::RightButton, NO_CLICK_ACTION);
-
-	setMouseBinding(Qt::SHIFT + Qt::LeftButton + Qt::RightButton, FRAME, ZOOM);
-	setMouseBinding(Qt::SHIFT + Qt::MidButton, FRAME, TRANSLATE);
-	setMouseBinding(Qt::SHIFT + Qt::RightButton, FRAME, ROTATE);
-	setWheelBinding(Qt::ShiftModifier, FRAME, ZOOM);
-};
-
-
-void GLViewer4::keyPressEvent(QKeyEvent *e)
-{
-	if ( e-&gt;key()==Qt::Key_M )
-		if( !(isMoving = !isMoving ) )
-		{
-			displayMessage(&quot;moving finished&quot;);
-			notMoving();
-		}
-		else
-		{
-			displayMessage(&quot;moving selected object&quot;);
-			setMouseBinding(Qt::LeftButton + Qt::RightButton, FRAME, ZOOM);
-			setMouseBinding(Qt::LeftButton, FRAME, TRANSLATE);
-			setMouseBinding(Qt::MidButton, FRAME, TRANSLATE);
-			setMouseBinding(Qt::RightButton, FRAME, ROTATE);
-			setWheelBinding(Qt::NoModifier , FRAME, ZOOM);
-		}
-	else if( e-&gt;key()==Qt::Key_C &amp;&amp; selectedName() != -1 &amp;&amp; (*(Omega::instance().getRootBody()-&gt;bodies)).exists(selectedName()))
-		setSceneCenter(manipulatedFrame()-&gt;position()), updateGL();
-	else if( e-&gt;key()==Qt::Key_D )
-		wasDynamic = true;
-	else if( e-&gt;key()==Qt::Key_G )
-		drawGrid = !drawGrid, updateGL();
-
-// FIXME BEGIN - arguments for GLDraw*ers should be from dialog box, not through Omega !!!
-	else if( e-&gt;key()==Qt::Key_Delete )
-		Omega::instance().isoValue-=0.05, updateGL();
-	else if( e-&gt;key()==Qt::Key_Insert )
-		Omega::instance().isoValue+=0.05, updateGL();
-
-	else if( e-&gt;key()==Qt::Key_PageDown)
-		Omega::instance().isoThick-=0.05, updateGL();
-	else if( e-&gt;key()==Qt::Key_PageUp)
-		Omega::instance().isoThick+=0.05, updateGL();
-
-	else if( e-&gt;key()==Qt::Key_End )
-		Omega::instance().isoSec=std::max(1, Omega::instance().isoSec-1), updateGL();
-	else if( e-&gt;key()==Qt::Key_Home )
-		Omega::instance().isoSec+=1, updateGL();
-// FIXME END
-
-	else if (e-&gt;key() == Qt::Key_T)
-	{ // 'T' changes the projection type : perspective or orthogonal
-		if (camera()-&gt;type() == qglviewer::Camera::ORTHOGRAPHIC)
-			camera()-&gt;setType(qglviewer::Camera::PERSPECTIVE);
-		else
-			camera()-&gt;setType(qglviewer::Camera::ORTHOGRAPHIC);
-		updateGL();
-	}
-	else if( e-&gt;key()==Qt::Key_O )
-		camera()-&gt;setFieldOfView(camera()-&gt;fieldOfView()*0.9), updateGL();
-	else if( e-&gt;key()==Qt::Key_P )
-		camera()-&gt;setFieldOfView(camera()-&gt;fieldOfView()*1.1), updateGL();
-
-	else if( e-&gt;key()!=Qt::Key_Escape &amp;&amp; e-&gt;key()!=Qt::Key_Space )
-		QGLViewer::keyPressEvent(e);
-}
-
-void GLViewer4::centerScene()
-{
-	if (!Omega::instance().getRootBody())
-		return;
-
-	if(Omega::instance().getRootBody()-&gt;bodies-&gt;size() &lt; 500)
-		displayMessage(&quot;Less than 500 bodies, moving possible. Select with shift, press 'm' to move.&quot;, 6000);
-	else
-		displayMessage(&quot;More than 500 bodies. Moving not possible&quot;, 6000);
-
-	Vector3r min = Omega::instance().getRootBody()-&gt;boundingVolume-&gt;min;
-	Vector3r max = Omega::instance().getRootBody()-&gt;boundingVolume-&gt;max;
-	Vector3r center = (max+min)*0.5;
-	Vector3r halfSize = (max-min)*0.5;
-	float radius = std::max(halfSize[0] , std::max(halfSize[1] , halfSize[2]) );
-	setSceneCenter(qglviewer::Vec(center[0],center[1],center[2]));
-	setSceneRadius(radius*1.5);
-	showEntireScene();
-}
-
-void GLViewer4::draw() // FIXME maybe rename to RendererFlowControl, or something like that?
-{
-	if(Omega::instance().getRootBody())
-	{
-		int selection = selectedName();
-		if(selection != -1 &amp;&amp; (*(Omega::instance().getRootBody()-&gt;bodies)).exists(selection) )
-		{
-			Quaternionr&amp; q = (*(Omega::instance().getRootBody()-&gt;bodies))[selection]-&gt;physicalParameters-&gt;se3.orientation;
-			Vector3r&amp;    v = (*(Omega::instance().getRootBody()-&gt;bodies))[selection]-&gt;physicalParameters-&gt;se3.position;
-			float v0,v1,v2;
-			manipulatedFrame()-&gt;getPosition(v0,v1,v2);
-			v[0]=v0;v[1]=v1;v[2]=v2;
-			double q0,q1,q2,q3;
-			manipulatedFrame()-&gt;getOrientation(q0,q1,q2,q3);
-			q[0]=q0;q[1]=q1;q[2]=q2;q[3]=q3;
-
-			(*(Omega::instance().getRootBody()-&gt;bodies))[selection]-&gt;userForcedDisplacementRedrawHook();	
-		}
-		
-	// FIXME - here we want to actually call all responsible GLDraw Actors
-		renderer-&gt;render(Omega::instance().getRootBody(), selectedName());
-	}
-}
-
-void GLViewer4::drawWithNames() // FIXME maybe rename to RendererFlowControl, or something like that?
-{
-	if (Omega::instance().getRootBody() &amp;&amp; Omega::instance().getRootBody()-&gt;bodies-&gt;size() &lt; 500 )
-	// FIXME - here we want to actually call all responsible GLDraw Actors
-		renderer-&gt;renderWithNames(Omega::instance().getRootBody());
-}
-
-
-// new object selected.
-// set frame coordinates, and isDynamic=false;
-void GLViewer4::postSelection(const QPoint&amp; point) 
-{
-	int selection = selectedName();
-	if(selection == -1)
-	{
-		if(isMoving)
-		{
-			displayMessage(&quot;moving finished&quot;);
-			notMoving();
-			isMoving=false;
-		}
-		return;
-	}
-	if( (*(Omega::instance().getRootBody()-&gt;bodies)).exists(selection) )
-	{
-		if(Body::byId(body_id_t(selection))-&gt;isClumpMember()){ // select clump (invisible) instead of its member
-			cerr&lt;&lt;&quot;Clump member #&quot;&lt;&lt;selection&lt;&lt;&quot; selected, selecting clump instead.&quot;&lt;&lt;endl;
-			selection=Body::byId(body_id_t(selection))-&gt;clumpId;
-			setSelectedName(selection);
-		}
-
-		std::cerr &lt;&lt; &quot;new selection &quot; &lt;&lt; selection &lt;&lt; &quot;\n&quot;;
-		wasDynamic = (*(Omega::instance().getRootBody()-&gt;bodies))[selection]-&gt;isDynamic;
-		(*(Omega::instance().getRootBody()-&gt;bodies))[selection]-&gt;isDynamic = false;
-
-		Quaternionr&amp; q = (*(Omega::instance().getRootBody()-&gt;bodies))[selection]-&gt;physicalParameters-&gt;se3.orientation;
-		Vector3r&amp;    v = (*(Omega::instance().getRootBody()-&gt;bodies))[selection]-&gt;physicalParameters-&gt;se3.position;
-		manipulatedFrame()-&gt;setPositionAndOrientation(qglviewer::Vec(v[0],v[1],v[2]),qglviewer::Quaternion(q[0],q[1],q[2],q[3]));
-	}
-
-}
-
-// maybe new object will be selected.
-// if so, then set isDynamic of previous selection, to old value
-void GLViewer4::endSelection(const QPoint &amp;point)
-{
-	int old = selectedName();
-
-	QGLViewer::endSelection(point);
-
-	if(old != -1 &amp;&amp; old!=selectedName() &amp;&amp; (*(Omega::instance().getRootBody()-&gt;bodies)).exists(old) )
-		(*(Omega::instance().getRootBody()-&gt;bodies))[old]-&gt;isDynamic = wasDynamic;
-}
-
-void GLViewer4::postDraw()
-{
-	if( drawGrid ) // FIXME drawGrid is yet another RendererFlowControl's Actor.
-	{
-//		glMatrixMode(GL_MODELVIEW);
-		glPushMatrix();
-		glPushAttrib(GL_ALL_ATTRIB_BITS);
-		qglColor(foregroundColor());
-		glDisable(GL_LIGHTING);
-		glLineWidth(0.1);
-		glBegin(GL_LINES);
-
-		float sizef = QGLViewer::camera()-&gt;sceneRadius()*3.0f; 
-		int size = static_cast&lt;int&gt;(sizef);
-		qglviewer::Vec v = QGLViewer::camera()-&gt;sceneCenter();
-		int x = static_cast&lt;int&gt;(v[0]); int y = static_cast&lt;int&gt;(v[1]);
-		float xf = (static_cast&lt;int&gt;(v[0]*100.0))/100.0;
-		float yf = (static_cast&lt;int&gt;(v[1]*100.0))/100.0;
-//		float nbSubdivisions = size;
-//		for (int i=0; i&lt;=nbSubdivisions; ++i)
-		for (int i= -size ; i&lt;=size; ++i )
-		{
-//			const float pos = size*(2.0*i/nbSubdivisions-1.0);
-			glVertex2i( i   +x, -size+y);
-			glVertex2i( i   +x, +size+y);
-			glVertex2i(-size+x, i    +y);
-			glVertex2i( size+x, i    +y);
-		}
-		if(sizef &lt;= 2.0)
-		{
-			glColor3f(0.9,0.9,0.9);
-			for (float i= -(static_cast&lt;int&gt;(sizef*100.0))/100.0 ; i&lt;=sizef; i+=0.01 )
-			{
-				glVertex2f( i    +xf, -sizef+yf);
-				glVertex2f( i    +xf, +sizef+yf);
-				glVertex2f(-sizef+xf, i     +yf);
-				glVertex2f( sizef+xf, i     +yf);
-			}
-		}
-		
-		glEnd();
-		glPopAttrib();
-		glPopMatrix();
-	}
-	QGLViewer::postDraw();
-}
-
-/*
-void GLViewer4::closeEvent(QCloseEvent *e)
-{
-	cerr&lt;&lt;&quot;CLOSE&#160;EVENT!?&quot;&lt;&lt;endl;
-	//emit closeSignal(viewId);
-}
-*/
-
-#endif

Deleted: trunk/gui/py/GLViewer4.hpp
===================================================================
--- trunk/gui/py/GLViewer4.hpp	2008-07-27 11:52:50 UTC (rev 1453)
+++ trunk/gui/py/GLViewer4.hpp	2008-07-28 19:25:02 UTC (rev 1454)
@@ -1,44 +0,0 @@
-//  Copyright (C) 2004 by Olivier Galizzi, Janek Kozicki
-//  qt4 port 2008 V&#225;clav &#352;milauer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">eudoxos at arcig.cz</A>&gt;
-
-#pragma once
-
-#include&lt;yade/core/Omega.hpp&gt;
-#include&lt;yade/core/RenderingEngine.hpp&gt;
-#include&lt;QGLViewer/qglviewer.h&gt;
-
-class GLViewer4 : public QGLViewer
-{
-	//Q_OBJECT;
-	//friend class QGLThread;
-		
-	private:
-		int			viewId;
-		bool			drawGrid; // FIXME - draw grid is in fact just another GLDrawActor
-		bool			isMoving;
-		bool			wasDynamic;
-		shared_ptr&lt;RenderingEngine&gt; renderer;
-
-	public :
-		GLViewer4 (int id, shared_ptr&lt;RenderingEngine&gt; renderer, const QGLFormat&amp; format, QWidget * parent=0, QGLWidget * shareWidget=0);
-		virtual ~GLViewer4() {};
-		virtual void draw();
-		//virtual void init(){};
-		//virtual QString helpString() const {return QString(&quot;@@@&quot;);}
-		virtual void drawWithNames();
-		void centerScene();
-		void notMoving();
-	protected :
-		virtual void keyPressEvent(QKeyEvent *e);
-		virtual void postDraw();
-		//virtual void closeEvent(QCloseEvent *e);
-		virtual void postSelection(const QPoint&amp; point);
-		virtual void endSelection(const QPoint &amp;point);
-	//slot:
-	//		void callUpdateGL(){cerr&lt;&lt;&quot;@&quot;; updateGL();}
-
-	signals :
-//		virtual void closeSignal(int i);
-};
-
-

Modified: trunk/gui/py/utils.py
===================================================================
--- trunk/gui/py/utils.py	2008-07-27 11:52:50 UTC (rev 1453)
+++ trunk/gui/py/utils.py	2008-07-28 19:25:02 UTC (rev 1454)
@@ -74,7 +74,6 @@
 			walls[-1].shape['visible']=True
 	return walls
 
-
 def aabbExtrema(consider=lambda body:True):
 	&quot;&quot;&quot;return min and max points of an aabb around spherical packing (non-spheres are ignored)&quot;&quot;&quot;
 	inf=float('inf')
@@ -95,7 +94,6 @@
 	other=((axis+1)%3,(axis+2)%3)
 	return (ext[1][other[0]]-ext[0][other[0]])*(ext[1][other[1]]-ext[0][other[1]])
 
-
 def randomizeColors(onShapes=True,onMolds=False,onlyDynamic=False):
 	&quot;&quot;&quot;Assign random colors to shape's (GeometricalModel) and/or mold's (InteractingGeometry) diffuseColor.
 	
@@ -109,9 +107,6 @@
 		if onShapes and (b['isDynamic'] or not onlyDynamic): b.shape['diffuseColor']=color
 		if onMolds  and (b['isDynamic'] or not onlyDynamic): b.mold['diffuseColor']=color
 
-def runInQtGui(background=True):
-	raise DeprecationWarning(&quot;This  runInQtGui functions is deprecated, since python now coexists with QtGUI.&quot;)
-
 def PWaveTimeStep():
 	&quot;&quot;&quot;Estimate timestep by the elastic wave propagation speed (p-wave).
 	
@@ -155,46 +150,3 @@
 		out.write('%g\t%g\t%g\t%g\n'%(b.phys['se3'][0],b.phys['se3'][1],b.phys['se3'][2],b.shape['radius']))
 	out.close()
 
-def qtCreateVideo(playerDb,out,viewerState=None,dispParamsNo=-1,stride=1,fps=24,postLoadHook=None):
-	&quot;&quot;&quot;Create video by replaying a simulation. Snapshots are taken to temporary files,
-	encoded to a .ogg stream (theora codec); temps are deleted at the end.
-
-	If the output file exists already, a ~[number] is appended and the old file is renamed.
-
-	playerDb is the database with saved simulation states,
-	out is the output file (like a.ogg), fps is frames-per-second for the video that is created,
-	dispParamsNo, stride and postLoadHook are passed to qt.runPlayer (docs in gui/qt3/QtGUI-Python.cpp).
-	
-	You need a display to run this (either virtual, like xvfb, or physical).
-
-	Necessary packages: python-gst0.10 gstreamer0.10-plugins-good python-gobject
-	&quot;&quot;&quot;
-	import pygst,sys,gobject,os
-	pygst.require(&quot;0.10&quot;)
-	import gst
-	from yade import qt
-	qt.Player(True)
-	# postLoadHook and viewerState have &quot;&quot; instead of None in the c++ interface
-	wildcard,snaps=qt.runPlayer(
-		savedSim=playerDb,
-		snapBase='',
-		viewerState=(viewerstate if viewerState else &quot;&quot;),
-		dispParamsNo=dispParamsNo,
-		stride=stride,
-		postLoadHook=(postLoadHook if postLoadHook else ''))
-	if(os.path.exists(out)):
-		i=0;
-		while(os.path.exists(out+&quot;~%d&quot;%i)): i+=1
-		os.rename(out,out+&quot;~%d&quot;%i); print &quot;Output file `%s' already existed, old file renamed to `%s'&quot;%(out,out+&quot;~%d&quot;%i)
-	print &quot;Encoding video from %s (%d files total) to %s&quot;%(wildcard,len(snaps),out)
-	pipeline=gst.parse_launch('multifilesrc location=&quot;%s&quot; index=0 caps=&quot;image/png,framerate=\(fraction\)%d/1&quot; ! pngdec ! ffmpegcolorspace ! theoraenc sharpness=2 quality=32 ! oggmux ! filesink location=&quot;%s&quot;'%(wildcard,fps,out))
-	bus=pipeline.get_bus()
-	bus.add_signal_watch()
-	mainloop=gobject.MainLoop();
-	bus.connect(&quot;message::eos&quot;,lambda bus,msg: mainloop.quit())
-	pipeline.set_state(gst.STATE_PLAYING)
-	mainloop.run()
-	pipeline.set_state(gst.STATE_NULL); pipeline.get_state()
-	print &quot;Cleaning snapshot files.&quot;
-	for f in snaps: os.remove(f)
-

Modified: trunk/gui/qt3/GLViewer.cpp
===================================================================
--- trunk/gui/qt3/GLViewer.cpp	2008-07-27 11:52:50 UTC (rev 1453)
+++ trunk/gui/qt3/GLViewer.cpp	2008-07-28 19:25:02 UTC (rev 1454)
@@ -41,6 +41,8 @@
 
 	if(manipulatedFrame()==0) setManipulatedFrame(new qglviewer::ManipulatedFrame());
 
+	camera()-&gt;setUpVector(qglviewer::Vec(0,0,1));
+
 	xyPlaneConstraint=shared_ptr&lt;qglviewer::LocalConstraint&gt;(new qglviewer::LocalConstraint());
 	//xyPlaneConstraint-&gt;setTranslationConstraint(qglviewer::AxisPlaneConstraint::AXIS,qglviewer::Vec(0,0,1));
 	//xyPlaneConstraint-&gt;setRotationConstraint(qglviewer::AxisPlaneConstraint::FORBIDDEN,qglviewer::Vec(0,0,1));

Modified: trunk/gui/qt3/GLViewer.hpp
===================================================================
--- trunk/gui/qt3/GLViewer.hpp	2008-07-27 11:52:50 UTC (rev 1453)
+++ trunk/gui/qt3/GLViewer.hpp	2008-07-28 19:25:02 UTC (rev 1454)
@@ -37,9 +37,8 @@
 	friend class QGLThread;
 	protected:
 		shared_ptr&lt;OpenGLRenderingEngine&gt; renderer;
+
 	private :
-		bool 			drawGridXYZ[3];
-		bool 			drawScale;
 		bool			isMoving;
 		bool			wasDynamic;
 		float			cut_plane;
@@ -48,9 +47,13 @@
 		set&lt;int&gt; boundClipPlanes;
 		shared_ptr&lt;qglviewer::LocalConstraint&gt; xyPlaneConstraint;
 		string strBoundGroup(){string ret;FOREACH(int i, boundClipPlanes) ret+=&quot; &quot;+lexical_cast&lt;string&gt;(i+1);return ret;}
+
+     public :
+
 		void centerMedianQuartile();
+		bool 			drawGridXYZ[3];
+		bool 			drawScale;
 
-     public :
 		GLViewer (int id, shared_ptr&lt;OpenGLRenderingEngine&gt; _renderer, QWidget * parent=0, QGLWidget * shareWidget=0);
 		virtual ~GLViewer (){};
 		virtual void draw();

Modified: trunk/gui/qt3/QtGUI-python.cpp
===================================================================
--- trunk/gui/qt3/QtGUI-python.cpp	2008-07-27 11:52:50 UTC (rev 1453)
+++ trunk/gui/qt3/QtGUI-python.cpp	2008-07-28 19:25:02 UTC (rev 1454)
@@ -35,7 +35,11 @@
 #undef POST_SYNT_EVENT
 void evtVIEW(){QApplication::postEvent(ensuredMainWindow(),new QCustomEvent(YadeQtMainWindow::EVENT_VIEW)); }
 
+// event associated data will be deleted in the event handler
+void restoreGLViewerState_str(string str){string* s=new string(str); QApplication::postEvent(ensuredMainWindow(),new QCustomEvent((QEvent::Type)YadeQtMainWindow::EVENT_RESTORE_GLVIEWER_STR,(void*)s));}
+void restoreGLViewerState_num(int dispStateNo){int* i=new int(dispStateNo); QApplication::postEvent(ensuredMainWindow(),new QCustomEvent((QEvent::Type)YadeQtMainWindow::EVENT_RESTORE_GLVIEWER_NUM,(void*)i));}
 
+
 /* This function adds the ability to non-interactively run the player. 
  *
  * @param savedSim is simulation saved by either SQLiteRecorder (preferrably) or 
@@ -68,7 +72,7 @@
  * with /tmp/tmpFile.py containing something like:
  *
  *  from yade import qt
- *  qt.runPlayer('/tmp/aa.sqlite','/tmp/__g','/tmp/qglviewerState.xml',20)
+ *  qt.runPlayerSession('/tmp/aa.sqlite','/tmp/__g','/tmp/qglviewerState.xml',20)
  *  quit()
  *
  * @returns tuple of (wildcard,[snap0,snap1,snap2,...]), where the list contains filename of snapshots.
@@ -100,7 +104,50 @@
 
 BOOST_PYTHON_FUNCTION_OVERLOADS(runPlayerSession_overloads,runPlayerSession,2,6);
 
-BOOST_PYTHON_MODULE(qt){
+qglviewer::Vec tuple2vec(python::tuple t){ qglviewer::Vec ret; for(int i=0;i&lt;3;i++){python::extract&lt;Real&gt; e(t[i]); if(!e.check()) throw invalid_argument(&quot;Element #&quot;+lexical_cast&lt;string&gt;(i)+&quot; is not a number&quot;); ret[i]=e();} return ret;};
+python::tuple vec2tuple(qglviewer::Vec v){return python::make_tuple(v[0],v[1],v[2]);};
+
+class pyGLViewer{
+	shared_ptr&lt;GLViewer&gt; glv;
+	void init(size_t viewNo){
+		if(YadeQtMainWindow::self-&gt;glViews.size()&lt;viewNo+1 || !YadeQtMainWindow::self-&gt;glViews[viewNo]){throw runtime_error(&quot;No view #&quot;+lexical_cast&lt;string&gt;(viewNo));}
+		glv=YadeQtMainWindow::self-&gt;glViews[viewNo];
+	}
+	public:
+		pyGLViewer(){ init(0); }
+		pyGLViewer(size_t viewNo){init(viewNo);}
+		pyGLViewer(const shared_ptr&lt;GLViewer&gt;&amp; _glv){glv=_glv;}
+		python::tuple get_grid(){return python::make_tuple(glv-&gt;drawGridXYZ[0],glv-&gt;drawGridXYZ[1],glv-&gt;drawGridXYZ[2]);}
+		void set_grid(bool x,bool y,bool z){glv-&gt;drawGridXYZ[0]=x; glv-&gt;drawGridXYZ[1]=y; glv-&gt;drawGridXYZ[2]=z;}
+		#define VEC_GET_SET(property,getter,setter) python::object get_##property(){return vec2tuple(getter());} void set_##property(python::tuple t){setter(tuple2vec(t));}
+		VEC_GET_SET(upVector,glv-&gt;camera()-&gt;upVector,glv-&gt;camera()-&gt;setUpVector);
+		VEC_GET_SET(lookAt,glv-&gt;camera()-&gt;position()+glv-&gt;camera()-&gt;viewDirection,glv-&gt;camera()-&gt;lookAt);
+		VEC_GET_SET(viewDir,glv-&gt;camera()-&gt;viewDirection,glv-&gt;camera()-&gt;setViewDirection);
+		VEC_GET_SET(eyePosition,glv-&gt;camera()-&gt;position,glv-&gt;camera()-&gt;setPosition);
+		#define BOOL_GET_SET(property,getter,setter)void set_##property(bool b){setter(b);} bool get_##property(){return getter();}
+		BOOL_GET_SET(axes,glv-&gt;axisIsDrawn,glv-&gt;setAxisIsDrawn);
+		BOOL_GET_SET(fps,glv-&gt;FPSIsDisplayed,glv-&gt;setFPSIsDisplayed);
+		bool get_scale(){return glv-&gt;drawScale;} void set_scale(bool b){glv-&gt;drawScale=b;}
+		bool get_orthographic(){return glv-&gt;camera()-&gt;type()==qglviewer::Camera::ORTHOGRAPHIC;}
+		void set_orthographic(bool b){return glv-&gt;camera()-&gt;setType(b ? qglviewer::Camera::ORTHOGRAPHIC : qglviewer::Camera::PERSPECTIVE);}
+		#define FLOAT_GET_SET(property,getter,setter)void set_##property(Real r){setter(r);} Real get_##property(){return getter();}
+		FLOAT_GET_SET(sceneRadius,glv-&gt;sceneRadius,glv-&gt;setSceneRadius);
+		void fitAABB(python::tuple min, python::tuple max){glv-&gt;camera()-&gt;fitBoundingBox(tuple2vec(min),tuple2vec(max));}
+		void fitSphere(python::tuple center,Real radius){glv-&gt;camera()-&gt;fitSphere(tuple2vec(center),radius);}
+		void showEntireScene(){glv-&gt;camera()-&gt;showEntireScene();}
+		void center(bool median=false){if(median)glv-&gt;centerMedianQuartile(); else glv-&gt;centerScene();}
+};
+
+BOOST_PYTHON_MEMBER_FUNCTION_OVERLOADS(pyGLViewer_center_overloads,center,0,1);
+
+
+python::list getAllViews(){
+	python::list ret;
+	for(size_t i=0; i&lt;YadeQtMainWindow::self-&gt;glViews.size(); i++) ret.append(YadeQtMainWindow::self-&gt;glViews[i]);
+	return ret;
+};
+
+BOOST_PYTHON_MODULE(_qt){
 	def(&quot;Generator&quot;,evtGENERATOR,&quot;Start simulation generator&quot;);
 	def(&quot;Controller&quot;,evtCONTROLLER,&quot;Start simulation controller&quot;);
 	def(&quot;Player&quot;,evtPLAYER,&quot;Start simulation player&quot;);
@@ -110,8 +157,26 @@
 	def(&quot;close&quot;,Quit);
 	def(&quot;isActive&quot;,qtGuiIsActive,&quot;Whether the Qt GUI is being used.&quot;);
 	def(&quot;runPlayerSession&quot;,runPlayerSession,runPlayerSession_overloads(args(&quot;savedQGLState&quot;,&quot;dispParamsNo&quot;,&quot;stride&quot;,&quot;postLoadHook&quot;)));
+	def(&quot;views&quot;,getAllViews);
 
 	BASIC_PY_PROXY_WRAPPER(pyOpenGLRenderingEngine,&quot;GLRenderer&quot;)
 		.def(&quot;setRefSe3&quot;,&amp;pyOpenGLRenderingEngine::setRefSe3,&quot;Make current positions and orientation reference for scaleDisplacements and scaleRotations.&quot;);
 
+	boost::python::class_&lt;pyGLViewer&gt;(&quot;GLViewer&quot;)
+		.def(python::init&lt;unsigned&gt;())
+		.add_property(&quot;upVector&quot;,&amp;pyGLViewer::get_upVector,&amp;pyGLViewer::set_upVector)
+		.add_property(&quot;lookAt&quot;,&amp;pyGLViewer::get_lookAt,&amp;pyGLViewer::set_lookAt)
+		.add_property(&quot;viewDir&quot;,&amp;pyGLViewer::get_viewDir,&amp;pyGLViewer::set_viewDir)
+		.add_property(&quot;eyePosition&quot;,&amp;pyGLViewer::get_eyePosition,&amp;pyGLViewer::set_eyePosition)
+		.add_property(&quot;grid&quot;,&amp;pyGLViewer::get_grid,&amp;pyGLViewer::set_grid)
+		.add_property(&quot;fps&quot;,&amp;pyGLViewer::get_fps,&amp;pyGLViewer::set_fps)
+		.add_property(&quot;axes&quot;,&amp;pyGLViewer::get_axes,&amp;pyGLViewer::set_axes)
+		.add_property(&quot;scale&quot;,&amp;pyGLViewer::get_scale,&amp;pyGLViewer::set_scale)
+		.add_property(&quot;sceneRadius&quot;,&amp;pyGLViewer::get_sceneRadius,&amp;pyGLViewer::set_sceneRadius)
+		.add_property(&quot;ortho&quot;,&amp;pyGLViewer::get_orthographic,&amp;pyGLViewer::set_orthographic)
+		.def(&quot;fitAABB&quot;,&amp;pyGLViewer::fitAABB)
+		.def(&quot;fitSphere&quot;,&amp;pyGLViewer::fitSphere)
+		.def(&quot;showEntireScene&quot;,&amp;pyGLViewer::showEntireScene)
+		.def(&quot;center&quot;,&amp;pyGLViewer::center,pyGLViewer_center_overloads())
+		;
 }

Modified: trunk/gui/qt3/YadeQtMainWindow.cpp
===================================================================
--- trunk/gui/qt3/YadeQtMainWindow.cpp	2008-07-27 11:52:50 UTC (rev 1453)
+++ trunk/gui/qt3/YadeQtMainWindow.cpp	2008-07-28 19:25:02 UTC (rev 1454)
@@ -199,6 +199,12 @@
 		case EVENT_VIEW: createView(); break;
 		case EVENT_PLAYER: createPlayer(); break;
 		case EVENT_GENERATOR: createGenerator(); break;
+		#if 0
+		case EVENT_RESTORE_GLVIEWER_NUM:
+			{if(glViews.size()&lt;1 || !glViews[0]){ LOG_ERROR(&quot;No primary view to set attributes on, ignored.&quot;);} else{glViews[0]-&gt;useDisplayParameters(*(int*)(e-&gt;data())); delete (int*)e-&gt;data(); }} break;
+		case EVENT_RESTORE_GLVIEWER_STR:
+			{if(glViews.size()&lt;1 || !glViews[0]){ LOG_ERROR(&quot;No primary view to set attributes on, ignored.&quot;);} else{glViews[0]-&gt;setState(*(string*)(e-&gt;data())); delete (string*)e-&gt;data();}} break;
+		#endif
 		default: ;
 	}
 }

Modified: trunk/gui/qt3/YadeQtMainWindow.hpp
===================================================================
--- trunk/gui/qt3/YadeQtMainWindow.hpp	2008-07-27 11:52:50 UTC (rev 1453)
+++ trunk/gui/qt3/YadeQtMainWindow.hpp	2008-07-28 19:25:02 UTC (rev 1454)
@@ -49,12 +49,11 @@
 	public :
 		YadeQtMainWindow ();
 		virtual ~YadeQtMainWindow ();
+		static YadeQtMainWindow* self; // retrieve instance pointer form elsewhere
 
-		static YadeQtMainWindow* self; // HACK to retrieve this &quot;singleton&quot; form elsewhere
-
 		DECLARE_LOGGER;
 	public slots :
-		enum{EVENT_CONTROLLER=QEvent::User+1,EVENT_PLAYER,EVENT_VIEW,EVENT_GENERATOR};
+		enum{EVENT_CONTROLLER=QEvent::User+1,EVENT_PLAYER,EVENT_VIEW,EVENT_GENERATOR,EVENT_RESTORE_GLVIEWER_NUM,EVENT_RESTORE_GLVIEWER_STR,EVENT_RESTORE_VIEWER_FILE};
 		virtual void customEvent(QCustomEvent* e);
 		/* each of player, controller, generator have slots for them being opened and closed: create{Player,Controller,Generator} and the instances are kept in player, controller, generator. */
 		#define __MK_RM_CHILD(Child,child,YadeClass)  virtual void close##Child(){if(child)child=shared_ptr&lt;YadeClass&gt;();} virtual void create##Child(){if(!child){child=shared_ptr&lt;YadeClass&gt;(new YadeClass()); connect(child.get(),SIGNAL(closeSignal()),this,SLOT(close##Child())); child-&gt;show();} else {child-&gt;show(); child-&gt;raise();}}

Added: trunk/gui/qt3/qt.py
===================================================================
--- trunk/gui/qt3/qt.py	2008-07-27 11:52:50 UTC (rev 1453)
+++ trunk/gui/qt3/qt.py	2008-07-28 19:25:02 UTC (rev 1454)
@@ -0,0 +1,46 @@
+from _qt import *
+if not isActive():
+	raise ImportError(&quot;The Qt gui is not being used (run with -N QtGUI).&quot;)
+
+def createVideo(playerDb,out,viewerState=None,dispParamsNo=-1,stride=1,fps=24,postLoadHook=None):
+	&quot;&quot;&quot;Create video by replaying a simulation. Snapshots are taken to temporary files,
+	encoded to a .ogg stream (theora codec); temps are deleted at the end.
+
+	If the output file exists already, a ~[number] is appended and the old file is renamed.
+
+	playerDb is the database with saved simulation states,
+	out is the output file (like a.ogg), fps is frames-per-second for the video that is created,
+	dispParamsNo, stride and postLoadHook are passed to qt.runPlayer (docs in gui/qt3/QtGUI-Python.cpp).
+	
+	You need a display to run this (either virtual, like xvfb, or physical).
+
+	Necessary packages: python-gst0.10 gstreamer0.10-plugins-good python-gobject
+	&quot;&quot;&quot;
+	import pygst,sys,gobject,os
+	pygst.require(&quot;0.10&quot;)
+	import gst
+	from yade import qt
+	# postLoadHook and viewerState have &quot;&quot; instead of None in the c++ interface
+	wildcard,snaps=qt.runPlayerSession(
+		playerDb,
+		'', # snapBase
+		savedQGLState=(viewerState if viewerState else ''),
+		dispParamsNo=dispParamsNo,
+		stride=stride,
+		postLoadHook=(postLoadHook if postLoadHook else ''))
+	if(os.path.exists(out)):
+		i=0;
+		while(os.path.exists(out+&quot;~%d&quot;%i)): i+=1
+		os.rename(out,out+&quot;~%d&quot;%i); print &quot;Output file `%s' already existed, old file renamed to `%s'&quot;%(out,out+&quot;~%d&quot;%i)
+	print &quot;Encoding video from %s (%d files total) to %s&quot;%(wildcard,len(snaps),out)
+	pipeline=gst.parse_launch('multifilesrc location=&quot;%s&quot; index=0 caps=&quot;image/png,framerate=\(fraction\)%d/1&quot; ! pngdec ! ffmpegcolorspace ! theoraenc sharpness=2 quality=32 ! oggmux ! filesink location=&quot;%s&quot;'%(wildcard,fps,out))
+	bus=pipeline.get_bus()
+	bus.add_signal_watch()
+	mainloop=gobject.MainLoop();
+	bus.connect(&quot;message::eos&quot;,lambda bus,msg: mainloop.quit())
+	pipeline.set_state(gst.STATE_PLAYING)
+	mainloop.run()
+	pipeline.set_state(gst.STATE_NULL); pipeline.get_state()
+	print &quot;Cleaning snapshot files.&quot;
+	for f in snaps: os.remove(f)
+

Modified: trunk/scripts/simple-scene-player.py
===================================================================
--- trunk/scripts/simple-scene-player.py	2008-07-27 11:52:50 UTC (rev 1453)
+++ trunk/scripts/simple-scene-player.py	2008-07-28 19:25:02 UTC (rev 1454)
@@ -48,6 +48,7 @@
 	o=Omega()
 	for b in o.bodies: b.shape['wire']=True
 # you must have saved the viewer state by using Alt-S in the view...
-utils.qtCreateVideo('/tmp/player.sqlite','/tmp/player.ogg','/tmp/qglviewerState.xml',stride=10,fps=12,postLoadHook='setWire()')
+from yade import qt
+qt.createVideo('/tmp/player.sqlite','/tmp/player.ogg','/tmp/qglviewerState.xml',stride=10,fps=12,postLoadHook='setWire()')
 
 quit()


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000413.html">[Yade-commits] r1453 - trunk/pkg/dem
</A></li>
	<LI>Next message: <A HREF="000415.html">[Yade-commits] r1455 - in trunk: core extra gui/py gui/qt3	lib/miniWm3 pkg/common/Engine/DeusExMachina	pkg/common/Engine/StandAloneEngine
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#414">[ date ]</a>
              <a href="thread.html#414">[ thread ]</a>
              <a href="subject.html#414">[ subject ]</a>
              <a href="author.html#414">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/yade-commits">More information about the Yade-commits
mailing list</a><br>
</body></html>
