<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Yade-commits] r1242 - in trunk: . core extra extra/clump extra/screw extra/tetra extra/usct gui gui/cmd lib/factory pkg/common pkg/common/Container pkg/common/DataClass/BoundingVolume pkg/common/DataClass/GeometricalModel pkg/common/DataClass/InteractingGeometry pkg/common/DataClass/InteractionGeometry pkg/common/DataClass/InteractionPhysics pkg/common/DataClass/PhysicalAction pkg/common/DataClass/PhysicalParameters pkg/common/Engine/DeusExMachina pkg/common/Engine/EngineUnit pkg/common/Engine/MetaEngine pkg/common/Engine/StandAloneEngine pkg/common/RenderingEngine/GLDrawBoundingVolume pkg/common/RenderingEngine/GLDrawGeometricalModel pkg/common/RenderingEngine/GLDrawInteractingGeometry pkg/common/RenderingEngine/GLDrawInteractionGeometry pkg/common/RenderingEngine/GLDrawInteractionPhysics pkg/common/RenderingEngine/GLDrawShadowVolume pkg/common/RenderingEngine/GLDrawState pkg/common/RenderingEngine/OpenGLRenderingEngine pkg/dem pkg/dem/DataClass/InteractingGeometry pkg/dem/DataC! lass/InteractionGeometry pkg/dem/DataClass/InteractionPhysics pkg/dem/DataClass/PhysicalAction pkg/dem/DataClass/PhysicalParameters pkg/dem/Engine/DeusExMachina pkg/dem/Engine/EngineUnit pkg/dem/Engine/StandAloneEngine pkg/dem/PreProcessor pkg/dem/RenderingEngine/GLDrawInteractingMyTetrahedron pkg/dem/RenderingEngine/GLDrawSDECLinkGeometry pkg/dem/RenderingEngine/GLDrawSpheresContactGeometry pkg/fem/DataClass/GeometricalModel pkg/fem/DataClass/PhysicalParameters pkg/fem/Engine/EngineUnit pkg/fem/Engine/StandAloneEngine pkg/fem/PreProcessor pkg/lattice/DataClass/GeometricalModel pkg/lattice/DataClass/InteractingGeometry pkg/lattice/DataClass/InteractionPhysics pkg/lattice/DataClass/PhysicalParameters pkg/lattice/Engine/EngineUnit pkg/lattice/Engine/StandAloneEngine pkg/lattice/PreProcessor pkg/lattice/RenderingEngine/GLDrawLatticeBeamState pkg/lattice/RenderingEngine/GLDrawLatticeInteractingGeometry pkg/lattice/RenderingEngine/GLDrawLatticeSetGeometry pkg/lattice/RenderingEn! gine/GLDrawLineSegment pkg/mass-spring/DataClass/InteractionGe! ometry p
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/yade-commits/2008/index.html" >
   <LINK REL="made" HREF="mailto:yade-commits%40lists.berlios.de?Subject=Re%3A%20%5BYade-commits%5D%20r1242%20-%20in%20trunk%3A%20.%20core%20extra%20extra/clump%0A%20extra/screw%20extra/tetra%20extra/usct%20gui%20gui/cmd%20lib/factory%20pkg/common%0A%20pkg/common/Container%20pkg/common/DataClass/BoundingVolume%0A%20pkg/common/DataClass/GeometricalModel%0A%20pkg/common/DataClass/InteractingGeometry%0A%20pkg/common/DataClass/InteractionGeometry%0A%20pkg/common/DataClass/InteractionPhysics%20pkg/common/DataClass/PhysicalAction%0A%20pkg/common/DataClass/PhysicalParameters%20pkg/common/Engine/DeusExMachina%0A%20pkg/common/Engine/EngineUnit%20pkg/common/Engine/MetaEngine%0A%20pkg/common/Engine/StandAloneEngine%0A%20pkg/common/RenderingEngine/GLDrawBoundingVolume%0A%20pkg/common/RenderingEngine/GLDrawGeometricalModel%0A%20pkg/common/RenderingEngine/GLDrawInteractingGeometry%0A%20pkg/common/RenderingEngine/GLDrawInteractionGeometry%0A%20pkg/common/RenderingEngine/GLDrawInteractionPhysics%0A%20pkg/common/RenderingEngine/GLDrawShadowVolume%0A%20pkg/common/RenderingEngine/GLDrawState%0A%20pkg/common/RenderingEngine/OpenGLRenderingEngine%20pkg/dem%0A%20pkg/dem/DataClass/InteractingGeometry%20pkg/dem/DataC%21%0A%20lass/InteractionGeometry%20pkg/dem/DataClass/InteractionPhysics%0A%20pkg/dem/DataClass/PhysicalAction%20pkg/dem/DataClass/PhysicalParameters%0A%20pkg/dem/Engine/DeusExMachina%20pkg/dem/Engine/EngineUnit%0A%20pkg/dem/Engine/StandAloneEngine%20pkg/dem/PreProcessor%0A%20pkg/dem/RenderingEngine/GLDrawInteractingMyTetrahedron%0A%20pkg/dem/RenderingEngine/GLDrawSDECLinkGeometry%0A%20pkg/dem/RenderingEngine/GLDrawSpheresContactGeometry%0A%20pkg/fem/DataClass/GeometricalModel%20pkg/fem/DataClass/PhysicalParameters%0A%20pkg/fem/Engine/EngineUnit%20pkg/fem/Engine/StandAloneEngine%0A%20pkg/fem/PreProcessor%20pkg/lattice/DataClass/GeometricalModel%0A%20pkg/lattice/DataClass/InteractingGeometry%0A%20pkg/lattice/DataClass/InteractionPhysics%0A%20pkg/lattice/DataClass/PhysicalParameters%20pkg/lattice/Engine/EngineUnit%0A%20pkg/lattice/Engine/StandAloneEngine%20pkg/lattice/PreProcessor%0A%20pkg/lattice/RenderingEngine/GLDrawLatticeBeamState%0A%20pkg/lattice/RenderingEngine/GLDrawLatticeInteractingGeometry%0A%20pkg/lattice/RenderingEngine/GLDrawLatticeSetGeometry%0A%20pkg/lattice/RenderingEn%21%20gine/GLDrawLineSegment%0A%20pkg/mass-spring/DataClass/InteractionGe%21%20ometry%20p&In-Reply-To=%3C200802041036.m14AaeOi008862%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000206.html">
   <LINK REL="Next"  HREF="000208.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Yade-commits] r1242 - in trunk: . core extra extra/clump extra/screw extra/tetra extra/usct gui gui/cmd lib/factory pkg/common pkg/common/Container pkg/common/DataClass/BoundingVolume pkg/common/DataClass/GeometricalModel pkg/common/DataClass/InteractingGeometry pkg/common/DataClass/InteractionGeometry pkg/common/DataClass/InteractionPhysics pkg/common/DataClass/PhysicalAction pkg/common/DataClass/PhysicalParameters pkg/common/Engine/DeusExMachina pkg/common/Engine/EngineUnit pkg/common/Engine/MetaEngine pkg/common/Engine/StandAloneEngine pkg/common/RenderingEngine/GLDrawBoundingVolume pkg/common/RenderingEngine/GLDrawGeometricalModel pkg/common/RenderingEngine/GLDrawInteractingGeometry pkg/common/RenderingEngine/GLDrawInteractionGeometry pkg/common/RenderingEngine/GLDrawInteractionPhysics pkg/common/RenderingEngine/GLDrawShadowVolume pkg/common/RenderingEngine/GLDrawState pkg/common/RenderingEngine/OpenGLRenderingEngine pkg/dem pkg/dem/DataClass/InteractingGeometry pkg/dem/DataC! lass/InteractionGeometry pkg/dem/DataClass/InteractionPhysics pkg/dem/DataClass/PhysicalAction pkg/dem/DataClass/PhysicalParameters pkg/dem/Engine/DeusExMachina pkg/dem/Engine/EngineUnit pkg/dem/Engine/StandAloneEngine pkg/dem/PreProcessor pkg/dem/RenderingEngine/GLDrawInteractingMyTetrahedron pkg/dem/RenderingEngine/GLDrawSDECLinkGeometry pkg/dem/RenderingEngine/GLDrawSpheresContactGeometry pkg/fem/DataClass/GeometricalModel pkg/fem/DataClass/PhysicalParameters pkg/fem/Engine/EngineUnit pkg/fem/Engine/StandAloneEngine pkg/fem/PreProcessor pkg/lattice/DataClass/GeometricalModel pkg/lattice/DataClass/InteractingGeometry pkg/lattice/DataClass/InteractionPhysics pkg/lattice/DataClass/PhysicalParameters pkg/lattice/Engine/EngineUnit pkg/lattice/Engine/StandAloneEngine pkg/lattice/PreProcessor pkg/lattice/RenderingEngine/GLDrawLatticeBeamState pkg/lattice/RenderingEngine/GLDrawLatticeInteractingGeometry pkg/lattice/RenderingEngine/GLDrawLatticeSetGeometry pkg/lattice/RenderingEn! gine/GLDrawLineSegment pkg/mass-spring/DataClass/InteractionGe! ometry p</H1>
    <B>eudoxos at BerliOS</B> 
    <A HREF="mailto:yade-commits%40lists.berlios.de?Subject=Re%3A%20%5BYade-commits%5D%20r1242%20-%20in%20trunk%3A%20.%20core%20extra%20extra/clump%0A%20extra/screw%20extra/tetra%20extra/usct%20gui%20gui/cmd%20lib/factory%20pkg/common%0A%20pkg/common/Container%20pkg/common/DataClass/BoundingVolume%0A%20pkg/common/DataClass/GeometricalModel%0A%20pkg/common/DataClass/InteractingGeometry%0A%20pkg/common/DataClass/InteractionGeometry%0A%20pkg/common/DataClass/InteractionPhysics%20pkg/common/DataClass/PhysicalAction%0A%20pkg/common/DataClass/PhysicalParameters%20pkg/common/Engine/DeusExMachina%0A%20pkg/common/Engine/EngineUnit%20pkg/common/Engine/MetaEngine%0A%20pkg/common/Engine/StandAloneEngine%0A%20pkg/common/RenderingEngine/GLDrawBoundingVolume%0A%20pkg/common/RenderingEngine/GLDrawGeometricalModel%0A%20pkg/common/RenderingEngine/GLDrawInteractingGeometry%0A%20pkg/common/RenderingEngine/GLDrawInteractionGeometry%0A%20pkg/common/RenderingEngine/GLDrawInteractionPhysics%0A%20pkg/common/RenderingEngine/GLDrawShadowVolume%0A%20pkg/common/RenderingEngine/GLDrawState%0A%20pkg/common/RenderingEngine/OpenGLRenderingEngine%20pkg/dem%0A%20pkg/dem/DataClass/InteractingGeometry%20pkg/dem/DataC%21%0A%20lass/InteractionGeometry%20pkg/dem/DataClass/InteractionPhysics%0A%20pkg/dem/DataClass/PhysicalAction%20pkg/dem/DataClass/PhysicalParameters%0A%20pkg/dem/Engine/DeusExMachina%20pkg/dem/Engine/EngineUnit%0A%20pkg/dem/Engine/StandAloneEngine%20pkg/dem/PreProcessor%0A%20pkg/dem/RenderingEngine/GLDrawInteractingMyTetrahedron%0A%20pkg/dem/RenderingEngine/GLDrawSDECLinkGeometry%0A%20pkg/dem/RenderingEngine/GLDrawSpheresContactGeometry%0A%20pkg/fem/DataClass/GeometricalModel%20pkg/fem/DataClass/PhysicalParameters%0A%20pkg/fem/Engine/EngineUnit%20pkg/fem/Engine/StandAloneEngine%0A%20pkg/fem/PreProcessor%20pkg/lattice/DataClass/GeometricalModel%0A%20pkg/lattice/DataClass/InteractingGeometry%0A%20pkg/lattice/DataClass/InteractionPhysics%0A%20pkg/lattice/DataClass/PhysicalParameters%20pkg/lattice/Engine/EngineUnit%0A%20pkg/lattice/Engine/StandAloneEngine%20pkg/lattice/PreProcessor%0A%20pkg/lattice/RenderingEngine/GLDrawLatticeBeamState%0A%20pkg/lattice/RenderingEngine/GLDrawLatticeInteractingGeometry%0A%20pkg/lattice/RenderingEngine/GLDrawLatticeSetGeometry%0A%20pkg/lattice/RenderingEn%21%20gine/GLDrawLineSegment%0A%20pkg/mass-spring/DataClass/InteractionGe%21%20ometry%20p&In-Reply-To=%3C200802041036.m14AaeOi008862%40sheep.berlios.de%3E"
       TITLE="[Yade-commits] r1242 - in trunk: . core extra extra/clump extra/screw extra/tetra extra/usct gui gui/cmd lib/factory pkg/common pkg/common/Container pkg/common/DataClass/BoundingVolume pkg/common/DataClass/GeometricalModel pkg/common/DataClass/InteractingGeometry pkg/common/DataClass/InteractionGeometry pkg/common/DataClass/InteractionPhysics pkg/common/DataClass/PhysicalAction pkg/common/DataClass/PhysicalParameters pkg/common/Engine/DeusExMachina pkg/common/Engine/EngineUnit pkg/common/Engine/MetaEngine pkg/common/Engine/StandAloneEngine pkg/common/RenderingEngine/GLDrawBoundingVolume pkg/common/RenderingEngine/GLDrawGeometricalModel pkg/common/RenderingEngine/GLDrawInteractingGeometry pkg/common/RenderingEngine/GLDrawInteractionGeometry pkg/common/RenderingEngine/GLDrawInteractionPhysics pkg/common/RenderingEngine/GLDrawShadowVolume pkg/common/RenderingEngine/GLDrawState pkg/common/RenderingEngine/OpenGLRenderingEngine pkg/dem pkg/dem/DataClass/InteractingGeometry pkg/dem/DataC! lass/InteractionGeometry pkg/dem/DataClass/InteractionPhysics pkg/dem/DataClass/PhysicalAction pkg/dem/DataClass/PhysicalParameters pkg/dem/Engine/DeusExMachina pkg/dem/Engine/EngineUnit pkg/dem/Engine/StandAloneEngine pkg/dem/PreProcessor pkg/dem/RenderingEngine/GLDrawInteractingMyTetrahedron pkg/dem/RenderingEngine/GLDrawSDECLinkGeometry pkg/dem/RenderingEngine/GLDrawSpheresContactGeometry pkg/fem/DataClass/GeometricalModel pkg/fem/DataClass/PhysicalParameters pkg/fem/Engine/EngineUnit pkg/fem/Engine/StandAloneEngine pkg/fem/PreProcessor pkg/lattice/DataClass/GeometricalModel pkg/lattice/DataClass/InteractingGeometry pkg/lattice/DataClass/InteractionPhysics pkg/lattice/DataClass/PhysicalParameters pkg/lattice/Engine/EngineUnit pkg/lattice/Engine/StandAloneEngine pkg/lattice/PreProcessor pkg/lattice/RenderingEngine/GLDrawLatticeBeamState pkg/lattice/RenderingEngine/GLDrawLatticeInteractingGeometry pkg/lattice/RenderingEngine/GLDrawLatticeSetGeometry pkg/lattice/RenderingEn! gine/GLDrawLineSegment pkg/mass-spring/DataClass/InteractionGe! ometry p">eudoxos at mail.berlios.de
       </A><BR>
    <I>Mon Feb  4 11:36:40 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000206.html">[Yade-commits] r1241 - in trunk: . doc
</A></li>
        <LI>Next message: <A HREF="000208.html">[Yade-commits] r1243 - in trunk: . core extra extra/clump	extra/tetra extra/usct gui/cmd lib/base	pkg/common/Engine/EngineUnit pkg/dem/Engine/DeusExMachina	pkg/dem/Engine/EngineUnit
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#207">[ date ]</a>
              <a href="thread.html#207">[ thread ]</a>
              <a href="subject.html#207">[ subject ]</a>
              <a href="author.html#207">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: eudoxos
Date: 2008-02-04 11:36:31 +0100 (Mon, 04 Feb 2008)
New Revision: 1242

Added:
   trunk/extra/Brefcom.cpp
   trunk/extra/Brefcom.hpp
   trunk/extra/BrefcomTestGen.cpp
   trunk/extra/BrefcomTestGen.hpp
   trunk/extra/usct/
   trunk/extra/usct/UniaxialStrainControlledTest.cpp
   trunk/extra/usct/UniaxialStrainControlledTest.hpp
   trunk/scripts/pch.py
Modified:
   trunk/SConstruct
   trunk/core/MetaDispatchingEngine.cpp
   trunk/core/MetaDispatchingEngine.hpp
   trunk/core/Omega.cpp
   trunk/core/Omega.hpp
   trunk/extra/SConscript
   trunk/extra/clump/Clump.cpp
   trunk/extra/clump/PythonRecorder.cpp
   trunk/extra/clump/Shop.cpp
   trunk/extra/clump/Shop.hpp
   trunk/extra/screw/ScrewGen.cpp
   trunk/extra/tetra/Tetra.cpp
   trunk/extra/tetra/TetraTestGen.cpp
   trunk/gui/SConscript
   trunk/gui/cmd/attrUtils.cpp
   trunk/gui/cmd/cmdGui.cpp
   trunk/gui/cmd/yadeControl.cpp
   trunk/lib/factory/DynLibManager.cpp
   trunk/lib/factory/DynLibManager.hpp
   trunk/pkg/common/Container/BodyAssocVector.cpp
   trunk/pkg/common/Container/BodyRedirectionVector.cpp
   trunk/pkg/common/Container/InteractionHashMap.cpp
   trunk/pkg/common/Container/InteractionVecSet.cpp
   trunk/pkg/common/Container/PhysicalActionVectorVector.cpp
   trunk/pkg/common/DataClass/BoundingVolume/AABB.cpp
   trunk/pkg/common/DataClass/BoundingVolume/BoundingSphere.cpp
   trunk/pkg/common/DataClass/GeometricalModel/Box.cpp
   trunk/pkg/common/DataClass/GeometricalModel/Mesh2D.cpp
   trunk/pkg/common/DataClass/GeometricalModel/Quadrilateral.cpp
   trunk/pkg/common/DataClass/GeometricalModel/Sphere.cpp
   trunk/pkg/common/DataClass/GeometricalModel/Tetrahedron.cpp
   trunk/pkg/common/DataClass/InteractingGeometry/InteractingBox.cpp
   trunk/pkg/common/DataClass/InteractingGeometry/InteractingSphere.cpp
   trunk/pkg/common/DataClass/InteractingGeometry/MetaInteractingGeometry.cpp
   trunk/pkg/common/DataClass/InteractionGeometry/ClosestFeatures.cpp
   trunk/pkg/common/DataClass/InteractionPhysics/SimpleElasticInteraction.cpp
   trunk/pkg/common/DataClass/PhysicalAction/Force.cpp
   trunk/pkg/common/DataClass/PhysicalAction/Momentum.cpp
   trunk/pkg/common/DataClass/PhysicalParameters/ElasticBodyParameters.cpp
   trunk/pkg/common/DataClass/PhysicalParameters/ParticleParameters.cpp
   trunk/pkg/common/DataClass/PhysicalParameters/RigidBodyParameters.cpp
   trunk/pkg/common/Engine/DeusExMachina/DisplacementEngine.cpp
   trunk/pkg/common/Engine/DeusExMachina/ForceEngine.cpp
   trunk/pkg/common/Engine/DeusExMachina/GravityEngine.cpp
   trunk/pkg/common/Engine/DeusExMachina/RotationEngine.cpp
   trunk/pkg/common/Engine/DeusExMachina/TranslationEngine.cpp
   trunk/pkg/common/Engine/EngineUnit/CundallNonViscousForceDamping.cpp
   trunk/pkg/common/Engine/EngineUnit/CundallNonViscousMomentumDamping.cpp
   trunk/pkg/common/Engine/EngineUnit/ElasticBodySimpleRelationship.cpp
   trunk/pkg/common/Engine/EngineUnit/InteractingBox2AABB.cpp
   trunk/pkg/common/Engine/EngineUnit/InteractingSphere2AABB.cpp
   trunk/pkg/common/Engine/EngineUnit/LeapFrogOrientationIntegrator.cpp
   trunk/pkg/common/Engine/EngineUnit/LeapFrogPositionIntegrator.cpp
   trunk/pkg/common/Engine/EngineUnit/MetaInteractingGeometry2AABB.cpp
   trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.cpp
   trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.cpp
   trunk/pkg/common/Engine/MetaEngine/BoundingVolumeMetaEngine.cpp
   trunk/pkg/common/Engine/MetaEngine/GeometricalModelMetaEngine.cpp
   trunk/pkg/common/Engine/MetaEngine/InteractingGeometryMetaEngine.cpp
   trunk/pkg/common/Engine/MetaEngine/InteractionGeometryMetaEngine.cpp
   trunk/pkg/common/Engine/MetaEngine/InteractionPhysicsMetaEngine.cpp
   trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplier.cpp
   trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamper.cpp
   trunk/pkg/common/Engine/MetaEngine/PhysicalParametersMetaEngine.cpp
   trunk/pkg/common/Engine/StandAloneEngine/DistantPersistentSAPCollider.cpp
   trunk/pkg/common/Engine/StandAloneEngine/PersistentSAPCollider.cpp
   trunk/pkg/common/Engine/StandAloneEngine/PersistentSAPCollider.hpp
   trunk/pkg/common/Engine/StandAloneEngine/PhysicalActionContainerInitializer.cpp
   trunk/pkg/common/Engine/StandAloneEngine/PhysicalActionContainerReseter.cpp
   trunk/pkg/common/Engine/StandAloneEngine/SAPCollider.cpp
   trunk/pkg/common/RenderingEngine/GLDrawBoundingVolume/GLDrawAABB.cpp
   trunk/pkg/common/RenderingEngine/GLDrawBoundingVolume/GLDrawBoundingSphere.cpp
   trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawBox.cpp
   trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawMesh2D.cpp
   trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawQuadrilateral.cpp
   trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawSphere.cpp
   trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawTetrahedron.cpp
   trunk/pkg/common/RenderingEngine/GLDrawInteractingGeometry/GLDrawInteractingBox.cpp
   trunk/pkg/common/RenderingEngine/GLDrawInteractingGeometry/GLDrawInteractingSphere.cpp
   trunk/pkg/common/RenderingEngine/GLDrawInteractingGeometry/GLDrawMetaInteractingGeometry.cpp
   trunk/pkg/common/RenderingEngine/GLDrawInteractionGeometry/GLDrawClosestFeatures.cpp
   trunk/pkg/common/RenderingEngine/GLDrawInteractionPhysics/GLDrawSimpleElasticInteraction.cpp
   trunk/pkg/common/RenderingEngine/GLDrawShadowVolume/GLDrawBoxShadowVolume.cpp
   trunk/pkg/common/RenderingEngine/GLDrawShadowVolume/GLDrawSphereShadowVolume.cpp
   trunk/pkg/common/RenderingEngine/GLDrawState/GLDrawParticleState.cpp
   trunk/pkg/common/RenderingEngine/GLDrawState/GLDrawRigidBodyState.cpp
   trunk/pkg/common/RenderingEngine/OpenGLRenderingEngine/OpenGLRenderingEngine.cpp
   trunk/pkg/common/SConscript
   trunk/pkg/dem/DataClass/InteractingGeometry/InteractingMyTetrahedron.cpp
   trunk/pkg/dem/DataClass/InteractionGeometry/InteractionOfMyTetrahedron.cpp
   trunk/pkg/dem/DataClass/InteractionGeometry/SDECLinkGeometry.cpp
   trunk/pkg/dem/DataClass/InteractionGeometry/SpheresContactGeometry.cpp
   trunk/pkg/dem/DataClass/InteractionPhysics/CapillaryParameters.cpp
   trunk/pkg/dem/DataClass/InteractionPhysics/CohesiveFrictionalContactInteraction.cpp
   trunk/pkg/dem/DataClass/InteractionPhysics/ElasticContactInteraction.cpp
   trunk/pkg/dem/DataClass/InteractionPhysics/SDECLinkPhysics.cpp
   trunk/pkg/dem/DataClass/PhysicalAction/GlobalStiffness.cpp
   trunk/pkg/dem/DataClass/PhysicalParameters/BodyMacroParameters.cpp
   trunk/pkg/dem/DataClass/PhysicalParameters/CohesiveFrictionalBodyParameters.cpp
   trunk/pkg/dem/Engine/DeusExMachina/CapillaryPressureEngine.cpp
   trunk/pkg/dem/Engine/DeusExMachina/CapillaryRecorder.cpp
   trunk/pkg/dem/Engine/DeusExMachina/CapillaryStressRecorder.cpp
   trunk/pkg/dem/Engine/DeusExMachina/ContactStressRecorder.cpp
   trunk/pkg/dem/Engine/DeusExMachina/HydraulicForceEngine.cpp
   trunk/pkg/dem/Engine/DeusExMachina/MakeItFlat.cpp
   trunk/pkg/dem/Engine/DeusExMachina/ResultantForceEngine.cpp
   trunk/pkg/dem/Engine/DeusExMachina/TriaxialCompressionEngine.cpp
   trunk/pkg/dem/Engine/DeusExMachina/TriaxialStateRecorder.cpp
   trunk/pkg/dem/Engine/DeusExMachina/TriaxialStressController.cpp
   trunk/pkg/dem/Engine/DeusExMachina/WallStressRecorder.cpp
   trunk/pkg/dem/Engine/EngineUnit/CohesiveFrictionalRelationships.cpp
   trunk/pkg/dem/Engine/EngineUnit/InteractingBox2InteractingSphere4SpheresContactGeometry.cpp
   trunk/pkg/dem/Engine/EngineUnit/InteractingBox2InteractingSphere4SpheresContactGeometryWater.cpp
   trunk/pkg/dem/Engine/EngineUnit/InteractingMyTetrahedron2AABB.cpp
   trunk/pkg/dem/Engine/EngineUnit/InteractingMyTetrahedron2InteractingBox4InteractionOfMyTetrahedron.cpp
   trunk/pkg/dem/Engine/EngineUnit/InteractingMyTetrahedron2InteractingMyTetrahedron4InteractionOfMyTetrahedron.cpp
   trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2AABBwater.cpp
   trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4DistantSpheresContactGeometry.cpp
   trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4SpheresContactGeometry.cpp
   trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4SpheresContactGeometryWater.cpp
   trunk/pkg/dem/Engine/EngineUnit/MacroMicroElasticRelationships.cpp
   trunk/pkg/dem/Engine/EngineUnit/MacroMicroElasticRelationshipsWater.cpp
   trunk/pkg/dem/Engine/EngineUnit/SimpleElasticRelationships.cpp
   trunk/pkg/dem/Engine/EngineUnit/Tetrahedron2InteractingMyTetrahedron.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/AveragePositionRecorder.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/CapillaryCohesiveLaw.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/CohesiveFrictionalContactLaw.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/ElasticCohesiveLaw.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/ElasticContactLaw.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/ElasticCriterionTimeStepper.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/ForceRecorder.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/GeometricalModelForceColorizer.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessCounter.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessCounter.hpp
   trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessTimeStepper.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/MyTetrahedronLaw.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/PositionOrientationRecorder.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/VelocityRecorder.cpp
   trunk/pkg/dem/PreProcessor/CohesiveTriaxialTest.cpp
   trunk/pkg/dem/PreProcessor/Funnel.cpp
   trunk/pkg/dem/PreProcessor/HydraulicTest.cpp
   trunk/pkg/dem/PreProcessor/ModifiedTriaxialTest.cpp
   trunk/pkg/dem/PreProcessor/SDECImpactTest.cpp
   trunk/pkg/dem/PreProcessor/SDECLinkedSpheres.cpp
   trunk/pkg/dem/PreProcessor/SDECMovingWall.cpp
   trunk/pkg/dem/PreProcessor/SDECSpheresPlane.cpp
   trunk/pkg/dem/PreProcessor/TetrahedronsTest.cpp
   trunk/pkg/dem/PreProcessor/ThreePointBending.cpp
   trunk/pkg/dem/PreProcessor/TriaxialTest.cpp
   trunk/pkg/dem/PreProcessor/TriaxialTest.hpp
   trunk/pkg/dem/PreProcessor/TriaxialTestWater.cpp
   trunk/pkg/dem/RenderingEngine/GLDrawInteractingMyTetrahedron/GLDrawInteractingMyTetrahedron.cpp
   trunk/pkg/dem/RenderingEngine/GLDrawSDECLinkGeometry/GLDrawSDECLinkGeometry.cpp
   trunk/pkg/dem/RenderingEngine/GLDrawSpheresContactGeometry/GLDrawSpheresContactGeometry.cpp
   trunk/pkg/dem/SConscript
   trunk/pkg/fem/DataClass/GeometricalModel/FEMSetGeometry.cpp
   trunk/pkg/fem/DataClass/PhysicalParameters/FEMNodeData.cpp
   trunk/pkg/fem/DataClass/PhysicalParameters/FEMSetParameters.cpp
   trunk/pkg/fem/DataClass/PhysicalParameters/FEMTetrahedronData.cpp
   trunk/pkg/fem/Engine/EngineUnit/FEMSet2Tetrahedrons.cpp
   trunk/pkg/fem/Engine/EngineUnit/FEMSetTextLoader.cpp
   trunk/pkg/fem/Engine/EngineUnit/FEMTetrahedronStiffness.cpp
   trunk/pkg/fem/Engine/StandAloneEngine/FEMLaw.cpp
   trunk/pkg/fem/PreProcessor/FEMBeam.cpp
   trunk/pkg/lattice/DataClass/GeometricalModel/LatticeSetGeometry.cpp
   trunk/pkg/lattice/DataClass/GeometricalModel/LineSegment.cpp
   trunk/pkg/lattice/DataClass/InteractingGeometry/LatticeInteractingGeometry.cpp
   trunk/pkg/lattice/DataClass/InteractionPhysics/LatticeBeamAngularSpring.cpp
   trunk/pkg/lattice/DataClass/InteractionPhysics/NonLocalDependency.cpp
   trunk/pkg/lattice/DataClass/PhysicalParameters/LatticeBeamParameters.cpp
   trunk/pkg/lattice/DataClass/PhysicalParameters/LatticeNodeParameters.cpp
   trunk/pkg/lattice/DataClass/PhysicalParameters/LatticeSetParameters.cpp
   trunk/pkg/lattice/Engine/EngineUnit/LatticeSet2LatticeBeams.cpp
   trunk/pkg/lattice/Engine/StandAloneEngine/BeamRecorder.cpp
   trunk/pkg/lattice/Engine/StandAloneEngine/LatticeLaw.cpp
   trunk/pkg/lattice/Engine/StandAloneEngine/MeasurePoisson.cpp
   trunk/pkg/lattice/Engine/StandAloneEngine/MovingSupport.cpp
   trunk/pkg/lattice/Engine/StandAloneEngine/NodeRecorder.cpp
   trunk/pkg/lattice/Engine/StandAloneEngine/NonLocalInitializer.cpp
   trunk/pkg/lattice/Engine/StandAloneEngine/StrainRecorder.cpp
   trunk/pkg/lattice/PreProcessor/LatticeExample.cpp
   trunk/pkg/lattice/RenderingEngine/GLDrawLatticeBeamState/GLDrawLatticeBeamState.cpp
   trunk/pkg/lattice/RenderingEngine/GLDrawLatticeInteractingGeometry/GLDrawLatticeInteractingGeometry.cpp
   trunk/pkg/lattice/RenderingEngine/GLDrawLatticeSetGeometry/GLDrawLatticeSetGeometry.cpp
   trunk/pkg/lattice/RenderingEngine/GLDrawLineSegment/GLDrawLineSegment.cpp
   trunk/pkg/mass-spring/DataClass/InteractionGeometry/SpringGeometry.cpp
   trunk/pkg/mass-spring/DataClass/InteractionPhysics/SpringPhysics.cpp
   trunk/pkg/mass-spring/DataClass/PhysicalParameters/ParticleSetParameters.cpp
   trunk/pkg/mass-spring/Engine/EngineUnit/ParticleSet2Mesh2D.cpp
   trunk/pkg/mass-spring/Engine/StandAloneEngine/MassSpringLaw.cpp
   trunk/pkg/mass-spring/PreProcessor/HangingCloth.cpp
   trunk/pkg/realtime-rigidbody/Engine/EngineUnit/InteractingBox2InteractingBox4ClosestFeatures.cpp
   trunk/pkg/realtime-rigidbody/Engine/EngineUnit/InteractingBox2InteractingSphere4ClosestFeatures.cpp
   trunk/pkg/realtime-rigidbody/Engine/EngineUnit/InteractingSphere2InteractingSphere4ClosestFeatures.cpp
   trunk/pkg/realtime-rigidbody/Engine/StandAloneEngine/FrictionLessElasticContactLaw.cpp
   trunk/pkg/realtime-rigidbody/PreProcessor/BoxStack.cpp
   trunk/pkg/realtime-rigidbody/PreProcessor/RotatingBox.cpp
Log:
1. BIG?\194?\160update of python wrappers - enagines can be created, added, modified from python now. Examples will be provided very soon.
2. fix plugin loader for multi-plugins: YADE_PLUGIN() macro should be used in all plugins, otherwise due to linking symbol overrides a multi-plugin will shadow classes in the plugin actually being loaded (better solution?!)
3. Add experimental BREakable Frictional COhesive Moment-blocking material (brefcom for short), not yet fully done.
4. PersistentSAPCollider now can be parametrized to permit distant contacts (is not the default, though), incorporating Bruno's changes in DistantPersistentSAPCollider
5. Uniaxial strain-controlled test (USCT), a quite simple implementation. Used primarily for brefcom testing now.
6. Fix SConstruct so that it is backward-compatible with python2.4
 


Modified: trunk/SConstruct
===================================================================
--- trunk/SConstruct	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/SConstruct	2008-02-04 10:36:31 UTC (rev 1242)
@@ -21,18 +21,21 @@
 #  3. Have build.log with commands and all output...
 #
 # And as usually, clean up the code, get rid of workarounds and hacks etc.
-
 import os,os.path,string,re,sys
 import SCons
 # SCons version numbers are needed a few times
-#ver=[str(x) for x in SCons.__version__.split('.')]
-#for i in range(0,len(ver)):
-#	ver[i]=&quot;&quot;.join([x if x in ('0123456789') else '0' for x in ver[i]])
-#	if len(ver[i])&gt;2: ver[i]=ver[i][0:2]+&quot;.&quot;+ver[i][2:]
-#sconsVersion=10000*float(ver[0])+(100*float(ver[1]) if len(ver)&gt;1 else 0)+(float(ver[2]) if len(ver)&gt;2 else 0)
-#
-# should work with python 2.4
-sconsVersion=sum([int(SCons.__version__.split('.')[ord[0]])*ord[1] for ord in [(0,10000),(1,100),(2,1)][:len(SCons.__version__.split('.'))] ])
+# rewritten for python2.4
+ver=[str(x) for x in SCons.__version__.split('.')]
+for i in range(0,len(ver)):
+	def any2num(x):
+		if x in ('0123456789'): return x
+		else: return '0'
+	ver[i]=&quot;&quot;.join([any2num(x) for x in ver[i]])
+	if len(ver[i])&gt;2: ver[i]=ver[i][0:2]+&quot;.&quot;+ver[i][2:]
+sconsVersion=10000*float(ver[0])
+if len(ver)&gt;1: sconsVersion+=100*float(ver[1])
+if len(ver)&gt;2: sconsVersion+=float(ver[2])
+# print sconsVersion
 
 ##########################################################################################
 ########## PROXY TO NEWER SCONS (DOWNLOADED IF NEEDED) ###################################

Modified: trunk/core/MetaDispatchingEngine.cpp
===================================================================
--- trunk/core/MetaDispatchingEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/core/MetaDispatchingEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -39,7 +39,6 @@
 	return functorNames;
 }
 
-
 void MetaDispatchingEngine::clear()
 {
 	functorNames.clear();

Modified: trunk/core/MetaDispatchingEngine.hpp
===================================================================
--- trunk/core/MetaDispatchingEngine.hpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/core/MetaDispatchingEngine.hpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -14,11 +14,10 @@
 
 class MetaDispatchingEngine : public MetaEngine
 {
-
-	protected :
-		vector&lt;vector&lt;string&gt; &gt;		functorNames;
+	public:
+		vector&lt;vector&lt;string&gt; &gt;		functorNames; // public for python interface; since there is getFunctorArguments returning RW(!) reference to this, why have it private anyway?!
 		list&lt;shared_ptr&lt;EngineUnit&gt; &gt;	functorArguments;
-
+	protected:
 		void storeFunctorArguments(shared_ptr&lt;EngineUnit&gt; eu);
 
 	public :

Modified: trunk/core/Omega.cpp
===================================================================
--- trunk/core/Omega.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/core/Omega.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -11,6 +11,7 @@
 #include&quot;Omega.hpp&quot;
 #include&quot;yadeExceptions.hpp&quot;
 #include&quot;MetaBody.hpp&quot;
+#include&quot;TimeStepper.hpp&quot;
 #include&quot;ThreadRunner.hpp&quot;
 #include&quot;Preferences.hpp&quot;
 #include&lt;Wm3Vector3.h&gt;
@@ -173,10 +174,8 @@
 
 void Omega::scanPlugins()
 {
-// #define STUPID_DLL
 //	ClassFactory::instance().unloadAll();
 
-	// TODO: remove all comments of the form /*DLL ... */, they comment the old code that whould not be needed any more
 
 	vector&lt;string&gt;::iterator dldi    = preferences-&gt;dynlibDirectories.begin();
 	vector&lt;string&gt;::iterator dldiEnd = preferences-&gt;dynlibDirectories.end();
@@ -184,9 +183,6 @@
 		ClassFactory::instance().addBaseDirectory((*dldi));
 			
 	vector&lt;string&gt; dynlibsList;
-	#ifdef STUPID_DLL
-		vector&lt; int &gt;    dynlibsListLoaded;
-	#endif
 
 	vector&lt;string&gt;::iterator si = preferences-&gt;dynlibDirectories.begin();
 	vector&lt;string&gt;::iterator siEnd = preferences-&gt;dynlibDirectories.end();
@@ -223,9 +219,6 @@
 					if(dynlibsList.size()==0 || ClassFactory::instance().systemNameToLibName(name.leaf())!=dynlibsList.back()) {
 						LOG_DEBUG(&quot;Added plugin: &quot;&lt;&lt;*si&lt;&lt;&quot;/&quot;&lt;&lt;di-&gt;leaf()&lt;&lt;&quot;.&quot;);
 						dynlibsList.push_back(ClassFactory::instance().systemNameToLibName(name.leaf()));
-						#ifdef STUPID_DLL
-							dynlibsListLoaded.push_back(false);
-						#endif
 					}
 					else LOG_DEBUG(&quot;Possible plugin discarded: &quot;&lt;&lt;*si&lt;&lt;&quot;/&quot;&lt;&lt;name.leaf()&lt;&lt;&quot;.&quot;);
 				} else LOG_DEBUG(&quot;File not considered a plugin: &quot;&lt;&lt;di-&gt;leaf()&lt;&lt;&quot;.&quot;);
@@ -236,31 +229,12 @@
 
 	bool allLoaded = false;
 	vector&lt;string&gt; dynlibsClassList; // dynlibsList holds filenames, this holds classes defined inside (may be different if using yadePuginClasses)
-	#ifdef STUPID_DLL
-		int overflow = 30; // to prevent infinite loop
-		assert(dynlibsList.size() == dynlibsListLoaded.size());
-		while (!allLoaded &amp;&amp; --overflow &gt; 0){
-		int loaded = 0;
-	#endif
 		vector&lt; string &gt;::iterator dlli    = dynlibsList.begin();
 		vector&lt; string &gt;::iterator dlliEnd = dynlibsList.end();
 		allLoaded = true;
-		for( ; dlli!=dlliEnd ; ++dlli
-		#ifdef STUPID_DLL
-		, ++loaded
-		#endif
-		)
-		{
-			#ifdef STUPID_DLL
-			if( dynlibsListLoaded[loaded] == false ) {
-				LOG_DEBUG(&quot;Trying to load plugin &quot;&lt;&lt;*dlli&lt;&lt;&quot; (no.&quot;&lt;&lt;loaded&lt;&lt;&quot;; overflow=&quot;&lt;&lt;overflow&lt;&lt;&quot;)&quot;);
-			#endif
+		for( ; dlli!=dlliEnd ; ++dlli ) {
 			bool thisLoaded = ClassFactory::instance().load((*dlli));
-			if (!thisLoaded
-				#ifdef STUPID_DLL
-				&amp;&amp; overflow == 1
-				#endif
-				){
+			if (!thisLoaded){
 				string err=ClassFactory::instance().lastError();
 				// HACK
 				if(err.find(&quot;cannot open shared object file: No such file or directory&quot;)!=std::string::npos){
@@ -277,27 +251,17 @@
 				}
 				else LOG_ERROR(&quot;Error loading Library `&quot;&lt;&lt;(*dlli)&lt;&lt;&quot;': &quot;&lt;&lt;err&lt;&lt;&quot; .&quot;); // leave space to not to confuse c++filt
 			}
-			#ifdef STUPID_DLL
-			else if (!thisLoaded) { LOG_DEBUG(&quot;Plugin &quot;&lt;&lt;*dlli&lt;&lt;&quot; not loaded successfully this time: &quot;&lt;&lt;ClassFactory::instance().lastError()&lt;&lt;&quot; (will retry).&quot;); }
-			#endif
 			else { // no error
 				if (ClassFactory::instance().lastPluginClasses().size()==0){ // regular plugin, one class per file
 					dynlibsClassList.push_back(*dlli);
-					LOG_DEBUG(&quot;Plugin &quot;&lt;&lt;*dlli&lt;&lt;&quot; loaded succesfully.&quot;);
+					LOG_DEBUG(&quot;Plugin &quot;&lt;&lt;*dlli&lt;&lt;&quot;: loaded default class &quot;&lt;&lt;*dlli&lt;&lt;&quot;.&quot;);
 				} else {// if plugin defines yadePluginClasses (has multiple classes), insert these into dynLibsList
 					vector&lt;string&gt; css=ClassFactory::instance().lastPluginClasses();
-					for(size_t i=0; i&lt;css.size();i++) { dynlibsClassList.push_back(css[i]); LOG_DEBUG(&quot;Plugin &quot;&lt;&lt;*dlli&lt;&lt;&quot;: added class &quot;&lt;&lt;css[i]&lt;&lt;&quot;.&quot;);  }
+					for(size_t i=0; i&lt;css.size();i++) { dynlibsClassList.push_back(css[i]); LOG_DEBUG(&quot;Plugin &quot;&lt;&lt;*dlli&lt;&lt;&quot;: loaded explicit class &quot;&lt;&lt;css[i]&lt;&lt;&quot;.&quot;);  }
 				}
 			}
 			allLoaded &amp;= thisLoaded;
-			#ifdef STUPID_DLL
-				if(thisLoaded) dynlibsListLoaded[loaded] = true; }
-			#endif
 		}
-	#ifdef STUPID_DLL
-	}
-	#endif
-
 	if(!allLoaded) LOG_WARN(&quot;Couldn't load everything, some stuff may work incorrectly.&quot;);
 	
 	buildDynlibDatabase(dynlibsClassList);
@@ -424,6 +388,17 @@
 	rootBody-&gt;setTimeSteppersActive(!s);
 }
 
+
+bool Omega::timeStepperActive(){
+	if(!rootBody) return false;
+	for(vector&lt;shared_ptr&lt;Engine&gt; &gt;::iterator I=rootBody-&gt;engines.begin(); I!=rootBody-&gt;engines.end(); ++I){
+		if (isInheritingFrom((*I)-&gt;getClassName(),&quot;TimeStepper&quot;)){
+			return static_pointer_cast&lt;TimeStepper&gt;(*I)-&gt;active;
+		}
+	}
+	return false;
+}
+
 //FIXME : make that recursive to scan all submetabodies ???
 bool Omega::containTimeStepper()
 {

Modified: trunk/core/Omega.hpp
===================================================================
--- trunk/core/Omega.hpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/core/Omega.hpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -109,6 +109,7 @@
 		void		setTimeStep(const Real);
 		Real		getTimeStep();
 		void		skipTimeStepper(bool s);
+		bool 		timeStepperActive();
 		bool		containTimeStepper();
 
 		const		shared_ptr&lt;MetaBody&gt;&amp; getRootBody();

Added: trunk/extra/Brefcom.cpp
===================================================================
--- trunk/extra/Brefcom.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/extra/Brefcom.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -0,0 +1,232 @@
+// 2008 &#169; V&#225;clav &#352;milauer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">eudoxos at arcig.cz</A>&gt; 
+#include&quot;Brefcom.hpp&quot;
+#include&lt;yade/core/MetaBody.hpp&gt;
+#include&lt;yade/pkg-dem/BodyMacroParameters.hpp&gt;
+
+
+YADE_PLUGIN(&quot;BrefcomMakeContact&quot;,&quot;BrefcomContact&quot;,&quot;BrefcomLaw&quot;);
+
+/********************** BrefcomMakeContact ****************************/
+CREATE_LOGGER(BrefcomMakeContact);
+
+
+//! @todo Formulas in the following should be verified
+void BrefcomMakeContact::go(const shared_ptr&lt;PhysicalParameters&gt;&amp; pp1, const shared_ptr&lt;PhysicalParameters&gt;&amp; pp2, const shared_ptr&lt;Interaction&gt;&amp; interaction){
+
+	const shared_ptr&lt;SpheresContactGeometry&gt;&amp; contGeom=dynamic_pointer_cast&lt;SpheresContactGeometry&gt;(interaction-&gt;interactionGeometry);
+	assert(contGeom); // for now, don't handle anything other than SpheresContactGeometry
+
+	if(!interaction-&gt;isNew &amp;&amp; interaction-&gt;interactionPhysics){
+		const shared_ptr&lt;BrefcomContact&gt; contPhys=dynamic_pointer_cast&lt;BrefcomContact&gt;(interaction-&gt;interactionPhysics);
+		assert(contPhys);
+		contPhys-&gt;prevNormal=contGeom-&gt;normal;
+	} else {
+		interaction-&gt;isNew; // just in case
+		//TRACE;
+
+		const shared_ptr&lt;BodyMacroParameters&gt;&amp; elast1=static_pointer_cast&lt;BodyMacroParameters&gt;(pp1);
+		const shared_ptr&lt;BodyMacroParameters&gt;&amp; elast2=static_pointer_cast&lt;BodyMacroParameters&gt;(pp2);
+
+		shared_ptr&lt;BrefcomContact&gt; contPhys(new BrefcomContact());
+		interaction-&gt;interactionPhysics=contPhys;
+
+
+		Real E12=2*elast1-&gt;young*elast2-&gt;young/(elast1-&gt;young+elast2-&gt;young); // harmonic Young's modulus average
+		Real nu12=2*elast1-&gt;poisson*elast2-&gt;poisson/(elast1-&gt;poisson+elast2-&gt;poisson); // dtto for Poisson ratio 
+		Real S12=Mathr::PI*pow(min(contGeom-&gt;radius1,contGeom-&gt;radius2),2); // &quot;surface&quot; of interaction
+
+		contPhys-&gt;omegaPl=0;
+		/* let's try initial distance for d0; that should prevent packings with inner stresses from exploding */
+		//contPhys-&gt;d0=contGeom-&gt;radius1 + contGeom-&gt;radius2; // equilibrium distace is &quot;just touching&quot;
+		contPhys-&gt;d0=(elast1-&gt;se3.position-elast2-&gt;se3.position).Length(); // equilibrium distance is now
+		contPhys-&gt;Kn=(E12*S12/contPhys-&gt;d0)*( (1+alpha)/(beta*(1+nu12) + gamma*(1-alpha*nu12)));
+		contPhys-&gt;Ks=contPhys-&gt;Kn*(1-alpha*nu12)/(1+nu12);
+		contPhys-&gt;zeta=zeta; // TODO: calculate zeta from Gf
+		contPhys-&gt;frictionAngle=.5*(elast1-&gt;frictionAngle+elast2-&gt;frictionAngle);
+		contPhys-&gt;FnMax=S12*sigmaT;
+		contPhys-&gt;cohesion=S12*sigmaC;
+		contPhys-&gt;prevNormal=contGeom-&gt;normal;
+		contPhys-&gt;Fs=Vector3r::ZERO;
+
+		// HACK: after beginning all links will be without cohesion (omegaPl=1) !!!
+		if(Omega::instance().getCurrentIteration()&gt;50) contPhys-&gt;omegaPl=1;
+		// OTOH, structural contacts will have this flag
+		else contPhys-&gt;isStructural=true;
+	}
+}
+
+
+
+
+/********************** BrefcomContact ****************************/
+CREATE_LOGGER(BrefcomContact);
+
+
+
+/********************** BrefcomLaw ****************************/
+CREATE_LOGGER(BrefcomLaw);
+
+void BrefcomLaw::calculateNormalForce(){
+	Real d=(rbp1-&gt;se3.position - rbp2-&gt;se3.position).Length();
+	//TRVAR2(d,BC-&gt;dBreak);
+	if(d &gt; BC-&gt;dBreak){
+		BC-&gt;omegaPl=1; /* LOG_DEBUG(&quot;Complete damage for #&quot;&lt;&lt;id1&lt;&lt;&quot;+#&quot;&lt;&lt;id2); */
+		Fn=Vector3r::ZERO; return; }
+	Fn = (d - BC-&gt;d0_curr) * BC-&gt;Kn * contGeom-&gt;normal;
+	//TRVAR4(d,BC-&gt;d0_curr,Fn.Length(),BC-&gt;FnMax_curr);
+
+	BREFREC(d);
+	BREFREC(BC-&gt;d0_curr);
+
+	#if 0
+		if(d&gt;BC-&gt;dPeak_curr){ /* on the softening branch of the diagram */
+			force+=(BC-&gt;dBreak - d)*(BC-&gt;Kn / BC-&gt;zeta) * contGeom-&gt;normal;
+			BC-&gt;omegaPl=(d - BC-&gt;dPeak)/(BC-&gt;dBreak - BC-&gt;dPeak);
+		} else { /* on the elastic branch */
+			force+=(d - BC-&gt;d0_curr)* BC-&gt;Kn * contGeom-&gt;normal;
+		}
+	#endif
+}
+
+void BrefcomLaw::calculateShearForce(){
+	Fs=Vector3r::ZERO; return;
+	
+	Fs = BC-&gt;Fs;
+	Real dt=Omega::instance().getTimeStep();
+	// rotation of the contact normal
+	Fs -= BC-&gt;Fs.Cross( BC-&gt;prevNormal.Cross(contGeom-&gt;normal) );
+	//TRVAR1(BC-&gt;Fs.Cross( BC-&gt;prevNormal.Cross(contGeom-&gt;normal)));
+	// mutual rotation of elements
+	Real angle=dt*.5*contGeom-&gt;normal.Dot(rbp1-&gt;angularVelocity+rbp2-&gt;angularVelocity);
+	Fs -= BC-&gt;Fs.Cross(angle*contGeom-&gt;normal);
+	//TRVAR1(BC-&gt;Fs.Cross(angle*contGeom-&gt;normal));
+	// element slip
+	Vector3r relVelocity=
+		rbp2-&gt;velocity+rbp2-&gt;angularVelocity.Cross(contGeom-&gt;contactPoint-rbp2-&gt;se3.position)-
+		rbp1-&gt;velocity+rbp1-&gt;angularVelocity.Cross(contGeom-&gt;contactPoint-rbp1-&gt;se3.position);
+	Vector3r shearDisplacement=dt*(relVelocity-contGeom-&gt;normal.Dot(relVelocity)*contGeom-&gt;normal);
+	Fs -= BC-&gt;Ks*shearDisplacement;
+	//TRVAR1(BC-&gt;Ks*shearDisplacement);
+	if(isnan(Fs[0]) || isnan(Fs[1]) || isnan(Fs[2])){
+		TRVAR4(BC-&gt;Fs, BC-&gt;prevNormal, contGeom-&gt;normal, BC-&gt;Fs.Cross(BC-&gt;prevNormal.Cross(contGeom-&gt;normal)));
+		TRVAR4(angle, rbp1-&gt;angularVelocity, rbp2-&gt;angularVelocity,BC-&gt;Fs.Cross(angle*contGeom-&gt;normal));
+		TRVAR4(rbp1-&gt;se3.position, rbp2-&gt;se3.position,rbp1-&gt;velocity,rbp2-&gt;velocity);
+		TRVAR4(relVelocity,shearDisplacement,BC-&gt;Ks,BC-&gt;Ks*shearDisplacement);
+		exit(0);
+	}
+}
+
+void BrefcomLaw::rotationEffects(){
+	/* TODO */
+	/* is in ElasticCohesiveLaw under if(momentRotationLaw) { &#8230; }, but that code is messy;
+	 * should be rewritten using some article */
+}
+
+void BrefcomLaw::envelopeAndDamage(void){
+
+	/* Fn and Fs envelope is:
+		Fn &lt; FnMax_curr
+		Fs &lt; cohesion_curr - Fn*tan(frictionAngle);
+
+		If any of these conditions is violated, decrement forces keeping their ratio and incement damage.
+	*/
+	Real fn=Fn.Dot(contGeom-&gt;normal) /* sign does matter here */, fs=Fs.Length() /* sign irrelevant */;
+	if(fn&gt;Mathr::EPSILON &amp;&amp; fn &gt; BC-&gt;FnMax_curr){
+		/* return force on the softening branch */
+		Real dmgFactor=max(1.,(BC-&gt;FnMax_curr - (fn - BC-&gt;FnMax_curr)/BC-&gt;zeta) / fn);
+		//if(isnan(dmgFactor)){TRVAR3(fn,Fn,contGeom-&gt;normal); exit(0);}
+		//TRVAR4(fn,BC-&gt;FnMax_curr,dmgFactor,BC-&gt;omegaPl);
+		Fn*=dmgFactor; fn*=dmgFactor;
+		BC-&gt;omegaPl=1-fn/BC-&gt;FnMax; // FnMax_curr will be updated from omegaPl at the next iteration
+		// LOG_DEBUG(&quot;Increasing damage to &quot;&lt;&lt;BC-&gt;omegaPl);
+		if(Omega::instance().getCurrentIteration()%100 &amp;&amp; BC-&gt;omegaPl&gt;=1) { Real d=(rbp1-&gt;se3.position - rbp2-&gt;se3.position).Length(); TRVAR4(rbp1-&gt;se3.position,rbp2-&gt;se3.position,d,fn);  }
+		if(isnan(Fn[0]) || isnan(Fn[1]) || isnan(Fn[2])){ TRVAR4(Fn,fn,dmgFactor,BC-&gt;omegaPl);	exit(0); }
+	}
+	//TRVAR2(fs,BC-&gt;cohesion_curr - fn*tan(BC-&gt;frictionAngle));
+	if(fs &gt; BC-&gt;cohesion_curr - fn*tan(BC-&gt;frictionAngle)){
+		Real FsMax_curr=BC-&gt;cohesion_curr - fn*tan(BC-&gt;frictionAngle);
+		Fs.Normalize();
+		Fs*=FsMax_curr;
+		#if 0
+			Real FsMax_undamaged=BC-&gt;cohesion - fn*tan(BC-&gt;frictionAngle);
+			Fs*=(FsMax_curr/fs);
+			BC-&gt;omegaPl=1-FsMax_curr/FsMax_undamaged;
+			TRVAR5(fs,BC-&gt;cohesion_curr,FsMax_curr,FsMax_curr/fs,BC-&gt;omegaPl);
+		#endif
+		#if 0 // FIXME: not tested!!!
+			/* decrease both forces, keep their proportion; tricky */
+			Real fnEnvelope=BC-&gt;cohesion_curr/((fn/fs)+tan(BC-&gt;frictionAngle)); // normal force on the envelope, with the same Fn/Fs proportion
+			dmgFactor=(fnEnvelope-(fn-fnEnvelope)/BC-&gt;zeta)/fn; // factor by which decrease Fn
+			TRVAR2(fn,fs);
+			TRVAR5(BC-&gt;cohesion_curr,BC-&gt;frictionAngle,dmgFactor,fnEnvelope,BC-&gt;omegaPl);
+			Fn*=dmgFactor; fn*=dmgFactor;
+			Fs*=dmgFactor;
+			BC-&gt;omegaPl*=(1-fn/fnEnvelope); // increase damage
+		#endif
+	}
+	BREFREC(BC-&gt;omegaPl);
+	BREFREC(Fn.Length());
+	BREFREC(Fs.Length());
+}
+
+void BrefcomLaw::applyForces(){
+	BC-&gt;Fs=Fs; BC-&gt;Fn=Fn; // remember forces
+	Vector3r force=Fn+Fs;
+
+	static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(id1,ForceClassIndex))-&gt;force-=force;
+	static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(id2,ForceClassIndex))-&gt;force+=force;
+	static_pointer_cast&lt;Momentum&gt;(rootBody-&gt;physicalActions-&gt;find(id1,MomentumClassIndex))-&gt;momentum-=
+		(contGeom-&gt;contactPoint - rbp1-&gt;se3.position).Cross(force);
+	static_pointer_cast&lt;Momentum&gt;(rootBody-&gt;physicalActions-&gt;find(id2,MomentumClassIndex))-&gt;momentum+=
+		(contGeom-&gt;contactPoint - rbp2-&gt;se3.position).Cross(force);
+}
+
+void BrefcomLaw::action(Body* body){
+	rootBody=YADE_CAST&lt;MetaBody*&gt;(body);
+	for(InteractionContainer::iterator I=rootBody-&gt;transientInteractions-&gt;begin(); I!=rootBody-&gt;transientInteractions-&gt;end(); ++I){
+		if(!(*I)-&gt;isReal) continue;
+		//TRACE;
+		// initialize temporaries
+		id1=(*I)-&gt;getId1(); id2=(*I)-&gt;getId2();
+		body1=Body::byId(id1); body2=Body::byId(id2);
+		assert(body1); assert(body2);
+		BC=YADE_PTR_CAST&lt;BrefcomContact&gt;((*I)-&gt;interactionPhysics);
+		contGeom=YADE_PTR_CAST&lt;SpheresContactGeometry&gt;((*I)-&gt;interactionGeometry);
+		rbp1=YADE_PTR_CAST&lt;RigidBodyParameters&gt;(body1-&gt;physicalParameters);
+		rbp2=YADE_PTR_CAST&lt;RigidBodyParameters&gt;(body2-&gt;physicalParameters);
+		assert(BC); assert(contGeom); assert(rbp1); assert(rbp2);
+
+		// don't disregard links with omegaPl=1, they can still be compressed !!
+		// if(BC-&gt;omegaPl &gt;= 1) continue; // we want to keep broken links formally alive, for statistics of material damage
+		
+		recValues.clear(); recLabels.clear();
+		BREFREC(id1);
+		BREFREC(id2);
+		BREFREC2(rbp1-&gt;se3.position[0],&quot;x1&quot;);
+		BREFREC2(rbp1-&gt;se3.position[1],&quot;y1&quot;);
+		BREFREC2(rbp1-&gt;se3.position[2],&quot;z1&quot;);
+		BREFREC2(rbp2-&gt;se3.position[0],&quot;x2&quot;);
+		BREFREC2(rbp2-&gt;se3.position[1],&quot;y2&quot;);
+		BREFREC2(rbp2-&gt;se3.position[2],&quot;z2&quot;);
+
+		BC-&gt;deduceOtherParams(); // initialize non-fundamental params/variables
+		//TRVAR5(BC-&gt;d0,BC-&gt;Kn,BC-&gt;Ks,BC-&gt;zeta,BC-&gt;FnMax);
+		//TRVAR5(BC-&gt;omegaPl,BC-&gt;dBreak,BC-&gt;dPeak,BC-&gt;d0_curr,BC-&gt;dPeak_curr);
+
+		calculateNormalForce();
+		calculateShearForce();
+		// rotationEffects();
+
+		envelopeAndDamage();
+	
+		/* see above: we keep even broken links there */
+		//if(BC-&gt;omegaPl&gt;=1) { (*I)-&gt;isReal=false; return; } // if total damage, cancel interaction; collider will delete it properly
+
+		applyForces();
+
+		for(size_t i=0; i&lt;recValues.size(); i++) recStream&lt;&lt;recLabels[i]&lt;&lt;&quot;: &quot;&lt;&lt;recValues[i]&lt;&lt;&quot; &quot;;
+		recStream&lt;&lt;endl;
+	}
+}
+
+

Added: trunk/extra/Brefcom.hpp
===================================================================
--- trunk/extra/Brefcom.hpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/extra/Brefcom.hpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -0,0 +1,158 @@
+// 2008 &#169; V&#225;clav &#352;milauer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">eudoxos at arcig.cz</A>&gt; 
+#pragma once
+#include&lt;yade/extra/Shop.hpp&gt;
+
+#include&lt;yade/core/InteractionSolver.hpp&gt;
+#include&lt;yade/core/FileGenerator.hpp&gt;
+#include&lt;yade/pkg-common/RigidBodyParameters.hpp&gt;
+#include&lt;yade/pkg-common/Force.hpp&gt;
+#include&lt;yade/pkg-common/Momentum.hpp&gt;
+#include&lt;yade/pkg-common/InteractionPhysicsEngineUnit.hpp&gt;
+#include&lt;yade/pkg-dem/SpheresContactGeometry.hpp&gt;
+
+/*! @brief Convert macroscopic properties to BrefcomContact with corresponding parameters.
+ *
+ * Most of the model is taken from MacroMicroElasticRelationships.
+ *
+ * @todo alpha, beta, gamma constants should be set to better values that Laurent presented in Nantes.
+ *
+ * */
+class BrefcomMakeContact: public InteractionPhysicsEngineUnit{
+	private:
+	public:
+		/* &quot;constants&quot; for macro-micro */
+		Real alpha, beta, gamma;
+		/* nonelastic material parameters */
+		/* alternatively (and more cleanly), we would have subclass of ElasticBodyParameters,
+		 * which would define just those in addition to the elastic ones.
+		 * This might be done later, for now hardcode that here. Note that sigmaC and Gf are not used at all now. */
+		/* uniaxial traction resistance, uniaxial compression resistance, fracture energy, elastic/softening modulus ratio */
+		Real sigmaT, sigmaC, Gf, zeta;
+
+		BrefcomMakeContact(){ alpha=2.5; beta=2.0; gamma=2.65; sigmaT=3e6, sigmaC=30e6; Gf=1e5; zeta=10; }
+		virtual void go(const shared_ptr&lt;PhysicalParameters&gt;&amp; pp1, const shared_ptr&lt;PhysicalParameters&gt;&amp; pp2, const shared_ptr&lt;Interaction&gt;&amp; interaction);
+		virtual void registerAttributes(){
+			InteractionPhysicsEngineUnit::registerAttributes();
+			REGISTER_ATTRIBUTE(alpha);
+			REGISTER_ATTRIBUTE(beta);
+			REGISTER_ATTRIBUTE(gamma);
+			REGISTER_ATTRIBUTE(sigmaT);
+			REGISTER_ATTRIBUTE(sigmaC);
+			REGISTER_ATTRIBUTE(Gf);
+			REGISTER_ATTRIBUTE(zeta);
+		}
+		REGISTER_CLASS_NAME(BrefcomMakeContact);
+		REGISTER_BASE_CLASS_NAME(InteractionPhysicsEngineUnit);
+		DECLARE_LOGGER;
+};
+REGISTER_SERIALIZABLE(BrefcomMakeContact,false);
+
+/*! @brief representation of a single interaction of the brefcom type: storage for relevant parameters.
+ *
+ * Evolution of the contact is governed by BrefcomLaw:
+ * that includes damage effects and chages of parameters inside BrefcomContact.
+ *
+ * @todo Ks is currently unused, but it is calculated from Kn in BrefcomMakeContact using nu12 and alpha;
+ * 	if Kn changes due to damage, how do we adjust Ks? BrefcomMakeContact could do that at every iter? Messy?
+ *
+ * @todo frictionAngle is currently unused
+ */
+class BrefcomContact: public InteractionPhysics {
+	private:
+	public:
+		/*! Fundamental parameters (constants) */
+		Real d0, Kn, Ks, zeta, frictionAngle, FnMax, cohesion;
+		/*! Fundamental state variables */
+		Real omegaPl;
+		Vector3r prevNormal, Fs; // shear force is cummulative, this must be remembered
+		Vector3r Fn; // remembers last normal force, used by stiffness counter
+		bool isStructural; // whether this is &quot;neighbour&quot; or just &quot;meeting&quot; contact
+		/* calculated by deduceOtherParams (called at every iteration); first two are constants as well, other two depend on damage. */
+		Real dPeak, dBreak, d0_curr, dPeak_curr, cohesion_curr, FnMax_curr;
+		void deduceOtherParams(void){
+			dBreak=d0+(FnMax/Kn)*(1+zeta);
+			dPeak=d0+(FnMax/Kn);
+			d0_curr=d0+omegaPl*(dBreak-d0);
+			dPeak_curr=dPeak+omegaPl*(dBreak-dPeak);
+			FnMax_curr=FnMax*(1-omegaPl);
+			cohesion_curr=cohesion*(1-omegaPl);
+			// if(Omega::instance().getCurrentIteration()%100==0 &amp;&amp; omegaPl&gt;=1){ TRVAR4(d0,omegaPl,d0_curr,FnMax_curr); }
+		} 
+
+		BrefcomContact(): InteractionPhysics(){ /* just in case someone forgets */ Fs=Vector3r::ZERO; Fn=Vector3r::ZERO; omegaPl=0; isStructural=false; }
+
+		void registerAttributes(){
+			InteractionPhysics::registerAttributes();
+			REGISTER_ATTRIBUTE(d0);
+			REGISTER_ATTRIBUTE(Kn);
+			REGISTER_ATTRIBUTE(Ks);
+			REGISTER_ATTRIBUTE(zeta);
+			REGISTER_ATTRIBUTE(frictionAngle);
+			REGISTER_ATTRIBUTE(FnMax);
+			REGISTER_ATTRIBUTE(omegaPl);
+			REGISTER_ATTRIBUTE(prevNormal);
+			REGISTER_ATTRIBUTE(Fs);
+			REGISTER_ATTRIBUTE(isStructural);
+			/*REGISTER_ATTRIBUTE(dPeak);
+			REGISTER_ATTRIBUTE(dBreak);
+			REGISTER_ATTRIBUTE(d0_curr);
+			REGISTER_ATTRIBUTE(dPeak_curr);*/
+		};
+
+	REGISTER_CLASS_NAME(BrefcomContact);
+	REGISTER_BASE_CLASS_NAME(InteractionPhysics);
+	DECLARE_LOGGER;
+};
+REGISTER_SERIALIZABLE(BrefcomContact,false);
+
+#define BREFREC(a) {recValues.push_back(a); recLabels.push_back(#a);}
+#define BREFREC2(a,b) {recValues.push_back(a); recLabels.push_back(b);}
+class BrefcomLaw: public InteractionSolver{
+	private:
+		// cache class indices to avoid lookup at every iteration
+		int MomentumClassIndex, ForceClassIndex; // if possible make it &quot;const int&quot; and move init to initializers
+		//! apply effects of normal displacements
+		void calculateNormalForce();
+		//! apply effects of shearing
+		void calculateShearForce();
+		//! apply effects of mutual particle rotation
+		void rotationEffects();
+		//! adjust forces so that they are not outside resistance envelope and update damage parameter if necessary
+		void envelopeAndDamage();
+		//! plly calculated force on particles
+		void applyForces();
+		/* storage variables, to avoid passing them around on the stack */
+		Vector3r Fs, Fn;
+		/* temporaries initialized in the loop over interactions; above methods use these. */
+		body_id_t id1, id2;
+		shared_ptr&lt;Body&gt; body1, body2;
+		shared_ptr&lt;BrefcomContact&gt; BC;
+		shared_ptr&lt;SpheresContactGeometry&gt; contGeom;
+		shared_ptr&lt;RigidBodyParameters&gt; rbp1, rbp2;
+		MetaBody* rootBody;
+		// recording  values
+		ofstream recStream;
+		vector&lt;Real&gt; recValues;
+		vector&lt;string&gt; recLabels;
+	public:
+		BrefcomLaw() {
+			/* cache indices for Force and Momentum */
+			ForceClassIndex=shared_ptr&lt;PhysicalAction&gt;(new Force())-&gt;getClassIndex();
+			MomentumClassIndex=shared_ptr&lt;PhysicalAction&gt;(new Momentum())-&gt;getClassIndex();
+			TRVAR2(ForceClassIndex,MomentumClassIndex);
+		};
+		void action(Body* body);
+	protected: 
+		void registerAttributes(){InteractionSolver::registerAttributes();};
+		void postProcessAttributes(bool deserializing){ if(deserializing) recStream.open(&quot;/tmp/breflaw.data&quot;); }
+
+	REGISTER_CLASS_NAME(BrefcomLaw);
+	REGISTER_BASE_CLASS_NAME(InteractionSolver);
+	DECLARE_LOGGER;
+};
+
+REGISTER_SERIALIZABLE(BrefcomLaw,false);
+
+ 
+
+

Added: trunk/extra/BrefcomTestGen.cpp
===================================================================
--- trunk/extra/BrefcomTestGen.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/extra/BrefcomTestGen.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -0,0 +1,147 @@
+// 2008 &#169; V&#225;clav &#352;milauer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">eudoxos at arcig.cz</A>&gt; 
+#include&quot;BrefcomTestGen.hpp&quot;
+#include&lt;yade/core/MetaBody.hpp&gt;
+#include&lt;yade/pkg-dem/BodyMacroParameters.hpp&gt;
+
+YADE_PLUGIN(&quot;BrefcomTestGen&quot;);
+
+
+/************************ BrefcomTestGen ****************************/
+/*#include&lt;yade/pkg-common/MetaInteractingGeometry2AABB.hpp&gt;
+#include&lt;yade/pkg-common/MetaInteractingGeometry.hpp&gt;
+#include&lt;yade/pkg-common/Box.hpp&gt;
+#include&lt;yade/pkg-common/Sphere.hpp&gt;
+#include&lt;yade/pkg-common/PersistentSAPCollider.hpp&gt;
+
+#include&lt;yade/pkg-common/BodyRedirectionVector.hpp&gt;
+#include&lt;yade/pkg-common/InteractionVecSet.hpp&gt;
+#include&lt;yade/pkg-common/PhysicalActionVectorVector.hpp&gt;
+
+#include&lt;yade/pkg-common/InteractingBox.hpp&gt;
+
+#include&lt;yade/pkg-common/InteractingBox2AABB.hpp&gt;
+#include&lt;yade/pkg-common/Momentum.hpp&gt;
+#include&lt;yade/pkg-common/Force.hpp&gt;
+#include&lt;yade/pkg-dem/InteractingSphere2InteractingSphere4SpheresContactGeometry.hpp&gt;
+#include&lt;yade/pkg-dem/InteractingBox2InteractingSphere4SpheresContactGeometry.hpp&gt;*/
+
+
+#include&lt;yade/pkg-common/PhysicalActionContainerReseter.hpp&gt;
+#include&lt;yade/pkg-common/PhysicalActionContainerInitializer.hpp&gt;
+#include&lt;yade/pkg-common/InteractingSphere.hpp&gt;
+#include&lt;yade/pkg-common/BoundingVolumeMetaEngine.hpp&gt;
+#include&lt;yade/pkg-common/AABB.hpp&gt;
+#include&lt;yade/pkg-common/InteractingSphere2AABB.hpp&gt;
+#include&lt;yade/pkg-common/MetaInteractingGeometry.hpp&gt;
+#include&lt;yade/pkg-common/MetaInteractingGeometry2AABB.hpp&gt;
+#include&lt;yade/pkg-common/InteractionGeometryMetaEngine.hpp&gt;
+#include&lt;yade/pkg-common/InteractionPhysicsMetaEngine.hpp&gt;
+#include&lt;yade/pkg-dem/InteractingSphere2InteractingSphere4DistantSpheresContactGeometry.hpp&gt;
+#include&lt;yade/pkg-common/PhysicalActionApplier.hpp&gt;
+#include&lt;yade/pkg-common/PhysicalParametersMetaEngine.hpp&gt;
+#include&lt;yade/pkg-common/NewtonsForceLaw.hpp&gt;
+#include&lt;yade/pkg-common/NewtonsMomentumLaw.hpp&gt;
+#include&lt;yade/pkg-common/LeapFrogPositionIntegrator.hpp&gt;
+#include&lt;yade/pkg-common/LeapFrogOrientationIntegrator.hpp&gt;
+#include&lt;yade/pkg-common/PersistentSAPCollider.hpp&gt;
+#include&lt;yade/extra/UniaxialStrainControlledTest.hpp&gt;
+
+/*
+
+#include&lt;yade/pkg-common/PhysicalActionDamper.hpp&gt;
+#include&lt;yade/pkg-common/CundallNonViscousForceDamping.hpp&gt;
+#include&lt;yade/pkg-common/CundallNonViscousMomentumDamping.hpp&gt;
+#include&lt;yade/pkg-common/GravityEngine.hpp&gt;
+
+#include&lt;yade/pkg-dem/BodyMacroParameters.hpp&gt;
+#include&lt;yade/pkg-dem/ElasticCriterionTimeStepper.hpp&gt;
+#include&lt;yade/pkg-dem/ElasticContactLaw.hpp&gt;
+#include&lt;yade/pkg-dem/ElasticCohesiveLaw.hpp&gt;
+
+#include&lt;yade/pkg-dem/SpheresContactGeometry.hpp&gt;
+#include&lt;yade/pkg-dem/ElasticContactInteraction.hpp&gt;
+#include&lt;yade/pkg-dem/SDECLinkGeometry.hpp&gt;
+#include&lt;yade/pkg-dem/SDECLinkPhysics.hpp&gt;
+
+*/
+
+CREATE_LOGGER(BrefcomTestGen);
+
+void BrefcomTestGen::createEngines(){
+	rootBody-&gt;initializers.clear();
+
+	shared_ptr&lt;PhysicalActionContainerInitializer&gt; physicalActionInitializer(new PhysicalActionContainerInitializer);
+	physicalActionInitializer-&gt;physicalActionNames.push_back(&quot;Force&quot;);
+	physicalActionInitializer-&gt;physicalActionNames.push_back(&quot;Momentum&quot;);
+	rootBody-&gt;initializers.push_back(physicalActionInitializer);
+	
+	shared_ptr&lt;BoundingVolumeMetaEngine&gt; boundingVolumeDispatcher	= shared_ptr&lt;BoundingVolumeMetaEngine&gt;(new BoundingVolumeMetaEngine);
+	boundingVolumeDispatcher-&gt;DISPATCHER_ADD3(InteractingSphere,AABB,InteractingSphere2AABB);
+	boundingVolumeDispatcher-&gt;DISPATCHER_ADD3(MetaInteractingGeometry,AABB,MetaInteractingGeometry2AABB);
+	rootBody-&gt;initializers.push_back(boundingVolumeDispatcher);
+
+	rootBody-&gt;engines.clear();
+
+	rootBody-&gt;engines.push_back(shared_ptr&lt;Engine&gt;(new PhysicalActionContainerReseter));
+	rootBody-&gt;engines.push_back(boundingVolumeDispatcher);
+
+	shared_ptr&lt;PersistentSAPCollider&gt; collider(new PersistentSAPCollider);
+	collider-&gt;haveDistantTransient=true;
+	rootBody-&gt;engines.push_back(collider);
+
+	shared_ptr&lt;InteractionGeometryMetaEngine&gt; igeomDispatcher(new InteractionGeometryMetaEngine);
+	igeomDispatcher-&gt;DISPATCHER_ADD3(InteractingSphere,InteractingSphere,InteractingSphere2InteractingSphere4DistantSpheresContactGeometry);
+	rootBody-&gt;engines.push_back(igeomDispatcher);
+
+	shared_ptr&lt;InteractionPhysicsMetaEngine&gt; iphysDispatcher(new InteractionPhysicsMetaEngine);
+	iphysDispatcher-&gt;DISPATCHER_ADD3(BodyMacroParameters,BodyMacroParameters,BrefcomMakeContact);
+	rootBody-&gt;engines.push_back(iphysDispatcher);
+
+	shared_ptr&lt;BrefcomLaw&gt; bLaw(new BrefcomLaw);
+	rootBody-&gt;engines.push_back(bLaw);
+
+	shared_ptr&lt;PhysicalActionApplier&gt; applyActionDispatcher(new PhysicalActionApplier);
+	applyActionDispatcher-&gt;DISPATCHER_ADD3(Force,ParticleParameters,NewtonsForceLaw);
+	applyActionDispatcher-&gt;DISPATCHER_ADD3(Momentum,RigidBodyParameters,NewtonsMomentumLaw);
+	rootBody-&gt;engines.push_back(applyActionDispatcher);
+	
+	shared_ptr&lt;PhysicalParametersMetaEngine&gt; positionIntegrator(new PhysicalParametersMetaEngine);
+	positionIntegrator-&gt;DISPATCHER_ADD2(ParticleParameters,LeapFrogPositionIntegrator);
+	rootBody-&gt;engines.push_back(positionIntegrator);
+
+	shared_ptr&lt;PhysicalParametersMetaEngine&gt; orientationIntegrator(new PhysicalParametersMetaEngine);
+	orientationIntegrator-&gt;DISPATCHER_ADD2(RigidBodyParameters,LeapFrogOrientationIntegrator);
+	rootBody-&gt;engines.push_back(orientationIntegrator);
+}
+
+bool BrefcomTestGen::generate(){
+	message=&quot;&quot;;
+	rootBody=Shop::rootBody();
+
+	/* We don't use collider and orientation integrator for now!&#160;*/
+	createEngines();
+
+	shared_ptr&lt;UniaxialStrainer&gt; strainer(new UniaxialStrainer);
+	strainer-&gt;strainRate=strainRate;
+	strainer-&gt;axis=2; // z-oriented straining
+	strainer-&gt;limitStrain=-4;
+	rootBody-&gt;engines.push_back(strainer);
+	
+	// control normal/shear ratio
+	//Real zCoord=.1; Real yCoord=sqrt(1-zCoord*zCoord); // distance is always 2, with contact at origin
+	Real zCoord=1, yCoord=.2;
+	shared_ptr&lt;Body&gt; s1=Shop::sphere(Vector3r(0,-yCoord,-zCoord),1), s2=Shop::sphere(Vector3r(0,yCoord,zCoord),1);
+	body_id_t id1=rootBody-&gt;bodies-&gt;insert(s1), id2=rootBody-&gt;bodies-&gt;insert(s2);
+	
+	//  engines should take care of the rest of interaction; this is what collider would do normally
+	/*
+	rootBody-&gt;transientInteractions-&gt;insert(id1,id2);
+	rootBody-&gt;transientInteractions-&gt;find(id1,id2)-&gt;isReal=1;
+	rootBody-&gt;transientInteractions-&gt;find(id1,id2)-&gt;isNew=1;
+	*/
+
+	strainer-&gt;negIds.push_back(id1); strainer-&gt;negCoords.push_back(-1);
+	strainer-&gt;posIds.push_back(id2); strainer-&gt;posCoords.push_back(1);
+
+	return true;
+}

Added: trunk/extra/BrefcomTestGen.hpp
===================================================================
--- trunk/extra/BrefcomTestGen.hpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/extra/BrefcomTestGen.hpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -0,0 +1,22 @@
+#pragma once
+#include&lt;yade/extra/Shop.hpp&gt;
+#include&lt;yade/core/FileGenerator.hpp&gt;
+#include&lt;yade/extra/Brefcom.hpp&gt;
+
+class BrefcomTestGen: public FileGenerator {
+	private:
+		void createEngines();
+	public:
+		Real strainRate;
+		BrefcomTestGen(){strainRate=1e-2;};
+		bool generate();
+	protected :
+		void registerAttributes(){
+			FileGenerator::registerAttributes();
+			REGISTER_ATTRIBUTE(strainRate);
+		}
+	REGISTER_CLASS_NAME(BrefcomTestGen);
+	REGISTER_BASE_CLASS_NAME(FileGenerator);
+	DECLARE_LOGGER;
+};
+REGISTER_SERIALIZABLE(BrefcomTestGen,false);

Modified: trunk/extra/SConscript
===================================================================
--- trunk/extra/SConscript	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/extra/SConscript	2008-02-04 10:36:31 UTC (rev 1242)
@@ -46,7 +46,12 @@
 	
 	env.SharedLibrary('TetraTestGen',['tetra/TetraTestGen.cpp'],LIBS=env['LIBS']+['Shop','Tetra']),
 
+	env.SharedLibrary('UniaxialStrainControlledTest',['usct/UniaxialStrainControlledTest.cpp'],LIBS=env['LIBS']+['Shop','GlobalStiffnessTimeStepper','GlobalStiffnessCounter']),
 
+	env.SharedLibrary('Brefcom',['Brefcom.cpp'],LIBS=env['LIBS']+['Shop','InteractingSphere2InteractingSphere4DistantSpheresContactGeometry']),
+
+	env.SharedLibrary('BrefcomTestGen',['BrefcomTestGen.cpp'],LIBS=env['LIBS']+['Shop','UniaxialStrainControlledTest']),
+
 	env.SharedLibrary('Shop',
 		['clump/Shop.cpp'],
 		LIBS=env['LIBS']+[
@@ -93,7 +98,12 @@
 			'Force',
 			'InteractingSphere2InteractingSphere4SpheresContactGeometry',
 			#'Clump',
-			'yade-multimethods']),
+			'yade-multimethods',
+			'SpheresContactGeometry',
+			'ElasticContactInteraction',
+			'SDECLinkGeometry',
+			'SDECLinkPhysics',
+			]),
 
 ])
 

Modified: trunk/extra/clump/Clump.cpp
===================================================================
--- trunk/extra/clump/Clump.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/extra/clump/Clump.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -3,12 +3,7 @@
 #include&quot;Clump.hpp&quot;
 #include&lt;algorithm&gt;
 
-const char* yadePluginClasses[]={
-	&quot;Clump&quot;,
-	&quot;ClumpMemberMover&quot;,
-	&quot;ClumpTestGen&quot;,
-	NULL /*sentinel*/
-};
+YADE_PLUGIN(&quot;Clump&quot;,&quot;ClumpMemberMover&quot;,&quot;ClumpTestGen&quot;);
 
 CREATE_LOGGER(Clump);
 CREATE_LOGGER(ClumpMemberMover);

Modified: trunk/extra/clump/PythonRecorder.cpp
===================================================================
--- trunk/extra/clump/PythonRecorder.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/extra/clump/PythonRecorder.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -82,3 +82,4 @@
 
 
 
+YADE_PLUGIN();
\ No newline at end of file

Modified: trunk/extra/clump/Shop.cpp
===================================================================
--- trunk/extra/clump/Shop.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/extra/clump/Shop.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -1,6 +1,8 @@
 // 2007 &#169; V&#225;clav &#352;milauer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">eudoxos at arcig.cz</A>&gt;
 #include&quot;Shop.hpp&quot;
 
+#include&lt;boost/filesystem/convenience.hpp&gt;
+
 #include&lt;yade/core/MetaBody.hpp&gt;
 #include&lt;yade/core/Body.hpp&gt;
 
@@ -54,6 +56,12 @@
 #include&lt;yade/pkg-dem/ElasticContactLaw.hpp&gt;
 #include&lt;yade/pkg-dem/ElasticCohesiveLaw.hpp&gt;
 
+#include&lt;yade/pkg-dem/SpheresContactGeometry.hpp&gt;
+#include&lt;yade/pkg-dem/ElasticContactInteraction.hpp&gt;
+#include&lt;yade/pkg-dem/SDECLinkGeometry.hpp&gt;
+#include&lt;yade/pkg-dem/SDECLinkPhysics.hpp&gt;
+
+
 #if 0
 #ifdef EMBED_PYTHON
 	#include&lt;yade/extra/PythonRecorder.hpp&gt;
@@ -382,3 +390,109 @@
 
 		return body;
 }
+
+
+void Shop::saveSpheresToFile(string fname){
+	const shared_ptr&lt;MetaBody&gt;&amp; rootBody=Omega::instance().getRootBody();
+	ofstream f(fname.c_str());
+	if(!f.good()) throw runtime_error(&quot;Unable to open file `&quot;+fname+&quot;'&quot;);
+
+	for(BodyContainer::iterator I=rootBody-&gt;bodies-&gt;begin(); I!=rootBody-&gt;bodies-&gt;end(); ++I){
+		const shared_ptr&lt;Body&gt;&amp; b=*I;
+		if (!b-&gt;isDynamic) continue;
+		shared_ptr&lt;InteractingSphere&gt;	intSph=dynamic_pointer_cast&lt;InteractingSphere&gt;(b-&gt;interactingGeometry);
+		if(!intSph) continue;
+		const Vector3r&amp; pos=b-&gt;physicalParameters-&gt;se3.position;
+		f&lt;&lt;pos[0]&lt;&lt;&quot; &quot;&lt;&lt;pos[1]&lt;&lt;&quot; &quot;&lt;&lt;pos[2]&lt;&lt;&quot; &quot;&lt;&lt;intSph-&gt;radius&lt;&lt;&quot; &quot;&lt;&lt;1&lt;&lt;&quot; &quot;&lt;&lt;1&lt;&lt;endl;
+	}
+	f.close();
+}
+
+vector&lt;pair&lt;Vector3r,Real&gt; &gt; Shop::loadSpheresFromFile(string fname, Vector3r&amp; minXYZ, Vector3r&amp; maxXYZ){
+	if(!boost::filesystem::exists(fname)) {
+		throw std::runtime_error(string(&quot;File with spheres `&quot;)+fname+&quot;' doesn't exist.&quot;);
+	}
+	vector&lt;pair&lt;Vector3r,Real&gt; &gt; spheres;
+	ifstream sphereFile(fname.c_str());
+	if(!sphereFile.good()) throw std::runtime_error(&quot;File with spheres `&quot;+fname+&quot;' couldn't be opened.&quot;);
+	int tmp1,tmp2;
+	Vector3r C;
+	Real r;
+	while(!sphereFile.eof()){
+		sphereFile&gt;&gt;C[0]; sphereFile&gt;&gt;C[1]; sphereFile&gt;&gt;C[2];
+		sphereFile&gt;&gt;r;
+		// TRVAR3(spheres.size(),C,r);
+		sphereFile&gt;&gt;tmp1;
+		if(r==1) continue; // arrrgh, boxes have 5 record/line, spheres have 6; 4th number for box is 1 and we assume there is no sphere with radius 1; Wenjie, I'm gonna tell you one day how smart this format is.
+		if(sphereFile.eof()) continue; // prevents trailing newlines from copying last sphere as well
+		sphereFile&gt;&gt;tmp2; // read the 6th (unused) number for spheres
+		for(int j=0; j&lt;3; j++) { minXYZ[j]=(spheres.size()&gt;0?min(C[j]-r,minXYZ[j]):C[j]-r); maxXYZ[j]=(spheres.size()&gt;0?max(C[j]+r,maxXYZ[j]):C[j]+r);}
+		spheres.push_back(pair&lt;Vector3r,Real&gt;(C,r));
+	}
+	TRVAR2(minXYZ,maxXYZ);
+	return spheres;
+}
+
+
+/* Create permanent link between partcles that have transient link now, return number of created permalinks.
+ *
+ * Needs valid Omega instance. Stiffness parameters are copied from the transientInteraction. Order of forceId1 and forceId2 is irrelevant.
+ *
+ * @param cohesionMask mask that must hold for _both_ Bodies in interaction, unless it is zero and is ignored.
+ * @param linkOk is function expression: bool linkOK(body_id_t,body_id_t) will tell us, whether link between two particular bodies should be created. Defaults to true (always create).
+ **/
+int Shop::createCohesion(Real limitNormalForce, Real limitShearForce, int cohesionMask, boost::function&lt;bool(body_id_t,body_id_t)&gt; linkOK){
+	int numNewLinks=0;
+	shared_ptr&lt;MetaBody&gt; rb=YADE_PTR_CAST&lt;MetaBody&gt;(Omega::instance().getRootBody());
+	vector&lt;pair&lt;body_id_t,body_id_t&gt; &gt; toBeDeleted;
+
+	// loop over transient interactions
+	for(InteractionContainer::iterator I=rb-&gt;transientInteractions-&gt;begin(); I!=rb-&gt;transientInteractions-&gt;end(); ++I){
+		const shared_ptr&lt;Interaction&gt;&amp; contact=*I;
+		if (!contact-&gt;isReal) continue; // only overlapping AABBs, not body contact
+		int id1=contact-&gt;getId1(), id2=contact-&gt;getId2();
+		LOG_DEBUG(&quot;Considering linking #&quot;&lt;&lt;id1&lt;&lt;&quot; + #&quot;&lt;&lt;id2&lt;&lt;&quot;...&quot;);
+
+		if (!linkOK(id1,id2)) {LOG_DEBUG(&quot;Disallowed by linkOK.&quot;); continue; }// user didn't want to link these
+
+		const shared_ptr&lt;Body&gt;&amp; b1=Body::byId(id1), b2=Body::byId(id2);
+		if (!(cohesionMask==0 || (b1-&gt;getGroupMask() &amp; cohesionMask) &amp;&amp; (b2-&gt;getGroupMask() &amp; cohesionMask))) {LOG_DEBUG(&quot;Mask mismatch.&quot;); continue; }// if mask is valid for both bodies or is zero, go ahead
+		// if we have sphere without interacting sphere, it is (most likely) a bug anyway -- no need to dynamic-cast in non-debug builds
+		shared_ptr&lt;SpheresContactGeometry&gt; contGeom=dynamic_pointer_cast&lt;SpheresContactGeometry&gt;(contact-&gt;interactionGeometry);
+		shared_ptr&lt;ElasticContactInteraction&gt; contPhys=dynamic_pointer_cast&lt;ElasticContactInteraction&gt;(contact-&gt;interactionPhysics);
+		shared_ptr&lt;InteractingSphere&gt;	intSph1=dynamic_pointer_cast&lt;InteractingSphere&gt;(b1-&gt;interactingGeometry);
+		shared_ptr&lt;InteractingSphere&gt;	intSph2=dynamic_pointer_cast&lt;InteractingSphere&gt;(b2-&gt;interactingGeometry);
+
+		if(!(contGeom &amp;&amp; contPhys &amp;&amp; intSph1 &amp;&amp; intSph2)) { LOG_DEBUG(&quot;Non-spherical elemnt(s) or inelastic contact.&quot;); continue;}
+
+		// replace this transient contact by permanent contact
+		// we don't need to delete the transient one since collider will (should) do it in the next loop.
+		toBeDeleted.push_back(pair&lt;body_id_t,body_id_t&gt;(id1,id2));
+
+		shared_ptr&lt;Interaction&gt; link(new Interaction(id1,id2));
+		shared_ptr&lt;SDECLinkGeometry&gt; linkGeom(new SDECLinkGeometry);
+		shared_ptr&lt;SDECLinkPhysics&gt; linkPhys(new SDECLinkPhysics);
+
+		linkGeom-&gt;radius1=intSph1-&gt;radius-.5*abs(intSph1-&gt;radius-intSph2-&gt;radius);
+		linkGeom-&gt;radius2=intSph2-&gt;radius-.5*abs(intSph1-&gt;radius-intSph2-&gt;radius);
+		linkGeom-&gt;normal=contGeom-&gt;normal;
+		link-&gt;interactionGeometry=linkGeom;
+
+		linkPhys-&gt;initialKn=contPhys-&gt;kn; linkPhys-&gt;initialKs=contPhys-&gt;ks;
+		linkPhys-&gt;initialEquilibriumDistance=intSph1-&gt;radius+intSph2-&gt;radius;
+		linkPhys-&gt;kn=linkPhys-&gt;initialKn; linkPhys-&gt;ks=linkPhys-&gt;initialKs; linkPhys-&gt;equilibriumDistance=linkPhys-&gt;initialEquilibriumDistance;
+		linkPhys-&gt;heta=1;
+		linkPhys-&gt;knMax=contPhys-&gt;normalForce.Length()*10000; // limitNormalForce;
+		linkPhys-&gt;ksMax=contPhys-&gt;normalForce.Length()*10000; // limitShearForce;
+		link-&gt;interactionPhysics=linkPhys;
+
+		link-&gt;isReal=true;
+		link-&gt;isNew=true; // only true if linkPhys doesn't exist; but we've just created it ourselves
+		rb-&gt;persistentInteractions-&gt;insert(link);
+		numNewLinks++;
+		LOG_DEBUG(&quot;LINKED #&quot;&lt;&lt;id1&lt;&lt;&quot; + #&quot;&lt;&lt;id2&lt;&lt;&quot;! (knMax=&quot;&lt;&lt;linkPhys-&gt;knMax&lt;&lt;&quot;, ksMax=&quot;&lt;&lt;linkPhys-&gt;ksMax&lt;&lt;&quot;)&quot;);
+	}
+	// TODO: warn user if CohesiveElasticLaw is not active
+
+	return numNewLinks;
+}

Modified: trunk/extra/clump/Shop.hpp
===================================================================
--- trunk/extra/clump/Shop.hpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/extra/clump/Shop.hpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -1,17 +1,23 @@
 // 2007 &#169; V&#225;clav &#352;milauer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">eudoxos at arcig.cz</A>&gt;
 
+#pragma once
+
 #include&lt;string&gt;
 #include&lt;map&gt;
 #include&lt;iostream&gt;
 #include&lt;typeinfo&gt;
 #include&lt;boost/any.hpp&gt;
 #include&lt;boost/shared_ptr.hpp&gt;
+#include&lt;boost/lambda/lambda.hpp&gt;
 
 #include&lt;Wm3Vector3.h&gt;
 #include&lt;Wm3Quaternion.h&gt;
 #include&lt;yade/lib-base/yadeWm3.hpp&gt;
 #include&lt;yade/lib-base/Logging.hpp&gt;
+#include&lt;yade/core/Body.hpp&gt;
 
+#include&lt;boost/function.hpp&gt;
+
 /*
 #include&lt;yade/core/MetaBody.hpp&gt;
 #include&lt;yade/core/Body.hpp&gt;
@@ -48,5 +54,12 @@
 		static shared_ptr&lt;Body&gt; sphere(Vector3r center, Real radius);
 		static shared_ptr&lt;Body&gt; box(Vector3r center, Vector3r extents);
 		static shared_ptr&lt;Body&gt; tetra(Vector3r v[4]);
+
+		static vector&lt;pair&lt;Vector3r,Real&gt; &gt; loadSpheresFromFile(string fname,Vector3r&amp; minXYZ, Vector3r&amp; maxXYZ);
+		static void saveSpheresToFile(string fileName);
+
+		// (true || boost::lambda::_1) means that true is the default
+		static int createCohesion(Real limitNormalForce, Real limitShearForce, int groupMask=0,
+			boost::function&lt;bool(body_id_t,body_id_t)&gt; linkOK = (true || boost::lambda::_1) );
 };
 

Modified: trunk/extra/screw/ScrewGen.cpp
===================================================================
--- trunk/extra/screw/ScrewGen.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/extra/screw/ScrewGen.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -2,10 +2,7 @@
 #include&lt;yade/extra/Clump.hpp&gt;
 #include&lt;yade/extra/Shop.hpp&gt;
 
-const char* yadePluginClasses[]={
-	&quot;ScrewGen&quot;,
-	NULL /*sentinel*/
-};
+YADE_PLUGIN(&quot;ScrewGen&quot;);
 
 CREATE_LOGGER(ScrewGen);
 

Modified: trunk/extra/tetra/Tetra.cpp
===================================================================
--- trunk/extra/tetra/Tetra.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/extra/tetra/Tetra.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -2,18 +2,8 @@
 
 #include&quot;Tetra.hpp&quot;
 
-const char* yadePluginClasses[]={
-	// self-contained in hpp:
-	&quot;TetraMold&quot;,
-	&quot;TetraBang&quot;, 
-	&quot;Tetrahedron2TetraMold&quot;,
-	&quot;TetraAABB&quot;, 
-	// some code in cpp (this file):
-	&quot;TetraLaw&quot;,	 
-	&quot;Tetra2TetraBang&quot;,
-	&quot;TetraDraw&quot;,
-	NULL /*sentinel*/
-};
+YADE_PLUGIN(/* self-contained in hpp: */ &quot;TetraMold&quot;, &quot;TetraBang&quot;, &quot;Tetrahedron2TetraMold&quot;,&quot;TetraAABB&quot;, 
+	/* some code in cpp (this file): */ &quot;TetraLaw&quot;,	 &quot;Tetra2TetraBang&quot;,&quot;TetraDraw&quot;);
 
 #include&lt;boost/shared_ptr.hpp&gt;
 
@@ -390,6 +380,8 @@
 
 	for(InteractionContainer::iterator contactI=rootBody-&gt;transientInteractions-&gt;begin(); contactI!=rootBody-&gt;transientInteractions-&gt;end(); ++contactI){
 		if (!(*contactI)-&gt;isReal) continue; // Tetra2TetraBang::go returned false for this interaction, skip it
+		const shared_ptr&lt;TetraBang&gt;&amp; contactGeom(dynamic_pointer_cast&lt;TetraBang&gt;((*contactI)-&gt;interactionGeometry));
+		if(!contactGeom) continue;
 
 		const body_id_t idA=(*contactI)-&gt;getId1(), idB=(*contactI)-&gt;getId2();
 		const shared_ptr&lt;Body&gt;&amp; A=Body::byId(idA), B=Body::byId(idB);
@@ -399,8 +391,6 @@
 		const shared_ptr&lt;ElasticBodyParameters&gt;&amp; physA(dynamic_pointer_cast&lt;ElasticBodyParameters&gt;(A-&gt;physicalParameters));
 		const shared_ptr&lt;ElasticBodyParameters&gt;&amp; physB(dynamic_pointer_cast&lt;ElasticBodyParameters&gt;(B-&gt;physicalParameters));
 		
-		const shared_ptr&lt;TetraBang&gt;&amp; contactGeom(dynamic_pointer_cast&lt;TetraBang&gt;((*contactI)-&gt;interactionGeometry));
-		if(!contactGeom) {LOG_TRACE(&quot;interactionGeoemtry is not a TetraBang&quot;); continue;}
 		//const shared_ptr&lt;SimpleElasticInteraction&gt;&amp; contactPhys(dynamic_pointer_cast&lt;SimpleElasticInteraction*&gt;((*contactI)-&gt;interactionPhysics));
 
 

Modified: trunk/extra/tetra/TetraTestGen.cpp
===================================================================
--- trunk/extra/tetra/TetraTestGen.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/extra/tetra/TetraTestGen.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -6,10 +6,7 @@
 
 #include&quot;Tetra.hpp&quot;
 
-const char* yadePluginClasses[]={
-        &quot;TetraTestGen&quot;,
-        NULL /*sentinel*/
-};
+YADE_PLUGIN(&quot;TetraTestGen&quot;);
 
 bool TetraTestGen::generate()
 {

Added: trunk/extra/usct/UniaxialStrainControlledTest.cpp
===================================================================
--- trunk/extra/usct/UniaxialStrainControlledTest.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/extra/usct/UniaxialStrainControlledTest.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -0,0 +1,277 @@
+// 2008 &#169; V&#225;clav &#352;milauer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">eudoxos at arcig.cz</A>&gt; 
+#include&quot;UniaxialStrainControlledTest.hpp&quot;
+#include&lt;yade/pkg-common/Force.hpp&gt;
+#include&lt;yade/pkg-common/InteractingSphere.hpp&gt;
+#include&lt;yade/pkg-dem/SDECLinkGeometry.hpp&gt;
+#include&lt;yade/pkg-dem/SDECLinkPhysics.hpp&gt;
+#include&lt;yade/extra/Brefcom.hpp&gt;
+YADE_PLUGIN(&quot;USCTGen&quot;,&quot;UniaxialStrainer&quot;);
+
+
+/************************ UniaxialStrainer **********************/
+CREATE_LOGGER(UniaxialStrainer);
+
+void UniaxialStrainer::applyCondition(Body* _rootBody){
+	if(posIds.size()==0 || negIds.size()==0) return;
+	assert(posIds.size()==posCoords.size() &amp;&amp; negIds.size()==negCoords.size());
+
+	if(originalLength&lt;0) {
+		originalLength=USCT_AXIS_COORD(posIds[0])-USCT_AXIS_COORD(negIds[0]);
+		LOG_DEBUG(&quot;Reference particles: positive #&quot;&lt;&lt;posIds[0]&lt;&lt;&quot; at &quot;&lt;&lt;USCT_AXIS_COORD(posIds[0])&lt;&lt;
+			&quot;; negative #&quot;&lt;&lt;negIds[0]&lt;&lt;&quot; at &quot;&lt;&lt;USCT_AXIS_COORD(negIds[0]));
+		LOG_INFO(&quot;Setting initial length to &quot;&lt;&lt;originalLength);
+	}
+	// linearly increase strain to the desired value
+	if(abs(currentStrainRate)&lt;abs(strainRate))currentStrainRate+=strainRate*.01; else currentStrainRate=strainRate;
+
+	Real dAX=.5*currentStrainRate*originalLength*Omega::instance().getTimeStep();
+	for(size_t i=0; i&lt;negIds.size(); i++){
+		//TRVAR1(USCT_AXIS_COORD(negIds[i]));
+		negCoords[i]-=dAX;
+		USCT_AXIS_COORD(negIds[i])=negCoords[i]; // update current position
+		negCoords[i]-=dAX; //USCT_AXIS_COORD(negIds[i]); // store current position
+		//if(strain&lt;-0.000155 &amp;&amp; i==0) LOG_DEBUG(&quot;Moved #&quot;&lt;&lt;negIds[i]&lt;&lt;&quot; by &quot;&lt;&lt;-dAX&lt;&lt;&quot; to &quot;&lt;&lt;negCoords[i]);
+	}
+	for(size_t i=0; i&lt;posIds.size(); i++){
+		posCoords[i]+=dAX;
+		USCT_AXIS_COORD(posIds[i])=posCoords[i];
+		//if(strain&lt;-0.000155 &amp;&amp; i==0) LOG_DEBUG(&quot;Moved #&quot;&lt;&lt;posIds[i]&lt;&lt;&quot; by &quot;&lt;&lt;dAX&lt;&lt;&quot; to &quot;&lt;&lt;posCoords[i]);
+	}
+
+	Real axialLength=USCT_AXIS_COORD(posIds[0])-USCT_AXIS_COORD(negIds[0]);
+	Real strain=axialLength/originalLength-1;
+	if(Omega::instance().getCurrentIteration()%400==0) TRVAR5(dAX,axialLength,originalLength,currentStrainRate,strain);
+	// reverse if we're over the limit strain
+	// if(notYetReversed &amp;&amp; limitStrain!=0 &amp;&amp; ((currentStrainRate&gt;0 &amp;&amp; strain&gt;limitStrain) || (currentStrainRate&lt;0 &amp;&amp; strain&lt;limitStrain))) { currentStrainRate*=-1; notYetReversed=false; LOG_INFO(&quot;Reversed strain rate to &quot;&lt;&lt;currentStrainRate); }
+	MetaBody* rootBody=static_cast&lt;MetaBody*&gt;(_rootBody);
+	if(Omega::instance().getCurrentIteration()%40==0 &amp;&amp; recStream.good()) {
+		computeAxialForce(rootBody);
+		recStream&lt;&lt;Omega::instance().getCurrentIteration()&lt;&lt;&quot; &quot;&lt;&lt;strain&lt;&lt;&quot; &quot;&lt;&lt;sumPosForces&lt;&lt;&quot; &quot;&lt;&lt;sumNegForces&lt;&lt;&quot; &quot;&lt;&lt;negCoords[0]&lt;&lt;&quot; &quot;&lt;&lt;posCoords[0]&lt;&lt;endl;
+	}
+}
+
+bool UniaxialStrainer::idInVector(body_id_t id, const vector&lt;body_id_t&gt;&amp; V){
+	for(size_t i=0; i&lt;V.size(); i++){ if(V[i]==id) return true; }
+	return false;
+}
+
+void UniaxialStrainer::computeAxialForce(MetaBody* rootBody){
+	sumPosForces=0; sumNegForces=0;
+	#if 0
+		for(InteractionContainer::iterator I=rootBody-&gt;transientInteractions-&gt;begin(); I!=rootBody-&gt;transientInteractions-&gt;end(); ++I){
+			if(!(*I)-&gt;isReal) { continue; }
+			const shared_ptr&lt;BrefcomContact&gt;&amp; BC=dynamic_pointer_cast&lt;BrefcomContact&gt;((*I)-&gt;interactionPhysics);
+			//const shared_ptr&lt;SpheresContactGeometry&gt;&amp; SCG=dynamic_pointer_cast&lt;SpheresContactGeometry&gt;((*I)-&gt;interactionGeometry);
+			if(/* (!SCG)&#160;|| */ (!BC) || (!BC-&gt;isStructural)) { continue; }
+			body_id_t id1=(*I)-&gt;getId1(), id2=(*I)-&gt;getId2(), id;
+
+			/* following: if (id1 || id2) &#8712; (posIds||negIds): add axis.Dot(contact-&gt;Fs+contact-&gt;Fn) to (sumPosForces||sumNegForces) */
+			bool pos1=idInVector(id1,posIds), pos2=idInVector(id2,posIds), neg1=idInVector(id1,negIds), neg2=idInVector(id2,negIds);
+			if(!(pos1&amp;&amp;pos2)) id = pos1 ? id1 : (pos2 ? id2 : Body::ID_NONE);
+			if(id!=Body::ID_NONE){
+				Vector3r ax=Vector3r::ZERO; ax[axis]=-1;
+				sumPosForces+=(id==id1?1:-1)*BC-&gt;Fn.Dot(ax); // sumPosForces+=ax.Dot(BC-&gt;Fs+BC-&gt;Fn); /* TRVAR1(ax.Dot(BC-&gt;Fs+BC-&gt;Fn)); */
+			}
+			if(!(neg1&amp;&amp;neg2)) id = neg1 ? id1 : (neg2 ? id2 : Body::ID_NONE);
+			if(id!=Body::ID_NONE){
+				Vector3r ax=Vector3r::ZERO; ax[axis]=1;
+				sumNegForces+=(id==id1?1:-1)*BC-&gt;Fn.Dot(ax); //sumNegForces+=ax.Dot(BC-&gt;Fs+BC-&gt;Fn); /* TRVAR1(ax.Dot(BC-&gt;Fs+BC-&gt;Fn)); */
+			}
+		}
+	#else
+		shared_ptr&lt;Force&gt; f(new Force);
+		for(size_t i=0; i&lt;negIds.size(); i++){
+			sumNegForces-=static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(negIds[i],f-&gt;getClassIndex()))-&gt;force[axis];
+		}
+		for(size_t i=0; i&lt;posIds.size(); i++){
+			sumPosForces+=static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(posIds[i],f-&gt;getClassIndex()))-&gt;force[axis];
+		}
+	#endif
+	//TRVAR2(sumPosForces,sumNegForces);
+}
+
+/***************************************** USCTGen **************************/
+CREATE_LOGGER(USCTGen);
+
+bool USCTGen::generate(){
+	message=&quot;&quot;;
+	rootBody=Shop::rootBody();
+	//Shop::rootBodyActors(rootBody);
+	createEngines();
+	shared_ptr&lt;UniaxialStrainer&gt; strainer(new UniaxialStrainer);
+	rootBody-&gt;engines.push_back(strainer); // updating params later
+	strainer-&gt;strainRate=strainRate;
+	strainer-&gt;axis=axis;
+	strainer-&gt;limitStrain=limitStrain;
+	
+	// load spheres
+	Vector3r minXYZ,maxXYZ;
+	typedef vector&lt;pair&lt;Vector3r,Real&gt; &gt; vecVecReal;
+	vecVecReal spheres=Shop::loadSpheresFromFile(spheresFile,minXYZ,maxXYZ);
+	TRVAR2(minXYZ,maxXYZ);
+	// get spheres that are &quot;close enough&quot; to the strained ends
+	for(vecVecReal::iterator I=spheres.begin(); I!=spheres.end(); I++){
+		Vector3r C=I-&gt;first;
+		Real r=I-&gt;second;
+		shared_ptr&lt;Body&gt; S=Shop::sphere(C,r);
+		body_id_t sId=rootBody-&gt;bodies-&gt;insert(S);
+		Real distFactor=1.2;
+		if (C[axis]-distFactor*r&lt;minXYZ[axis]) {
+			strainer-&gt;negIds.push_back(sId);
+			strainer-&gt;negCoords.push_back(C[axis]);
+			LOG_DEBUG(&quot;NEG inserted #&quot;&lt;&lt;sId&lt;&lt;&quot; with C[axis]=&quot;&lt;&lt;C[axis]);
+		}
+		if (C[axis]+distFactor*r&gt;maxXYZ[axis]) {
+			strainer-&gt;posIds.push_back(sId);
+			strainer-&gt;posCoords.push_back(C[axis]);
+			LOG_DEBUG(&quot;POS inserted #&quot;&lt;&lt;sId&lt;&lt;&quot; with C[axis]=&quot;&lt;&lt;C[axis]);
+		}
+	}
+#if 0
+	// create links between spheres
+	Real distFactor=1.2;
+	for(BodyContainer::iterator I1=rootBody-&gt;bodies-&gt;begin(); I1!=rootBody-&gt;bodies-&gt;end(); ++I1){
+		for(BodyContainer::iterator I2=rootBody-&gt;bodies-&gt;begin(); I2!=rootBody-&gt;bodies-&gt;end(); ++I2){
+			Vector3r C1=(*I1)-&gt;physicalParameters-&gt;se3.position, C2=(*I2)-&gt;physicalParameters-&gt;se3.position;
+			const shared_ptr&lt;InteractingSphere&gt;&amp; is1=dynamic_pointer_cast&lt;InteractingSphere&gt;((*I1)-&gt;interactingGeometry), is2=dynamic_pointer_cast&lt;InteractingSphere&gt;((*I2)-&gt;interactingGeometry);
+			assert(is1 &amp;&amp; is2);
+			Real r1=is1-&gt;radius, r2=is2-&gt;radius;
+			if((C2-C1).Length()&lt;(r1+r2)*distFactor){
+					shared_ptr&lt;Interaction&gt; link(new Interaction((*I1)-&gt;getId(),(*I2)-&gt;getId()));
+					shared_ptr&lt;SDECLinkGeometry&gt; geom(new SDECLinkGeometry);
+					shared_ptr&lt;SDECLinkPhysics&gt; phys(new SDECLinkPhysics);
+					geom-&gt;radius1=r1-.5*abs(r1-r2); geom-&gt;radius2=r2-.5*abs(r1-r2);
+					link-&gt;interactionGeometry=geom;
+
+					phys-&gt;initialKn=50000000; phys-&gt;knMax=550000000;
+					phys-&gt;initialKs=5000000; phys-&gt;ksMax=550000000;
+					phys-&gt;heta=1;
+					phys-&gt;initialEquilibriumDistance=(C1-C2).Length();
+					link-&gt;interactionPhysics=phys;
+
+					link-&gt;isReal=true; link-&gt;isNew=false;
+					rootBody-&gt;persistentInteractions-&gt;insert(link);
+					//LOG_DEBUG(&quot;Linked #&quot;&lt;&lt;(*I1)-&gt;getId()&lt;&lt;&quot; and #&quot;&lt;&lt;(*I2)-&gt;getId()&lt;&lt;&quot;.&quot;);
+			}
+		}
+	}
+	// remove collider
+	for(vector&lt;shared_ptr&lt;Engine&gt; &gt;::iterator I=rootBody-&gt;engines.begin(); I!=rootBody-&gt;engines.end(); ++I){
+		if((*I)-&gt;getClassName()==&quot;PersistentSAPCollider&quot;) {
+			rootBody-&gt;engines.erase(I);
+			LOG_DEBUG(&quot;Removed PersistentSAPCollider engine.&quot;);
+			break;
+		}
+	}
+#endif
+	return true;
+}
+
+#include&lt;yade/extra/Brefcom.hpp&gt;
+
+#include&lt;yade/pkg-common/RigidBodyParameters.hpp&gt;
+#include&lt;yade/pkg-common/Force.hpp&gt;
+#include&lt;yade/pkg-common/Momentum.hpp&gt;
+#include&lt;yade/pkg-common/InteractionPhysicsEngineUnit.hpp&gt;
+#include&lt;yade/pkg-dem/SpheresContactGeometry.hpp&gt;
+#include&lt;yade/core/MetaBody.hpp&gt;
+#include&lt;yade/pkg-dem/BodyMacroParameters.hpp&gt;
+#include&lt;yade/pkg-common/PhysicalActionContainerReseter.hpp&gt;
+#include&lt;yade/pkg-common/PhysicalActionContainerInitializer.hpp&gt;
+#include&lt;yade/pkg-common/InteractingSphere.hpp&gt;
+#include&lt;yade/pkg-common/BoundingVolumeMetaEngine.hpp&gt;
+#include&lt;yade/pkg-common/AABB.hpp&gt;
+#include&lt;yade/pkg-common/InteractingSphere2AABB.hpp&gt;
+#include&lt;yade/pkg-common/MetaInteractingGeometry.hpp&gt;
+#include&lt;yade/pkg-common/MetaInteractingGeometry2AABB.hpp&gt;
+#include&lt;yade/pkg-common/InteractionGeometryMetaEngine.hpp&gt;
+#include&lt;yade/pkg-common/InteractionPhysicsMetaEngine.hpp&gt;
+#include&lt;yade/pkg-dem/InteractingSphere2InteractingSphere4DistantSpheresContactGeometry.hpp&gt;
+#include&lt;yade/pkg-common/PhysicalActionApplier.hpp&gt;
+#include&lt;yade/pkg-common/PhysicalParametersMetaEngine.hpp&gt;
+#include&lt;yade/pkg-common/NewtonsForceLaw.hpp&gt;
+#include&lt;yade/pkg-common/NewtonsMomentumLaw.hpp&gt;
+#include&lt;yade/pkg-common/LeapFrogPositionIntegrator.hpp&gt;
+#include&lt;yade/pkg-common/LeapFrogOrientationIntegrator.hpp&gt;
+#include&lt;yade/pkg-common/PersistentSAPCollider.hpp&gt;
+#include&lt;yade/pkg-dem/GlobalStiffnessCounter.hpp&gt;
+#include&lt;yade/pkg-dem/GlobalStiffnessTimeStepper.hpp&gt;
+#include&lt;yade/pkg-common/PhysicalActionDamper.hpp&gt;
+#include&lt;yade/pkg-common/CundallNonViscousForceDamping.hpp&gt;
+#include&lt;yade/pkg-common/CundallNonViscousMomentumDamping.hpp&gt;
+
+
+
+void USCTGen::createEngines(){
+	rootBody-&gt;initializers.clear();
+
+	shared_ptr&lt;PhysicalActionContainerInitializer&gt; physicalActionInitializer(new PhysicalActionContainerInitializer);
+	physicalActionInitializer-&gt;physicalActionNames.push_back(&quot;Force&quot;);
+	physicalActionInitializer-&gt;physicalActionNames.push_back(&quot;Momentum&quot;);
+	physicalActionInitializer-&gt;physicalActionNames.push_back(&quot;GlobalStiffness&quot;);
+	rootBody-&gt;initializers.push_back(physicalActionInitializer);
+	
+	shared_ptr&lt;BoundingVolumeMetaEngine&gt; boundingVolumeDispatcher	= shared_ptr&lt;BoundingVolumeMetaEngine&gt;(new BoundingVolumeMetaEngine);
+	boundingVolumeDispatcher-&gt;DISPATCHER_ADD3(InteractingSphere,AABB,InteractingSphere2AABB);
+	boundingVolumeDispatcher-&gt;DISPATCHER_ADD3(MetaInteractingGeometry,AABB,MetaInteractingGeometry2AABB);
+	rootBody-&gt;initializers.push_back(boundingVolumeDispatcher);
+
+	rootBody-&gt;engines.clear();
+
+	rootBody-&gt;engines.push_back(shared_ptr&lt;Engine&gt;(new PhysicalActionContainerReseter));
+	rootBody-&gt;engines.push_back(boundingVolumeDispatcher);
+
+	shared_ptr&lt;PersistentSAPCollider&gt; collider(new PersistentSAPCollider);
+	collider-&gt;haveDistantTransient=true;
+	rootBody-&gt;engines.push_back(collider);
+
+	shared_ptr&lt;InteractionGeometryMetaEngine&gt; igeomDispatcher(new InteractionGeometryMetaEngine);
+	igeomDispatcher-&gt;DISPATCHER_ADD3(InteractingSphere,InteractingSphere,InteractingSphere2InteractingSphere4DistantSpheresContactGeometry);
+	rootBody-&gt;engines.push_back(igeomDispatcher);
+
+	shared_ptr&lt;InteractionPhysicsMetaEngine&gt; iphysDispatcher(new InteractionPhysicsMetaEngine);
+	iphysDispatcher-&gt;DISPATCHER_ADD3(BodyMacroParameters,BodyMacroParameters,BrefcomMakeContact);
+	rootBody-&gt;engines.push_back(iphysDispatcher);
+
+	shared_ptr&lt;BrefcomLaw&gt; bLaw(new BrefcomLaw);
+	rootBody-&gt;engines.push_back(bLaw);
+
+	shared_ptr&lt;CundallNonViscousForceDamping&gt; actionForceDamping(new CundallNonViscousForceDamping);
+	actionForceDamping-&gt;damping = .5;
+	shared_ptr&lt;CundallNonViscousMomentumDamping&gt; actionMomentumDamping(new CundallNonViscousMomentumDamping);
+	actionMomentumDamping-&gt;damping = .5;
+	shared_ptr&lt;PhysicalActionDamper&gt; actionDampingDispatcher(new PhysicalActionDamper);
+	actionDampingDispatcher-&gt;add(&quot;Force&quot;,&quot;ParticleParameters&quot;,&quot;CundallNonViscousForceDamping&quot;,actionForceDamping);
+	actionDampingDispatcher-&gt;add(&quot;Momentum&quot;,&quot;RigidBodyParameters&quot;,&quot;CundallNonViscousMomentumDamping&quot;,actionMomentumDamping);
+	rootBody-&gt;engines.push_back(actionDampingDispatcher);
+
+
+
+	shared_ptr&lt;PhysicalActionApplier&gt; applyActionDispatcher(new PhysicalActionApplier);
+	applyActionDispatcher-&gt;DISPATCHER_ADD3(Force,ParticleParameters,NewtonsForceLaw);
+	applyActionDispatcher-&gt;DISPATCHER_ADD3(Momentum,RigidBodyParameters,NewtonsMomentumLaw);
+	rootBody-&gt;engines.push_back(applyActionDispatcher);
+	
+	shared_ptr&lt;PhysicalParametersMetaEngine&gt; positionIntegrator(new PhysicalParametersMetaEngine);
+	positionIntegrator-&gt;DISPATCHER_ADD2(ParticleParameters,LeapFrogPositionIntegrator);
+	rootBody-&gt;engines.push_back(positionIntegrator);
+
+	shared_ptr&lt;PhysicalParametersMetaEngine&gt; orientationIntegrator(new PhysicalParametersMetaEngine);
+	orientationIntegrator-&gt;DISPATCHER_ADD2(RigidBodyParameters,LeapFrogOrientationIntegrator);
+	rootBody-&gt;engines.push_back(orientationIntegrator);
+
+	shared_ptr&lt;GlobalStiffnessTimeStepper&gt; globalStiffnessTimeStepper(new GlobalStiffnessTimeStepper);
+	globalStiffnessTimeStepper-&gt;sdecGroupMask=1023; // BIN 111111111, should always match
+	globalStiffnessTimeStepper-&gt;timeStepUpdateInterval=100;
+	globalStiffnessTimeStepper-&gt;defaultDt=1e-6;
+	rootBody-&gt;engines.push_back(globalStiffnessTimeStepper);
+
+	shared_ptr&lt;GlobalStiffnessCounter&gt; globalStiffnessCounter(new GlobalStiffnessCounter);
+	globalStiffnessCounter-&gt;sdecGroupMask=1023;
+	globalStiffnessCounter-&gt;interval=100;
+
+	rootBody-&gt;engines.push_back(globalStiffnessCounter);
+
+}
+
+

Added: trunk/extra/usct/UniaxialStrainControlledTest.hpp
===================================================================
--- trunk/extra/usct/UniaxialStrainControlledTest.hpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/extra/usct/UniaxialStrainControlledTest.hpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -0,0 +1,69 @@
+// 2008 &#169; V&#225;clav &#352;milauer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">eudoxos at arcig.cz</A>&gt; 
+#pragma once
+#include&lt;fstream&gt;
+#include&lt;yade/extra/Shop.hpp&gt;
+#include&lt;yade/core/FileGenerator.hpp&gt;
+#include&lt;yade/core/DeusExMachina.hpp&gt;
+
+class USCTGen: public FileGenerator {
+	private:
+		void createEngines();
+	public:
+		USCTGen(){ axis=1; limitStrain=0; };
+		~USCTGen (){};
+		bool generate();
+		string spheresFile;
+		Real strainRate, limitStrain;
+		int axis;
+	protected :
+		void registerAttributes(){
+			FileGenerator::registerAttributes();
+			REGISTER_ATTRIBUTE(spheresFile);
+			REGISTER_ATTRIBUTE(axis);
+			REGISTER_ATTRIBUTE(strainRate);
+			REGISTER_ATTRIBUTE(limitStrain);
+		}
+	REGISTER_CLASS_NAME(USCTGen);
+	REGISTER_BASE_CLASS_NAME(FileGenerator);
+	DECLARE_LOGGER;
+};
+REGISTER_SERIALIZABLE(USCTGen,false);
+
+class UniaxialStrainer: public DeusExMachina {
+	private:
+		bool idInVector(body_id_t id, const vector&lt;body_id_t&gt;&amp; V);
+		void computeAxialForce(MetaBody* rootBody);
+		ofstream recStream;
+		#define USCT_AXIS_COORD(id) (Body::byId(id)-&gt;physicalParameters-&gt;se3.position[axis])
+	public:
+		Real strainRate,currentStrainRate,originalLength,limitStrain;
+		Real sumPosForces,sumNegForces;
+		int axis;
+		bool notYetReversed;
+		vector&lt;body_id_t&gt; posIds, negIds;
+		vector&lt;Real&gt; posCoords,negCoords;
+
+		virtual void applyCondition(Body* _rootBody);
+		UniaxialStrainer(){axis=2; currentStrainRate=0; originalLength=-1; limitStrain=-1; notYetReversed=true; };
+		virtual ~UniaxialStrainer(){};
+		void registerAttributes(){
+			DeusExMachina::registerAttributes();
+			REGISTER_ATTRIBUTE(strainRate);
+			REGISTER_ATTRIBUTE(currentStrainRate);
+			REGISTER_ATTRIBUTE(axis);
+			REGISTER_ATTRIBUTE(posIds);
+			REGISTER_ATTRIBUTE(negIds);
+			REGISTER_ATTRIBUTE(posCoords);
+			REGISTER_ATTRIBUTE(negCoords);
+			REGISTER_ATTRIBUTE(originalLength);
+			REGISTER_ATTRIBUTE(limitStrain);
+			REGISTER_ATTRIBUTE(notYetReversed);
+		}
+		void postProcessAttributes(bool deserializing){if(deserializing) recStream.open(&quot;/tmp/usct.data&quot;); };
+	REGISTER_CLASS_NAME(UniaxialStrainer);
+	REGISTER_BASE_CLASS_NAME(DeusExMachina);
+	DECLARE_LOGGER;
+};
+REGISTER_SERIALIZABLE(UniaxialStrainer,false);
+
+

Modified: trunk/gui/SConscript
===================================================================
--- trunk/gui/SConscript	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/gui/SConscript	2008-02-04 10:36:31 UTC (rev 1242)
@@ -30,7 +30,6 @@
 			'qt3/YadeQtGeneratedMainWindow.ui',
 			'qt3/YadeQtMainWindow.cpp'],
 		LIBS=env['LIBS']+['yade-base',
-			'yade-base',
 			'yade-multimethods',
 			'yade-factory',
 			'yade-opengl',

Modified: trunk/gui/cmd/attrUtils.cpp
===================================================================
--- trunk/gui/cmd/attrUtils.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/gui/cmd/attrUtils.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -23,6 +23,7 @@
  * They define python special functions that support dictionary operations on this object and calls proxies for them. */
 #define ATTR_ACCESS_PY(cxxClass) \
 	def(&quot;__getitem__&quot;,&amp;cxxClass::wrappedPyGet).def(&quot;__setitem__&quot;,&amp;cxxClass::wrappedPySet).def(&quot;keys&quot;,&amp;cxxClass::wrappedPyKeys)
+	//.def(&quot;__getattr__&quot;,&amp;cxxClass::wrappedPyGet).def(&quot;__setattr__&quot;,&amp;cxxClass::wrappedPySet)
 
 
 /*! Helper class for accessing registered attributes through the serialization interface.
@@ -102,9 +103,9 @@
 
 		//! return attribute value as python object
 		boost::python::object pyGet(std::string key){
-			vector&lt;string&gt; raw=getAttrStr(key);
 			DescriptorMap::iterator I=descriptors.find(key);
 			if(I==descriptors.end()) throw std::invalid_argument(string(&quot;Invalid key: `&quot;)+key+&quot;'.&quot;);
+			vector&lt;string&gt; raw=getAttrStr(key);
 			if(raw.size()==1){
 				if(descriptors[key].types[0]==BOOL) return boost::python::object(lexical_cast&lt;bool&gt;(raw[0]));
 				if(descriptors[key].types[0]==STRING) return boost::python::object(raw[0]);

Modified: trunk/gui/cmd/cmdGui.cpp
===================================================================
--- trunk/gui/cmd/cmdGui.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/gui/cmd/cmdGui.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -55,6 +55,8 @@
 		//if(status){ LOG_ERROR(&quot;pyade import failed.&quot;); } else LOG_DEBUG(&quot;pyade imported.&quot;);
 		PyRun_SimpleString(&quot;from yadeControl import *&quot;);
 
+		PyRun_SimpleString(&quot;sys.excepthook=sys.__excepthook__&quot;); // apport on ubuntu overrides this, not needed
+
 		if(!runScript.empty()){
 			LOG_DEBUG(&quot;Will now run file `&quot;&lt;&lt;runScript&lt;&lt;&quot;'&quot;);
 			FILE* runScriptFILE=fopen(runScript.c_str(),&quot;r&quot;);

Modified: trunk/gui/cmd/yadeControl.cpp
===================================================================
--- trunk/gui/cmd/yadeControl.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/gui/cmd/yadeControl.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -20,6 +20,11 @@
 #include&lt;yade/core/FileGenerator.hpp&gt;
 #include&lt;yade/gui-qt3/GLViewer.hpp&gt;
 
+#include&lt;yade/core/MetaDispatchingEngine.hpp&gt;
+#include&lt;yade/core/StandAloneEngine.hpp&gt;
+#include&lt;yade/core/DeusExMachina.hpp&gt;
+#include&lt;yade/core/EngineUnit.hpp&gt;
+
 #include&lt;qapplication.h&gt;
 // qt3 sucks
 #undef DEBUG
@@ -31,9 +36,96 @@
 
 class RenderingEngine;
 
+/* TODO:
+ * have engine constructors that take engine name as first argument (instead of the .clss('...') method)
+ */
+
+class pyEngineUnit{
+		shared_ptr&lt;AttrAccess&gt; accessor;
+	public:	
+		void ensureEng(void){ if(!eng) throw runtime_error(&quot;No proxied EngineUnit.&quot;); if(!accessor) accessor=shared_ptr&lt;AttrAccess&gt;(new AttrAccess(eng));  }
+		shared_ptr&lt;EngineUnit&gt; eng;
+		vector&lt;string&gt; bases; // names of classes for which we dispatch
+		pyEngineUnit(const shared_ptr&lt;EngineUnit&gt;&amp; _eng, const vector&lt;string&gt;&amp; _bases): eng(_eng), bases(_bases) {}
+		pyEngineUnit(string clss, string base1=&quot;&quot;, string base2=&quot;&quot;){
+			eng=dynamic_pointer_cast&lt;EngineUnit&gt;(ClassFactory::instance().createShared(clss)); if(!eng) throw runtime_error(&quot;Invalid engine class `&quot;+clss+&quot;': either nonexistent, or not unable to cast to `EngineUnit'&quot;);
+			if(!base1.empty()){ bases.push_back(base1); if(!base2.empty()) bases.push_back(base2); }
+		}
+		std::string pyStr(void){ ensureEng(); string ret(&quot;&lt;&quot;+eng-&gt;getClassName()+&quot; EngineUnit {&quot;); for(size_t i=0; i&lt;bases.size(); i++) ret+=bases[i]+(i&lt;bases.size()-1?&quot;,&quot;:&quot;&quot;); return ret+&quot;}&gt;&quot;; }
+		ATTR_ACCESS_CXX(accessor,ensureEng);
+};
+
+class pyEngine{
+	private:
+		shared_ptr&lt;AttrAccess&gt; accessor;
+	public:	
+		void ensureEng(void){ if(!eng) throw runtime_error(&quot;No proxied Engine.&quot;); if(!accessor) accessor=shared_ptr&lt;AttrAccess&gt;(new AttrAccess(eng)); }
+		shared_ptr&lt;Engine&gt; eng;
+		//pyEngine(void){throw;}
+		pyEngine(const shared_ptr&lt;Engine&gt;&amp; _eng): eng(_eng) {}
+		pyEngine(string clss){ eng=dynamic_pointer_cast&lt;Engine&gt;(ClassFactory::instance().createShared(clss)); if(!eng) throw runtime_error(&quot;Invalid engine class `&quot;+clss+&quot;': either nonexistent, or not unable to cast to `Engine'&quot;); }
+		virtual std::string pyStr(void){ throw; } 
+		ATTR_ACCESS_CXX(accessor,ensureEng);
+};
+
+class pyStandAloneEngine: public pyEngine{
+	public:
+		pyStandAloneEngine(const shared_ptr&lt;StandAloneEngine&gt;&amp; _eng): pyEngine(_eng) {}
+		pyStandAloneEngine(string clss): pyEngine(clss) {};
+		std::string pyStr(void){ ensureEng(); return string(&quot;&lt;&quot;)+eng-&gt;getClassName()+&quot; StandAloneEngine&gt;&quot;; }
+};
+
+class pyDeusExMachina: public pyEngine{
+	public:
+		pyDeusExMachina(const shared_ptr&lt;DeusExMachina&gt;&amp; _eng): pyEngine(_eng) {}
+		pyDeusExMachina(string clss): pyEngine(clss) {};
+		std::string pyStr(void){ ensureEng(); return string(&quot;&lt;&quot;)+eng-&gt;getClassName()+&quot; DeusExMachina&gt;&quot;; }
+};
+
+class pyMetaEngine: public pyEngine{
+	public:
+		pyMetaEngine(const shared_ptr&lt;MetaDispatchingEngine&gt;&amp; _eng): pyEngine(_eng) {}
+		pyMetaEngine(string clss): pyEngine(clss) {};
+		//pyMetaEngine(string clss){ eng=dynamic_pointer_cast&lt;MetaDispatchingEngine&gt;(ClassFactory::instance().createShared(clss)); if(!eng) throw runtime_error(&quot;Invalid engine class `&quot;+clss+&quot;': either nonexistent, or not unable to cast to `MetaDispatchingEngine'&quot;); };
+		std::string pyStr(void){ ensureEng(); return string(&quot;&lt;&quot;)+eng-&gt;getClassName()+&quot; MetaEngine&gt;&quot;; }
+		python::list functors_get(void){
+			ensureEng(); shared_ptr&lt;MetaDispatchingEngine&gt; me=dynamic_pointer_cast&lt;MetaDispatchingEngine&gt;(eng); if(!me) throw runtime_error(&quot;Proxied class not a MetaDispatchingEngine (FIXME: add checks)&quot;); python::list ret;
+			/* garbage design: functorArguments are instances of EngineUnits, but they may not be present; therefore, only use them if they exist; our pyMetaEngine, however, will always have both names and EnguneUnit objects in the same count */
+			for(size_t i=0; i&lt;me-&gt;functorNames.size(); i++){
+				shared_ptr&lt;EngineUnit&gt; eu;
+				string functorName(*(me-&gt;functorNames[i].rbegin()));
+				if(i&lt;=me-&gt;functorArguments.size()){ /* count i-th list member */ size_t j=0;
+					for(list&lt;shared_ptr&lt;EngineUnit&gt; &gt;::iterator I=me-&gt;functorArguments.begin(); I!=me-&gt;functorArguments.end(); I++, j++) { if(j==i) { eu=(*I); break;}}
+				}
+				if(!eu) /* either list was shorter or empty pointer in the functorArguments list */ { eu=dynamic_pointer_cast&lt;EngineUnit&gt;(ClassFactory::instance().createShared(functorName)); if(!eu) throw runtime_error(&quot;Unable to construct `&quot;+string(*(me-&gt;functorNames[i].rbegin()))+&quot;' EngineUnit&quot;); }
+				assert(eu);
+				vector&lt;string&gt; fn; for(size_t j=0; j&lt;me-&gt;functorNames[i].size()-1; j++) fn.push_back(me-&gt;functorNames[i][j]); // all names but the last one, which is the functor class name; TODO: use std::algo for the copy
+				ret.append(pyEngineUnit(eu,fn));
+			}
+			return ret;
+		}
+		void functors_set(python::object ftrs){
+			ensureEng(); shared_ptr&lt;MetaDispatchingEngine&gt; me=dynamic_pointer_cast&lt;MetaDispatchingEngine&gt;(eng); if(!me) throw runtime_error(&quot;Proxied class not a MetaDispatchingEngine (FIXME: add checks)&quot;);
+			me-&gt;clear(); int len=python::len(ftrs);
+			for(int i=0; i&lt;len; i++){
+				const pyEngineUnit&amp; eu=python::extract&lt;pyEngineUnit&gt;(PySequence_GetItem(ftrs.ptr(),i));
+				switch(eu.bases.size()){
+					case 1: me-&gt;add(eu.bases[0],eu.eng-&gt;getClassName(),eu.eng);break;
+					case 2: me-&gt;add(eu.bases[0],eu.bases[1],eu.eng-&gt;getClassName(),eu.eng);break;
+					default: throw runtime_error(&quot;Unhandled number (&quot;+lexical_cast&lt;string&gt;(eu.bases.size())+&quot;, must be 1 or 2) of base classes for functor.&quot;);
+				}
+			}
+		}
+};
+
+
+
+
 class pyOmega{
+	#define OMEGA Omega::instance()
+	private:
+		void assertRootBody(){if(!OMEGA.getRootBody()) throw std::runtime_error(&quot;No root body.&quot;); }
 	public:
-	#define OMEGA Omega::instance()
 	pyOmega(){};
 
 	long iter(){ return OMEGA.getCurrentIteration();}
@@ -45,7 +137,9 @@
 	}
 	// long realTime(){return OMEGA(get...);}
 	double dt_get(){return OMEGA.getTimeStep();}
-	void dt_set(double dt){OMEGA.setTimeStep(dt);}
+	void dt_set(double dt){OMEGA.skipTimeStepper(true); OMEGA.setTimeStep(dt);}
+	bool usesTimeStepper_get(){return OMEGA.timeStepperActive();}
+	void usesTimeStepper_set(bool use){OMEGA.skipTimeStepper(!use);}
 
 	void run(){OMEGA.startSimulationLoop(); cerr&lt;&lt;&quot;RUN!&quot;&lt;&lt;endl;}
 	// must stop, then reload
@@ -61,6 +155,32 @@
 		OMEGA.createSimulationLoop();
 		cerr&lt;&lt;&quot;LOAD!&quot;&lt;&lt;endl;
 	}
+
+	void save(std::string fileName){
+		assertRootBody();
+		OMEGA.saveSimulation(fileName);
+		cerr&lt;&lt;&quot;SAVE!&quot;&lt;&lt;endl;
+	}
+
+	python::list engines_get(void){
+		assertRootBody(); python::list ret; const shared_ptr&lt;MetaBody&gt;&amp; rootBody=OMEGA.getRootBody();
+		for(vector&lt;shared_ptr&lt;Engine&gt; &gt;::iterator I=rootBody-&gt;engines.begin(); I!=rootBody-&gt;engines.end(); ++I){
+			#define APPEND_ENGINE_IF_POSSIBLE(engineType,pyEngineType) { shared_ptr&lt;engineType&gt; e=dynamic_pointer_cast&lt;engineType&gt;(*I); if(e) { ret.append(pyEngineType(e)); continue; } }
+			APPEND_ENGINE_IF_POSSIBLE(MetaDispatchingEngine,pyMetaEngine); APPEND_ENGINE_IF_POSSIBLE(StandAloneEngine,pyStandAloneEngine); APPEND_ENGINE_IF_POSSIBLE(DeusExMachina,pyDeusExMachina);
+			throw std::runtime_error(&quot;Unknown engine type: `&quot;+(*I)-&gt;getClassName()+&quot;' (only MetaDispatchingEngine, StandAloneEngine and DeusExMachina are supported)&quot;);
+		}
+		return ret;
+	}
+
+	void engines_set(python::object egs){
+		assertRootBody(); int len=python::len(egs); const shared_ptr&lt;MetaBody&gt;&amp; rootBody=OMEGA.getRootBody(); rootBody-&gt;engines.clear();
+		for(int i=0; i&lt;len; i++){
+			#define PUSH_BACK_ENGINE_IF_POSSIBLE(pyEngineType) if(python::extract&lt;pyEngineType&gt;(PySequence_GetItem(egs.ptr(),i)).check()){ pyEngineType e=python::extract&lt;pyEngineType&gt;(PySequence_GetItem(egs.ptr(),i)); rootBody-&gt;engines.push_back(e.eng); /* cerr&lt;&lt;&quot;added &quot;&lt;&lt;e.pyStr()&lt;&lt;&quot;, a &quot;&lt;&lt;#pyEngineType&lt;&lt;endl; */ continue; }
+			PUSH_BACK_ENGINE_IF_POSSIBLE(pyStandAloneEngine); PUSH_BACK_ENGINE_IF_POSSIBLE(pyMetaEngine); PUSH_BACK_ENGINE_IF_POSSIBLE(pyDeusExMachina);
+			throw std::runtime_error(&quot;Encountered unknown engine type (unable to extract from python object)&quot;);
+		}
+	}
+
 	//void join(){cerr&lt;&lt;&quot;JOIN!&quot;&lt;&lt;endl; OMEGA.joinSimulationLoop();}
 	#undef OMEGA
 };
@@ -177,6 +297,7 @@
 CREATE_LOGGER(pyGLViewer);
 
 
+
 BOOST_PYTHON_MODULE(yadeControl)
 {
 	/* <A HREF="http://mail.python.org/pipermail/c++-sig/2004-March/007025.html">http://mail.python.org/pipermail/c++-sig/2004-March/007025.html</A>
@@ -192,12 +313,15 @@
 		.add_property(&quot;time&quot;,&amp;pyOmega::simulationTime)
 		.add_property(&quot;realtime&quot;,&amp;pyOmega::realTime)
 		.add_property(&quot;dt&quot;,&amp;pyOmega::dt_get,&amp;pyOmega::dt_set)
-		//.add_property(&quot;timeStepper&quot;,&amp;timeStepper_get,&amp;timeStepper_set)
+		.add_property(&quot;usesTimeStepper&quot;,&amp;pyOmega::usesTimeStepper_get,&amp;pyOmega::usesTimeStepper_set)
 		.def(&quot;load&quot;,&amp;pyOmega::load)
+		.def(&quot;save&quot;,&amp;pyOmega::save)
 		.def(&quot;run&quot;,&amp;pyOmega::run)
 		// .def(&quot;join&quot;,&amp;pyOmega::join)
 		.def(&quot;pause&quot;,&amp;pyOmega::pause)
-		.def(&quot;step&quot;,&amp;pyOmega::step);
+		.def(&quot;step&quot;,&amp;pyOmega::step)
+		.add_property(&quot;engines&quot;,&amp;pyOmega::engines_get,&amp;pyOmega::engines_set)
+		;
 
 		#if 0
 			.def(&quot;oneStep&quot;,&amp;oneStep)
@@ -217,6 +341,36 @@
 	boost::python::class_&lt;pyGLViewer&gt;(&quot;View&quot;)
 		.ATTR_ACCESS_PY(pyGLViewer);
 
+	
+	/* FIXME: __str__, __repr__ etc should be inherited from one parent class in python; how to do that? */
+	/* clss currently doesn't check whether StandAloneEngine is not MetaDispatchingEngine, for example. Fix this later. */
+	python::class_&lt;pyStandAloneEngine&gt;(&quot;StandAloneEngine&quot;,python::init&lt;string&gt;())
+	.ATTR_ACCESS_PY(pyStandAloneEngine)
+	.def(&quot;__str__&quot;,&amp;pyStandAloneEngine::pyStr).def(&quot;__repr__&quot;,&amp;pyStandAloneEngine::pyStr)
+	//.def(&quot;clss&quot;,&amp;pyStandAloneEngine::pyInit);
+	;
+
+	python::class_&lt;pyMetaEngine&gt;(&quot;MetaEngine&quot;,python::init&lt;string&gt;())
+	.ATTR_ACCESS_PY(pyMetaEngine)
+	.def(&quot;__str__&quot;,&amp;pyMetaEngine::pyStr).def(&quot;__repr__&quot;,&amp;pyMetaEngine::pyStr)
+	//.def(&quot;clss&quot;,&amp;pyMetaEngine::pyInit)
+	.add_property(&quot;functors&quot;,&amp;pyMetaEngine::functors_get,&amp;pyMetaEngine::functors_set)
+	;
+
+	boost::python::class_&lt;pyDeusExMachina&gt;(&quot;DeusExMachina&quot;,python::init&lt;string&gt;())
+	.ATTR_ACCESS_PY(pyDeusExMachina)
+	.def(&quot;__str__&quot;,&amp;pyDeusExMachina::pyStr).def(&quot;__repr__&quot;,&amp;pyDeusExMachina::pyStr)
+	//.def(&quot;clss&quot;,&amp;pyStandAloneEngine::pyInit);
+	;
+
+	boost::python::class_&lt;pyEngineUnit&gt;(&quot;EngineUnit&quot;,python::init&lt;string, python::optional&lt;string,string&gt; &gt;())
+	.ATTR_ACCESS_PY(pyEngineUnit)
+	.def(&quot;__str__&quot;,&amp;pyEngineUnit::pyStr).def(&quot;__repr__&quot;,&amp;pyEngineUnit::pyStr)
+	// .def(&quot;clss&quot;,&amp;pyEngineUnit::pyInit)
+	.add_property(&quot;bases&quot;,&amp;pyEngineUnit::bases,&amp;pyEngineUnit::bases) // not yet functional
+	;
+	
+
 	//scope().attr(&quot;iter&quot;)=OMEGA(getCurrentIteration());
 	//scope().attr(&quot;time&quot;)=realTime(getSimulationTime());
 	//scope().attr(&quot;verbose&quot;)=;

Modified: trunk/lib/factory/DynLibManager.cpp
===================================================================
--- trunk/lib/factory/DynLibManager.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/lib/factory/DynLibManager.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -83,8 +83,7 @@
 {
 	lastPluginClasses.clear();
 
-	if (libName.empty())
-		return false;
+	if (libName.empty()) return false;
 
 	string libFileName = libNameToSystemName(libName);
 
@@ -124,7 +123,9 @@
 #ifndef WIN32
 	char**yadePluginClasses=(char**)dlsym(handle, &quot;yadePluginClasses&quot;);
 	// errors are ignored, since definition of this sybol is optional
-	if(dlerror()==NULL){ for(int i=0; yadePluginClasses[i]; i++){ lastPluginClasses.push_back(yadePluginClasses[i]); }}
+	if(dlerror()==NULL){ for(int i=0; yadePluginClasses[i]!=NULL &amp;&amp; strlen(yadePluginClasses[i])&gt;0; i++){
+		lastPluginClasses.push_back(yadePluginClasses[i]); LOG_DEBUG(&quot;Pushed back `&quot;&lt;&lt;yadePluginClasses[i]&lt;&lt;&quot;'.&quot;); }
+	}
 #endif
 	return true;
 }

Modified: trunk/lib/factory/DynLibManager.hpp
===================================================================
--- trunk/lib/factory/DynLibManager.hpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/lib/factory/DynLibManager.hpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -28,6 +28,12 @@
 
 using namespace std;
 
+/*! Macro defining what classes can be found in this plugin -- must always be used in the respective .cpp file.
+
+If left empty, filename will be used to deduce that.
+*/
+#define YADE_PLUGIN(...) const char* yadePluginClasses[]={ __VA_ARGS__ &quot;&quot;, NULL };
+
 class DynLibManager 
 {
 	private :

Modified: trunk/pkg/common/Container/BodyAssocVector.cpp
===================================================================
--- trunk/pkg/common/Container/BodyAssocVector.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Container/BodyAssocVector.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -172,3 +172,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Container/BodyRedirectionVector.cpp
===================================================================
--- trunk/pkg/common/Container/BodyRedirectionVector.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Container/BodyRedirectionVector.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -210,3 +210,4 @@
 
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Container/InteractionHashMap.cpp
===================================================================
--- trunk/pkg/common/Container/InteractionHashMap.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Container/InteractionHashMap.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -121,3 +121,4 @@
 {
 	return interactions.size();
 }
+YADE_PLUGIN();

Modified: trunk/pkg/common/Container/InteractionVecSet.cpp
===================================================================
--- trunk/pkg/common/Container/InteractionVecSet.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Container/InteractionVecSet.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -192,3 +192,4 @@
 	return currentSize;
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Container/PhysicalActionVectorVector.cpp
===================================================================
--- trunk/pkg/common/Container/PhysicalActionVectorVector.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Container/PhysicalActionVectorVector.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -131,3 +131,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/BoundingVolume/AABB.cpp
===================================================================
--- trunk/pkg/common/DataClass/BoundingVolume/AABB.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/BoundingVolume/AABB.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -17,3 +17,4 @@
 {
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/BoundingVolume/BoundingSphere.cpp
===================================================================
--- trunk/pkg/common/DataClass/BoundingVolume/BoundingSphere.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/BoundingVolume/BoundingSphere.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -35,3 +35,4 @@
 // 	min = center-v;
 // 	max = center+v;	
 // }
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/GeometricalModel/Box.cpp
===================================================================
--- trunk/pkg/common/DataClass/GeometricalModel/Box.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/GeometricalModel/Box.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -27,3 +27,4 @@
 	REGISTER_ATTRIBUTE(extents);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/GeometricalModel/Mesh2D.cpp
===================================================================
--- trunk/pkg/common/DataClass/GeometricalModel/Mesh2D.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/GeometricalModel/Mesh2D.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -59,3 +59,4 @@
 
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/GeometricalModel/Quadrilateral.cpp
===================================================================
--- trunk/pkg/common/DataClass/GeometricalModel/Quadrilateral.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/GeometricalModel/Quadrilateral.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -47,3 +47,4 @@
 	REGISTER_ATTRIBUTE(i4);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/GeometricalModel/Sphere.cpp
===================================================================
--- trunk/pkg/common/DataClass/GeometricalModel/Sphere.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/GeometricalModel/Sphere.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -26,3 +26,4 @@
 	REGISTER_ATTRIBUTE(radius);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/GeometricalModel/Tetrahedron.cpp
===================================================================
--- trunk/pkg/common/DataClass/GeometricalModel/Tetrahedron.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/GeometricalModel/Tetrahedron.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -36,3 +36,4 @@
 	// FIXME
 	REGISTER_ATTRIBUTE(v);
 }
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/InteractingGeometry/InteractingBox.cpp
===================================================================
--- trunk/pkg/common/DataClass/InteractingGeometry/InteractingBox.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/InteractingGeometry/InteractingBox.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -24,3 +24,4 @@
 	REGISTER_ATTRIBUTE(extents);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/InteractingGeometry/InteractingSphere.cpp
===================================================================
--- trunk/pkg/common/DataClass/InteractingGeometry/InteractingSphere.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/InteractingGeometry/InteractingSphere.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -24,3 +24,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/InteractingGeometry/MetaInteractingGeometry.cpp
===================================================================
--- trunk/pkg/common/DataClass/InteractingGeometry/MetaInteractingGeometry.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/InteractingGeometry/MetaInteractingGeometry.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -17,3 +17,4 @@
 {
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/InteractionGeometry/ClosestFeatures.cpp
===================================================================
--- trunk/pkg/common/DataClass/InteractionGeometry/ClosestFeatures.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/InteractionGeometry/ClosestFeatures.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -32,3 +32,4 @@
 // 
 // }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/InteractionPhysics/SimpleElasticInteraction.cpp
===================================================================
--- trunk/pkg/common/DataClass/InteractionPhysics/SimpleElasticInteraction.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/InteractionPhysics/SimpleElasticInteraction.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -22,3 +22,4 @@
 {
 	REGISTER_ATTRIBUTE(kn);
 }
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/PhysicalAction/Force.cpp
===================================================================
--- trunk/pkg/common/DataClass/PhysicalAction/Force.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/PhysicalAction/Force.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -47,3 +47,4 @@
 	return shared_ptr&lt;Force&gt;(new Force(*this));
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/PhysicalAction/Momentum.cpp
===================================================================
--- trunk/pkg/common/DataClass/PhysicalAction/Momentum.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/PhysicalAction/Momentum.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -46,3 +46,4 @@
 	return shared_ptr&lt;Momentum&gt;(new Momentum(*this));
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/PhysicalParameters/ElasticBodyParameters.cpp
===================================================================
--- trunk/pkg/common/DataClass/PhysicalParameters/ElasticBodyParameters.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/PhysicalParameters/ElasticBodyParameters.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -23,3 +23,4 @@
 	REGISTER_ATTRIBUTE(young);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/PhysicalParameters/ParticleParameters.cpp
===================================================================
--- trunk/pkg/common/DataClass/PhysicalParameters/ParticleParameters.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/PhysicalParameters/ParticleParameters.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -29,3 +29,4 @@
 	REGISTER_ATTRIBUTE(velocity);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/DataClass/PhysicalParameters/RigidBodyParameters.cpp
===================================================================
--- trunk/pkg/common/DataClass/PhysicalParameters/RigidBodyParameters.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/DataClass/PhysicalParameters/RigidBodyParameters.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -28,3 +28,4 @@
 	REGISTER_ATTRIBUTE(angularVelocity);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/DeusExMachina/DisplacementEngine.cpp
===================================================================
--- trunk/pkg/common/Engine/DeusExMachina/DisplacementEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/DeusExMachina/DisplacementEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -94,3 +94,4 @@
 
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/DeusExMachina/ForceEngine.cpp
===================================================================
--- trunk/pkg/common/Engine/DeusExMachina/ForceEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/DeusExMachina/ForceEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -43,3 +43,4 @@
         }
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/DeusExMachina/GravityEngine.cpp
===================================================================
--- trunk/pkg/common/Engine/DeusExMachina/GravityEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/DeusExMachina/GravityEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -51,3 +51,4 @@
         }
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/DeusExMachina/RotationEngine.cpp
===================================================================
--- trunk/pkg/common/Engine/DeusExMachina/RotationEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/DeusExMachina/RotationEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -67,3 +67,4 @@
 
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/DeusExMachina/TranslationEngine.cpp
===================================================================
--- trunk/pkg/common/Engine/DeusExMachina/TranslationEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/DeusExMachina/TranslationEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -69,3 +69,4 @@
 
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/EngineUnit/CundallNonViscousForceDamping.cpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/CundallNonViscousForceDamping.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/EngineUnit/CundallNonViscousForceDamping.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -42,3 +42,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/EngineUnit/CundallNonViscousMomentumDamping.cpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/CundallNonViscousMomentumDamping.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/EngineUnit/CundallNonViscousMomentumDamping.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -46,3 +46,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/EngineUnit/ElasticBodySimpleRelationship.cpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/ElasticBodySimpleRelationship.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/EngineUnit/ElasticBodySimpleRelationship.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -33,3 +33,4 @@
 {
 };
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/EngineUnit/InteractingBox2AABB.cpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/InteractingBox2AABB.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/EngineUnit/InteractingBox2AABB.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -32,3 +32,4 @@
 	aabb-&gt;max = aabb-&gt;center+aabb-&gt;halfSize;
 }
 	
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/EngineUnit/InteractingSphere2AABB.cpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/InteractingSphere2AABB.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/EngineUnit/InteractingSphere2AABB.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -27,3 +27,4 @@
 
 }
 	
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/EngineUnit/LeapFrogOrientationIntegrator.cpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/LeapFrogOrientationIntegrator.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/EngineUnit/LeapFrogOrientationIntegrator.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -43,3 +43,4 @@
 	firsts[id] = false;
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/EngineUnit/LeapFrogPositionIntegrator.cpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/LeapFrogPositionIntegrator.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/EngineUnit/LeapFrogPositionIntegrator.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -41,3 +41,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/EngineUnit/MetaInteractingGeometry2AABB.cpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/MetaInteractingGeometry2AABB.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/EngineUnit/MetaInteractingGeometry2AABB.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -51,3 +51,4 @@
 	aabb-&gt;max = max;
 }
 	
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.cpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -49,3 +49,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.cpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -33,3 +33,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/MetaEngine/BoundingVolumeMetaEngine.cpp
===================================================================
--- trunk/pkg/common/Engine/MetaEngine/BoundingVolumeMetaEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/MetaEngine/BoundingVolumeMetaEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -33,3 +33,4 @@
 
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/MetaEngine/GeometricalModelMetaEngine.cpp
===================================================================
--- trunk/pkg/common/Engine/MetaEngine/GeometricalModelMetaEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/MetaEngine/GeometricalModelMetaEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -27,3 +27,4 @@
 	 	operator()(body-&gt;physicalParameters,body-&gt;geometricalModel,body);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/MetaEngine/InteractingGeometryMetaEngine.cpp
===================================================================
--- trunk/pkg/common/Engine/MetaEngine/InteractingGeometryMetaEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/MetaEngine/InteractingGeometryMetaEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -29,3 +29,4 @@
 		operator()(body-&gt;geometricalModel,body-&gt;interactingGeometry,body-&gt;physicalParameters-&gt;se3,body);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/MetaEngine/InteractionGeometryMetaEngine.cpp
===================================================================
--- trunk/pkg/common/Engine/MetaEngine/InteractionGeometryMetaEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/MetaEngine/InteractionGeometryMetaEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -57,3 +57,4 @@
 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/MetaEngine/InteractionPhysicsMetaEngine.cpp
===================================================================
--- trunk/pkg/common/Engine/MetaEngine/InteractionPhysicsMetaEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/MetaEngine/InteractionPhysicsMetaEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -45,3 +45,4 @@
 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplier.cpp
===================================================================
--- trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplier.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplier.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -26,3 +26,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamper.cpp
===================================================================
--- trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamper.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamper.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -36,3 +36,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/MetaEngine/PhysicalParametersMetaEngine.cpp
===================================================================
--- trunk/pkg/common/Engine/MetaEngine/PhysicalParametersMetaEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/MetaEngine/PhysicalParametersMetaEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -28,3 +28,4 @@
  	operator()(body-&gt;physicalParameters,body);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/StandAloneEngine/DistantPersistentSAPCollider.cpp
===================================================================
--- trunk/pkg/common/Engine/StandAloneEngine/DistantPersistentSAPCollider.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/StandAloneEngine/DistantPersistentSAPCollider.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -254,3 +254,4 @@
 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/StandAloneEngine/PersistentSAPCollider.cpp
===================================================================
--- trunk/pkg/common/Engine/StandAloneEngine/PersistentSAPCollider.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/StandAloneEngine/PersistentSAPCollider.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -1,36 +1,35 @@
 /*************************************************************************
-*  Copyright (C) 2004 by Olivier Galizzi                                 *
-*  <A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">olivier.galizzi at imag.fr</A>                                               *
-*                                                                        *
+*  Copyright (C) 2004,2007 by
+*  	Olivier Galizzi &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">olivier.galizzi at imag.fr</A>&gt;
+*  	Bruno Chareyre &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">bruno.chareyre at hmg.inpg.fr</A>&gt;
+*  	V&#225;clav &#352;milauer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">eudoxos at arcig.cz</A>&gt;
+*
 *  This program is free software; it is licensed under the terms of the  *
 *  GNU General Public License v2 or later. See file LICENSE for details. *
 *************************************************************************/
 
-#include &quot;PersistentSAPCollider.hpp&quot;
+#include&quot;PersistentSAPCollider.hpp&quot;
 #include&lt;yade/core/Body.hpp&gt;
 #include&lt;yade/core/MetaBody.hpp&gt;
 #include&lt;yade/core/BodyContainer.hpp&gt;
+#include&lt;limits&gt;
 
 PersistentSAPCollider::PersistentSAPCollider() : BroadInteractor()
 {
-//	cerr &lt;&lt; &quot;PersistentSAPCollider\n&quot;;
+	noTransientIfPersistentExists=false;
+	haveDistantTransient=false;
 
-	//this-&gt;maxObject = 150000;
 	nbObjects=0;
-
 	//xBounds.resize(2*maxObject);
 	//yBounds.resize(2*maxObject);
 	//zBounds.resize(2*maxObject);
-
-	//minimums = new Real[3*maxObject];
-	//maximums = new Real[3*maxObject];
-	
+	//minima = new Real[3*maxObject];
+	//maxima = new Real[3*maxObject];
 	xBounds.clear();
 	yBounds.clear();
 	zBounds.clear();
-
-	minimums.clear();
-	maximums.clear();
+	minima.clear();
+	maxima.clear();
 }
 
 PersistentSAPCollider::~PersistentSAPCollider()
@@ -41,65 +40,52 @@
 void PersistentSAPCollider::action(Body* body)
 {
 
-	MetaBody * ncb = YADE_CAST&lt;MetaBody*&gt;(body);
-	shared_ptr&lt;BodyContainer&gt; bodies = ncb-&gt;bodies;
+	MetaBody *ncb=YADE_CAST&lt;MetaBody*&gt;(body);
+	shared_ptr&lt;BodyContainer&gt; bodies=ncb-&gt;bodies;
 	
-	if (2*bodies-&gt;size()!=xBounds.size())
-	{
+	if (2*bodies-&gt;size()!=xBounds.size()){
 		xBounds.resize(2*bodies-&gt;size());
 		yBounds.resize(2*bodies-&gt;size());
 		zBounds.resize(2*bodies-&gt;size());
-
-		minimums.resize(3*bodies-&gt;size());
-		maximums.resize(3*bodies-&gt;size());
+		minima.resize(3*bodies-&gt;size());
+		maxima.resize(3*bodies-&gt;size());
 	}
 
-	// Updates the minimums and maximums arrays according to the new center and radius of the spheres
+	// Updates the minima and maxima arrays according to the new center and radius of the spheres
 	int offset;
 	Vector3r min,max;
-	shared_ptr&lt;Body&gt; b;
 
-	BodyContainer::iterator bi    = bodies-&gt;begin();
-	BodyContainer::iterator biEnd = bodies-&gt;end();
-	for(unsigned int i=0 ; bi!=biEnd ; ++bi,i++ )
-	{
-		b = *bi;
-		
+	BodyContainer::iterator bi=bodies-&gt;begin();
+	for(unsigned int i=0 ; bi!=bodies-&gt;end(); ++bi,i++) {
+		const shared_ptr&lt;Body&gt;&amp; b=*bi;
 		offset = 3*i;
 		//FIXME: this is broken: bodies without boundingVolume are just skipped, which means that some garbage values are used later!
-		if(b-&gt;boundingVolume) // can't assume that everybody has BoundingVolume
-		{
-			min = b-&gt;boundingVolume-&gt;min;
-			max = b-&gt;boundingVolume-&gt;max;
-			minimums[offset+0] = min[0];
-			minimums[offset+1] = min[1];
-			minimums[offset+2] = min[2];
-			maximums[offset+0] = max[0];
-			maximums[offset+1] = max[1];
-			maximums[offset+2] = max[2];
+		if(b-&gt;boundingVolume){ // can't assume that everybody has BoundingVolume
+			min=b-&gt;boundingVolume-&gt;min; max=b-&gt;boundingVolume-&gt;max;
+			minima[offset+0]=min[0]; minima[offset+1]=min[1]; minima[offset+2]=min[2];
+			maxima[offset+0]=max[0]; maxima[offset+1]=max[1]; maxima[offset+2]=max[2];
 		}
+		else {
+			double nan=std::numeric_limits&lt;Real&gt;::quiet_NaN();
+			minima[offset+0]=nan; minima[offset+1]=nan; minima[offset+2]=nan;
+			maxima[offset+0]=nan; maxima[offset+1]=nan; maxima[offset+2]=nan;
+			cerr&lt;&lt;&quot;Assigning nan's, not tested! (hangs during sort?)&quot;&lt;&lt;endl;	
+		}
 	}
-	
-	transientInteractions = ncb-&gt;transientInteractions;
-	InteractionContainer::iterator ii    = transientInteractions-&gt;begin();
-	InteractionContainer::iterator iiEnd = transientInteractions-&gt;end();
-	for( ; ii!=iiEnd ; ++ii)
-	{
-		shared_ptr&lt;Interaction&gt; interaction = *ii;
-		// FIXME : remove this isNew flag and test if interactionPhysic ?
-		if (interaction-&gt;isReal) // if a interaction was only potential then no geometry was created for it and so this time it is still a new one
-			interaction-&gt;isNew = false;
-		interaction-&gt;isReal = false;
+
+	transientInteractions = ncb-&gt;transientInteractions;	
+	for(InteractionContainer::iterator I=transientInteractions-&gt;begin(); I!=transientInteractions-&gt;end(); ++I) {
+		if ((*I)-&gt;isReal) (*I)-&gt;isNew=false; // FIXME : remove this isNew flag and test if interactionPhysic ?
+		if(!haveDistantTransient) (*I)-&gt;isReal=false; // reset this flag, is used later... (??)
 	}
 	
 	updateIds(bodies-&gt;size());
-	nbObjects = bodies-&gt;size();
+	nbObjects=bodies-&gt;size();
 
 	// permutation sort of the AABBBounds along the 3 axis performed in a independant manner
 	sortBounds(xBounds, nbObjects);
 	sortBounds(yBounds, nbObjects);
 	sortBounds(zBounds, nbObjects);
-
 }
 
 
@@ -107,25 +93,16 @@
 {
 
 	// the first time broadInteractionTest is called nbObject=0
-	if (nbElements!=nbObjects)
-	{
-		int begin,end;
+	if (nbElements!=nbObjects){
+		int begin=0, end=nbElements;
+		if (nbElements&gt;nbObjects) begin=nbObjects;
 
-		end = nbElements;
-		begin = 0;
-
-		if (nbElements&gt;nbObjects)
-			begin = nbObjects;
-
 		// initialization if the xBounds, yBounds, zBounds
-		for(int i=begin;i&lt;end;i++)
-		{
+		for(int i=begin;i&lt;end;i++){
 			xBounds[2*i]	= shared_ptr&lt;AABBBound&gt;(new AABBBound(i,1));
 			xBounds[2*i+1]	= shared_ptr&lt;AABBBound&gt;(new AABBBound(i,0));
-			
 			yBounds[2*i]	= shared_ptr&lt;AABBBound&gt;(new AABBBound(i,1));
 			yBounds[2*i+1]	= shared_ptr&lt;AABBBound&gt;(new AABBBound(i,0));
-			
 			zBounds[2*i]	= shared_ptr&lt;AABBBound&gt;(new AABBBound(i,1));
 			zBounds[2*i+1]	= shared_ptr&lt;AABBBound&gt;(new AABBBound(i,0));
 		}
@@ -147,10 +124,8 @@
 		findOverlappingBB(xBounds, nbElements);
 		findOverlappingBB(yBounds, nbElements);
 		findOverlappingBB(zBounds, nbElements);
-
 	}
-	else
-		updateBounds(nbElements);
+	else updateBounds(nbElements);
 }
 
 
@@ -176,9 +151,11 @@
 
 void PersistentSAPCollider::updateOverlapingBBSet(int id1,int id2)
 {
-
 // 	// look if the pair (id1,id2) already exists in the overleppingBB collection
-	bool found = (transientInteractions-&gt;find(body_id_t(id1),body_id_t(id2))!=0);
+	const shared_ptr&lt;Interaction&gt;&amp; interaction=transientInteractions-&gt;find(body_id_t(id1),body_id_t(id2));
+	bool found=(interaction!=0);//Bruno's Hack
+	// if there is persistent interaction, we will not create transient one!
+	bool foundPersistent = noTransientIfPersistentExists ? (persistentInteractions-&gt;find(body_id_t(id1),body_id_t(id2))!=0) : false;
 	
 	// test if the AABBs of the spheres number &quot;id1&quot; and &quot;id2&quot; are overlapping
 	int offset1 = 3*id1;
@@ -186,67 +163,48 @@
 	// FIXME: this is perhaps an expensive operation?!
 	const shared_ptr&lt;Body&gt;&amp; b1(Body::byId(body_id_t(id1))), b2(Body::byId(body_id_t(id2)));
 	bool overlap =
-
 		(b1-&gt;isStandalone() || b2-&gt;isStandalone() || b1-&gt;clumpId!=b2-&gt;clumpId ) &amp;&amp; // only collide if at least one particle is standalone or they belong to different clumps
 		!b1-&gt;isClump() &amp;&amp; !b2-&gt;isClump() &amp;&amp; // do not collide clumps, since they are just containers, never interact
 
-		!(maximums[offset1]&lt;minimums[offset2] || maximums[offset2]&lt;minimums[offset1] || 
-		maximums[offset1+1]&lt;minimums[offset2+1] || maximums[offset2+1]&lt;minimums[offset1+1] || 
-		maximums[offset1+2]&lt;minimums[offset2+2] || maximums[offset2+2]&lt;minimums[offset1+2]);
+		!(maxima[offset1]&lt;minima[offset2] || maxima[offset2]&lt;minima[offset1] || 
+		maxima[offset1+1]&lt;minima[offset2+1] || maxima[offset2+1]&lt;minima[offset1+1] || 
+		maxima[offset1+2]&lt;minima[offset2+2] || maxima[offset2+2]&lt;minima[offset1+2]);
 
 	// inserts the pair p=(id1,id2) if the two AABB overlaps and if p does not exists in the overlappingBB
-	if (overlap &amp;&amp; !found)
-		transientInteractions-&gt;insert(body_id_t(id1),body_id_t(id2));
+	if(overlap &amp;&amp; !found &amp;&amp; !foundPersistent) transientInteractions-&gt;insert(body_id_t(id1),body_id_t(id2));
 	// removes the pair p=(id1,id2) if the two AABB do not overlapp any more and if p already exists in the overlappingBB
-	else if (!overlap &amp;&amp; found)
-		transientInteractions-&gt;erase(body_id_t(id1),body_id_t(id2));
-
+	else if(!overlap &amp;&amp; found &amp;&amp; (haveDistantTransient ? !interaction-&gt;isReal : true) ) transientInteractions-&gt;erase(body_id_t(id1),body_id_t(id2));
 }
 
 
 void PersistentSAPCollider::updateBounds(int nbElements)
 {
+	for(int i=0; i &lt; 2*nbElements; i++){
+		if (xBounds[i]-&gt;lower) xBounds[i]-&gt;value = minima[3*xBounds[i]-&gt;id+0];
+		else xBounds[i]-&gt;value = maxima[3*xBounds[i]-&gt;id+0];
 
-	for(int i=0; i &lt; 2*nbElements; i++)
-	{
-		if (xBounds[i]-&gt;lower)
-			xBounds[i]-&gt;value = minimums[3*xBounds[i]-&gt;id+0];
-		else
-			xBounds[i]-&gt;value = maximums[3*xBounds[i]-&gt;id+0];
+		if (yBounds[i]-&gt;lower) yBounds[i]-&gt;value = minima[3*yBounds[i]-&gt;id+1];
+		else yBounds[i]-&gt;value = maxima[3*yBounds[i]-&gt;id+1];
 
-		if (yBounds[i]-&gt;lower)
-			yBounds[i]-&gt;value = minimums[3*yBounds[i]-&gt;id+1];
-		else
-			yBounds[i]-&gt;value = maximums[3*yBounds[i]-&gt;id+1];
-
-		if (zBounds[i]-&gt;lower)
-			zBounds[i]-&gt;value = minimums[3*zBounds[i]-&gt;id+2];
-		else
-			zBounds[i]-&gt;value = maximums[3*zBounds[i]-&gt;id+2];
+		if (zBounds[i]-&gt;lower) zBounds[i]-&gt;value = minima[3*zBounds[i]-&gt;id+2];
+		else zBounds[i]-&gt;value = maxima[3*zBounds[i]-&gt;id+2];
 	}
 }
 
 
 
 
-void PersistentSAPCollider::findOverlappingBB(std::vector&lt;shared_ptr&lt;AABBBound&gt; &gt;&amp; bounds, int nbElements)
-{
-
-	int i,j;
-
-	i = j = 0;
-	while (i&lt;2*nbElements)
-	{
-		while (i&lt;2*nbElements &amp;&amp; !bounds[i]-&gt;lower)
-			i++;
+void PersistentSAPCollider::findOverlappingBB(std::vector&lt;shared_ptr&lt;AABBBound&gt; &gt;&amp; bounds, int nbElements){
+	int i=0,j=0;
+	while (i&lt;2*nbElements) {
+		while (i&lt;2*nbElements &amp;&amp; !bounds[i]-&gt;lower) i++;
 		j=i+1;
-		while (j&lt;2*nbElements &amp;&amp; bounds[j]-&gt;id!=bounds[i]-&gt;id)
-		{
-			if (bounds[j]-&gt;lower)
-				updateOverlapingBBSet(bounds[i]-&gt;id,bounds[j]-&gt;id);
+		while (j&lt;2*nbElements &amp;&amp; bounds[j]-&gt;id!=bounds[i]-&gt;id){
+			if (bounds[j]-&gt;lower) updateOverlapingBBSet(bounds[i]-&gt;id,bounds[j]-&gt;id);
 			j++;
 		}
 		i++;
 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/StandAloneEngine/PersistentSAPCollider.hpp
===================================================================
--- trunk/pkg/common/Engine/StandAloneEngine/PersistentSAPCollider.hpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/StandAloneEngine/PersistentSAPCollider.hpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -57,11 +57,12 @@
 		// collection of AABB that are in interaction
 		//protected : vector&lt; set&lt;unsigned int&gt; &gt; overlappingBB;
 		shared_ptr&lt;InteractionContainer&gt; transientInteractions;
+		shared_ptr&lt;InteractionContainer&gt; persistentInteractions;
 		/// upper right corner of the AABB of the objects =&gt;  for spheres = center[i]-radius
-		vector&lt;Real&gt; maximums;
+		vector&lt;Real&gt; maxima;
 
 		/// lower left corner of the AABB of the objects =&gt;  for spheres = center[i]+radius
-		vector&lt;Real&gt; minimums;
+		vector&lt;Real&gt; minima;
 
 		/// Used the first time broadInteractionTest is called, to initialize and sort the xBounds, yBounds,
 		/// and zBounds arrays and to initialize the overlappingBB collection
@@ -92,7 +93,18 @@
 		/// return a list &quot;transientInteractions&quot; of pairs of Body which Bounding volume are in potential interaction
 		void action(Body * body);
 
+		//! When creating transient interaction, look first if a persistent link between the pair in question exists; in that case, skip it.
+		bool noTransientIfPersistentExists;
+		//! Don't break transient interaction once bodies don't overlap anymore; material law will be responsible for breaking it.
+		bool haveDistantTransient;
 
+		void registerAttributes(){
+			BroadInteractor::registerAttributes();
+			REGISTER_ATTRIBUTE(noTransientIfPersistentExists);
+			REGISTER_ATTRIBUTE(haveDistantTransient);
+		}
+
+
 	REGISTER_CLASS_NAME(PersistentSAPCollider);
 	REGISTER_BASE_CLASS_NAME(BroadInteractor);
 

Modified: trunk/pkg/common/Engine/StandAloneEngine/PhysicalActionContainerInitializer.cpp
===================================================================
--- trunk/pkg/common/Engine/StandAloneEngine/PhysicalActionContainerInitializer.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/StandAloneEngine/PhysicalActionContainerInitializer.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -44,3 +44,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/StandAloneEngine/PhysicalActionContainerReseter.cpp
===================================================================
--- trunk/pkg/common/Engine/StandAloneEngine/PhysicalActionContainerReseter.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/StandAloneEngine/PhysicalActionContainerReseter.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -24,3 +24,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/StandAloneEngine/SAPCollider.cpp
===================================================================
--- trunk/pkg/common/Engine/StandAloneEngine/SAPCollider.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/Engine/StandAloneEngine/SAPCollider.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -295,3 +295,4 @@
 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawBoundingVolume/GLDrawAABB.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawBoundingVolume/GLDrawAABB.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawBoundingVolume/GLDrawAABB.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -23,3 +23,4 @@
 	glutWireCube(1);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawBoundingVolume/GLDrawBoundingSphere.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawBoundingVolume/GLDrawBoundingSphere.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawBoundingVolume/GLDrawBoundingSphere.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -18,3 +18,4 @@
 	glutWireSphere(s-&gt;radius,10,10);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawBox.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawBox.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawBox.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -36,3 +36,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawMesh2D.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawMesh2D.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawMesh2D.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -82,3 +82,4 @@
 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawQuadrilateral.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawQuadrilateral.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawQuadrilateral.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -214,3 +214,4 @@
 	y = X[1];
 };
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawSphere.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawSphere.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawSphere.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -229,3 +229,4 @@
 }
 
 ///////////////////////////////////////////////////////////////////////////////////////////////////
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawTetrahedron.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawTetrahedron.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawGeometricalModel/GLDrawTetrahedron.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -143,3 +143,4 @@
 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawInteractingGeometry/GLDrawInteractingBox.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawInteractingGeometry/GLDrawInteractingBox.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawInteractingGeometry/GLDrawInteractingBox.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -32,3 +32,4 @@
 //	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawInteractingGeometry/GLDrawInteractingSphere.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawInteractingGeometry/GLDrawInteractingSphere.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawInteractingGeometry/GLDrawInteractingSphere.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -152,3 +152,4 @@
 		subdivideTriangle(vertices[(unsigned int)faces[i][0]],vertices[(unsigned int)faces[i][1]],vertices[(unsigned int)faces[i][2]],depth);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawInteractingGeometry/GLDrawMetaInteractingGeometry.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawInteractingGeometry/GLDrawMetaInteractingGeometry.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawInteractingGeometry/GLDrawMetaInteractingGeometry.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -16,3 +16,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawInteractionGeometry/GLDrawClosestFeatures.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawInteractionGeometry/GLDrawClosestFeatures.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawInteractionGeometry/GLDrawClosestFeatures.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -43,3 +43,4 @@
 	glEnd();
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawInteractionPhysics/GLDrawSimpleElasticInteraction.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawInteractionPhysics/GLDrawSimpleElasticInteraction.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawInteractionPhysics/GLDrawSimpleElasticInteraction.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -40,3 +40,4 @@
 	glPopMatrix();
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawShadowVolume/GLDrawBoxShadowVolume.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawShadowVolume/GLDrawBoxShadowVolume.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawShadowVolume/GLDrawBoxShadowVolume.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -288,3 +288,4 @@
 
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawShadowVolume/GLDrawSphereShadowVolume.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawShadowVolume/GLDrawSphereShadowVolume.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawShadowVolume/GLDrawSphereShadowVolume.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -56,3 +56,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawState/GLDrawParticleState.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawState/GLDrawParticleState.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawState/GLDrawParticleState.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -39,3 +39,4 @@
 	glEnd();
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/GLDrawState/GLDrawRigidBodyState.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/GLDrawState/GLDrawRigidBodyState.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/GLDrawState/GLDrawRigidBodyState.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -48,3 +48,4 @@
 	glEnd();
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/RenderingEngine/OpenGLRenderingEngine/OpenGLRenderingEngine.cpp
===================================================================
--- trunk/pkg/common/RenderingEngine/OpenGLRenderingEngine/OpenGLRenderingEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/RenderingEngine/OpenGLRenderingEngine/OpenGLRenderingEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -684,3 +684,4 @@
 	shadowVolumeFunctorNames.push_back(v);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/common/SConscript
===================================================================
--- trunk/pkg/common/SConscript	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/common/SConscript	2008-02-04 10:36:31 UTC (rev 1242)
@@ -145,11 +145,7 @@
 	env.SharedLibrary('TranslationEngine',
 		['Engine/DeusExMachina/TranslationEngine.cpp'],
 		LIBS=env['LIBS']+['yade-base',
-			
 			'ParticleParameters',
-			'yade-factory',
-			'yade-base',
-			
 			'yade-serialization',
 			'yade-multimethods'],
 		CPPPATH=env['CPPPATH']+['DataClass/PhysicalParameters',
@@ -159,10 +155,6 @@
 	env.SharedLibrary('DisplacementEngine',
 		['Engine/DeusExMachina/DisplacementEngine.cpp'],
 		LIBS=env['LIBS']+['yade-base',
-			
-			'yade-factory',
-			'yade-base',
-			
 			'yade-serialization',
 			'yade-multimethods'],
 		CPPPATH=env['CPPPATH']+['$PREFIX/include', 'Engine/DeusExMachina']),
@@ -210,14 +202,11 @@
 	env.SharedLibrary('InteractingBox2AABB',
 		['Engine/EngineUnit/InteractingBox2AABB.cpp'],
 		LIBS=env['LIBS']+['yade-base',
-			
 			'BoundingVolumeMetaEngine',
 			'InteractingBox',
 			'AABB',
 			'Box',
-			'yade-base',
-			
-			'yade-multimethods'],
+			'yade-base'],
 		CPPPATH=env['CPPPATH']+['DataClass/BoundingVolume',
 			'DataClass/InteractingGeometry',
 			'$PREFIX/include',

Modified: trunk/pkg/dem/DataClass/InteractingGeometry/InteractingMyTetrahedron.cpp
===================================================================
--- trunk/pkg/dem/DataClass/InteractingGeometry/InteractingMyTetrahedron.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/DataClass/InteractingGeometry/InteractingMyTetrahedron.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -32,3 +32,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/DataClass/InteractionGeometry/InteractionOfMyTetrahedron.cpp
===================================================================
--- trunk/pkg/dem/DataClass/InteractionGeometry/InteractionOfMyTetrahedron.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/DataClass/InteractionGeometry/InteractionOfMyTetrahedron.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -18,3 +18,4 @@
 {
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/DataClass/InteractionGeometry/SDECLinkGeometry.cpp
===================================================================
--- trunk/pkg/dem/DataClass/InteractionGeometry/SDECLinkGeometry.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/DataClass/InteractionGeometry/SDECLinkGeometry.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -25,3 +25,4 @@
 	REGISTER_ATTRIBUTE(radius1);
 	REGISTER_ATTRIBUTE(radius2);
 }
+YADE_PLUGIN();

Modified: trunk/pkg/dem/DataClass/InteractionGeometry/SpheresContactGeometry.cpp
===================================================================
--- trunk/pkg/dem/DataClass/InteractionGeometry/SpheresContactGeometry.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/DataClass/InteractionGeometry/SpheresContactGeometry.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -31,3 +31,4 @@
 	REGISTER_ATTRIBUTE(radius2);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/DataClass/InteractionPhysics/CapillaryParameters.cpp
===================================================================
--- trunk/pkg/dem/DataClass/InteractionPhysics/CapillaryParameters.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/DataClass/InteractionPhysics/CapillaryParameters.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -43,3 +43,4 @@
 	REGISTER_ATTRIBUTE(Delta2);
 	REGISTER_ATTRIBUTE(meniscus);
 }
+YADE_PLUGIN();

Modified: trunk/pkg/dem/DataClass/InteractionPhysics/CohesiveFrictionalContactInteraction.cpp
===================================================================
--- trunk/pkg/dem/DataClass/InteractionPhysics/CohesiveFrictionalContactInteraction.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/DataClass/InteractionPhysics/CohesiveFrictionalContactInteraction.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -66,3 +66,4 @@
 //				,normalForce			// normal force applied on a DE
 //				,shearForce;			// shear force applied on a DE
 }
+YADE_PLUGIN();

Modified: trunk/pkg/dem/DataClass/InteractionPhysics/ElasticContactInteraction.cpp
===================================================================
--- trunk/pkg/dem/DataClass/InteractionPhysics/ElasticContactInteraction.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/DataClass/InteractionPhysics/ElasticContactInteraction.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -45,3 +45,4 @@
 //				,normalForce			// normal force applied on a DE
 //				,shearForce;			// shear force applied on a DE
 }
+YADE_PLUGIN();

Modified: trunk/pkg/dem/DataClass/InteractionPhysics/SDECLinkPhysics.cpp
===================================================================
--- trunk/pkg/dem/DataClass/InteractionPhysics/SDECLinkPhysics.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/DataClass/InteractionPhysics/SDECLinkPhysics.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -41,3 +41,4 @@
 	REGISTER_ATTRIBUTE(heta);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/DataClass/PhysicalAction/GlobalStiffness.cpp
===================================================================
--- trunk/pkg/dem/DataClass/PhysicalAction/GlobalStiffness.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/DataClass/PhysicalAction/GlobalStiffness.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -48,3 +48,4 @@
 	return shared_ptr&lt;GlobalStiffness&gt;(new GlobalStiffness(*this));
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/DataClass/PhysicalParameters/BodyMacroParameters.cpp
===================================================================
--- trunk/pkg/dem/DataClass/PhysicalParameters/BodyMacroParameters.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/DataClass/PhysicalParameters/BodyMacroParameters.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -24,3 +24,4 @@
 	REGISTER_ATTRIBUTE(frictionAngle);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/DataClass/PhysicalParameters/CohesiveFrictionalBodyParameters.cpp
===================================================================
--- trunk/pkg/dem/DataClass/PhysicalParameters/CohesiveFrictionalBodyParameters.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/DataClass/PhysicalParameters/CohesiveFrictionalBodyParameters.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -26,3 +26,4 @@
 	REGISTER_ATTRIBUTE(isBroken);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/DeusExMachina/CapillaryPressureEngine.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/CapillaryPressureEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/DeusExMachina/CapillaryPressureEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -55,3 +55,4 @@
 	
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/DeusExMachina/CapillaryRecorder.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/CapillaryRecorder.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/DeusExMachina/CapillaryRecorder.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -117,3 +117,4 @@
 	
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/DeusExMachina/CapillaryStressRecorder.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/CapillaryStressRecorder.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/DeusExMachina/CapillaryStressRecorder.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -237,3 +237,4 @@
 	
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/DeusExMachina/ContactStressRecorder.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/ContactStressRecorder.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/DeusExMachina/ContactStressRecorder.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -342,3 +342,4 @@
 	
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/DeusExMachina/HydraulicForceEngine.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/HydraulicForceEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/DeusExMachina/HydraulicForceEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -138,3 +138,4 @@
     }
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/DeusExMachina/MakeItFlat.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/MakeItFlat.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/DeusExMachina/MakeItFlat.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -57,3 +57,4 @@
         }
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/DeusExMachina/ResultantForceEngine.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/ResultantForceEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/DeusExMachina/ResultantForceEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -95,3 +95,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/DeusExMachina/TriaxialCompressionEngine.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/TriaxialCompressionEngine.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/DeusExMachina/TriaxialCompressionEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -12,8 +12,11 @@
 #include&lt;yade/pkg-common/Force.hpp&gt;
 #include&lt;yade/pkg-dem/ElasticContactInteraction.hpp&gt;
 #include&lt;yade/lib-base/yadeWm3Extra.hpp&gt;
-#include &lt;boost/lexical_cast.hpp&gt;
+#include&lt;boost/lexical_cast.hpp&gt;
+#include&lt;boost/lambda/lambda.hpp&gt;
+#include&lt;yade/extra/Shop.hpp&gt;
 
+
 class CohesiveFrictionalRelationships;
 
 CREATE_LOGGER(TriaxialCompressionEngine);
@@ -69,7 +72,7 @@
 }
 
 void TriaxialCompressionEngine::doStateTransition(stateNum nextState){
-	if ( currentState==STATE_UNINITIALIZED &amp;&amp; nextState==STATE_ISO_COMPACTION){
+	if ( /* currentState==STATE_UNINITIALIZED &amp;&amp; */ nextState==STATE_ISO_COMPACTION){
 		sigma_iso=sigmaIsoCompaction;
 	}
 	else if((currentState==STATE_ISO_COMPACTION || currentState==STATE_ISO_UNLOADING || currentState==STATE_LIMBO) &amp;&amp; nextState==STATE_TRIAX_LOADING){
@@ -79,6 +82,19 @@
 		//compressionActivated = true;
 		wall_bottom_activated=false;
 		wall_top_activated=false;
+		if(currentState==STATE_ISO_UNLOADING){ LOG_INFO(&quot;Speres -&gt; /tmp/unloaded.spheres&quot;); Shop::saveSpheresToFile(&quot;/tmp/unloaded.spheres&quot;); }
+		if(1){
+			max_vel*=20;
+			Shop::createCohesion(1e-4,1e-4,0); // (boost::lambda::_1 %2==0) &amp;&amp; (boost::lambda::_2%2==0));
+			/*shared_ptr&lt;MetaBody&gt; rootBody=Omega::instance().getRootBody();
+			for(vector&lt;shared_ptr&lt;Engine&gt; &gt;::iterator I=rootBody-&gt;engines.begin(); I!=rootBody-&gt;engines.end(); ++I){
+				if((*I)-&gt;getClassName()==&quot;PersistentSAPCollider&quot;) {
+					rootBody-&gt;engines.erase(I);
+					LOG_DEBUG(&quot;Removed PersistentSAPCollider engine.&quot;);
+					break;
+				}
+			}*/
+		}
 		if(!firstRun) saveSimulation=true; // saving snapshot .xml will actually be done in ::applyCondition
 	}
 	else if(currentState==STATE_ISO_COMPACTION &amp;&amp; nextState==STATE_ISO_UNLOADING){
@@ -108,8 +124,7 @@
 
 	UnbalancedForce=ComputeUnbalancedForce(body); // calculated at every iteration
 	MetaBody * ncb = static_cast&lt;MetaBody*&gt;(body);
-	if (Omega::instance().getCurrentIteration() % 100 == 0) {
-		LOG_DEBUG(stateName(currentState));}
+	if (Omega::instance().getCurrentIteration() % 100 == 0) { /* TRVAR1(meanStress);*/ /* TRVAR2(stateName(currentState),sigma_iso); */ }
 
 	if(currentState==STATE_ISO_COMPACTION || currentState==STATE_ISO_UNLOADING){
 		// FIXME: do we need this?? it makes sense to activate compression only during compaction!: || autoCompressionActivation)
@@ -153,9 +168,9 @@
 {
 	// here, we make sure to get consistent parameters, in case someone fiddled with the scene .xml manually
 	if(firstRun){
-		LOG_FATAL(&quot;First run!&quot;);
+		LOG_INFO(&quot;First run, will initialize!&quot;);
 		//sigma_iso was changed, we need to rerun compaction
-		if(sigma_iso!=previousSigmaIso) doStateTransition(STATE_ISO_COMPACTION);
+		if(sigma_iso!=previousSigmaIso || currentState==STATE_UNINITIALIZED) doStateTransition(STATE_ISO_COMPACTION);
 		if(previousState==STATE_LIMBO &amp;&amp; currentState==STATE_TRIAX_LOADING) doStateTransition(STATE_TRIAX_LOADING);
 		previousState=currentState;
 		previousSigmaIso=sigma_iso;
@@ -163,32 +178,34 @@
 	}
 	if(currentState==STATE_LIMBO) return;
 
-    TriaxialStressController::applyCondition(body);
-    if (Omega::instance().getCurrentIteration() % testEquilibriumInterval == 0) {
+   TriaxialStressController::applyCondition(body);
+   if (Omega::instance().getCurrentIteration() % testEquilibriumInterval == 0) {
         updateParameters(body);
         if (saveSimulation) {
             string fileName = &quot;../data/&quot; + Phase1End + &quot;_&quot; +
                               lexical_cast&lt;string&gt;(Omega::instance().getCurrentIteration()) + &quot;.xml&quot;;
             LOG_INFO(&quot;saving snapshot: &quot;&lt;&lt;fileName);
             Omega::instance().saveSimulation(fileName);
+				fileName=&quot;../data/&quot;+Phase1End+&quot;_&quot;+lexical_cast&lt;string&gt;(Omega::instance().getCurrentIteration())+&quot;.spheres&quot;;
+				LOG_INFO(&quot;saving spheres: &quot;&lt;&lt;fileName);
+				Shop::saveSpheresToFile(fileName);
             saveSimulation = false;
         }
     }
 	 if (currentState==STATE_TRIAX_LOADING) {
-        if (Omega::instance().getCurrentIteration() % 100 == 0) LOG_DEBUG(&quot;Compression active.&quot;);
+        // if (Omega::instance().getCurrentIteration() % 100 == 0) LOG_DEBUG(&quot;Compression active.&quot;);
         Real dt = Omega::instance().getTimeStep();
-        MetaBody * ncb = static_cast&lt;MetaBody*&gt;(body);
-        shared_ptr&lt;BodyContainer&gt;&amp; bodies = ncb-&gt;bodies;
 
         if (currentStrainRate &lt; strainRate) currentStrainRate += strainRate*0.0003;	// !!! if unloading (?)
         else currentStrainRate = strainRate;
 
 		  /* Move top and bottom wall according to strain rate */
-        PhysicalParameters* p = static_cast&lt;PhysicalParameters*&gt;((*bodies)[wall_bottom_id]-&gt;physicalParameters. get());
+        PhysicalParameters* p=static_cast&lt;PhysicalParameters*&gt;(Body::byId(wall_bottom_id)-&gt;physicalParameters.get());
         p-&gt;se3.position += 0.5*strainRate*height*translationAxis*dt;
-        p = static_cast&lt;PhysicalParameters*&gt;((*bodies)[wall_top_id]-&gt;physicalParameters.get( ));
+        p = static_cast&lt;PhysicalParameters*&gt;(Body::byId(wall_top_id)-&gt;physicalParameters.get());
         p-&gt;se3.position -= 0.5*strainRate*height*translationAxis*dt;
     }
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/DeusExMachina/TriaxialStateRecorder.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/TriaxialStateRecorder.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/DeusExMachina/TriaxialStateRecorder.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -148,3 +148,4 @@
 
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/DeusExMachina/TriaxialStressController.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/TriaxialStressController.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/DeusExMachina/TriaxialStressController.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -161,19 +161,23 @@
 void TriaxialStressController::controlExternalStress(int wall, MetaBody* ncb, Vector3r resultantForce, PhysicalParameters* p, Real wall_max_vel)
 {
 	Real translation=normal[wall].Dot(static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall],ForceClassIndex).get() )-&gt;force - resultantForce);
-	//cerr &lt;&lt; &quot;current force= &quot; &lt;&lt; static_cast&lt;Force*&gt;(ncb-&gt;physicalActions-&gt;find(wall_id[wall],ForceClassIndex).get() )-&gt;force &lt;&lt; &quot; imposed force = &quot; &lt;&lt; resultantForce &lt;&lt; endl;
+	//bool log=((wall==3) &amp;&amp; (Omega::instance().getCurrentIteration()%200==0));
+	const bool log=false;
+	if(log) LOG_DEBUG(&quot;wall=&quot;&lt;&lt;wall&lt;&lt;&quot; actualForce=&quot;&lt;&lt;static_cast&lt;Force*&gt;(ncb-&gt;physicalActions-&gt;find(wall_id[wall],ForceClassIndex).get() )-&gt;force&lt;&lt;&quot;, resultantForce=&quot;&lt;&lt;resultantForce&lt;&lt;&quot;, translation=&quot;&lt;&lt;translation);
 	if (translation!=0)
 	{
 	   if (stiffness[wall]!=0)
 	   {
 			translation /= stiffness[wall];
+			if(log) TRVAR2(translation,wall_max_vel*Omega::instance().getTimeStep())
 			translation = std::min( abs(translation), wall_max_vel*Omega::instance().getTimeStep() ) * Mathr::Sign(translation);
 	   }
 	   else
 		translation = wall_max_vel * Mathr::Sign(translation);
 	}
 	previousTranslation[wall] = (1-wallDamping)*translation*normal[wall];// + 0.7*previousTranslation[wall];// formula for &quot;steady-flow&quot; evolution with fluctuations
-	p-&gt;se3.position	+= previousTranslation[wall];
+	p-&gt;se3.position += previousTranslation[wall];
+	if(log)TRVAR2(previousTranslation,p-&gt;se3.position);
 }
 
 
@@ -201,7 +205,7 @@
 	width = p_right-&gt;se3.position.X() - p_left-&gt;se3.position.X() - thickness;
 	depth = p_front-&gt;se3.position.Z() - p_back-&gt;se3.position.Z() - thickness;
  
-	bool isARadiusControlIteration = (Omega::instance().getCurrentIteration() % radiusControlInterval == 0);
+		bool isARadiusControlIteration = (Omega::instance().getCurrentIteration() % radiusControlInterval == 0);
 	if (Omega::instance().getCurrentIteration() % computeStressStrainInterval == 0 ||
 		 (internalCompaction &amp;&amp; isARadiusControlIteration) )
 		computeStressStrain(ncb);
@@ -222,15 +226,13 @@
 		if (isARadiusControlIteration) {
 			//Real s = computeStressStrain(ncb);
 			if (sigma_iso&lt;=meanStress) maxMultiplier = finalMaxMultiplier;
-			if (meanStress==0)
-				previousMultiplier = maxMultiplier;
+			if (meanStress==0) previousMultiplier = maxMultiplier;
 			else {
 				//     		previousMultiplier = 1+0.7*(sigma_iso-s)*(previousMultiplier-1.f)/(s-previousStress); // = (Dsigma/apparentModulus)*0.7
 				//     		previousMultiplier = std::max(2-maxMultiplier, std::min(previousMultiplier, maxMultiplier));
 				previousMultiplier = 1.+(sigma_iso-meanStress)/sigma_iso*(maxMultiplier-1.); // = (Dsigma/apparentModulus)*0.7
 			}
 			previousStress = meanStress;
-			//cerr &lt;&lt; &quot;maxMultiplier&quot; &lt;&lt; maxMultiplier &lt;&lt; endl;
 			//Real apparentModulus = (s-previousStress)/(previousMultiplier-1.f);
 			controlInternalStress(ncb, previousMultiplier);
 		}
@@ -262,12 +264,12 @@
 	stress[wall_right] = ( static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall_right],ForceClassIndex).get() )-&gt;force ) * invXSurface;
 	stress[wall_front] = ( static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall_front],ForceClassIndex).get() )-&gt;force ) * invZSurface;
 	stress[wall_back] = ( static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall_back],ForceClassIndex).get() )-&gt;force ) * invZSurface;	
-		
+
  	//cerr &lt;&lt; &quot;stresses : &quot; &lt;&lt;  stress[wall_bottom] &lt;&lt; &quot; &quot; &lt;&lt;
  //stress[wall_top]&lt;&lt; &quot; &quot; &lt;&lt; stress[wall_left]&lt;&lt; &quot; &quot; &lt;&lt; stress[wall_right]&lt;&lt; &quot; &quot;
  //&lt;&lt; stress[wall_front] &lt;&lt; &quot; &quot; &lt;&lt; stress[wall_back] &lt;&lt; endl;
 
-	for (int i=0; i&lt;6; i++) meanStress-= stress[i].Dot(normal[i]);
+	for (int i=0; i&lt;6; i++) meanStress-=stress[i].Dot(normal[i]);
 	meanStress/=6.;
 	// FIXME: meanStress is both returned as function value and stored in meanStress member. Confusing, change prototype to void, since return value isn't used anywhere.
 	return meanStress;
@@ -367,3 +369,4 @@
 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/DeusExMachina/WallStressRecorder.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/WallStressRecorder.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/DeusExMachina/WallStressRecorder.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -116,3 +116,4 @@
 	
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/EngineUnit/CohesiveFrictionalRelationships.cpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/CohesiveFrictionalRelationships.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/EngineUnit/CohesiveFrictionalRelationships.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -125,3 +125,4 @@
 		}
 	}
 };
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/EngineUnit/InteractingBox2InteractingSphere4SpheresContactGeometry.cpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/InteractingBox2InteractingSphere4SpheresContactGeometry.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/EngineUnit/InteractingBox2InteractingSphere4SpheresContactGeometry.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -165,3 +165,4 @@
 	return isInteracting;
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/EngineUnit/InteractingBox2InteractingSphere4SpheresContactGeometryWater.cpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/InteractingBox2InteractingSphere4SpheresContactGeometryWater.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/EngineUnit/InteractingBox2InteractingSphere4SpheresContactGeometryWater.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -187,3 +187,4 @@
 	return isInteracting;
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/EngineUnit/InteractingMyTetrahedron2AABB.cpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/InteractingMyTetrahedron2AABB.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/EngineUnit/InteractingMyTetrahedron2AABB.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -43,3 +43,4 @@
 	aabb-&gt;max = max;	
 }
 	
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/EngineUnit/InteractingMyTetrahedron2InteractingBox4InteractionOfMyTetrahedron.cpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/InteractingMyTetrahedron2InteractingBox4InteractionOfMyTetrahedron.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/EngineUnit/InteractingMyTetrahedron2InteractingBox4InteractionOfMyTetrahedron.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -131,3 +131,4 @@
 	return isInteracting;
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/EngineUnit/InteractingMyTetrahedron2InteractingMyTetrahedron4InteractionOfMyTetrahedron.cpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/InteractingMyTetrahedron2InteractingMyTetrahedron4InteractionOfMyTetrahedron.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/EngineUnit/InteractingMyTetrahedron2InteractingMyTetrahedron4InteractionOfMyTetrahedron.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -91,3 +91,4 @@
 	return isInteracting;
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2AABBwater.cpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2AABBwater.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2AABBwater.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -27,3 +27,4 @@
 
 }
 	
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4DistantSpheresContactGeometry.cpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4DistantSpheresContactGeometry.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4DistantSpheresContactGeometry.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -114,3 +114,4 @@
 	return go(cm1,cm2,se31,se32,c);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4SpheresContactGeometry.cpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4SpheresContactGeometry.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4SpheresContactGeometry.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -99,3 +99,4 @@
 	return go(cm1,cm2,se31,se32,c);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4SpheresContactGeometryWater.cpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4SpheresContactGeometryWater.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4SpheresContactGeometryWater.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -93,3 +93,4 @@
 	return go(cm1,cm2,se31,se32,c);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/EngineUnit/MacroMicroElasticRelationships.cpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/MacroMicroElasticRelationships.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/EngineUnit/MacroMicroElasticRelationships.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -128,3 +128,4 @@
 		}
 	}
 };
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/EngineUnit/MacroMicroElasticRelationshipsWater.cpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/MacroMicroElasticRelationshipsWater.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/EngineUnit/MacroMicroElasticRelationshipsWater.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -131,3 +131,4 @@
 		}
 	}
 };
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/EngineUnit/SimpleElasticRelationships.cpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/SimpleElasticRelationships.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/EngineUnit/SimpleElasticRelationships.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -98,3 +98,4 @@
 		}
 	}
 };
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/EngineUnit/Tetrahedron2InteractingMyTetrahedron.cpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/Tetrahedron2InteractingMyTetrahedron.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/EngineUnit/Tetrahedron2InteractingMyTetrahedron.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -32,3 +32,4 @@
 	it-&gt;r4 = it-&gt;c4.Length();
 }
 	
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/StandAloneEngine/AveragePositionRecorder.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/AveragePositionRecorder.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/StandAloneEngine/AveragePositionRecorder.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -81,3 +81,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/StandAloneEngine/CapillaryCohesiveLaw.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/CapillaryCohesiveLaw.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/StandAloneEngine/CapillaryCohesiveLaw.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -489,3 +489,4 @@
         os &lt;&lt; endl;
         return os;
 }
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/StandAloneEngine/CohesiveFrictionalContactLaw.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/CohesiveFrictionalContactLaw.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/StandAloneEngine/CohesiveFrictionalContactLaw.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -251,3 +251,4 @@
 
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/StandAloneEngine/ElasticCohesiveLaw.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/ElasticCohesiveLaw.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/StandAloneEngine/ElasticCohesiveLaw.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -40,7 +40,6 @@
 }
 
 
-//FIXME : remove bool first !!!!!
 void ElasticCohesiveLaw::action(Body* body)
 {
 	MetaBody * ncb = YADE_CAST&lt;MetaBody*&gt;(body);
@@ -142,46 +141,6 @@
 			t1.Normalize();
 			Vector3r t2	= n.UnitCross(t1);
 	
-	// 		if (n[0]!=0 &amp;&amp; n[1]!=0 &amp;&amp; n[2]!=0)
-	// 		{
-	// 			t1 = Vector3r(0,0,sqrt(1.0/(1+(n[2]*n[2]/(n[1]*n[1])))));
-	// 			t1[1] = -n[2]/n[1]*t1[2];
-	// 			t1.normalize();
-	// 			t2 = n.unitCross(t1);
-	// 		}
-	// 		else
-	// 		{
-	// 			if (n[0]==0 &amp;&amp; n[1]!=0 &amp;&amp; n[2]!=0)
-	// 			{
-	// 				t1 = Vector3r(1,0,0);
-	// 				t2 = n.unitCross(t1);
-	// 			}
-	// 			else if (n[0]!=0 &amp;&amp; n[1]==0 &amp;&amp; n[2]!=0)
-	// 			{
-	// 				t1 = Vector3r(0,1,0);
-	// 				t2 = n.unitCross(t1);
-	// 			}
-	// 			else if (n[0]!=0 &amp;&amp; n[1]!=0 &amp;&amp; n[2]==0)
-	// 			{
-	// 				t1 = Vector3r(0,0,1);
-	// 				t2 = n.unitCross(t1);
-	// 			}
-	// 			else if (n[0]==0 &amp;&amp; n[1]==0 &amp;&amp; n[2]!=0)
-	// 			{
-	// 				t1 = Vector3r(1,0,0);
-	// 				t2 = Vector3r(0,1,0);
-	// 			}
-	// 			else if (n[0]==0 &amp;&amp; n[1]!=0 &amp;&amp; n[2]==0)
-	// 			{
-	// 				t1 = Vector3r(0,0,1);
-	// 				t2 = Vector3r(1,0,0);
-	// 			}
-	// 			else if (n[0]!=0 &amp;&amp; n[1]==0 &amp;&amp; n[2]==0)
-	// 			{
-	// 				t1 = Vector3r(0,1,0);
-	// 				t2 = Vector3r(0,0,1);
-	// 			}
-	// 		}
 	
 			Quaternionr q_i_n,q_n_i;
 	
@@ -285,3 +244,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/StandAloneEngine/ElasticContactLaw.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/ElasticContactLaw.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/StandAloneEngine/ElasticContactLaw.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -6,7 +6,7 @@
 *  GNU General Public License v2 or later. See file LICENSE for details. *
 *************************************************************************/
 
-#include &quot;ElasticContactLaw.hpp&quot;
+#include&quot;ElasticContactLaw.hpp&quot;
 #include&lt;yade/pkg-dem/BodyMacroParameters.hpp&gt;
 #include&lt;yade/pkg-dem/SpheresContactGeometry.hpp&gt;
 #include&lt;yade/pkg-dem/SDECLinkGeometry.hpp&gt;
@@ -34,7 +34,6 @@
 }
 
 
-//FIXME : remove bool first !!!!!
 void ElasticContactLaw::action(Body* body)
 {
 	MetaBody * ncb = YADE_CAST&lt;MetaBody*&gt;(body);
@@ -131,3 +130,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/StandAloneEngine/ElasticCriterionTimeStepper.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/ElasticCriterionTimeStepper.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/StandAloneEngine/ElasticCriterionTimeStepper.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -77,6 +77,7 @@
 		return; // skip other groups
 
 	ElasticContactInteraction* sdecContact = dynamic_cast&lt;ElasticContactInteraction*&gt;(interaction-&gt;interactionPhysics.get());
+	// if(!sdecContact) sdecContact=dynamic_cast&lt;SDECLinkPhysics*&gt;(interaction-&gt;interactionPhysics.get());
 	SpheresContactGeometry* interactionGeometry = dynamic_cast&lt;SpheresContactGeometry*&gt;(interaction-&gt;interactionGeometry.get());
 	BodyMacroParameters * body1	= dynamic_cast&lt;BodyMacroParameters*&gt;((*bodies)[id1]-&gt;physicalParameters.get());
 	BodyMacroParameters * body2	= dynamic_cast&lt;BodyMacroParameters*&gt;((*bodies)[id2]-&gt;physicalParameters.get());
@@ -146,3 +147,4 @@
 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/StandAloneEngine/ForceRecorder.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/ForceRecorder.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/StandAloneEngine/ForceRecorder.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -77,3 +77,4 @@
 		
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/StandAloneEngine/GeometricalModelForceColorizer.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/GeometricalModelForceColorizer.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/StandAloneEngine/GeometricalModelForceColorizer.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -83,3 +83,4 @@
 		
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessCounter.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessCounter.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessCounter.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -21,6 +21,8 @@
 #include&lt;yade/pkg-dem/GlobalStiffness.hpp&gt;
 #include &quot;GlobalStiffnessCounter.hpp&quot;
 
+#include&lt;yade/extra/Brefcom.hpp&gt;
+
 GlobalStiffnessCounter::GlobalStiffnessCounter() : InteractionSolver() , actionForce(new Force) , actionMomentum(new Momentum), actionStiffness(new GlobalStiffness)
 {
 	interval=1;//FIXME very high frequency - not required 
@@ -45,15 +47,119 @@
 	return ((Omega::instance().getCurrentIteration() % interval == 0) || (Omega::instance().getCurrentIteration() &lt; 100));
 }
 
+
+bool GlobalStiffnessCounter::getSphericalElasticInteractionParameters(const shared_ptr&lt;Interaction&gt;&amp; contact, Vector3r&amp; normal, Real&amp; kn, Real&amp; ks, Real&amp; radius1, Real&amp; radius2){
+	shared_ptr&lt;SpheresContactGeometry&gt; currentContactGeometry=static_pointer_cast&lt;SpheresContactGeometry&gt;(contact-&gt;interactionGeometry);
+	shared_ptr&lt;ElasticContactInteraction&gt; currentContactPhysics=static_pointer_cast&lt;ElasticContactInteraction&gt;(contact-&gt;interactionPhysics);
+
+	Real fn=currentContactPhysics-&gt;normalForce.Length();
+	if(fn&lt;Mathr::EPSILON) return false; // FIXME: sharp comparison of floats will be false on machine-zeros (like 2.3333e-18 etc.): should be Mathr::EPSILON*someScaleFactor
+	normal=currentContactGeometry-&gt;normal;
+	radius1=currentContactGeometry-&gt;radius1; radius2=currentContactGeometry-&gt;radius2;
+	kn=currentContactPhysics-&gt;kn; ks=currentContactPhysics-&gt;ks;
+	return true;
+}
+
+bool GlobalStiffnessCounter::getInteractionParameters(const shared_ptr&lt;Interaction&gt;&amp; contact, Vector3r&amp; normal, Real&amp; kn, Real&amp; ks, Real&amp; radius1, Real&amp; radius2){
+
+	shared_ptr&lt;SpheresContactGeometry&gt; geom1=dynamic_pointer_cast&lt;SpheresContactGeometry&gt;(contact-&gt;interactionGeometry);
+	shared_ptr&lt;ElasticContactInteraction&gt; phys1=dynamic_pointer_cast&lt;ElasticContactInteraction&gt;(contact-&gt;interactionPhysics);
+	if(geom1 &amp;&amp; phys1){
+		Real fn=phys1-&gt;normalForce.Length();
+		if(fn&lt;Mathr::EPSILON) return false; // FIXME: sharp comparison of floats will be false on machine-zeros (like 2.3333e-18 etc.): should be Mathr::EPSILON*someScaleFactor
+		normal=geom1-&gt;normal;
+		radius1=geom1-&gt;radius1; radius2=geom1-&gt;radius2;
+		kn=phys1-&gt;kn; ks=phys1-&gt;ks;
+		return true;
+	}
+
+	shared_ptr&lt;SpheresContactGeometry&gt; geom2=dynamic_pointer_cast&lt;SpheresContactGeometry&gt;(contact-&gt;interactionGeometry);
+	shared_ptr&lt;BrefcomContact&gt; phys2=dynamic_pointer_cast&lt;BrefcomContact&gt;(contact-&gt;interactionPhysics);
+	if(geom2 &amp;&amp; phys2){
+		Real fn=phys2-&gt;Fn.Length();
+		if(fn&lt;Mathr::EPSILON) return false; // FIXME: sharp comparison of floats will be false on machine-zeros (like 2.3333e-18 etc.): should be Mathr::EPSILON*someScaleFactor
+		normal=geom2-&gt;normal;
+		radius1=geom2-&gt;radius1; radius2=geom2-&gt;radius2;
+		kn=phys2-&gt;Kn; ks=phys2-&gt;Ks;
+		return true;
+	}
+
+	shared_ptr&lt;SDECLinkGeometry&gt; geom3=dynamic_pointer_cast&lt;SDECLinkGeometry&gt;(contact-&gt;interactionGeometry);
+	shared_ptr&lt;SDECLinkPhysics&gt; phys3=dynamic_pointer_cast&lt;SDECLinkPhysics&gt;(contact-&gt;interactionPhysics);
+	if(geom3 &amp;&amp; phys3){
+		Real fn=phys3-&gt;normalForce.Length();
+		if(fn&lt;Mathr::EPSILON) return false; // FIXME: sharp comparison of floats will be false on machine-zeros (like 2.3333e-18 etc.): should be Mathr::EPSILON*someScaleFactor
+		normal=geom3-&gt;normal;
+		radius1=geom3-&gt;radius1; radius2=geom3-&gt;radius2;
+		kn=phys3-&gt;kn; ks=phys3-&gt;ks;
+		return true;
+	}
+
+	return false;
+}
+
+void GlobalStiffnessCounter::traverseInteractions(MetaBody* ncb, const shared_ptr&lt;InteractionContainer&gt;&amp; interactions, bool spheresOnly){
+	for(InteractionContainer::iterator I=interactions-&gt;begin(); I!=interactions-&gt;end(); ++I){
+		const shared_ptr&lt;Interaction&gt;&amp; contact = *I;
+		if(!contact-&gt;isReal) continue;
+
+		body_id_t id1=contact-&gt;getId1(), id2=contact-&gt;getId2();
+
+		// all we need for getting stiffness
+		Vector3r normal; Real kn, ks, radius1, radius2;
+
+		/* This is to overcome class scatter:
+		 * 	SpheresContactGeometry &amp; ElasticContactInteraction
+		 * 	or
+		 * 	SDECLinkGeometry &amp; SDECLinkPhysics
+		 * 	or
+		 * 	SpheresContactGeometry &amp; BrefcomContact
+		 */
+		if(spheresOnly){ // go fast, may CRASH for non-spherical stuff however (!)
+			if(!getSphericalElasticInteractionParameters(contact, normal, kn, ks, radius1, radius2)) continue;
+		} else {
+			if(!getInteractionParameters(contact,normal,kn,ks,radius1,radius2)) continue;
+		}
+
+			
+		//Diagonal terms of the translational stiffness matrix
+		Vector3r diag_stiffness = Vector3r(std::pow(normal.X(),2),std::pow(normal.Y(),2),std::pow(normal.Z(),2));
+		diag_stiffness *= kn-ks;
+		diag_stiffness = diag_stiffness + Vector3r(1,1,1)*ks;
+
+		//diagonal terms of the rotational stiffness matrix
+		// Vector3r branch1 = currentContactGeometry-&gt;normal*currentContactGeometry-&gt;radius1;
+		// Vector3r branch2 = currentContactGeometry-&gt;normal*currentContactGeometry-&gt;radius2;
+		Vector3r diag_Rstiffness =
+			Vector3r(std::pow(normal.Y(),2)+std::pow(normal.Z(),2),
+				std::pow(normal.X(),2)+std::pow(normal.Z(),2),
+				std::pow(normal.X(),2)+std::pow(normal.Y(),2));
+		diag_Rstiffness *= ks;
+		//cerr &lt;&lt; &quot;diag_Rstifness=&quot; &lt;&lt; diag_Rstiffness &lt;&lt; endl;
+
+		PhysicalAction* st = ncb-&gt;physicalActions-&gt;find(id1,actionStiffness-&gt;getClassIndex()).get();
+		GlobalStiffness* s = static_cast&lt;GlobalStiffness*&gt;(st);
+		s-&gt;stiffness += diag_stiffness;
+		s-&gt;Rstiffness += diag_Rstiffness*pow(radius1,2);	
+		st = ncb-&gt;physicalActions-&gt;find(id2,actionStiffness-&gt;getClassIndex()).get();
+		s = static_cast&lt;GlobalStiffness*&gt;(st);
+		s-&gt;stiffness += diag_stiffness;
+		s-&gt;Rstiffness += diag_Rstiffness*pow(radius2,2);
+	}
+}
+
 void GlobalStiffnessCounter::action(Body* body)
 {
-        MetaBody * ncb = YADE_CAST&lt;MetaBody*&gt;(body);
-//        shared_ptr&lt;BodyContainer&gt;&amp; bodies = ncb-&gt;bodies;
+	MetaBody * ncb = YADE_CAST&lt;MetaBody*&gt;(body);
+	// shared_ptr&lt;BodyContainer&gt;&amp; bodies = ncb-&gt;bodies;
+	//	Real dt = Omega::instance().getTimeStep();
 
-//        Real dt = Omega::instance().getTimeStep();
+	/// transient Links
+	traverseInteractions(ncb,ncb-&gt;transientInteractions, /*spheresOnly? */ false);
 
-        /// Non Permanents Links												///
-
+	/* ignore pesistent links, unused */
+	// traverseInteractions(ncb,ncb-&gt;persistentInteractions);
+#if 0
         InteractionContainer::iterator ii    = ncb-&gt;transientInteractions-&gt;begin();
         InteractionContainer::iterator iiEnd = ncb-&gt;transientInteractions-&gt;end();
         //cerr &lt;&lt; &quot;#############################################################################################&quot; &lt;&lt; endl;
@@ -107,7 +213,9 @@
                         }
                 }
         }
+#endif
 }
 
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessCounter.hpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessCounter.hpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessCounter.hpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -29,9 +29,11 @@
 		int actionForceIndex;
 		int actionMomentumIndex;
 		int actionStiffnessIndex;
-		
-		
 
+		bool getInteractionParameters(const shared_ptr&lt;Interaction&gt;&amp; contact, Vector3r&amp; normal, Real&amp; kn, Real&amp; ks, Real&amp; radius1, Real&amp; radius2);
+		bool getSphericalElasticInteractionParameters(const shared_ptr&lt;Interaction&gt;&amp; contact, Vector3r&amp; normal, Real&amp; kn, Real&amp; ks, Real&amp; radius1, Real&amp; radius2);
+		void traverseInteractions(MetaBody* ncb, const shared_ptr&lt;InteractionContainer&gt;&amp; interactions, bool spheresOnly=false);
+
 	public :
 		unsigned int interval;
 		int sdecGroupMask;

Modified: trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessTimeStepper.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessTimeStepper.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessTimeStepper.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -51,14 +51,14 @@
 {
 	RigidBodyParameters * sdec	= static_cast&lt;RigidBodyParameters*&gt;(body-&gt;physicalParameters.get());
 	
-	Sphere* sphere = static_cast&lt;Sphere*&gt;(body-&gt;geometricalModel.get());
+	// Sphere* sphere = static_cast&lt;Sphere*&gt;(body-&gt;geometricalModel.get());
 	
 	Vector3r&amp; stiffness = (static_cast&lt;GlobalStiffness*&gt;( ncb-&gt;physicalActions-&gt;find (body-&gt;getId(), globalStiffnessClassIndex).get()))-&gt;stiffness;
 	Vector3r&amp; Rstiffness = (static_cast&lt;GlobalStiffness*&gt;( ncb-&gt;physicalActions-&gt;find (body-&gt;getId(), globalStiffnessClassIndex).get()))-&gt;Rstiffness;
 
 
 	//cerr &lt;&lt; &quot;Vector3r&amp; stiffness = (static_cast&lt;GlobalStiffness*&gt;( ncb&quot; &lt;&lt; endl;
-	if(! (sphere &amp;&amp; sdec &amp;&amp; stiffness) )
+	if(! ( /* sphere &amp;&amp; */ sdec &amp;&amp; stiffness) )
 		return; // not possible to compute!
 	//cerr &lt;&lt; &quot;return; // not possible to compute!&quot; &lt;&lt; endl;
 // 	Real Dab  	= sphere-&gt;radius;
@@ -183,3 +183,4 @@
 		string(&quot;, BUT timestep is &quot;)+lexical_cast&lt;string&gt;(Omega::instance().getTimeStep()))&lt;&lt;&quot;.&quot;);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/StandAloneEngine/MyTetrahedronLaw.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/MyTetrahedronLaw.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/StandAloneEngine/MyTetrahedronLaw.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -89,3 +89,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/StandAloneEngine/PositionOrientationRecorder.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/PositionOrientationRecorder.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/StandAloneEngine/PositionOrientationRecorder.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -82,3 +82,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/Engine/StandAloneEngine/VelocityRecorder.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/VelocityRecorder.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/Engine/StandAloneEngine/VelocityRecorder.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -81,3 +81,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/PreProcessor/CohesiveTriaxialTest.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/CohesiveTriaxialTest.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/PreProcessor/CohesiveTriaxialTest.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -790,3 +790,4 @@
 
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/PreProcessor/Funnel.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/Funnel.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/PreProcessor/Funnel.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -356,3 +356,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/PreProcessor/HydraulicTest.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/HydraulicTest.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/PreProcessor/HydraulicTest.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -308,3 +308,4 @@
 	return true;
 };
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/PreProcessor/ModifiedTriaxialTest.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/ModifiedTriaxialTest.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/PreProcessor/ModifiedTriaxialTest.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -791,3 +791,4 @@
 
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/PreProcessor/SDECImpactTest.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/SDECImpactTest.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/PreProcessor/SDECImpactTest.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -560,3 +560,4 @@
 	
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/PreProcessor/SDECLinkedSpheres.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/SDECLinkedSpheres.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/PreProcessor/SDECLinkedSpheres.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -409,3 +409,4 @@
 	
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/PreProcessor/SDECMovingWall.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/SDECMovingWall.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/PreProcessor/SDECMovingWall.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -451,3 +451,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/PreProcessor/SDECSpheresPlane.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/SDECSpheresPlane.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/PreProcessor/SDECSpheresPlane.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -413,3 +413,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/PreProcessor/TetrahedronsTest.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/TetrahedronsTest.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/PreProcessor/TetrahedronsTest.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -429,3 +429,4 @@
 	tet-&gt;v[3]=size*(Mathr::UnitRandom()*0.7+1.0)*Vector3r(0.16,0.93,-0.33);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/PreProcessor/ThreePointBending.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/ThreePointBending.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/PreProcessor/ThreePointBending.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -432,3 +432,4 @@
 	
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/PreProcessor/TriaxialTest.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/TriaxialTest.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/PreProcessor/TriaxialTest.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -16,6 +16,7 @@
 #include &quot;TriaxialTest.hpp&quot;
 
 #include&lt;yade/pkg-dem/ElasticContactLaw.hpp&gt;
+#include&lt;yade/pkg-dem/ElasticCohesiveLaw.hpp&gt;
 #include&lt;yade/pkg-dem/SimpleElasticRelationships.hpp&gt;
 #include&lt;yade/pkg-dem/BodyMacroParameters.hpp&gt;
 #include&lt;yade/pkg-dem/SDECLinkGeometry.hpp&gt;
@@ -65,6 +66,8 @@
 #include&lt;yade/pkg-common/InteractionHashMap.hpp&gt;
 #include&lt;yade/pkg-common/PhysicalActionVectorVector.hpp&gt;
 
+#include&lt;yade/extra/Shop.hpp&gt;
+
 #include &lt;boost/filesystem/convenience.hpp&gt;
 #include &lt;boost/lexical_cast.hpp&gt;
 #include &lt;boost/numeric/conversion/bounds.hpp&gt;
@@ -92,7 +95,7 @@
 	lowerCorner 		= Vector3r(0,0,0);
 	upperCorner 		= Vector3r(1,1,1);
 	thickness 		= 0.001;
-	importFilename 		= &quot;../data/small.sdec.xyz&quot;;
+	importFilename 		= &quot;&quot;; // &quot;../data/small.sdec.xyz&quot;;
 	outputFileName 		= &quot;../data/TriaxialTest.xml&quot;;
 	//nlayers = 1;
 	wall_top 		= true;
@@ -146,6 +149,7 @@
 	radiusControlInterval = 10;
 	numberOfGrains = 400;
 	strainRate = 0.1;
+	maxWallVelocity=0.01;
 	StabilityCriterion = 0.01;
 	autoCompressionActivation = false;
 	maxMultiplier = 1.01;
@@ -163,6 +167,8 @@
 	
 	sigmaIsoCompaction = 50000;
 	sigmaLateralConfinement=sigmaIsoCompaction;
+
+	wallOversizeFactor=1.;
 	
 //	wall_top_id =0;
 // 	wall_bottom_id =0;
@@ -211,6 +217,7 @@
 	REGISTER_ATTRIBUTE(radiusControlInterval);
 	REGISTER_ATTRIBUTE(numberOfGrains);
 	REGISTER_ATTRIBUTE(strainRate);
+	REGISTER_ATTRIBUTE(maxWallVelocity);
 	REGISTER_ATTRIBUTE(StabilityCriterion);
 	REGISTER_ATTRIBUTE(autoCompressionActivation);
 //	REGISTER_ATTRIBUTE(wall_top);
@@ -237,6 +244,8 @@
 	REGISTER_ATTRIBUTE(AnimationSnapshotsBaseName);
 	REGISTER_ATTRIBUTE(WallStressRecordFile);
 
+	REGISTER_ATTRIBUTE(wallOversizeFactor);
+
 //	REGISTER_ATTRIBUTE(gravity);
 	
 	//REGISTER_ATTRIBUTE(bigBall);
@@ -257,6 +266,7 @@
 bool TriaxialTest::generate()
 {
 //	unsigned int startId=boost::numeric::bounds&lt;unsigned int&gt;::highest(), endId=0; // record forces from group 2
+	message=&quot;&quot;;
 	
 	rootBody = shared_ptr&lt;MetaBody&gt;(new MetaBody);
 	createActors(rootBody);
@@ -272,66 +282,19 @@
 	shared_ptr&lt;Body&gt; body;
 	
 	vector&lt;BasicSphere&gt; sphere_list;
-	message=GenerateCloud(sphere_list, lowerCorner, upperCorner, numberOfGrains, 0.3, 0.75);
+	if(importFilename!=&quot;&quot;) sphere_list=Shop::loadSpheresFromFile(importFilename,lowerCorner,upperCorner);
+	else message+=GenerateCloud(sphere_list, lowerCorner, upperCorner, numberOfGrains, 0.3, 0.75);
 	
 	vector&lt;BasicSphere&gt;::iterator it = sphere_list.begin();
 	vector&lt;BasicSphere&gt;::iterator it_end = sphere_list.end();
 			
 	for (;it!=it_end; ++it)
 	{
-		cerr &lt;&lt; &quot;sphere (&quot; &lt;&lt; it-&gt;first &lt;&lt; &quot; &quot; &lt;&lt; it-&gt;second &lt;&lt; endl;
+		cerr &lt;&lt; &quot;sphere (&quot; &lt;&lt; it-&gt;first &lt;&lt; &quot; &quot; &lt;&lt; it-&gt;second &lt;&lt; &quot;)&quot;&lt;&lt;endl;
 		createSphere(body,it-&gt;first,it-&gt;second,false,true);
 		rootBody-&gt;bodies-&gt;insert(body);
 	}
 	
-// 	if(importFilename.size() != 0 &amp;&amp; filesystem::exists(importFilename) )
-// 	{
-// 		
-// 		Vector3r layersDistance (Vector3r::ZERO); 
-// 		for (int layer=1; layer &lt;= nlayers; ++layer)
-// 		{			
-// 			ifstream loadFile(importFilename.c_str());
-// 			long int i=0;
-// 			Real f,g,x,y,z,radius;
-// 			while( ! loadFile.eof() )
-// 			{
-// 				++i;
-// 				loadFile &gt;&gt; x;
-// 				loadFile &gt;&gt; y;
-// 				loadFile &gt;&gt; z;
-// 				Vector3r position = (Vector3r(x,z,y) + layersDistance);
-// 				loadFile &gt;&gt; radius;
-// 			
-// 				loadFile &gt;&gt; f;
-// 				loadFile &gt;&gt; g;
-// 				if( boxWalls ? f&gt;1 : false ) // skip loading of SDEC walls
-// 					continue;
-// 				if(f==8)
-// 					continue;
-// 	
-// 		//		if( i % 100 == 0 ) // FIXME - should display a progress BAR !!
-// 		//			cout &lt;&lt; &quot;loaded: &quot; &lt;&lt; i &lt;&lt; endl;
-// 				if(f==1)
-// 				{
-// 					lowerCorner[0] = min(position[0]-radius , lowerCorner[0]);
-// 					lowerCorner[1] = min(position[1]-radius , lowerCorner[1]);
-// 					lowerCorner[2] = min(position[2]-radius , lowerCorner[2]);
-// 					upperCorner[0] = max(position[0]+radius , upperCorner[0]);
-// 					upperCorner[1] = max(position[1]+radius , upperCorner[1]);
-// 					upperCorner[2] = max(position[2]+radius , upperCorner[2]);
-// 				}
-// 				createSphere(body,position,radius,false,f==1);
-// 				rootBody-&gt;bodies-&gt;insert(body);
-// 				if(f == 2)
-// 				{
-// 					startId = std::min(body-&gt;getId() , startId);
-// 					endId   = std::max(body-&gt;getId() , endId);
-// 				}
-// 					
-// 			}
-// 			layersDistance.y() = upperCorner.y();
-// 		}
-// 	}
 
 // create bigBall
 	//Vector3r position = (upperCorner+lowerCorner)*0.5 + Vector3r(0,bigBallDropHeight,0);
@@ -353,9 +316,9 @@
 	 						lowerCorner[1]-thickness/2.0,
 	 						(lowerCorner[2]+upperCorner[2])/2);
 	 	Vector3r halfSize	= Vector3r(
-	 						fabs(lowerCorner[0]-upperCorner[0])/2+thickness,
+	 						wallOversizeFactor*fabs(lowerCorner[0]-upperCorner[0])/2+thickness,
 							thickness/2.0,
-	 						fabs(lowerCorner[2]-upperCorner[2])/2+thickness);
+	 						wallOversizeFactor*fabs(lowerCorner[2]-upperCorner[2])/2+thickness);
 	
 		createBox(body,center,halfSize,wall_bottom_wire);
 	 	if(wall_bottom) {
@@ -374,9 +337,9 @@
 	 						upperCorner[1]+thickness/2.0,
 	 						(lowerCorner[2]+upperCorner[2])/2);
 	 	halfSize		= Vector3r(
-	 						fabs(lowerCorner[0]-upperCorner[0])/2+thickness,
+	 						wallOversizeFactor*fabs(lowerCorner[0]-upperCorner[0])/2+thickness,
 	 						thickness/2.0,
-	 						fabs(lowerCorner[2]-upperCorner[2])/2+thickness);
+	 						wallOversizeFactor*fabs(lowerCorner[2]-upperCorner[2])/2+thickness);
 	
 		createBox(body,center,halfSize,wall_top_wire);
 	 	if(wall_top) {
@@ -392,8 +355,8 @@
 	 						(lowerCorner[2]+upperCorner[2])/2);
 		halfSize		= Vector3r(
 							thickness/2.0,
-	 						fabs(lowerCorner[1]-upperCorner[1])/2+thickness,
-	 						fabs(lowerCorner[2]-upperCorner[2])/2+thickness);
+	 						wallOversizeFactor*fabs(lowerCorner[1]-upperCorner[1])/2+thickness,
+	 						wallOversizeFactor*fabs(lowerCorner[2]-upperCorner[2])/2+thickness);
 		createBox(body,center,halfSize,wall_1_wire);
 	 	if(wall_1) {
 			rootBody-&gt;bodies-&gt;insert(body);
@@ -407,8 +370,8 @@
 							(lowerCorner[2]+upperCorner[2])/2);
 	 	halfSize		= Vector3r(
 	 						thickness/2.0,
-	 						fabs(lowerCorner[1]-upperCorner[1])/2+thickness,
-	 						fabs(lowerCorner[2]-upperCorner[2])/2+thickness);
+	 						wallOversizeFactor*fabs(lowerCorner[1]-upperCorner[1])/2+thickness,
+	 						wallOversizeFactor*fabs(lowerCorner[2]-upperCorner[2])/2+thickness);
 	 	
 		createBox(body,center,halfSize,wall_2_wire);
 	 	if(wall_2) {
@@ -422,8 +385,8 @@
 	 						(lowerCorner[1]+upperCorner[1])/2,
 	 						lowerCorner[2]-thickness/2.0);
 	 	halfSize		= Vector3r(
-	 						fabs(lowerCorner[0]-upperCorner[0])/2+thickness,
-	 						fabs(lowerCorner[1]-upperCorner[1])/2+thickness,
+	 						wallOversizeFactor*fabs(lowerCorner[0]-upperCorner[0])/2+thickness,
+	 						wallOversizeFactor*fabs(lowerCorner[1]-upperCorner[1])/2+thickness,
 	 						thickness/2.0);
 		createBox(body,center,halfSize,wall_3_wire);
 	 	if(wall_3) {
@@ -438,8 +401,8 @@
 	 						(lowerCorner[1]+upperCorner[1])/2,
 	 						upperCorner[2]+thickness/2.0);
 	 	halfSize		= Vector3r(
-	 						fabs(lowerCorner[0]-upperCorner[0])/2+thickness,
-	 						fabs(lowerCorner[1]-upperCorner[1])/2+thickness,
+	 						wallOversizeFactor*fabs(lowerCorner[0]-upperCorner[0])/2+thickness,
+	 						wallOversizeFactor*fabs(lowerCorner[1]-upperCorner[1])/2+thickness,
 	 						thickness/2.0);
 		createBox(body,center,halfSize,wall_3_wire);
 	 	if(wall_4) {
@@ -632,6 +595,11 @@
 	
 	shared_ptr&lt;ElasticContactLaw&gt; elasticContactLaw(new ElasticContactLaw);
 	elasticContactLaw-&gt;sdecGroupMask = 2;
+
+	shared_ptr&lt;ElasticCohesiveLaw&gt; elasticCohesiveLaw(new ElasticCohesiveLaw);
+	elasticCohesiveLaw-&gt;sdecGroupMask = 2;
+	elasticCohesiveLaw-&gt;momentRotationLaw = true;
+
 	
 	//shared_ptr&lt;StiffnessCounter&gt; stiffnesscounter(new StiffnessCounter);
 	//stiffnesscounter-&gt;sdecGroupMask = 2;
@@ -649,7 +617,7 @@
 	//triaxialcompressionEngine-&gt; sigma_iso = sigma_iso;
 	triaxialcompressionEngine-&gt; sigmaIsoCompaction = sigmaIsoCompaction;
 	triaxialcompressionEngine-&gt; sigmaLateralConfinement = sigmaLateralConfinement;
-	triaxialcompressionEngine-&gt; max_vel = 0.01;
+	triaxialcompressionEngine-&gt;max_vel = maxWallVelocity;
 	triaxialcompressionEngine-&gt; thickness = thickness;
 	triaxialcompressionEngine-&gt;strainRate = strainRate;
 	triaxialcompressionEngine-&gt;StabilityCriterion = StabilityCriterion;
@@ -687,6 +655,7 @@
 	rootBody-&gt;engines.push_back(interactionGeometryDispatcher);
 	rootBody-&gt;engines.push_back(interactionPhysicsDispatcher);
 	rootBody-&gt;engines.push_back(elasticContactLaw);
+	rootBody-&gt;engines.push_back(elasticCohesiveLaw);
 	rootBody-&gt;engines.push_back(triaxialcompressionEngine);
 	//rootBody-&gt;engines.push_back(stiffnesscounter);
 	//rootBody-&gt;engines.push_back(stiffnessMatrixTimeStepper);
@@ -745,7 +714,6 @@
 }
 
 
-
 string GenerateCloud(vector&lt;BasicSphere&gt;&amp; sphere_list, Vector3r lowerCorner, Vector3r upperCorner, long number, Real rad_std_dev, Real porosity)
 {
 	typedef boost::minstd_rand StdGenerator;
@@ -793,3 +761,4 @@
 
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/PreProcessor/TriaxialTest.hpp
===================================================================
--- trunk/pkg/dem/PreProcessor/TriaxialTest.hpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/PreProcessor/TriaxialTest.hpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -74,10 +74,12 @@
 				
 				sigmaIsoCompaction,
 				sigmaLateralConfinement,
-				strainRate
-				,StabilityCriterion
-				,maxMultiplier ///max multiplier of diameters during internal compaction
-				,finalMaxMultiplier;
+				strainRate,
+				maxWallVelocity,
+				StabilityCriterion,
+				maxMultiplier, ///max multiplier of diameters during internal compaction
+				finalMaxMultiplier,
+				wallOversizeFactor; // make walls bigger (/smaller) than necessary by this factor
 
 		bool		 wall_top
 				,wall_bottom

Modified: trunk/pkg/dem/PreProcessor/TriaxialTestWater.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/TriaxialTestWater.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/PreProcessor/TriaxialTestWater.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -747,3 +747,4 @@
 
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/RenderingEngine/GLDrawInteractingMyTetrahedron/GLDrawInteractingMyTetrahedron.cpp
===================================================================
--- trunk/pkg/dem/RenderingEngine/GLDrawInteractingMyTetrahedron/GLDrawInteractingMyTetrahedron.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/RenderingEngine/GLDrawInteractingMyTetrahedron/GLDrawInteractingMyTetrahedron.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -36,3 +36,4 @@
 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/RenderingEngine/GLDrawSDECLinkGeometry/GLDrawSDECLinkGeometry.cpp
===================================================================
--- trunk/pkg/dem/RenderingEngine/GLDrawSDECLinkGeometry/GLDrawSDECLinkGeometry.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/RenderingEngine/GLDrawSDECLinkGeometry/GLDrawSDECLinkGeometry.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -81,3 +81,4 @@
 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/RenderingEngine/GLDrawSpheresContactGeometry/GLDrawSpheresContactGeometry.cpp
===================================================================
--- trunk/pkg/dem/RenderingEngine/GLDrawSpheresContactGeometry/GLDrawSpheresContactGeometry.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/RenderingEngine/GLDrawSpheresContactGeometry/GLDrawSpheresContactGeometry.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -78,3 +78,4 @@
 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/dem/SConscript
===================================================================
--- trunk/pkg/dem/SConscript	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/dem/SConscript	2008-02-04 10:36:31 UTC (rev 1242)
@@ -162,7 +162,7 @@
 			'BodyMacroParameters',
 			'yade-serialization',
 			'yade-base',
-			
+			'GLDrawInteractingSphere',
 			'yade-multimethods',
 			'Force',
 			'Momentum',
@@ -236,7 +236,8 @@
 			'Momentum',
 			'Sphere',
 			'RigidBodyParameters',
-			'GlobalStiffness']),
+			'GlobalStiffness',
+			'Brefcom']),
 
 	env.SharedLibrary('GlobalStiffnessTimeStepper',
 		['Engine/StandAloneEngine/GlobalStiffnessTimeStepper.cpp'],
@@ -254,7 +255,7 @@
 
 	env.SharedLibrary('ResultantForceEngine',
 		['Engine/DeusExMachina/ResultantForceEngine.cpp'],
-		LIBS=env['LIBS']+['yade-factory',
+		LIBS=env['LIBS']+[
 			'yade-base',		
 			'Force',
 			'ParticleParameters',
@@ -262,7 +263,7 @@
 
 	env.SharedLibrary('TriaxialStressController',
 		['Engine/DeusExMachina/TriaxialStressController.cpp'],
-		LIBS=env['LIBS']+['yade-factory',
+		LIBS=env['LIBS']+[
 			'yade-base',
 			'Force',
 			'ParticleParameters',
@@ -273,12 +274,13 @@
 
 	env.SharedLibrary('TriaxialCompressionEngine',
 		['Engine/DeusExMachina/TriaxialCompressionEngine.cpp'],
-		LIBS=env['LIBS']+['yade-factory',
+		LIBS=env['LIBS']+[
 			'yade-base',
 			'Force',
 			'ParticleParameters',
 			'ElasticContactInteraction',
-			'TriaxialStressController']),
+			'TriaxialStressController',
+			'Shop']),
 
 	env.SharedLibrary('GLDrawInteractingMyTetrahedron',
 		['RenderingEngine/GLDrawInteractingMyTetrahedron/GLDrawInteractingMyTetrahedron.cpp'],
@@ -548,7 +550,8 @@
 			'GlobalStiffnessTimeStepper',
 			'yade-base',
 			'TriaxialStateRecorder',
-			'PositionOrientationRecorder']),
+			'PositionOrientationRecorder',
+			'Shop']),
 			
 	env.SharedLibrary('CohesiveTriaxialTest',
 		['PreProcessor/CohesiveTriaxialTest.cpp'],

Modified: trunk/pkg/fem/DataClass/GeometricalModel/FEMSetGeometry.cpp
===================================================================
--- trunk/pkg/fem/DataClass/GeometricalModel/FEMSetGeometry.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/fem/DataClass/GeometricalModel/FEMSetGeometry.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -21,3 +21,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/fem/DataClass/PhysicalParameters/FEMNodeData.cpp
===================================================================
--- trunk/pkg/fem/DataClass/PhysicalParameters/FEMNodeData.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/fem/DataClass/PhysicalParameters/FEMNodeData.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -27,3 +27,4 @@
 	REGISTER_ATTRIBUTE(initialPosition);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/fem/DataClass/PhysicalParameters/FEMSetParameters.cpp
===================================================================
--- trunk/pkg/fem/DataClass/PhysicalParameters/FEMSetParameters.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/fem/DataClass/PhysicalParameters/FEMSetParameters.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -30,3 +30,4 @@
 	REGISTER_ATTRIBUTE(tetrahedronGroupMask);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/fem/DataClass/PhysicalParameters/FEMTetrahedronData.cpp
===================================================================
--- trunk/pkg/fem/DataClass/PhysicalParameters/FEMTetrahedronData.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/fem/DataClass/PhysicalParameters/FEMTetrahedronData.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -188,3 +188,4 @@
 	damping = Damp * mass ;
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/fem/Engine/EngineUnit/FEMSet2Tetrahedrons.cpp
===================================================================
--- trunk/pkg/fem/Engine/EngineUnit/FEMSet2Tetrahedrons.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/fem/Engine/EngineUnit/FEMSet2Tetrahedrons.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -43,3 +43,4 @@
 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/fem/Engine/EngineUnit/FEMSetTextLoader.cpp
===================================================================
--- trunk/pkg/fem/Engine/EngineUnit/FEMSetTextLoader.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/fem/Engine/EngineUnit/FEMSetTextLoader.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -134,3 +134,4 @@
 	body-&gt;physicalParameters	= physics;
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/fem/Engine/EngineUnit/FEMTetrahedronStiffness.cpp
===================================================================
--- trunk/pkg/fem/Engine/EngineUnit/FEMTetrahedronStiffness.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/fem/Engine/EngineUnit/FEMTetrahedronStiffness.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -35,3 +35,4 @@
 	}
 	
 }
+YADE_PLUGIN();

Modified: trunk/pkg/fem/Engine/StandAloneEngine/FEMLaw.cpp
===================================================================
--- trunk/pkg/fem/Engine/StandAloneEngine/FEMLaw.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/fem/Engine/StandAloneEngine/FEMLaw.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -88,3 +88,4 @@
 
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/fem/PreProcessor/FEMBeam.cpp
===================================================================
--- trunk/pkg/fem/PreProcessor/FEMBeam.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/fem/PreProcessor/FEMBeam.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -255,3 +255,4 @@
 }
 
  
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/DataClass/GeometricalModel/LatticeSetGeometry.cpp
===================================================================
--- trunk/pkg/lattice/DataClass/GeometricalModel/LatticeSetGeometry.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/DataClass/GeometricalModel/LatticeSetGeometry.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -21,3 +21,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/DataClass/GeometricalModel/LineSegment.cpp
===================================================================
--- trunk/pkg/lattice/DataClass/GeometricalModel/LineSegment.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/DataClass/GeometricalModel/LineSegment.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -23,3 +23,4 @@
 //	REGISTER_ATTRIBUTE(length); // no need to save it
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/DataClass/InteractingGeometry/LatticeInteractingGeometry.cpp
===================================================================
--- trunk/pkg/lattice/DataClass/InteractingGeometry/LatticeInteractingGeometry.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/DataClass/InteractingGeometry/LatticeInteractingGeometry.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -19,3 +19,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/DataClass/InteractionPhysics/LatticeBeamAngularSpring.cpp
===================================================================
--- trunk/pkg/lattice/DataClass/InteractionPhysics/LatticeBeamAngularSpring.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/DataClass/InteractionPhysics/LatticeBeamAngularSpring.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -49,3 +49,4 @@
 //	REGISTER_ATTRIBUTE(offPlaneAngle); // FIXME - can be calculated after deserialization
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/DataClass/InteractionPhysics/NonLocalDependency.cpp
===================================================================
--- trunk/pkg/lattice/DataClass/InteractionPhysics/NonLocalDependency.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/DataClass/InteractionPhysics/NonLocalDependency.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -26,3 +26,4 @@
 	REGISTER_ATTRIBUTE(gaussValue);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/DataClass/PhysicalParameters/LatticeBeamParameters.cpp
===================================================================
--- trunk/pkg/lattice/DataClass/PhysicalParameters/LatticeBeamParameters.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/DataClass/PhysicalParameters/LatticeBeamParameters.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -166,3 +166,4 @@
 	REGISTER_ATTRIBUTE(se3Displacement);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/DataClass/PhysicalParameters/LatticeNodeParameters.cpp
===================================================================
--- trunk/pkg/lattice/DataClass/PhysicalParameters/LatticeNodeParameters.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/DataClass/PhysicalParameters/LatticeNodeParameters.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -28,3 +28,4 @@
 	PhysicalParameters::registerAttributes();
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/DataClass/PhysicalParameters/LatticeSetParameters.cpp
===================================================================
--- trunk/pkg/lattice/DataClass/PhysicalParameters/LatticeSetParameters.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/DataClass/PhysicalParameters/LatticeSetParameters.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -37,3 +37,4 @@
         REGISTER_ATTRIBUTE(useStiffnessSoftening);
 }
  
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/Engine/EngineUnit/LatticeSet2LatticeBeams.cpp
===================================================================
--- trunk/pkg/lattice/Engine/EngineUnit/LatticeSet2LatticeBeams.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/Engine/EngineUnit/LatticeSet2LatticeBeams.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -48,3 +48,4 @@
 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/Engine/StandAloneEngine/BeamRecorder.cpp
===================================================================
--- trunk/pkg/lattice/Engine/StandAloneEngine/BeamRecorder.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/Engine/StandAloneEngine/BeamRecorder.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -207,3 +207,4 @@
 	 
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/Engine/StandAloneEngine/LatticeLaw.cpp
===================================================================
--- trunk/pkg/lattice/Engine/StandAloneEngine/LatticeLaw.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/Engine/StandAloneEngine/LatticeLaw.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -596,3 +596,4 @@
 
 */
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/Engine/StandAloneEngine/MeasurePoisson.cpp
===================================================================
--- trunk/pkg/lattice/Engine/StandAloneEngine/MeasurePoisson.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/Engine/StandAloneEngine/MeasurePoisson.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -114,3 +114,4 @@
 	 
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/Engine/StandAloneEngine/MovingSupport.cpp
===================================================================
--- trunk/pkg/lattice/Engine/StandAloneEngine/MovingSupport.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/Engine/StandAloneEngine/MovingSupport.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -222,3 +222,4 @@
 	 
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/Engine/StandAloneEngine/NodeRecorder.cpp
===================================================================
--- trunk/pkg/lattice/Engine/StandAloneEngine/NodeRecorder.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/Engine/StandAloneEngine/NodeRecorder.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -171,3 +171,4 @@
 	// GLDrawSomething can just put a getClassName()
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/Engine/StandAloneEngine/NonLocalInitializer.cpp
===================================================================
--- trunk/pkg/lattice/Engine/StandAloneEngine/NonLocalInitializer.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/Engine/StandAloneEngine/NonLocalInitializer.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -188,3 +188,4 @@
 //	cerr &lt;&lt; &quot;number of beams: &quot; &lt;&lt; total &lt;&lt; &quot;\n&quot;;
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/Engine/StandAloneEngine/StrainRecorder.cpp
===================================================================
--- trunk/pkg/lattice/Engine/StandAloneEngine/StrainRecorder.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/Engine/StandAloneEngine/StrainRecorder.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -119,3 +119,4 @@
 	 
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/PreProcessor/LatticeExample.cpp
===================================================================
--- trunk/pkg/lattice/PreProcessor/LatticeExample.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/PreProcessor/LatticeExample.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -1790,3 +1790,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/RenderingEngine/GLDrawLatticeBeamState/GLDrawLatticeBeamState.cpp
===================================================================
--- trunk/pkg/lattice/RenderingEngine/GLDrawLatticeBeamState/GLDrawLatticeBeamState.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/RenderingEngine/GLDrawLatticeBeamState/GLDrawLatticeBeamState.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -67,3 +67,4 @@
 	*/
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/RenderingEngine/GLDrawLatticeInteractingGeometry/GLDrawLatticeInteractingGeometry.cpp
===================================================================
--- trunk/pkg/lattice/RenderingEngine/GLDrawLatticeInteractingGeometry/GLDrawLatticeInteractingGeometry.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/RenderingEngine/GLDrawLatticeInteractingGeometry/GLDrawLatticeInteractingGeometry.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -199,3 +199,4 @@
 
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/RenderingEngine/GLDrawLatticeSetGeometry/GLDrawLatticeSetGeometry.cpp
===================================================================
--- trunk/pkg/lattice/RenderingEngine/GLDrawLatticeSetGeometry/GLDrawLatticeSetGeometry.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/RenderingEngine/GLDrawLatticeSetGeometry/GLDrawLatticeSetGeometry.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -233,3 +233,4 @@
 //	std::cerr &lt;&lt; &quot;GLDrawLatticeSetGeometry\n&quot;;
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/lattice/RenderingEngine/GLDrawLineSegment/GLDrawLineSegment.cpp
===================================================================
--- trunk/pkg/lattice/RenderingEngine/GLDrawLineSegment/GLDrawLineSegment.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/lattice/RenderingEngine/GLDrawLineSegment/GLDrawLineSegment.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -55,3 +55,4 @@
 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/mass-spring/DataClass/InteractionGeometry/SpringGeometry.cpp
===================================================================
--- trunk/pkg/mass-spring/DataClass/InteractionGeometry/SpringGeometry.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/mass-spring/DataClass/InteractionGeometry/SpringGeometry.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -23,3 +23,4 @@
 	REGISTER_ATTRIBUTE(p2);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/mass-spring/DataClass/InteractionPhysics/SpringPhysics.cpp
===================================================================
--- trunk/pkg/mass-spring/DataClass/InteractionPhysics/SpringPhysics.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/mass-spring/DataClass/InteractionPhysics/SpringPhysics.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -24,3 +24,4 @@
 	REGISTER_ATTRIBUTE(initialLength);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/mass-spring/DataClass/PhysicalParameters/ParticleSetParameters.cpp
===================================================================
--- trunk/pkg/mass-spring/DataClass/PhysicalParameters/ParticleSetParameters.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/mass-spring/DataClass/PhysicalParameters/ParticleSetParameters.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -20,3 +20,4 @@
 }
 
 
+YADE_PLUGIN();

Modified: trunk/pkg/mass-spring/Engine/EngineUnit/ParticleSet2Mesh2D.cpp
===================================================================
--- trunk/pkg/mass-spring/Engine/EngineUnit/ParticleSet2Mesh2D.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/mass-spring/Engine/EngineUnit/ParticleSet2Mesh2D.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -35,3 +35,4 @@
 	}
 }
 	
+YADE_PLUGIN();

Modified: trunk/pkg/mass-spring/Engine/StandAloneEngine/MassSpringLaw.cpp
===================================================================
--- trunk/pkg/mass-spring/Engine/StandAloneEngine/MassSpringLaw.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/mass-spring/Engine/StandAloneEngine/MassSpringLaw.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -78,3 +78,4 @@
 	
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/mass-spring/PreProcessor/HangingCloth.cpp
===================================================================
--- trunk/pkg/mass-spring/PreProcessor/HangingCloth.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/mass-spring/PreProcessor/HangingCloth.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -558,3 +558,4 @@
 	body-&gt;physicalParameters	= physics;
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/realtime-rigidbody/Engine/EngineUnit/InteractingBox2InteractingBox4ClosestFeatures.cpp
===================================================================
--- trunk/pkg/realtime-rigidbody/Engine/EngineUnit/InteractingBox2InteractingBox4ClosestFeatures.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/realtime-rigidbody/Engine/EngineUnit/InteractingBox2InteractingBox4ClosestFeatures.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -461,3 +461,4 @@
 
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/realtime-rigidbody/Engine/EngineUnit/InteractingBox2InteractingSphere4ClosestFeatures.cpp
===================================================================
--- trunk/pkg/realtime-rigidbody/Engine/EngineUnit/InteractingBox2InteractingSphere4ClosestFeatures.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/realtime-rigidbody/Engine/EngineUnit/InteractingBox2InteractingSphere4ClosestFeatures.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -124,3 +124,4 @@
 	return isInteracting;
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/realtime-rigidbody/Engine/EngineUnit/InteractingSphere2InteractingSphere4ClosestFeatures.cpp
===================================================================
--- trunk/pkg/realtime-rigidbody/Engine/EngineUnit/InteractingSphere2InteractingSphere4ClosestFeatures.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/realtime-rigidbody/Engine/EngineUnit/InteractingSphere2InteractingSphere4ClosestFeatures.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -45,3 +45,4 @@
 	return go(cm1,cm2,se31,se32,c);
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/realtime-rigidbody/Engine/StandAloneEngine/FrictionLessElasticContactLaw.cpp
===================================================================
--- trunk/pkg/realtime-rigidbody/Engine/StandAloneEngine/FrictionLessElasticContactLaw.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/realtime-rigidbody/Engine/StandAloneEngine/FrictionLessElasticContactLaw.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -149,3 +149,4 @@
 // 	}
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/realtime-rigidbody/PreProcessor/BoxStack.cpp
===================================================================
--- trunk/pkg/realtime-rigidbody/PreProcessor/BoxStack.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/realtime-rigidbody/PreProcessor/BoxStack.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -328,3 +328,4 @@
 	rootBody-&gt;physicalParameters 		= physics;
 }
 
+YADE_PLUGIN();

Modified: trunk/pkg/realtime-rigidbody/PreProcessor/RotatingBox.cpp
===================================================================
--- trunk/pkg/realtime-rigidbody/PreProcessor/RotatingBox.cpp	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/pkg/realtime-rigidbody/PreProcessor/RotatingBox.cpp	2008-02-04 10:36:31 UTC (rev 1242)
@@ -350,3 +350,4 @@
 }
 
 
+YADE_PLUGIN();

Added: trunk/scripts/pch.py
===================================================================
--- trunk/scripts/pch.py	2008-01-27 07:34:24 UTC (rev 1241)
+++ trunk/scripts/pch.py	2008-02-04 10:36:31 UTC (rev 1242)
@@ -0,0 +1,102 @@
+#!/usr/bin/python
+
+from sys import *
+import os,re
+from string import *
+
+incDir='../build-trunk/include/yade-trunk/yade'
+pchDir='./pch/'
+srcRoot='./'
+incModules={
+	'lib-base':0, 'lib-computational-geometry':0, 'lib-factory':0, 'lib-loki':0, 'lib-miniWm3':0, 'lib-multimethods':0, 'lib-opengl':0, 'lib-serialization':0, 'lib-serialization-bin':0, 'lib-serialization-qt':0, 'lib-serialization-xml':0,
+	'core':1,
+	'pkg-common':2,
+	'pkg-dem':3,
+	'pkg-realtime-rigidbody':3,
+	'pkg-lattice':3,
+	'pkg-mass-spring':3,
+	'pkg-fem':3,
+	'gui-cmd':3,
+	'gui-qt3':3, 
+	'extra':4}
+
+from os.path import sep
+import shutil
+
+inclusionGuards={'GLEngineEditor.hpp': 'GL_ENGINE_EDITOR_HPP', 'InteractionPhysicsEngineUnit.hpp': 'INTERACTIONPHYSICS_ENGINEUNIT_HPP', 'SpheresContactGeometry.hpp': 'SPHERESCONTACTGEOMETRY_HPP', 'GLWindowsManager.hpp': 'GLWINDOWSMANAGER_HPP', 'QtSimulationPlayer.hpp': 'QTSIMULATIONPLAYER_HPP', 'NewtonsMomentumLaw.hpp': 'NEWTONSMOMENTUMLAW_HPP', 'PhysicalParameters.hpp': 'PHYSICALPARAMETERS_HPP', 'ParticleParameters.hpp': 'PARTICLEPARAMETERS_HPP', 'HangingCloth.hpp': 'HANGINGCLOTH_HPP', 'GLDrawInteractionGeometryFunctor.hpp': 'GLDRAW_INTERACTION_GEOMETRY_FUNCTOR_HPP', 'GeometricalModel.hpp': 'GEOMETRICALMODEL_HPP', 'SDECImpactTest.hpp': 'SDECIMPORT_HPP', 'Funnel.hpp': 'FUNNEL_HPP', 'PhysicalActionContainerIteratorPointer.hpp': 'PHYSICALACTIONCONTAINERITERATORPOINTER_HPP', 'ClosestFeatures.hpp': 'CLOSESTSFEATURES_HPP', 'CapillaryStressRecorder.hpp': 'CAPILLARY_STRESS_RECORDER_HPP', 'InteractionGeometryEngineUnit.hpp': 'INTERACTIONGEOMETRYFUNCTOR_HPP', 'Functor.hpp': 'FUNCTOR!
 _INC_', 'BINFormatManager.hpp': 'BINFORMATMANAGER_HPP', 'SDECMovingWall.hpp': 'SDEC_MOVING_WALL_HPP', 'BroadInteractor.hpp': 'BROADINTERACTOR_HPP', 'InteractingBox.hpp': 'INTERACTION_BOX_HPP', 'BodyContainerIterator.hpp': 'BODYCONTAINERITERATOR_HPP', 'InteractionGeometry.hpp': 'INTERACTIONGEOMETRY_HPP', 'LineSegment.hpp': 'LINE_SEGMENT_HPP', 'GLDrawShadowVolumeFunctor.hpp': 'GLDRAWSHADOWVOLUMEFUNCTOR_HPP', 'ClassFactory.hpp': 'CLASSFACTORY_HPP', 'GLDrawLatticeBeamState.hpp': 'GLDRAW_LATTICE_BEAM_STATE_HPP', 'TypeManip.hpp': 'TYPEMANIP_INC_', 'OpenGLRenderingEngine.hpp': 'OPENGLRENDERINGENGINE_HPP', 'Sphere.hpp': 'SPHERE_HPP', 'TranslationEngine.hpp': 'TRANSLATOR_HPP', 'Tetrahedron.hpp': 'TETRAHEDRON_HPP', 'GLDrawSimpleElasticInteraction.hpp': 'GLDRAW_SIMPLE_ELASTIC_INTERACTION_HPP', 'AveragePositionRecorder.hpp': 'AVERAGE_POSISTION_RECORDER_HPP', 'EmptyType.hpp': 'EMPTYTYPE_INC_', 'BoxStack.hpp': 'BOXSTACK_HPP', 'QtSphericalDEM.hpp': 'QTSPHERICALDEM_HPP', 'CohesiveFrictiona!
 lContactLaw.hpp': 'COHESIVE_FRICTIONAL_CONTACT_LAW_HPP', 'QtMe!
 taDispat
chingEngineProperties.hpp': 'QTMETADISPATCHINGENGINEPROPERTIES_HPP', 'CapillaryRecorder.hpp': 'CAPILLARY_RECORDER_HPP', 'GLDrawBoxShadowVolume.hpp': 'GLDRAWBOXSHADOWVOLUME_HPP', 'FundamentalHandler.tpp': '__FUNDAMENTALHANDLER_H__', 'ElasticBodySimpleRelationship.hpp': 'ELASTICBODYSIMPLERELATIONSHIP_HPP', 'GeometricalModelEngineUnit.hpp': 'GEOMETRICAL_MODEL_ENGINE_UNIT_HPP', 'MovingSupport.hpp': 'NO_SHEAR_PLANE', 'QtGUIGenerator.hpp': 'QTGUIGENERATOR_HPP', 'LatticeLaw.hpp': 'LATTICELAW_HPP', 'Archive.hpp': 'ARCHIVECONTENT_HPP', 'InteractionGeometryMetaEngine.hpp': 'INTERACTION_GEOMETRY_METAENGINE_HPP', 'GLSimulationPlayerViewer.hpp': 'SIMULATIONVIEWER_HPP', 'DataRecorder.hpp': 'DATARECORDER_HPP', 'SphericalDEMSimulator.hpp': 'SPHERICALDEMSIMULATOR_HPP', 'Preferences.hpp': 'PREFERENCES_HPP', 'PersistentAloneSAPCollider.hpp': 'PERSISTENTSAPCOLLIDER_HPP', 'GLDrawInteractingMyTetrahedron.hpp': 'GLDRAWINTERACTINGMYTETRAHEDRON_HPP', 'MacroMicroElasticRelationshipsWater.hpp': 'SDECL!
 INEARCONTACTMODEL_HPP', 'ElasticCohesiveLaw.hpp': 'ELASTICCOHESIVELAW_HPP', 'MyTetrahedronLaw.hpp': 'MYTETRAHEDRONLAW_HPP', 'IOManagerExceptions.hpp': 'IOMANAGEREXCEPTIONS_HPP', 'Engine.hpp': 'ENGINE_HPP', 'QtFileGenerator.hpp': 'QTFILEGENERATOR_HPP', 'PositionOrientationRecorder.hpp': 'POSITIONORIENTATIONRECORDER_HPP', 'StandAloneSimulator.hpp': 'STANDALONESIMULATOR_HPP', 'SimulationFlow.hpp': 'SIMULATION_FLOW_HPP', 'TriaxialStateRecorder.hpp': 'TRIAXIAL_STATE_RECORDER_HPP', 'Indexable.hpp': 'INDEXABLE_HPP', 'FEMTetrahedronData.hpp': 'LATTICEBEAMPARAMETERS_HPP', 'FunctorWrapper.hpp': 'DYNLIB_LAUNCHER_HPP', 'MetaDispatchingEngine.hpp': 'METADISPATCHINGENGINE_HPP', 'ThreadWorker.hpp': 'THREAD_WORKER_HPP', 'CundallNonViscousMomentumDamping.hpp': 'ACTION_MOMENTUM_DAMPING_HPP', 'GLDrawBox.hpp': 'GLDRAWBOX_HPP', 'SimpleElasticInteraction.hpp': 'SIMPLEELASTICINTERACTION_HPP', 'QtGUIPreferences.hpp': 'QTGUIPREFERENCES_HPP', 'InteractionContainerIteratorPointer.hpp': 'INTERACTIONCO!
 NTAINERITERATORPOINTER_HPP', 'BodyRedirectionVectorIterator.hp!
 p': 'BOD
YREDIRECTIONVECTORITERATOR_HPP', 'MultiTypeHandler.tpp': '__MULTITYPEHANDLER_H__', 'FEMLaw.hpp': 'FEMLAW_HPP', 'MetaInteractingGeometry.hpp': 'METAINTERACTINGGEOMETRY_HPP', 'InteractingGeometry.hpp': 'INTERACTING_GEOMETRY_HPP', 'GLDrawBoundingSphere.hpp': 'GLDRAWBOUNDINGSPHERE_HPP', 'PhysicalActionApplierUnit.hpp': 'PHYSICALACTIONAPPLIERUNIT_HPP', 'TetraTestGen.hpp': 'TETRATESTGEN_HPP', 'GLDrawStateFunctor.hpp': 'GLDRAW_STATE_FUNCTOR_HPP', 'TriaxialTest.hpp': 'SDECIMPORT_HPP', 'GLViewer.hpp': 'GLVIEWER_HPP', 'yadeWm3Extra.hpp': 'YADE_GEOM_UTILS_HPP', 'InteractionHashMapIterator.hpp': 'INTERACTIONHASHMAPITERATOR_HPP', 'InteractionPhysics.hpp': 'INTERACTIONPHYSICS_HPP', 'CohesiveTriaxialTest.hpp': 'COHESIVE_TRIAXIAL_TEST_HPP', 'VelocityRecorder.hpp': 'VELOCITY_RECORDER_HPP', 'TetrahedronsTest.hpp': 'TETRAHEDRONSTEST_HPP', 'SerializableTypes.hpp': '__SERIALIZABLETYPES_HPP__', 'GLDrawRigidBodyState.hpp': 'GLDRAWRIGIDBODYSTATE_HPP', 'SerializationExceptions.hpp': 'SERIALIZATIONEX!
 CEPTIONS_HPP', 'GLDrawInteractingSphere.hpp': '__GLDRAWINTERACTIONSPHERE_HPP__', 'RotatingBox.hpp': 'ROTATINGBOX_HPP', 'GLDrawMetaInteractingGeometry.hpp': 'GLDRAWCOLLISIONGEOMETRYSET_HPP', 'NullGUI.hpp': 'NULLGUI_HPP', 'TypeTraits.hpp': 'TYPETRAITS_INC_', 'BodyRedirectionVector.hpp': 'BODYREDIRECTIONVECTOR_HPP', 'InteractingGeometryEngineUnit.hpp': 'INTERACTING_GEOMETRY_ENGINE_UNIT_HPP', 'FileDialog.hpp': 'FILEDIALOG_HPP', 'SDECSpheresPlane.hpp': 'SDEC_SPHERES_PLANE_HPP', 'Clump.hpp': 'CLUMP_HPP', 'PythonRecorder.hpp': 'PYTHON_RECORDER_HPP', 'FEMSetTextLoader.hpp': 'FEM_SET_TEXT_LOADER_HPP', 'DisplacementEngine.hpp': 'DISPLACEMENTENGINE_HPP', 'CapillaryCohesiveLaw.hpp': 'CAPILLARY_COHESIVE_LAW_HPP', 'SerializableSingleton.hpp': 'SERIALIZABLESINGLETON_HPP', 'WallStressRecorder.hpp': 'WALL_STRESS_RECORDER_HPP', 'CohesiveFrictionalContactInteraction.hpp': 'COHESIVE_FRICTIONAL_CONTACT_PARAMETERS_HPP', 'GlobalStiffnessCounter.hpp': 'GLOBALSTIFFNESSCOUNTER_HPP', 'GLDrawInteracti!
 ngGeometryFunctor.hpp': 'GLDRAWINTERACTIONGEOMETRYFUNCTOR_HPP'!
 , 'Simul
ationControllerUpdater.hpp': 'SIMULATIONCONTROLLERUPDATER_HPP', 'SimulationController.hpp': 'SIMULATIONCONTROLLER_HPP', 'SAPCollider.hpp': 'SAPCOLLIDER_HPP', 'SphericalDEM.hpp': 'SPHERICALDEM_HPP', 'Quadrilateral.hpp': 'QUADRILATERAL_HPP', 'yadeExceptions.hpp': 'YADE_EXCEPTIONS_HPP', 'GLDrawParticleState.hpp': 'GLDRAWPARTICLESTATE_HPP', 'TriaxialStressController.hpp': 'TRIAXIAL_STRESS_CONTROLLER_HPP', 'SDECLinkPhysics.hpp': 'SDECLINKPHYSICS_HPP', 'DistantPersistentSAPCollider.hpp': '__DISTANTPERSISTENTSAPCOLLIDER_HPP__', 'InteractingSphere.hpp': 'INTERACTIONSPHERE_HPP', 'SpringPhysics.hpp': 'SPRINGPHYSICS_HPP', 'Contact.hpp': 'CONTACT_HPP', 'PhysicalActionDamper.hpp': 'PHYSICALACTIONDAMPER_HPP', 'KnownFundamentalsHandler.tpp': 'KNOWNFUNDAMENTALSHANDLER_HPP', 'GLDrawGeometricalModelFunctor.hpp': 'GLDRAWGEOMETRICALMODELFUNCTOR_HPP', 'CapillaryPressureEngine.hpp': 'CAPILLARY_PRESSURE_ENGINE_HPP', 'NullType.hpp': 'NULLTYPE_INC_', 'PhysicalAction.hpp': 'PHYSICALACTION_HPP', 'Tetr!
 a.hpp': 'TETRA_HPP', 'GLDrawInteractionPhysicsFunctor.hpp': 'GLDRAW_INTERACTION_PHYSICS_FUNCTOR_HPP', 'PersistentSAPCollider.hpp': '__PERSISTENTSAPCOLLIDER_HPP__', 'GeometricalModelMetaEngine.hpp': 'GEOMETRICAL_MODEL_DISPATCHER_HPP', 'RenderingEngine.hpp': 'RENDERINGENGINE_HPP', 'Factorable.hpp': 'FACTORABLE_HPP', 'IOFormatManager.tpp': 'IOMANAGER_TPP', 'OpenGLWrapper.hpp': 'OPENGLWRAPPER_HPP', 'ElasticBodyParameters.hpp': 'ELASTICBODYPARAMETERS_HPP', 'GLDrawLatticeSetGeometry.hpp': 'GLDRAW_LATTICE_SET_GEOMETRY_HPP', 'InteractionContainerIterator.hpp': 'INTERACTIONCONTAINERITERATOR_HPP', 'QtGUI.hpp': 'QTGUI_HPP', 'MetaEngine.hpp': 'METAENGINE_HPP', 'InteractionOfMyTetrahedron.hpp': 'INTERACTIONOFMYTETRAHEDRON_HPP', 'AABB.hpp': 'AABB_HPP', 'BoundingVolume.hpp': 'BOUNDINGVOLUME_HPP', 'InteractionVecSetIterator.hpp': 'INTERACTIONVECSETITERATOR_HPP', 'PhysicalActionVectorVectorIterator.hpp': 'PHYSICALACTIONVECTORVECTORITERATOR_HPP', 'MacroMicroElasticRelationships.hpp': 'SDECLI!
 NEARCONTACTMODEL_HPP', 'GLDrawQuadrilateral.hpp': 'GLDRAW_QUAD!
 RILATERA
L_HPP', 'DynLibManager.hpp': 'DYNLIBMANAGER_HPP', 'BodyAssocVector.hpp': 'BODYASSOCVEC_HPP', 'Typelist.hpp': 'TYPELIST_INC_', 'PointerHandler.tpp': '__POINTERHANDLER_H__', 'GLDrawLatticeInteractingGeometry.hpp': 'GLDRAW_LATTICE_INTERACTING_GEOMETRY_HPP', 'Box.hpp': 'BOX_HPP', 'ResultantForceEngine.hpp': 'RESULTANT_FORCE_ENGINE_HPP', 'XMLFormatManager.hpp': 'XMLFORMATMANAGER_HPP', 'GLDrawSDECLinkGeometry.hpp': 'GLDRAW_SPHERES_LINK_CONTACT_GEOMETRY_HPP', 'InteractionVecSet.hpp': 'INTERACTIONVECSET_HPP', 'FrontEnd.hpp': 'FRONTEND_HPP', 'ArchiveTypes.hpp': '__ARCHIVESTYPES_HPP__', 'Logging.hpp': 'LOGGING_HPP', 'MetaBody.hpp': 'METABODY_HPP', 'BodyContainerIteratorPointer.hpp': 'BODYCONTAINERITERATORPOINTER_HPP', 'ContactStressRecorder.hpp': 'CONTACT_STRESS_RECORDER_HPP', 'IOFormatManager.hpp': 'IOFORMATMANAGER_HPP', 'FrictionLessElasticContactLaw.hpp': 'FRICTIONLESSELASTICCONTACTLAW_HPP', 'ForceEngine.hpp': 'FORCE_ENGINE_HPP', 'GLDrawSphereShadowVolume.hpp': 'GLDRAWSPHERESHADOWV!
 OLUME_HPP', 'BodyMacroParameters.hpp': 'BODYMACROPARAMETERS_HPP', 'GLWindow.hpp': 'GLWINDOW_HPP', 'PhysicalActionContainer.hpp': 'PHYSICALACTIONCONTAINER_HPP', 'RigidBodyParameters.hpp': 'RIGIDBODYPARAMETERS_HPP', 'GeometricalModelForceColorizer.hpp': 'GEOMETRICAL_MODEL_FORCE_COLORIZER_HPP', 'BodyAssocVectorIterator.hpp': 'BODYASSOCVECTORITERATOR', 'SpringGeometry.hpp': 'SPRINGGEOMETRY_HPP', 'ElasticContactLaw.hpp': 'ELASTIC_CONTACT_LAW_HPP', 'SDECLinkGeometry.hpp': 'SDECLINKGEOMETRY_HPP', 'GLDrawSphere.hpp': 'GLDRAWSPHERE_HPP', 'PhysicalActionApplier.hpp': 'PHYSICALACTIONAPPLIER_HPP', 'PhysicalActionContainerIterator.hpp': 'PHYSICALACTIONCONTAINERITERATOR_HPP', 'CohesiveFrictionalBodyParameters.hpp': 'COHESIVEFRICTIONALBODYPARAMETERS_HPP', 'GLDrawInteractingBox.hpp': 'GLDRAWINTERACTIONBOX_HPP', 'InteractionSolver.hpp': 'INTERACTIONSOLVER_HPP', 'GlobalStiffnessTimeStepper.hpp': 'STIFFNESS_MATRIX_TIME_STEPPER_HPP', 'InteractionContainer.hpp': 'INTERACTIONCONTAINER_HPP', 'Bod!
 y.hpp': 'BODY_HPP', 'GLDrawClosestFeatures.hpp': 'GLDRAW_CLOSE!
 ST_FEATU
RES_HPP', 'FpsTracker.hpp': 'FPSTRACKER_HPP', 'ElasticContactInteraction.hpp': 'ELASTIC_CONTACT_PARAMETERS_HPP', 'ThreePointBending.hpp': 'LINKEDSPHERES_HPP', 'NonLocalInitializer.hpp': 'NONLOCALINITIALIZER_HPP', 'ContainerHandler.tpp': '__CONTAINERHANDLER_H__', 'GLDrawAABB.hpp': 'GLDRAWAABB_HPP', 'XMLSaxParser.hpp': 'XMLSAXPARSER_HPP', 'TimeStepper.hpp': 'TIMESTEPPER_HPP', 'MassSpringLaw.hpp': 'MASSSPRINGLAW_HPP', 'EngineUnit.hpp': 'ENGINEUNIT_HPP', 'ModifiedTriaxialTest.hpp': 'SDECIMPORT_HPP', 'QtEngineEditor.hpp': 'QTENGINEEDITOR_HPP', 'BoundingVolumeEngineUnit.hpp': 'BOUNDINGVOLUMEFACTORY_HPP', 'GlobalStiffness.hpp': 'GLOBALSTIFFNESSMATRIX_HPP', 'MultiMethodsExceptions.hpp': 'MULTIMETHODSEXCEPTIONS_HPP', 'Momentum.hpp': 'MOMENTUM_HPP', 'PhysicalActionVectorVector.hpp': 'PHYSICALACTIONVECTORVECTOR_HPP', 'QtCodeGenerator.hpp': 'QTCODEGENERATOR_HPP', 'GLTextLabel.hpp': 'GLTEXTLABEL_HPP', 'YadeQtMainWindow.hpp': 'YADEQTMAINWINDOW_HPP', 'NonLocalDependency.hpp': 'NONLOCALDEPE!
 NDENCY_HPP', 'Force.hpp': 'ACTIONFORCE_HPP', 'ParticleSetParameters.hpp': 'PARTICLESETPARAMETERS_HPP', 'TriaxialCompressionEngine.hpp': 'TRIAXIALCOMPRESSIONENGINE_HPP', 'CundallNonViscousForceDamping.hpp': 'ACTION_FORCE_DAMPING_HPP', 'DynLibDispatcher.hpp': 'DYNLIB_DISPATCHER_HPP', 'FileGenerator.hpp': 'FILEGENERATOR_HPP', 'Omega.hpp': 'OMEGA_HPP', 'SimpleElasticRelationships.hpp': 'SIMPLECONTACTMODEL_HPP', 'RotationEngine.hpp': 'ROTATIONENGINE_HPP', 'InteractingMyTetrahedron.hpp': 'INTERACTING_MY_TETRAHEDRON_HPP', 'GLDrawLineSegment.hpp': 'GLDRAW_LINE_SEGMENT_HPP', 'cmdGui.hpp': 'CMDGUI_HPP', 'LatticeBeamAngularSpring.hpp': 'LATTICEBEAMANGULARSPRING_HPP', 'ForceRecorder.hpp': 'FORCE_RECORDER_HPP', 'QtPreferencesEditor.hpp': 'QTPREFERENCESEDITOR_HPP', 'GLDrawSpheresContactGeometry.hpp': 'GLDRAW_SPHERES_CONTACT_GEOMETRY_HPP', 'LatticeInteractingGeometry.hpp': 'LATTICE_INTERACTINGGEOMETRY_HPP', 'StandAloneEngine.hpp': 'STANDALONEENGINE_HPP', 'GLDrawBoundingVolumeFunctor.hpp':!
  'GLDRAWBOUNDINGVOLUMEFUNCTOR_HPP', 'NewtonsForceLaw.hpp': 'NE!
 WTONSFOR
CELAW_HPP', 'BoundingSphere.hpp': 'BOUNDINGSPHERE_HPP', 'MeasurePoisson.hpp': 'POISSON_RECORDER_HPP', 'DeusExMachina.hpp': 'KINEMATICENGINE_HPP', 'CapillaryParameters.hpp': 'CAPILLARY_PARAMETERS_HPP', 'AssocVector.hpp': 'ASSOCVECTOR_INC_', 'PhysicalActionDamperUnit.hpp': 'PHYSICALACTIONDAMPERUNIT_HPP', 'Interaction.hpp': 'INTERACTION_HPP', 'CohesiveFrictionalRelationships.hpp': 'COHESIVEFRICTIONALCONTACTMODEL_HPP', 'BoundingVolumeMetaEngine.hpp': 'BOUNDINGVOLUMEUPDATOR_HPP', 'InteractionHashMap.hpp': 'INTERACTIONHASHMAP_HPP', 'SDECLinkedSpheres.hpp': 'LINKEDSPHERES_HPP', 'BodyContainer.hpp': 'BODYCONTAINER_HPP', 'ElasticCriterionTimeStepper.hpp': 'ELASTIC_CRITERION_TIME_STEPPER_HPP'}
+
+# must modify these by hand
+skipEndifs={'Omega.hpp':1,'yadeWm3Extra.hpp':2,'Logging.hpp':1,'DynLibManager.hpp':1,'TypeManip.hpp':1,'PythonRecorder.hpp':1}
+
+
+def grepInc(path,f,module):
+	fullF=path+sep+f
+	print fullF
+	if 1:
+		bcUp='/tmp/'+f+'~~'
+		shutil.move(fullF,bcUp);
+		f2=open(fullF,'w')
+	else: bcUp=fullF
+	if inclusionGuards.has_key(f): guard=inclusionGuards[f]
+	else: guard=None
+	toSkip=0
+	if f in skipEndifs.keys(): toSkip=skipEndifs[f]
+	ifndefLevel=0
+	seenIncMod=[]
+	for l in open(bcUp):
+		m=re.match('^#include&lt;yade/([^/]*)/(.*)&gt;.*$',l)
+		if m:
+			incMod=m.group(1)
+			assert(incMod in incModules.keys())
+			assert(incModules[incMod]&lt;=incModules[module])
+			if incMod!=module:
+				if incMod not in seenIncMod:
+					l='#include&lt;yade/'+incMod+'.hh&gt;\n'
+					seenIncMod.append(incMod)
+				else: l=''
+		if guard:
+			m=re.match('^#ifndef\s+'+guard+'\s*$',l)
+			if m:
+				l='#pragma once\n'; ifndefLevel+=1
+			m=re.match('^#define\s+'+guard+'\s*$',l)
+			if m: l=''
+			m=re.match('^#endif.*$',l)
+			if m:
+				if toSkip&gt;0: toSkip-=1
+				else:
+					l=''; ifndefLevel-=1
+		f2.write(l);
+	assert(ifndefLevel==0)
+	f2.close()
+
+		#if m and guard==None:
+		#	guard=m.group(1)
+		#	#print f,guard
+		#m=re.match('^#define ([A-Z_]*)$',l)
+		#if m and guard!=None:
+		#	guardDefined=True
+		#m=re.match('#endif.*',l)
+		#if m and guard!=None and guardDefined:
+		#	inclusionGuards[f]=guard
+
+moduleHeaders={}
+for root, dirs, files in os.walk(srcRoot,topdown=True):
+	for d in ('.svn'): ## skip all files that are not part of sources in the proper sense!
+		try: dirs.remove(d)
+		except ValueError: pass
+	for f in files:
+		if f.split('.')[-1] in ('hpp','inl','ipp','tpp','h','mcr','cpp','cc','C'):
+			m=re.match('^.*?'+sep+'((extra|core)|((gui|lib|pkg)'+sep+'.*?))(|'+sep+'.*)$',root)
+			module=m.group(1).replace(sep,'-')
+			# add headers to encompassing header file
+			if f.split('.')[-1] in ('hpp','h'):
+				if moduleHeaders.has_key(module): moduleHeaders[module].append(f)
+				else: moduleHeaders[module]=[f]
+			assert(module in incModules.keys())
+			grepInc(root,f,module)
+
+for module in moduleHeaders.keys():
+	f=open(pchDir+sep+module+'.hh','w')
+	for hh in moduleHeaders[module]:
+		f.write('#include&lt;yade/'+module+'/'+hh+'&gt;\n')
+


Property changes on: trunk/scripts/pch.py
___________________________________________________________________
Name: svn:executable
   + *


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000206.html">[Yade-commits] r1241 - in trunk: . doc
</A></li>
	<LI>Next message: <A HREF="000208.html">[Yade-commits] r1243 - in trunk: . core extra extra/clump	extra/tetra extra/usct gui/cmd lib/base	pkg/common/Engine/EngineUnit pkg/dem/Engine/DeusExMachina	pkg/dem/Engine/EngineUnit
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#207">[ date ]</a>
              <a href="thread.html#207">[ thread ]</a>
              <a href="subject.html#207">[ subject ]</a>
              <a href="author.html#207">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/yade-commits">More information about the Yade-commits
mailing list</a><br>
</body></html>
