<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Yade-commits] r1383 - in trunk: gui gui/py gui/qt3	pkg/common/Engine/StandAloneEngine scripts
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/yade-commits/2008/index.html" >
   <LINK REL="made" HREF="mailto:yade-commits%40lists.berlios.de?Subject=Re%3A%20%5BYade-commits%5D%20r1383%20-%20in%20trunk%3A%20gui%20gui/py%20gui/qt3%0A%09pkg/common/Engine/StandAloneEngine%20scripts&In-Reply-To=%3C200806101028.m5AASfxV023190%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000343.html">
   <LINK REL="Next"  HREF="000345.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Yade-commits] r1383 - in trunk: gui gui/py gui/qt3	pkg/common/Engine/StandAloneEngine scripts</H1>
    <B>eudoxos at BerliOS</B> 
    <A HREF="mailto:yade-commits%40lists.berlios.de?Subject=Re%3A%20%5BYade-commits%5D%20r1383%20-%20in%20trunk%3A%20gui%20gui/py%20gui/qt3%0A%09pkg/common/Engine/StandAloneEngine%20scripts&In-Reply-To=%3C200806101028.m5AASfxV023190%40sheep.berlios.de%3E"
       TITLE="[Yade-commits] r1383 - in trunk: gui gui/py gui/qt3	pkg/common/Engine/StandAloneEngine scripts">eudoxos at mail.berlios.de
       </A><BR>
    <I>Tue Jun 10 12:28:41 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000343.html">[Yade-commits] r1382 - in trunk: core extra extra/clump gui/qt3
</A></li>
        <LI>Next message: <A HREF="000345.html">[Yade-commits] r1384 - trunk/pkg/dem/Engine/DeusExMachina
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#344">[ date ]</a>
              <a href="thread.html#344">[ thread ]</a>
              <a href="subject.html#344">[ subject ]</a>
              <a href="author.html#344">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: eudoxos
Date: 2008-06-10 12:28:40 +0200 (Tue, 10 Jun 2008)
New Revision: 1383

Modified:
   trunk/gui/SConscript
   trunk/gui/py/PeriodicPythonRunner.hpp
   trunk/gui/py/plot.py
   trunk/gui/qt3/YadeQtGeneratedMainWindow.ui
   trunk/pkg/common/Engine/StandAloneEngine/PeriodicEngine.hpp
   trunk/scripts/simple-scene-graph.py
Log:
1. Fix the priodic engine.
2. Add layout to the main windows with 4 buttons.
3. Fix PeriodicPythonRunner plugin installation
4. Update simple-scene-graph.py so that it works after latest plotting changes.


Modified: trunk/gui/SConscript
===================================================================
--- trunk/gui/SConscript	2008-06-10 09:17:01 UTC (rev 1382)
+++ trunk/gui/SConscript	2008-06-10 10:28:40 UTC (rev 1383)
@@ -41,11 +41,11 @@
 if 'EMBED_PYTHON' in env['CPPDEFINES']:
 	env.Install('$PREFIX/lib/yade$SUFFIX/gui',[
 		env.SharedLibrary('PythonUI',['py/PythonUI.cpp']),
+		env.SharedLibrary('PeriodicPythonRunner',['py/PeriodicPythonRunner.cpp']),
 		env.File('PythonUI_rc.py','py'),
 		# env.SharedLibrary('PlotDataGetter',['py/PlotDataGetter.cpp']),
 	])
-	# one level deeper so that you can say: from yade.wrapper import *
-	# (more submodules to come)
+	# python modules are one level deeper so that you can say: from yade.wrapper import *
 	env.Install('$PREFIX/lib/yade$SUFFIX/gui/yade',[
 		env.SharedLibrary('qt',['qt3/QtGUI-python.cpp'],SHLIBPREFIX='',LIBS=env['LIBS']+['QtGUI'],CPPPATH=env['CPPPATH']+[env['buildDir']+'/gui/qt3']), # CPPPATH is for files generated by moc which are indirectly included
 		env.SharedLibrary('wrapper',['py/yadeControl.cpp'],SHLIBPREFIX='',
@@ -59,7 +59,6 @@
 				'STLImporter'
 			],
 			),
-		env.SharedLibrary('PeriodicPythonRunner',['py/PeriodicPythonRunner.cpp']),
 		env.File('__init__.py','py'),
 		env.File('utils.py','py'),
 		env.File('runtime.py','py'),

Modified: trunk/gui/py/PeriodicPythonRunner.hpp
===================================================================
--- trunk/gui/py/PeriodicPythonRunner.hpp	2008-06-10 09:17:01 UTC (rev 1382)
+++ trunk/gui/py/PeriodicPythonRunner.hpp	2008-06-10 10:28:40 UTC (rev 1383)
@@ -16,12 +16,13 @@
 		PeriodicPythonRunner(): command(&quot;pass&quot;){};
 		/* virtual bool isActivated: not overridden, PeriodicEngine handles that */
 		virtual void action(MetaBody* b){
+			//cerr&lt;&lt;&quot;[PeriodicPythonRunner]&quot;;
 			PyGILState_STATE gstate;
 				gstate = PyGILState_Ensure();
 				PyRun_SimpleString(command.c_str()); // this is suboptimal, since it has to be parsed at every execution; critical?
 			PyGILState_Release(gstate);
 		}
-		virtual void registerAttributes(){ REGISTER_ATTRIBUTE(command); }
+		virtual void registerAttributes(){ PeriodicEngine::registerAttributes(); REGISTER_ATTRIBUTE(command); }
 	protected :
 		virtual void postProcessAttributes(bool deserializing){}
 	REGISTER_CLASS_NAME(PeriodicPythonRunner);

Modified: trunk/gui/py/plot.py
===================================================================
--- trunk/gui/py/plot.py	2008-06-10 09:17:01 UTC (rev 1382)
+++ trunk/gui/py/plot.py	2008-06-10 10:28:40 UTC (rev 1383)
@@ -34,14 +34,13 @@
 	&quot;&quot;&quot;
 	if l&gt;maxDataLen:
 		global plotDataCollector
-		pdc=PlotDataCollector;
-		if not pdc: pdc=o.labeledEngine('plotDataCollector') # will raise RuntimeError if not found
-		if pdc['mayDouble']: # may we double the period without getting over limits?
+		if not plotDataCollector: plotDataCollector=o.labeledEngine('plotDataCollector') # will raise RuntimeError if not found
+		if plotDataCollector['mayDouble']: # may we double the period without getting over limits?
 			print &quot;Reducing data: %d &gt; %d&quot;%(l,maxDataLen)
 			for d in data: data[d]=data[d][::2]
 			for attr in ['virtTimeLim','realTimeLim','iterLim']:
-				val=pdc[attr]
-				pdc[attr]=[val[0],val[1]*2,val[2]]
+				val=plotDataCollector[attr]
+				plotDataCollector[attr]=[val[0],val[1]*2,val[2]]
 
 
 def addData(d):
@@ -68,15 +67,14 @@
 
 def show(): plot()
 def plot():
-	pylab.ioff() # no interactive mode (hmmm, I don't know why actually...)
+	pylab.ion() ## # no interactive mode (hmmm, I don't know why actually...)
 	for p in plots:
 		pylab.figure()
 		plots_p=[fillNonSequence(o) for o in plots[p]]
 		pylab.plot(*sum([[data[p],data[d[0]],d[1]] for d in plots_p],[]))
 		pylab.legend([_p[0] for _p in plots_p])
 		pylab.xlabel(p)
-		pylab.show()
-	return
+	pylab.show()
 
 	
 import random

Modified: trunk/gui/qt3/YadeQtGeneratedMainWindow.ui
===================================================================
--- trunk/gui/qt3/YadeQtGeneratedMainWindow.ui	2008-06-10 09:17:01 UTC (rev 1382)
+++ trunk/gui/qt3/YadeQtGeneratedMainWindow.ui	2008-06-10 10:28:40 UTC (rev 1383)
@@ -8,14 +8,22 @@
         &lt;rect&gt;
             &lt;x&gt;0&lt;/x&gt;
             &lt;y&gt;0&lt;/y&gt;
-            &lt;width&gt;255&lt;/width&gt;
-            &lt;height&gt;140&lt;/height&gt;
+            &lt;width&gt;244&lt;/width&gt;
+            &lt;height&gt;128&lt;/height&gt;
         &lt;/rect&gt;
     &lt;/property&gt;
+    &lt;property name=&quot;sizePolicy&quot;&gt;
+        &lt;sizepolicy&gt;
+            &lt;hsizetype&gt;1&lt;/hsizetype&gt;
+            &lt;vsizetype&gt;1&lt;/vsizetype&gt;
+            &lt;horstretch&gt;0&lt;/horstretch&gt;
+            &lt;verstretch&gt;0&lt;/verstretch&gt;
+        &lt;/sizepolicy&gt;
+    &lt;/property&gt;
     &lt;property name=&quot;minimumSize&quot;&gt;
         &lt;size&gt;
-            &lt;width&gt;21&lt;/width&gt;
-            &lt;height&gt;27&lt;/height&gt;
+            &lt;width&gt;244&lt;/width&gt;
+            &lt;height&gt;128&lt;/height&gt;
         &lt;/size&gt;
     &lt;/property&gt;
     &lt;property name=&quot;caption&quot;&gt;
@@ -24,59 +32,59 @@
     &lt;property name=&quot;icon&quot;&gt;
         &lt;pixmap&gt;image0&lt;/pixmap&gt;
     &lt;/property&gt;
-    &lt;widget class=&quot;QLayoutWidget&quot;&gt;
+    &lt;grid&gt;
         &lt;property name=&quot;name&quot;&gt;
-            &lt;cstring&gt;layout1&lt;/cstring&gt;
+            &lt;cstring&gt;unnamed&lt;/cstring&gt;
         &lt;/property&gt;
-        &lt;property name=&quot;geometry&quot;&gt;
-            &lt;rect&gt;
-                &lt;x&gt;0&lt;/x&gt;
-                &lt;y&gt;0&lt;/y&gt;
-                &lt;width&gt;231&lt;/width&gt;
-                &lt;height&gt;88&lt;/height&gt;
-            &lt;/rect&gt;
-        &lt;/property&gt;
-        &lt;grid&gt;
+        &lt;widget class=&quot;QLayoutWidget&quot; row=&quot;0&quot; column=&quot;0&quot;&gt;
             &lt;property name=&quot;name&quot;&gt;
-                &lt;cstring&gt;unnamed&lt;/cstring&gt;
+                &lt;cstring&gt;layout1&lt;/cstring&gt;
             &lt;/property&gt;
-            &lt;property name=&quot;margin&quot;&gt;
-                &lt;number&gt;8&lt;/number&gt;
-            &lt;/property&gt;
-            &lt;widget class=&quot;QPushButton&quot; row=&quot;0&quot; column=&quot;1&quot;&gt;
+            &lt;grid&gt;
                 &lt;property name=&quot;name&quot;&gt;
-                    &lt;cstring&gt;btController&lt;/cstring&gt;
+                    &lt;cstring&gt;unnamed&lt;/cstring&gt;
                 &lt;/property&gt;
-                &lt;property name=&quot;text&quot;&gt;
-                    &lt;string&gt;Controller&lt;/string&gt;
+                &lt;property name=&quot;margin&quot;&gt;
+                    &lt;number&gt;4&lt;/number&gt;
                 &lt;/property&gt;
-            &lt;/widget&gt;
-            &lt;widget class=&quot;QPushButton&quot; row=&quot;1&quot; column=&quot;0&quot;&gt;
-                &lt;property name=&quot;name&quot;&gt;
-                    &lt;cstring&gt;btPlayer&lt;/cstring&gt;
+                &lt;property name=&quot;spacing&quot;&gt;
+                    &lt;number&gt;5&lt;/number&gt;
                 &lt;/property&gt;
-                &lt;property name=&quot;text&quot;&gt;
-                    &lt;string&gt;Player&lt;/string&gt;
-                &lt;/property&gt;
-            &lt;/widget&gt;
-            &lt;widget class=&quot;QPushButton&quot; row=&quot;0&quot; column=&quot;0&quot;&gt;
-                &lt;property name=&quot;name&quot;&gt;
-                    &lt;cstring&gt;btGenerator&lt;/cstring&gt;
-                &lt;/property&gt;
-                &lt;property name=&quot;text&quot;&gt;
-                    &lt;string&gt;Generator&lt;/string&gt;
-                &lt;/property&gt;
-            &lt;/widget&gt;
-            &lt;widget class=&quot;QPushButton&quot; row=&quot;1&quot; column=&quot;1&quot;&gt;
-                &lt;property name=&quot;name&quot;&gt;
-                    &lt;cstring&gt;btQuit&lt;/cstring&gt;
-                &lt;/property&gt;
-                &lt;property name=&quot;text&quot;&gt;
-                    &lt;string&gt;Quit&lt;/string&gt;
-                &lt;/property&gt;
-            &lt;/widget&gt;
-        &lt;/grid&gt;
-    &lt;/widget&gt;
+                &lt;widget class=&quot;QPushButton&quot; row=&quot;0&quot; column=&quot;1&quot;&gt;
+                    &lt;property name=&quot;name&quot;&gt;
+                        &lt;cstring&gt;btController&lt;/cstring&gt;
+                    &lt;/property&gt;
+                    &lt;property name=&quot;text&quot;&gt;
+                        &lt;string&gt;Controller&lt;/string&gt;
+                    &lt;/property&gt;
+                &lt;/widget&gt;
+                &lt;widget class=&quot;QPushButton&quot; row=&quot;1&quot; column=&quot;0&quot;&gt;
+                    &lt;property name=&quot;name&quot;&gt;
+                        &lt;cstring&gt;btPlayer&lt;/cstring&gt;
+                    &lt;/property&gt;
+                    &lt;property name=&quot;text&quot;&gt;
+                        &lt;string&gt;Player&lt;/string&gt;
+                    &lt;/property&gt;
+                &lt;/widget&gt;
+                &lt;widget class=&quot;QPushButton&quot; row=&quot;0&quot; column=&quot;0&quot;&gt;
+                    &lt;property name=&quot;name&quot;&gt;
+                        &lt;cstring&gt;btGenerator&lt;/cstring&gt;
+                    &lt;/property&gt;
+                    &lt;property name=&quot;text&quot;&gt;
+                        &lt;string&gt;Generator&lt;/string&gt;
+                    &lt;/property&gt;
+                &lt;/widget&gt;
+                &lt;widget class=&quot;QPushButton&quot; row=&quot;1&quot; column=&quot;1&quot;&gt;
+                    &lt;property name=&quot;name&quot;&gt;
+                        &lt;cstring&gt;btQuit&lt;/cstring&gt;
+                    &lt;/property&gt;
+                    &lt;property name=&quot;text&quot;&gt;
+                        &lt;string&gt;Quit&lt;/string&gt;
+                    &lt;/property&gt;
+                &lt;/widget&gt;
+            &lt;/grid&gt;
+        &lt;/widget&gt;
+    &lt;/grid&gt;
 &lt;/widget&gt;
 &lt;toolbars&gt;
 &lt;/toolbars&gt;

Modified: trunk/pkg/common/Engine/StandAloneEngine/PeriodicEngine.hpp
===================================================================
--- trunk/pkg/common/Engine/StandAloneEngine/PeriodicEngine.hpp	2008-06-10 09:17:01 UTC (rev 1382)
+++ trunk/pkg/common/Engine/StandAloneEngine/PeriodicEngine.hpp	2008-06-10 10:28:40 UTC (rev 1383)
@@ -30,14 +30,14 @@
 		Real lastRealTime,lastVirtTime; long lastIter;
 		bool mayDouble,mayHalve;
 		bool perhapsInconsistent;
-	public :
-		PeriodicEngine(): virtTimeLim(-1,0,0),realTimeLim(-1,0,0),iterLim(-1,0,0), lastRealTime(0.),lastVirtTime(0.),lastIter(0),mayDouble(false),mayHalve(false),perhapsInconsistent(true){};
 		void ensureConsistency(Vector3r&amp; v){
 			if(v[0]&lt;0) return; // not active
 			if(v[2]&lt;v[0]){Real lo=v[2]; v[2]=v[0]; v[0]=lo;} // swap limits if necessary
 			if(v[1]&lt;v[0]) v[1]=v[0]; // put actual value below the lower limit to the lower limit
 			if(v[1]&gt;v[2]) v[2]=v[1]; // put actual value above the upper limit to the upper limit
 		}
+	public :
+		PeriodicEngine(): virtTimeLim(-1,0,0),realTimeLim(-1,0,0),iterLim(-1,0,0), lastRealTime(0.),lastVirtTime(0.),lastIter(0),mayDouble(false),mayHalve(false),perhapsInconsistent(true){};
 		virtual void action(MetaBody* b) { throw; }
 		virtual bool isActivated(){
 			if(perhapsInconsistent){ ensureConsistency(virtTimeLim); ensureConsistency(realTimeLim); ensureConsistency(iterLim); perhapsInconsistent=false; }
@@ -48,10 +48,10 @@
 			long nowIter=Omega::instance().getCurrentIteration();
 			Real nowVirtTime=Omega::instance().getSimulationTime();
 			timeval tp; gettimeofday(&amp;tp,NULL); Real nowRealTime=tp.tv_sec+tp.tv_usec/1e6;
-
-			if (  (virtTimeLim[0]&gt;=0 &amp;&amp; lastVirtTime-nowVirtTime&gt;virtTimeLim[1])
-			 || (realTimeLim[0]&gt;=0 &amp;&amp; lastRealTime-nowRealTime&gt;realTimeLim[1])
-			 || (iterLim[0]&gt;=0     &amp;&amp; lastIter    -nowIter    &gt;iterLim[1])){
+			//cerr&lt;&lt;&quot;--------------------&quot;&lt;&lt;endl; cerr&lt;&lt;&quot;virt:&quot;&lt;&lt;virtTimeLim&lt;&lt;&quot;;&quot;&lt;&lt;lastVirtTime&lt;&lt;&quot;;&quot;&lt;&lt;nowVirtTime&lt;&lt;endl; cerr&lt;&lt;&quot;real:&quot;&lt;&lt;realTimeLim&lt;&lt;&quot;;&quot;&lt;&lt;lastRealTime&lt;&lt;&quot;;&quot;&lt;&lt;nowRealTime&lt;&lt;endl; cerr&lt;&lt;&quot;iter:&quot;&lt;&lt;iterLim&lt;&lt;&quot;;&quot;&lt;&lt;lastIter&lt;&lt;&quot;;&quot;&lt;&lt;nowIter&lt;&lt;endl;
+			if (  (virtTimeLim[0]&gt;=0 &amp;&amp; nowVirtTime-lastVirtTime&gt;virtTimeLim[1])
+			 || (realTimeLim[0]&gt;=0 &amp;&amp; nowRealTime-lastRealTime&gt;realTimeLim[1])
+			 || (iterLim[0]&gt;=0     &amp;&amp; nowIter    -lastIter    &gt;iterLim[1])){
 				lastVirtTime=nowVirtTime; lastRealTime=nowRealTime; lastIter=nowIter;
 				return true;
 			} else return false;

Modified: trunk/scripts/simple-scene-graph.py
===================================================================
--- trunk/scripts/simple-scene-graph.py	2008-06-10 09:17:01 UTC (rev 1382)
+++ trunk/scripts/simple-scene-graph.py	2008-06-10 10:28:40 UTC (rev 1383)
@@ -32,9 +32,16 @@
 	MetaEngine('PhysicalParametersMetaEngine',[EngineUnit('LeapFrogPositionIntegrator')]),
 	MetaEngine('PhysicalParametersMetaEngine',[EngineUnit('LeapFrogOrientationIntegrator')]),
 	###
-	### NOTE&#160;this extra engine
+	### NOTE&#160;this extra engine:
 	###
-	StandAloneEngine('PlotDataGetter',{'timeInterval':.01,'addPlotDataCall':'myAddPlotData()'})
+	### You want snapshot to be taken every 1 sec (realTimeLim) or every 50 iterations (iterLim),
+	### whichever comes soones. virtTimeLim attribute is unset, hence virtual time period is not taken into account.
+	### If there is too much data, they will be reduced automatically (every second number will be ditched) but
+	### the upper limit will always be guarded. 
+	### 
+	### The engine _must_ be labeled 'plotDataCollector', so that the reducer may find it and adjust its periods if necessary.
+	###
+	StandAloneEngine('PeriodicPythonRunner',{'realTimeLim':[1,1,4],'iterLim':[50,50,200],'command':'myAddPlotData()','label':'plotDataCollector'})
 ]
 from yade import utils
 o.bodies.append(utils.box(center=[0,0,0],extents=[.5,.5,.5],dynamic=False,color=[1,0,0],young=30e9,poisson=.3,density=2400))
@@ -66,7 +73,7 @@
 o.run();
 print &quot;&quot;&quot;Now, you can say
 
- yade.plot.show()
+ yade.plot.plot()
 
-to see figures. Calculation will be suspended until all plot windows will have been closed.
+to see figures.
 &quot;&quot;&quot;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000343.html">[Yade-commits] r1382 - in trunk: core extra extra/clump gui/qt3
</A></li>
	<LI>Next message: <A HREF="000345.html">[Yade-commits] r1384 - trunk/pkg/dem/Engine/DeusExMachina
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#344">[ date ]</a>
              <a href="thread.html#344">[ thread ]</a>
              <a href="subject.html#344">[ subject ]</a>
              <a href="author.html#344">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/yade-commits">More information about the Yade-commits
mailing list</a><br>
</body></html>
