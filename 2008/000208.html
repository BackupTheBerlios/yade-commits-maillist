<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Yade-commits] r1243 - in trunk: . core extra extra/clump	extra/tetra extra/usct gui/cmd lib/base	pkg/common/Engine/EngineUnit pkg/dem/Engine/DeusExMachina	pkg/dem/Engine/EngineUnit
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/yade-commits/2008/index.html" >
   <LINK REL="made" HREF="mailto:yade-commits%40lists.berlios.de?Subject=Re%3A%20%5BYade-commits%5D%20r1243%20-%20in%20trunk%3A%20.%20core%20extra%20extra/clump%0A%09extra/tetra%20extra/usct%20gui/cmd%20lib/base%0A%09pkg/common/Engine/EngineUnit%20pkg/dem/Engine/DeusExMachina%0A%09pkg/dem/Engine/EngineUnit&In-Reply-To=%3C200802091521.m19FLiai019873%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000207.html">
   <LINK REL="Next"  HREF="000209.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Yade-commits] r1243 - in trunk: . core extra extra/clump	extra/tetra extra/usct gui/cmd lib/base	pkg/common/Engine/EngineUnit pkg/dem/Engine/DeusExMachina	pkg/dem/Engine/EngineUnit</H1>
    <B>eudoxos at BerliOS</B> 
    <A HREF="mailto:yade-commits%40lists.berlios.de?Subject=Re%3A%20%5BYade-commits%5D%20r1243%20-%20in%20trunk%3A%20.%20core%20extra%20extra/clump%0A%09extra/tetra%20extra/usct%20gui/cmd%20lib/base%0A%09pkg/common/Engine/EngineUnit%20pkg/dem/Engine/DeusExMachina%0A%09pkg/dem/Engine/EngineUnit&In-Reply-To=%3C200802091521.m19FLiai019873%40sheep.berlios.de%3E"
       TITLE="[Yade-commits] r1243 - in trunk: . core extra extra/clump	extra/tetra extra/usct gui/cmd lib/base	pkg/common/Engine/EngineUnit pkg/dem/Engine/DeusExMachina	pkg/dem/Engine/EngineUnit">eudoxos at mail.berlios.de
       </A><BR>
    <I>Sat Feb  9 16:21:44 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000207.html">[Yade-commits] r1242 - in trunk: . core extra extra/clump extra/screw extra/tetra extra/usct gui gui/cmd lib/factory pkg/common pkg/common/Container pkg/common/DataClass/BoundingVolume pkg/common/DataClass/GeometricalModel pkg/common/DataClass/InteractingGeometry pkg/common/DataClass/InteractionGeometry pkg/common/DataClass/InteractionPhysics pkg/common/DataClass/PhysicalAction pkg/common/DataClass/PhysicalParameters pkg/common/Engine/DeusExMachina pkg/common/Engine/EngineUnit pkg/common/Engine/MetaEngine pkg/common/Engine/StandAloneEngine pkg/common/RenderingEngine/GLDrawBoundingVolume pkg/common/RenderingEngine/GLDrawGeometricalModel pkg/common/RenderingEngine/GLDrawInteractingGeometry pkg/common/RenderingEngine/GLDrawInteractionGeometry pkg/common/RenderingEngine/GLDrawInteractionPhysics pkg/common/RenderingEngine/GLDrawShadowVolume pkg/common/RenderingEngine/GLDrawState pkg/common/RenderingEngine/OpenGLRenderingEngine pkg/dem pkg/dem/DataClass/InteractingGeometry pkg/dem/DataC! lass/InteractionGeometry pkg/dem/DataClass/InteractionPhysics pkg/dem/DataClass/PhysicalAction pkg/dem/DataClass/PhysicalParameters pkg/dem/Engine/DeusExMachina pkg/dem/Engine/EngineUnit pkg/dem/Engine/StandAloneEngine pkg/dem/PreProcessor pkg/dem/RenderingEngine/GLDrawInteractingMyTetrahedron pkg/dem/RenderingEngine/GLDrawSDECLinkGeometry pkg/dem/RenderingEngine/GLDrawSpheresContactGeometry pkg/fem/DataClass/GeometricalModel pkg/fem/DataClass/PhysicalParameters pkg/fem/Engine/EngineUnit pkg/fem/Engine/StandAloneEngine pkg/fem/PreProcessor pkg/lattice/DataClass/GeometricalModel pkg/lattice/DataClass/InteractingGeometry pkg/lattice/DataClass/InteractionPhysics pkg/lattice/DataClass/PhysicalParameters pkg/lattice/Engine/EngineUnit pkg/lattice/Engine/StandAloneEngine pkg/lattice/PreProcessor pkg/lattice/RenderingEngine/GLDrawLatticeBeamState pkg/lattice/RenderingEngine/GLDrawLatticeInteractingGeometry pkg/lattice/RenderingEngine/GLDrawLatticeSetGeometry pkg/lattice/RenderingEn! gine/GLDrawLineSegment pkg/mass-spring/DataClass/InteractionGe! ometry p
</A></li>
        <LI>Next message: <A HREF="000209.html">[Yade-commits] r1244 - in trunk: core extra extra/clump extra/tetra	extra/usct pkg/common/Engine/EngineUnit	pkg/dem/Engine/EngineUnit pkg/dem/PreProcessor	pkg/fem/Engine/EngineUnit pkg/fem/PreProcessor	pkg/lattice/Engine/EngineUnit pkg/lattice/PreProcessor	pkg/mass-spring/Engine/EngineUnit pkg/mass-spring/PreProcessor	pkg/realtime-rigidbody/Engine/EngineUnit	pkg/realtime-rigidbody/PreProcessor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#208">[ date ]</a>
              <a href="thread.html#208">[ thread ]</a>
              <a href="subject.html#208">[ subject ]</a>
              <a href="author.html#208">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: eudoxos
Date: 2008-02-09 16:21:41 +0100 (Sat, 09 Feb 2008)
New Revision: 1243

Removed:
   trunk/core/MetaEngine.hpp
Modified:
   trunk/SConstruct
   trunk/core/EngineUnit1D.hpp
   trunk/core/EngineUnit2D.hpp
   trunk/core/MetaDispatchingEngine.cpp
   trunk/core/MetaDispatchingEngine.hpp
   trunk/core/MetaDispatchingEngine1D.hpp
   trunk/core/MetaDispatchingEngine2D.hpp
   trunk/core/Omega.cpp
   trunk/extra/Brefcom.cpp
   trunk/extra/Brefcom.hpp
   trunk/extra/BrefcomTestGen.cpp
   trunk/extra/clump/Shop.cpp
   trunk/extra/clump/Shop.hpp
   trunk/extra/tetra/Tetra.hpp
   trunk/extra/usct/UniaxialStrainControlledTest.cpp
   trunk/extra/usct/UniaxialStrainControlledTest.hpp
   trunk/gui/cmd/cmdGui.cpp
   trunk/gui/cmd/yadeControl.cpp
   trunk/lib/base/Logging.hpp
   trunk/pkg/common/Engine/EngineUnit/CundallNonViscousForceDamping.hpp
   trunk/pkg/common/Engine/EngineUnit/CundallNonViscousMomentumDamping.hpp
   trunk/pkg/common/Engine/EngineUnit/InteractingBox2AABB.hpp
   trunk/pkg/common/Engine/EngineUnit/InteractingSphere2AABB.hpp
   trunk/pkg/common/Engine/EngineUnit/LeapFrogOrientationIntegrator.hpp
   trunk/pkg/common/Engine/EngineUnit/LeapFrogPositionIntegrator.hpp
   trunk/pkg/common/Engine/EngineUnit/MetaInteractingGeometry2AABB.hpp
   trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.hpp
   trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.hpp
   trunk/pkg/dem/Engine/DeusExMachina/TriaxialCompressionEngine.cpp
   trunk/pkg/dem/Engine/EngineUnit/InteractingBox2InteractingSphere4SpheresContactGeometry.hpp
   trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4DistantSpheresContactGeometry.hpp
   trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4SpheresContactGeometry.hpp
   trunk/pkg/dem/Engine/EngineUnit/MacroMicroElasticRelationships.hpp
Log:
1. Remove MetaEngine, inherit MetaDispatchingEngine directly
2. Fix unbalanced force reporting (thanks for complaining, Bruno)
3. EngineUnits now declare their types with FUNCTOR1D(.) or FUNCTOR2D(.,.) macros, dispatchers will ask for their types automagically. Old syntax still supported, once all engines have those types declared, it will be obsoleted and removed (like e-&gt;add(&quot;InteractingSphere&quot;,&quot;InteractingSphere&quot;,&quot;InteractingSphere2InteractingSphere4SpheresContactGeometry&quot;); Shop and USCTGen usethe new syntax now.
4. Brefcom law passes some rudimentary tests and appears to work (normal force and damage for now; we miss shear force and blocked rotations)
5. Brefcom contact can be drawn with opengl, damage signified by color.
6. Updated Python wrapper.




Modified: trunk/SConstruct
===================================================================
--- trunk/SConstruct	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/SConstruct	2008-02-09 15:21:41 UTC (rev 1243)
@@ -41,7 +41,7 @@
 ########## PROXY TO NEWER SCONS (DOWNLOADED IF NEEDED) ###################################
 ##########################################################################################
 #print sconsVersion
-if sconsVersion&lt;9693: ##9700.20071212:  ##&lt;9700 ##&lt;9693: 
+if sconsVersion&lt;9700.20071212: ##9700.20071212:  ##&lt;9700 ##&lt;9693: 
 	#tgzParams=(&quot;<A HREF="http://dfn.dl.sourceforge.net/sourceforge/scons/scons-local-0.97.tar.gz">http://dfn.dl.sourceforge.net/sourceforge/scons/scons-local-0.97.tar.gz</A>&quot;,&quot;scons-local-0.97&quot;)
 	#tgzParams=(&quot;<A HREF="http://ovh.dl.sourceforge.net/sourceforge/scons/scons-local-0.97.0d20070918.tar.gz">http://ovh.dl.sourceforge.net/sourceforge/scons/scons-local-0.97.0d20070918.tar.gz</A>&quot;,&quot;/scons-local-0.97.0d20070918&quot;) ## sconsVersion&lt;=9700
 	tgzParams=(&quot;<A HREF="http://switch.dl.sourceforge.net/sourceforge/scons/scons-local-0.97.0d20071212.tar.gz">http://switch.dl.sourceforge.net/sourceforge/scons/scons-local-0.97.0d20071212.tar.gz</A>&quot;,&quot;/scons-local-0.97.0d20071212&quot;)

Modified: trunk/core/EngineUnit1D.hpp
===================================================================
--- trunk/core/EngineUnit1D.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/core/EngineUnit1D.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -13,6 +13,8 @@
 
 #include&lt;yade/lib-multimethods/FunctorWrapper.hpp&gt;
 
+#define FUNCTOR1D(type1) public: std::string get1DFunctorType1(void){return string(#type1);}
+
 template
 &lt;
 	class ReturnType,
@@ -21,6 +23,7 @@
 class EngineUnit1D : 	public EngineUnit,
 			public FunctorWrapper&lt;ReturnType, AttributesType&gt;
 {
+	public: virtual std::string get1DFunctorType1(void){throw runtime_error(&quot;Class &quot;+this-&gt;getClassName()+&quot; did not use FUNCTOR1D to declare its argument type?&quot;); }
 	REGISTER_CLASS_NAME(EngineUnit1D);
 	REGISTER_BASE_CLASS_NAME(EngineUnit FunctorWrapper);
 };

Modified: trunk/core/EngineUnit2D.hpp
===================================================================
--- trunk/core/EngineUnit2D.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/core/EngineUnit2D.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -13,6 +13,9 @@
 
 #include&lt;yade/lib-multimethods/FunctorWrapper.hpp&gt;
 
+#define FUNCTOR2D(type1,type2) public: std::string get2DFunctorType1(void){return string(#type1);}; std::string get2DFunctorType2(void){return string(#type2);};
+
+
 template
 &lt;
 	class ReturnType,
@@ -21,6 +24,8 @@
 class EngineUnit2D :	public EngineUnit,
 			public FunctorWrapper&lt;ReturnType, AttributesType&gt;
 {
+	public: virtual std::string get2DFunctorType1(void){throw runtime_error(&quot;Class &quot;+this-&gt;getClassName()+&quot; did not use FUNCTOR2D to declare its argument types?&quot;);}
+	public: virtual std::string get2DFunctorType2(void){throw runtime_error(&quot;Class &quot;+this-&gt;getClassName()+&quot; did not use FUNCTOR2D to declare its argument types?&quot;);}
 	REGISTER_CLASS_NAME(EngineUnit2D);
 	REGISTER_BASE_CLASS_NAME(EngineUnit FunctorWrapper);
 };

Modified: trunk/core/MetaDispatchingEngine.cpp
===================================================================
--- trunk/core/MetaDispatchingEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/core/MetaDispatchingEngine.cpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -22,13 +22,13 @@
 
 void MetaDispatchingEngine::postProcessAttributes(bool deserializing)
 {
-	MetaEngine::postProcessAttributes(deserializing);
+	Engine::postProcessAttributes(deserializing);
 }
 
 
 void MetaDispatchingEngine::registerAttributes()
 {
-	MetaEngine::registerAttributes();
+	Engine::registerAttributes();
 	REGISTER_ATTRIBUTE(functorNames);
 	REGISTER_ATTRIBUTE(functorArguments);
 }

Modified: trunk/core/MetaDispatchingEngine.hpp
===================================================================
--- trunk/core/MetaDispatchingEngine.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/core/MetaDispatchingEngine.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -9,10 +9,10 @@
 #ifndef METADISPATCHINGENGINE_HPP
 #define METADISPATCHINGENGINE_HPP
 
-#include &quot;MetaEngine.hpp&quot;
+#include &quot;Engine.hpp&quot;
 #include &quot;EngineUnit.hpp&quot;
 
-class MetaDispatchingEngine : public MetaEngine
+class MetaDispatchingEngine : public Engine
 {
 	public:
 		vector&lt;vector&lt;string&gt; &gt;		functorNames; // public for python interface; since there is getFunctorArguments returning RW(!) reference to this, why have it private anyway?!
@@ -45,7 +45,7 @@
 		virtual void registerAttributes();
 		virtual void postProcessAttributes(bool deserializing);
 	REGISTER_CLASS_NAME(MetaDispatchingEngine);
-	REGISTER_BASE_CLASS_NAME(MetaEngine);
+	REGISTER_BASE_CLASS_NAME(Engine);
 };
 
 REGISTER_SERIALIZABLE(MetaDispatchingEngine,false);

Modified: trunk/core/MetaDispatchingEngine1D.hpp
===================================================================
--- trunk/core/MetaDispatchingEngine1D.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/core/MetaDispatchingEngine1D.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -37,12 +37,23 @@
 {
 
 	public :
-		virtual void add( string baseClassName1, string libName, shared_ptr&lt;EngineUnit&gt; eu = shared_ptr&lt;EngineUnitType&gt;())
-		{
+		virtual void __attribute__((deprecated)) add(string baseClassName1, string libName, shared_ptr&lt;EngineUnit&gt; eu = shared_ptr&lt;EngineUnitType&gt;()) {
 			storeFunctorName(baseClassName1,libName,static_pointer_cast&lt;EngineUnitType&gt;(eu));
 			add1DEntry(baseClassName1,libName,static_pointer_cast&lt;EngineUnitType&gt;(eu));
 		}
 
+		virtual void add(EngineUnitType* eu){ add(shared_ptr&lt;EngineUnitType&gt;(eu)); }
+		virtual void add(shared_ptr&lt;EngineUnitType&gt; eu){
+			storeFunctorName(eu-&gt;get1DFunctorType1(),eu-&gt;getClassName(),eu);
+			add1DEntry(eu-&gt;get1DFunctorType1(),eu-&gt;getClassName(),static_pointer_cast&lt;EngineUnitType&gt;(eu));
+		}
+
+		virtual void add(string euType){
+			shared_ptr&lt;EngineUnitType&gt; eu=dynamic_pointer_cast&lt;EngineUnitType&gt;(ClassFactory::instance().createShared(euType));
+			if(!eu) throw runtime_error(&quot;Class `&quot;+euType+&quot;' could not be cast to required 1D EngineUnit&quot;);
+			add(eu);
+		}
+
 		int getDimension() { return 1; }
 	
 		virtual string getEngineUnitType() 

Modified: trunk/core/MetaDispatchingEngine2D.hpp
===================================================================
--- trunk/core/MetaDispatchingEngine2D.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/core/MetaDispatchingEngine2D.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -17,6 +17,8 @@
 /*! Same as DISPATCHER_ADD3 macro, but passes the additional 4th argument to MetaDispatchingEngine2D::add as its 4th, optional argument */
 #define DISPATCHER_ADD3_1(e1,e2,e3,e4) add(#e1,#e2,#e3,e4); {/* compile-time check for class existence */ typedef e1 p1; typedef e2 p2; typedef e3 p3;}
 
+
+
 template
 &lt;
 	class baseClass1, 
@@ -36,12 +38,28 @@
 				&gt;
 {
 	public :
-		virtual void add( string baseClassName1, string baseClassName2, string libName, shared_ptr&lt;EngineUnit&gt; eu = shared_ptr&lt;EngineUnitType&gt;())
+		__attribute__((deprecated))
+		virtual void add ( string baseClassName1, string baseClassName2, string libName, shared_ptr&lt;EngineUnit&gt; eu = shared_ptr&lt;EngineUnitType&gt;())  
 		{
 			storeFunctorName(baseClassName1,baseClassName2,libName,static_pointer_cast&lt;EngineUnitType&gt;(eu));
 			add2DEntry(baseClassName1,baseClassName2,libName,static_pointer_cast&lt;EngineUnitType&gt;(eu));
 		}
 
+		/* add functor by pointer: this is convenience for calls like foo-&gt;add(new SomeFunctor); */
+		virtual void add(EngineUnitType* eu){ add(shared_ptr&lt;EngineUnitType&gt;(eu)); }
+		/* add functor by shared pointer */
+		virtual void add(shared_ptr&lt;EngineUnitType&gt; eu){
+			storeFunctorName(eu-&gt;get2DFunctorType1(),eu-&gt;get2DFunctorType2(),eu-&gt;getClassName(),eu);
+			add2DEntry(eu-&gt;get2DFunctorType1(),eu-&gt;get2DFunctorType2(),eu-&gt;getClassName(),static_pointer_cast&lt;EngineUnitType&gt;(eu));
+		}
+		/* add functor by its literal name */
+		virtual void add(string euType){
+			shared_ptr&lt;EngineUnitType&gt; eu=dynamic_pointer_cast&lt;EngineUnitType&gt;(ClassFactory::instance().createShared(euType));
+			if(!eu) throw runtime_error(&quot;Class `&quot;+euType+&quot;' could not be cast to required 2D EngineUnit&quot;);
+			add(eu);
+		}
+
+
 		virtual int getDimension() { return 2; }
 
 		virtual string getEngineUnitType() 

Deleted: trunk/core/MetaEngine.hpp
===================================================================
--- trunk/core/MetaEngine.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/core/MetaEngine.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -1,31 +0,0 @@
-/*************************************************************************
-*  Copyright (C) 2004 by Olivier Galizzi                                 *
-*  <A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">olivier.galizzi at imag.fr</A>                                               *
-*  Copyright (C) 2004 by Janek Kozicki                                   *
-*  <A HREF="https://lists.berlios.de/mailman/listinfo/yade-commits">cosurgi at berlios.de</A>                                                    *
-*                                                                        *
-*  This program is free software; it is licensed under the terms of the  *
-*  GNU General Public License v2 or later. See file LICENSE for details. *
-*************************************************************************/
-
-#ifndef METAENGINE_HPP
-#define METAENGINE_HPP
-
-#include &quot;Engine.hpp&quot;
-
-class MetaEngine : public Engine
-{
-	public :
-		MetaEngine() {};
-		virtual ~MetaEngine() {};
-
-		virtual string getEngineUnitType() { throw; };
-
-	REGISTER_CLASS_NAME(MetaEngine);	
-	REGISTER_BASE_CLASS_NAME(Engine);
-};
-
-REGISTER_SERIALIZABLE(MetaEngine,false);
-
-#endif // METAENGINE_HPP
-

Modified: trunk/core/Omega.cpp
===================================================================
--- trunk/core/Omega.cpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/core/Omega.cpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -122,8 +122,9 @@
 			for(int i=0;i&lt;f-&gt;getBaseClassNumber();i++)
 				dynlibs[name].baseClasses.insert(f-&gt;getBaseClassName(i));
 		}
-		catch (FactoryError&amp;)
-		{
+		catch (FactoryError&amp; e){
+			/* FIXME: this catches all errors! Some of them are not harmful, however:
+			 * when a class is not factorable, it is OK to skip it; */	
 		}
 	}
 
@@ -137,7 +138,7 @@
 		{
 			string name = *bci;
 			if (name==&quot;MetaDispatchingEngine1D&quot; || name==&quot;MetaDispatchingEngine2D&quot;)
-				(*dli).second.baseClasses.insert(&quot;MetaEngine&quot;);
+				(*dli).second.baseClasses.insert(&quot;MetaDispatchingEngine&quot;);
 			else if (name==&quot;EngineUnit1D&quot; || name==&quot;EngineUnit2D&quot;)
 				(*dli).second.baseClasses.insert(&quot;EngineUnit&quot;);
 			else if (name==&quot;Serializable&quot;)

Modified: trunk/extra/Brefcom.cpp
===================================================================
--- trunk/extra/Brefcom.cpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/extra/Brefcom.cpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -2,9 +2,10 @@
 #include&quot;Brefcom.hpp&quot;
 #include&lt;yade/core/MetaBody.hpp&gt;
 #include&lt;yade/pkg-dem/BodyMacroParameters.hpp&gt;
+#include&lt;yade/pkg-common/Sphere.hpp&gt;
 
 
-YADE_PLUGIN(&quot;BrefcomMakeContact&quot;,&quot;BrefcomContact&quot;,&quot;BrefcomLaw&quot;);
+YADE_PLUGIN(&quot;BrefcomMakeContact&quot;,&quot;BrefcomContact&quot;,&quot;BrefcomLaw&quot;,&quot;GLDrawBrefcomContact&quot;);
 
 /********************** BrefcomMakeContact ****************************/
 CREATE_LOGGER(BrefcomMakeContact);
@@ -37,8 +38,8 @@
 
 		contPhys-&gt;omegaPl=0;
 		/* let's try initial distance for d0; that should prevent packings with inner stresses from exploding */
-		//contPhys-&gt;d0=contGeom-&gt;radius1 + contGeom-&gt;radius2; // equilibrium distace is &quot;just touching&quot;
-		contPhys-&gt;d0=(elast1-&gt;se3.position-elast2-&gt;se3.position).Length(); // equilibrium distance is now
+		contPhys-&gt;d0=contGeom-&gt;radius1 + contGeom-&gt;radius2; // equilibrium distace is &quot;just touching&quot;
+		//contPhys-&gt;d0=(elast1-&gt;se3.position-elast2-&gt;se3.position).Length(); // equilibrium distance is now
 		contPhys-&gt;Kn=(E12*S12/contPhys-&gt;d0)*( (1+alpha)/(beta*(1+nu12) + gamma*(1-alpha*nu12)));
 		contPhys-&gt;Ks=contPhys-&gt;Kn*(1-alpha*nu12)/(1+nu12);
 		contPhys-&gt;zeta=zeta; // TODO: calculate zeta from Gf
@@ -48,8 +49,9 @@
 		contPhys-&gt;prevNormal=contGeom-&gt;normal;
 		contPhys-&gt;Fs=Vector3r::ZERO;
 
+		// NEVER!!!
 		// HACK: after beginning all links will be without cohesion (omegaPl=1) !!!
-		if(Omega::instance().getCurrentIteration()&gt;50) contPhys-&gt;omegaPl=1;
+		if(false &amp;&amp; Omega::instance().getCurrentIteration()&gt;50) contPhys-&gt;omegaPl=1;
 		// OTOH, structural contacts will have this flag
 		else contPhys-&gt;isStructural=true;
 	}
@@ -67,16 +69,18 @@
 CREATE_LOGGER(BrefcomLaw);
 
 void BrefcomLaw::calculateNormalForce(){
-	Real d=(rbp1-&gt;se3.position - rbp2-&gt;se3.position).Length();
+	Real d=(rbp1-&gt;se3.position-rbp2-&gt;se3.position).Length();
 	//TRVAR2(d,BC-&gt;dBreak);
 	if(d &gt; BC-&gt;dBreak){
 		BC-&gt;omegaPl=1; /* LOG_DEBUG(&quot;Complete damage for #&quot;&lt;&lt;id1&lt;&lt;&quot;+#&quot;&lt;&lt;id2); */
-		Fn=Vector3r::ZERO; return; }
-	Fn = (d - BC-&gt;d0_curr) * BC-&gt;Kn * contGeom-&gt;normal;
-	//TRVAR4(d,BC-&gt;d0_curr,Fn.Length(),BC-&gt;FnMax_curr);
+		Fn=0; return; }
+	Fn = /* normal is A&#8594;B, but Fn is by convention as applied to A */ (d - BC-&gt;d0_curr) * BC-&gt;Kn;
 
+	BREFREC(Fn)
 	BREFREC(d);
-	BREFREC(BC-&gt;d0_curr);
+	BREFREC(BC-&gt;dBreak);
+	BREFREC(BC-&gt;dPeak);
+	BREFREC(BC-&gt;dPeak_curr)
 
 	#if 0
 		if(d&gt;BC-&gt;dPeak_curr){ /* on the softening branch of the diagram */
@@ -94,18 +98,18 @@
 	Fs = BC-&gt;Fs;
 	Real dt=Omega::instance().getTimeStep();
 	// rotation of the contact normal
-	Fs -= BC-&gt;Fs.Cross( BC-&gt;prevNormal.Cross(contGeom-&gt;normal) );
+	Fs += BC-&gt;Fs.Cross( BC-&gt;prevNormal.Cross(contGeom-&gt;normal) );
 	//TRVAR1(BC-&gt;Fs.Cross( BC-&gt;prevNormal.Cross(contGeom-&gt;normal)));
 	// mutual rotation of elements
 	Real angle=dt*.5*contGeom-&gt;normal.Dot(rbp1-&gt;angularVelocity+rbp2-&gt;angularVelocity);
-	Fs -= BC-&gt;Fs.Cross(angle*contGeom-&gt;normal);
+	Fs += BC-&gt;Fs.Cross(angle*contGeom-&gt;normal);
 	//TRVAR1(BC-&gt;Fs.Cross(angle*contGeom-&gt;normal));
 	// element slip
 	Vector3r relVelocity=
 		rbp2-&gt;velocity+rbp2-&gt;angularVelocity.Cross(contGeom-&gt;contactPoint-rbp2-&gt;se3.position)-
 		rbp1-&gt;velocity+rbp1-&gt;angularVelocity.Cross(contGeom-&gt;contactPoint-rbp1-&gt;se3.position);
 	Vector3r shearDisplacement=dt*(relVelocity-contGeom-&gt;normal.Dot(relVelocity)*contGeom-&gt;normal);
-	Fs -= BC-&gt;Ks*shearDisplacement;
+	Fs += BC-&gt;Ks*shearDisplacement;
 	//TRVAR1(BC-&gt;Ks*shearDisplacement);
 	if(isnan(Fs[0]) || isnan(Fs[1]) || isnan(Fs[2])){
 		TRVAR4(BC-&gt;Fs, BC-&gt;prevNormal, contGeom-&gt;normal, BC-&gt;Fs.Cross(BC-&gt;prevNormal.Cross(contGeom-&gt;normal)));
@@ -130,21 +134,26 @@
 
 		If any of these conditions is violated, decrement forces keeping their ratio and incement damage.
 	*/
-	Real fn=Fn.Dot(contGeom-&gt;normal) /* sign does matter here */, fs=Fs.Length() /* sign irrelevant */;
-	if(fn&gt;Mathr::EPSILON &amp;&amp; fn &gt; BC-&gt;FnMax_curr){
+	Real fs=Fs.Length() /* sign irrelevant */;
+	if(Fn &gt; Mathr::EPSILON &amp;&amp; Fn &gt; BC-&gt;FnMax_curr){
 		/* return force on the softening branch */
-		Real dmgFactor=max(1.,(BC-&gt;FnMax_curr - (fn - BC-&gt;FnMax_curr)/BC-&gt;zeta) / fn);
-		//if(isnan(dmgFactor)){TRVAR3(fn,Fn,contGeom-&gt;normal); exit(0);}
-		//TRVAR4(fn,BC-&gt;FnMax_curr,dmgFactor,BC-&gt;omegaPl);
-		Fn*=dmgFactor; fn*=dmgFactor;
-		BC-&gt;omegaPl=1-fn/BC-&gt;FnMax; // FnMax_curr will be updated from omegaPl at the next iteration
+		Real envRetFactor=max(1e-3 /*guard numerical stability*/,min(1. /*guard sane solution*/,
+			(BC-&gt;FnMax_curr - (Fn - BC-&gt;FnMax_curr)/BC-&gt;zeta) / Fn ));
+		//if(isnan(envRetFactor)){TRVAR3(fn,Fn,contGeom-&gt;normal); exit(0);}
+		Real d=(rbp1-&gt;se3.position - rbp2-&gt;se3.position).Length();
+		//TRVAR6(BC-&gt;d0,BC-&gt;dPeak,BC-&gt;dPeak_curr,BC-&gt;dBreak,BC-&gt;d0_curr,d);
+		//TRVAR5(Fn,BC-&gt;FnMax_curr,envRetFactor,BC-&gt;omegaPl,(BC-&gt;FnMax_curr - (Fn - BC-&gt;FnMax_curr)/BC-&gt;zeta) / Fn );
+		// if((d&lt;BC-&gt;d0_curr &amp;&amp; Fn&lt;0) || (d&gt;BC-&gt;d0_curr &amp;&amp; Fn&gt;0)) exit(1);
+		Fn*=envRetFactor;
+		BC-&gt;omegaPl=1-Fn/BC-&gt;FnMax; // FnMax_curr will be updated from omegaPl at the next iteration
+		if(BC-&gt;omegaPl&lt;0 || BC-&gt;omegaPl&gt;1){TRVAR5(Fn,BC-&gt;FnMax_curr,BC-&gt;zeta,envRetFactor,BC-&gt;omegaPl); exit(1);}
 		// LOG_DEBUG(&quot;Increasing damage to &quot;&lt;&lt;BC-&gt;omegaPl);
-		if(Omega::instance().getCurrentIteration()%100 &amp;&amp; BC-&gt;omegaPl&gt;=1) { Real d=(rbp1-&gt;se3.position - rbp2-&gt;se3.position).Length(); TRVAR4(rbp1-&gt;se3.position,rbp2-&gt;se3.position,d,fn);  }
-		if(isnan(Fn[0]) || isnan(Fn[1]) || isnan(Fn[2])){ TRVAR4(Fn,fn,dmgFactor,BC-&gt;omegaPl);	exit(0); }
+		//if(Omega::instance().getCurrentIteration()%100 &amp;&amp; BC-&gt;omegaPl&gt;=1) { Real d=(rbp1-&gt;se3.position - rbp2-&gt;se3.position).Length(); TRVAR4(rbp1-&gt;se3.position,rbp2-&gt;se3.position,d,Fn);  }
+		if(isnan(Fn)){ TRVAR3(Fn,envRetFactor,BC-&gt;omegaPl);	exit(0); }
 	}
 	//TRVAR2(fs,BC-&gt;cohesion_curr - fn*tan(BC-&gt;frictionAngle));
-	if(fs &gt; BC-&gt;cohesion_curr - fn*tan(BC-&gt;frictionAngle)){
-		Real FsMax_curr=BC-&gt;cohesion_curr - fn*tan(BC-&gt;frictionAngle);
+	if(fs &gt; BC-&gt;cohesion_curr - Fn*tan(BC-&gt;frictionAngle)){
+		Real FsMax_curr=BC-&gt;cohesion_curr - Fn*tan(BC-&gt;frictionAngle);
 		Fs.Normalize();
 		Fs*=FsMax_curr;
 		#if 0
@@ -165,27 +174,25 @@
 		#endif
 	}
 	BREFREC(BC-&gt;omegaPl);
-	BREFREC(Fn.Length());
+	BREFREC(Fn);
 	BREFREC(Fs.Length());
 }
 
 void BrefcomLaw::applyForces(){
-	BC-&gt;Fs=Fs; BC-&gt;Fn=Fn; // remember forces
-	Vector3r force=Fn+Fs;
+	BC-&gt;Fs=Fs; BC-&gt;Fn=Fn*contGeom-&gt;normal; // remember forces
+	Vector3r force=BC-&gt;Fn+Fs;
 
-	static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(id1,ForceClassIndex))-&gt;force-=force;
-	static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(id2,ForceClassIndex))-&gt;force+=force;
-	static_pointer_cast&lt;Momentum&gt;(rootBody-&gt;physicalActions-&gt;find(id1,MomentumClassIndex))-&gt;momentum-=
-		(contGeom-&gt;contactPoint - rbp1-&gt;se3.position).Cross(force);
-	static_pointer_cast&lt;Momentum&gt;(rootBody-&gt;physicalActions-&gt;find(id2,MomentumClassIndex))-&gt;momentum+=
-		(contGeom-&gt;contactPoint - rbp2-&gt;se3.position).Cross(force);
+	static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(id1,ForceClassIndex))-&gt;force+=force;
+	static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(id2,ForceClassIndex))-&gt;force-=force;
+	static_pointer_cast&lt;Momentum&gt;(rootBody-&gt;physicalActions-&gt;find(id1,MomentumClassIndex))-&gt;momentum+=(contGeom-&gt;contactPoint-rbp1-&gt;se3.position).Cross(force);
+	static_pointer_cast&lt;Momentum&gt;(rootBody-&gt;physicalActions-&gt;find(id2,MomentumClassIndex))-&gt;momentum-=(contGeom-&gt;contactPoint-rbp2-&gt;se3.position).Cross(force);
 }
 
 void BrefcomLaw::action(Body* body){
 	rootBody=YADE_CAST&lt;MetaBody*&gt;(body);
 	for(InteractionContainer::iterator I=rootBody-&gt;transientInteractions-&gt;begin(); I!=rootBody-&gt;transientInteractions-&gt;end(); ++I){
 		if(!(*I)-&gt;isReal) continue;
-		//TRACE;
+		// TRACE;
 		// initialize temporaries
 		id1=(*I)-&gt;getId1(); id2=(*I)-&gt;getId2();
 		body1=Body::byId(id1); body2=Body::byId(id2);
@@ -200,6 +207,7 @@
 		// if(BC-&gt;omegaPl &gt;= 1) continue; // we want to keep broken links formally alive, for statistics of material damage
 		
 		recValues.clear(); recLabels.clear();
+		BREFREC2(Omega::instance().getCurrentIteration(),&quot;iter&quot;);
 		BREFREC(id1);
 		BREFREC(id2);
 		BREFREC2(rbp1-&gt;se3.position[0],&quot;x1&quot;);
@@ -208,13 +216,14 @@
 		BREFREC2(rbp2-&gt;se3.position[0],&quot;x2&quot;);
 		BREFREC2(rbp2-&gt;se3.position[1],&quot;y2&quot;);
 		BREFREC2(rbp2-&gt;se3.position[2],&quot;z2&quot;);
+		BREFREC2(BC-&gt;omegaPl,&quot;&#969;&quot;);
 
 		BC-&gt;deduceOtherParams(); // initialize non-fundamental params/variables
 		//TRVAR5(BC-&gt;d0,BC-&gt;Kn,BC-&gt;Ks,BC-&gt;zeta,BC-&gt;FnMax);
 		//TRVAR5(BC-&gt;omegaPl,BC-&gt;dBreak,BC-&gt;dPeak,BC-&gt;d0_curr,BC-&gt;dPeak_curr);
 
 		calculateNormalForce();
-		calculateShearForce();
+		//calculateShearForce();
 		// rotationEffects();
 
 		envelopeAndDamage();
@@ -223,6 +232,8 @@
 		//if(BC-&gt;omegaPl&gt;=1) { (*I)-&gt;isReal=false; return; } // if total damage, cancel interaction; collider will delete it properly
 
 		applyForces();
+		//if(abs(Fn.Length())&gt;50 &amp;&amp; (Fn.Length()/BC-&gt;prevFn&lt;.5 || Fn.Length()/BC-&gt;prevFn&gt;2)){TRVAR2(BC-&gt;prevFn,Fn.Length());}
+		// BC-&gt;prevFn=Fn;
 
 		for(size_t i=0; i&lt;recValues.size(); i++) recStream&lt;&lt;recLabels[i]&lt;&lt;&quot;: &quot;&lt;&lt;recValues[i]&lt;&lt;&quot; &quot;;
 		recStream&lt;&lt;endl;
@@ -230,3 +241,35 @@
 }
 
 
+/********************** GLDrawBrefcomContact ****************************/
+
+#include&lt;yade/lib-opengl/OpenGLWrapper.hpp&gt;
+
+void GLDrawBrefcomContact::go(const shared_ptr&lt;InteractionPhysics&gt;&amp; ip, const shared_ptr&lt;Interaction&gt;&amp;, const shared_ptr&lt;Body&gt;&amp; b1, const shared_ptr&lt;Body&gt;&amp; b2, bool wireFrame){
+	const shared_ptr&lt;BrefcomContact&gt;&amp; BC=static_pointer_cast&lt;BrefcomContact&gt;(ip);
+
+	/* shared_ptr&lt;Sphere&gt; s1(dynamic_pointer_cast&lt;Sphere&gt;(b1-&gt;geometricalModel)), s2(dynamic_pointer_cast&lt;Sphere&gt;(b2-&gt;geometricalModel));
+	if(s1 &amp;&amp; s2){
+		Real radius=min(s1-&gt;radius,s2-&gt;radius), len=(b1-&gt;physicalParameters-&gt;se3.position-b2-&gt;physicalParameters-&gt;se3.position).Length();
+		glScale(len,radius,radius);
+		glutSolidCube(1);
+	} */
+
+	glColor3(BC-&gt;omegaPl,1-BC-&gt;omegaPl,0.0); /* damaged links red, undamaged green */
+
+	glBegin(GL_LINES);
+		glVertex3v(b1-&gt;physicalParameters-&gt;se3.position);
+		glVertex3v(b2-&gt;physicalParameters-&gt;se3.position);
+	glEnd();
+
+
+	Vector3r mid=0.5*(b1-&gt;physicalParameters-&gt;se3.position+b2-&gt;physicalParameters-&gt;se3.position);
+	glTranslatev(mid);
+	glPushMatrix();
+		glRasterPos2i(0,0);
+		std::string str=std::string(&quot;omegaPl=&quot;)+boost::lexical_cast&lt;std::string&gt;((float)(BC-&gt;omegaPl));
+		for(unsigned int i=0;i&lt;str.length();i++) glutBitmapCharacter(GLUT_BITMAP_HELVETICA_12,str[i]);
+	glPopMatrix();
+
+}
+

Modified: trunk/extra/Brefcom.hpp
===================================================================
--- trunk/extra/Brefcom.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/extra/Brefcom.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -9,7 +9,9 @@
 #include&lt;yade/pkg-common/Momentum.hpp&gt;
 #include&lt;yade/pkg-common/InteractionPhysicsEngineUnit.hpp&gt;
 #include&lt;yade/pkg-dem/SpheresContactGeometry.hpp&gt;
+#include&lt;yade/pkg-common/GLDrawInteractionPhysicsFunctor.hpp&gt;
 
+
 /*! @brief Convert macroscopic properties to BrefcomContact with corresponding parameters.
  *
  * Most of the model is taken from MacroMicroElasticRelationships.
@@ -41,6 +43,8 @@
 			REGISTER_ATTRIBUTE(Gf);
 			REGISTER_ATTRIBUTE(zeta);
 		}
+
+		FUNCTOR2D(BodyMacroParameters,BodyMacroParameters);
 		REGISTER_CLASS_NAME(BrefcomMakeContact);
 		REGISTER_BASE_CLASS_NAME(InteractionPhysicsEngineUnit);
 		DECLARE_LOGGER;
@@ -64,22 +68,25 @@
 		Real d0, Kn, Ks, zeta, frictionAngle, FnMax, cohesion;
 		/*! Fundamental state variables */
 		Real omegaPl;
+		/* prevNormal is oriented A&#8594;B (as in SpheresContactGeometry); OTOH, Fs is as it applies to B */
 		Vector3r prevNormal, Fs; // shear force is cummulative, this must be remembered
-		Vector3r Fn; // remembers last normal force, used by stiffness counter
+		Vector3r Fn; // normal force, as applied to A
 		bool isStructural; // whether this is &quot;neighbour&quot; or just &quot;meeting&quot; contact
 		/* calculated by deduceOtherParams (called at every iteration); first two are constants as well, other two depend on damage. */
 		Real dPeak, dBreak, d0_curr, dPeak_curr, cohesion_curr, FnMax_curr;
 		void deduceOtherParams(void){
 			dBreak=d0+(FnMax/Kn)*(1+zeta);
 			dPeak=d0+(FnMax/Kn);
-			d0_curr=d0+omegaPl*(dBreak-d0);
+			d0_curr=d0+omegaPl*(dBreak-d0); //FIXME!!!! this may be negative?!!!!
 			dPeak_curr=dPeak+omegaPl*(dBreak-dPeak);
 			FnMax_curr=FnMax*(1-omegaPl);
 			cohesion_curr=cohesion*(1-omegaPl);
 			// if(Omega::instance().getCurrentIteration()%100==0 &amp;&amp; omegaPl&gt;=1){ TRVAR4(d0,omegaPl,d0_curr,FnMax_curr); }
 		} 
+		/* debugging */
+		Real prevFn;
 
-		BrefcomContact(): InteractionPhysics(){ /* just in case someone forgets */ Fs=Vector3r::ZERO; Fn=Vector3r::ZERO; omegaPl=0; isStructural=false; }
+		BrefcomContact(): InteractionPhysics(){ createIndex(); /* just in case someone forgets */ Fs=Vector3r::ZERO; Fn=Vector3r::ZERO; omegaPl=0; isStructural=false; }
 
 		void registerAttributes(){
 			InteractionPhysics::registerAttributes();
@@ -121,8 +128,12 @@
 		void envelopeAndDamage();
 		//! plly calculated force on particles
 		void applyForces();
-		/* storage variables, to avoid passing them around on the stack */
-		Vector3r Fs, Fn;
+		/* storage variables, to avoid passing them around on the stack.
+		 *
+		 * The orientation is conventionally as forces should be applied on the SECOND element in the interaction.
+		 * That is, attractive force will be oriented as applied to the first element.
+		 * This is CONTRARY to ElasticCohesiveLaw !!! */
+		Vector3r Fs; Real Fn;
 		/* temporaries initialized in the loop over interactions; above methods use these. */
 		body_id_t id1, id2;
 		shared_ptr&lt;Body&gt; body1, body2;
@@ -139,7 +150,7 @@
 			/* cache indices for Force and Momentum */
 			ForceClassIndex=shared_ptr&lt;PhysicalAction&gt;(new Force())-&gt;getClassIndex();
 			MomentumClassIndex=shared_ptr&lt;PhysicalAction&gt;(new Momentum())-&gt;getClassIndex();
-			TRVAR2(ForceClassIndex,MomentumClassIndex);
+			//TRVAR2(ForceClassIndex,MomentumClassIndex);
 		};
 		void action(Body* body);
 	protected: 
@@ -150,9 +161,17 @@
 	REGISTER_BASE_CLASS_NAME(InteractionSolver);
 	DECLARE_LOGGER;
 };
-
 REGISTER_SERIALIZABLE(BrefcomLaw,false);
 
+class GLDrawBrefcomContact: public GLDrawInteractionPhysicsFunctor {
+	public: virtual void go(const shared_ptr&lt;InteractionPhysics&gt;&amp;,const shared_ptr&lt;Interaction&gt;&amp;,const shared_ptr&lt;Body&gt;&amp;,const shared_ptr&lt;Body&gt;&amp;,bool wireFrame);
+	RENDERS(BrefcomContact);
+	REGISTER_CLASS_NAME(GLDrawBrefcomContact);
+	REGISTER_BASE_CLASS_NAME(GLDrawInteractionPhysicsFunctor);
+};
+REGISTER_SERIALIZABLE(GLDrawBrefcomContact,false);
+
+
  
 
 

Modified: trunk/extra/BrefcomTestGen.cpp
===================================================================
--- trunk/extra/BrefcomTestGen.cpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/extra/BrefcomTestGen.cpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -118,7 +118,6 @@
 	message=&quot;&quot;;
 	rootBody=Shop::rootBody();
 
-	/* We don't use collider and orientation integrator for now!&#160;*/
 	createEngines();
 
 	shared_ptr&lt;UniaxialStrainer&gt; strainer(new UniaxialStrainer);
@@ -129,9 +128,12 @@
 	
 	// control normal/shear ratio
 	//Real zCoord=.1; Real yCoord=sqrt(1-zCoord*zCoord); // distance is always 2, with contact at origin
-	Real zCoord=1, yCoord=.2;
-	shared_ptr&lt;Body&gt; s1=Shop::sphere(Vector3r(0,-yCoord,-zCoord),1), s2=Shop::sphere(Vector3r(0,yCoord,zCoord),1);
-	body_id_t id1=rootBody-&gt;bodies-&gt;insert(s1), id2=rootBody-&gt;bodies-&gt;insert(s2);
+	Real zCoord=1, yCoord=0;
+	shared_ptr&lt;Body&gt;
+		s1=Shop::sphere(Vector3r(0,-yCoord,-zCoord),1),
+		s2=Shop::sphere(Vector3r(0,yCoord,zCoord),1),
+		sMid=Shop::sphere(Vector3r(0,0,0.01),1);
+	body_id_t id1=rootBody-&gt;bodies-&gt;insert(s1), id2=rootBody-&gt;bodies-&gt;insert(s2), id3=rootBody-&gt;bodies-&gt;insert(sMid);
 	
 	//  engines should take care of the rest of interaction; this is what collider would do normally
 	/*

Modified: trunk/extra/clump/Shop.cpp
===================================================================
--- trunk/extra/clump/Shop.cpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/extra/clump/Shop.cpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -32,6 +32,7 @@
 #include&lt;yade/pkg-common/LeapFrogOrientationIntegrator.hpp&gt;
 #include&lt;yade/pkg-dem/InteractingSphere2InteractingSphere4SpheresContactGeometry.hpp&gt;
 #include&lt;yade/pkg-dem/InteractingBox2InteractingSphere4SpheresContactGeometry.hpp&gt;
+#include&lt;yade/pkg-dem/MacroMicroElasticRelationships.hpp&gt;
 /*class InteractingSphere2AABB;
 class InteractingBox2AABB;
 class MetaInteractingGeometry;
@@ -172,10 +173,10 @@
 	rootBody-&gt;initializers.push_back(physicalActionInitializer);
 	
 	shared_ptr&lt;BoundingVolumeMetaEngine&gt; boundingVolumeDispatcher	= shared_ptr&lt;BoundingVolumeMetaEngine&gt;(new BoundingVolumeMetaEngine);
-	boundingVolumeDispatcher-&gt;DISPATCHER_ADD3(InteractingSphere,AABB,InteractingSphere2AABB);
-	boundingVolumeDispatcher-&gt;DISPATCHER_ADD3(InteractingBox,AABB,InteractingBox2AABB);
-	boundingVolumeDispatcher-&gt;DISPATCHER_ADD3(TetraMold,AABB,TetraAABB);
-	boundingVolumeDispatcher-&gt;DISPATCHER_ADD3(MetaInteractingGeometry,AABB,MetaInteractingGeometry2AABB);
+	boundingVolumeDispatcher-&gt;add(new InteractingSphere2AABB);
+	boundingVolumeDispatcher-&gt;add(new InteractingBox2AABB);
+	boundingVolumeDispatcher-&gt;add(new TetraAABB);
+	boundingVolumeDispatcher-&gt;add(new MetaInteractingGeometry2AABB);
 	rootBody-&gt;initializers.push_back(boundingVolumeDispatcher);
 
 	//engines
@@ -201,13 +202,13 @@
 	rootBody-&gt;engines.push_back(shared_ptr&lt;Engine&gt;(new PersistentSAPCollider));
 
 	shared_ptr&lt;InteractionGeometryMetaEngine&gt; interactionGeometryDispatcher(new InteractionGeometryMetaEngine);
-	interactionGeometryDispatcher-&gt;DISPATCHER_ADD3(InteractingSphere,InteractingSphere,InteractingSphere2InteractingSphere4SpheresContactGeometry);
-	interactionGeometryDispatcher-&gt;DISPATCHER_ADD3(InteractingSphere,InteractingBox,InteractingBox2InteractingSphere4SpheresContactGeometry);
-	interactionGeometryDispatcher-&gt;DISPATCHER_ADD3(TetraMold,TetraMold,Tetra2TetraBang);
+	interactionGeometryDispatcher-&gt;add(new InteractingSphere2InteractingSphere4SpheresContactGeometry);
+	interactionGeometryDispatcher-&gt;add(new InteractingBox2InteractingSphere4SpheresContactGeometry);
+	interactionGeometryDispatcher-&gt;add(new Tetra2TetraBang);
 	rootBody-&gt;engines.push_back(interactionGeometryDispatcher);
 
 	shared_ptr&lt;InteractionPhysicsMetaEngine&gt; interactionPhysicsDispatcher(new InteractionPhysicsMetaEngine);
-	interactionPhysicsDispatcher-&gt;DISPATCHER_ADD3(BodyMacroParameters,BodyMacroParameters,MacroMicroElasticRelationships);
+	interactionPhysicsDispatcher-&gt;add(new MacroMicroElasticRelationships);
 	rootBody-&gt;engines.push_back(interactionPhysicsDispatcher);
 		
 	shared_ptr&lt;ElasticContactLaw&gt; constitutiveLaw(new ElasticContactLaw);
@@ -236,22 +237,22 @@
 		shared_ptr&lt;CundallNonViscousMomentumDamping&gt; actionMomentumDamping(new CundallNonViscousMomentumDamping);
 		actionMomentumDamping-&gt;damping = getDefault&lt;double&gt;(&quot;param_damping&quot;);
 		shared_ptr&lt;PhysicalActionDamper&gt; actionDampingDispatcher(new PhysicalActionDamper);
-		actionDampingDispatcher-&gt;DISPATCHER_ADD3_1(Force,ParticleParameters,CundallNonViscousForceDamping,actionForceDamping);
-		actionDampingDispatcher-&gt;DISPATCHER_ADD3_1(Momentum,RigidBodyParameters,CundallNonViscousMomentumDamping,actionMomentumDamping);
+		actionDampingDispatcher-&gt;add(actionForceDamping);
+		actionDampingDispatcher-&gt;add(actionMomentumDamping);
 		rootBody-&gt;engines.push_back(actionDampingDispatcher);
 	}
 	
 	shared_ptr&lt;PhysicalActionApplier&gt; applyActionDispatcher(new PhysicalActionApplier);
-	applyActionDispatcher-&gt;DISPATCHER_ADD3(Force,ParticleParameters,NewtonsForceLaw);
-	applyActionDispatcher-&gt;DISPATCHER_ADD3(Momentum,RigidBodyParameters,NewtonsMomentumLaw);
+	applyActionDispatcher-&gt;add(new NewtonsForceLaw);
+	applyActionDispatcher-&gt;add(new NewtonsMomentumLaw);
 	rootBody-&gt;engines.push_back(applyActionDispatcher);
 	
 	shared_ptr&lt;PhysicalParametersMetaEngine&gt; positionIntegrator(new PhysicalParametersMetaEngine);
-	positionIntegrator-&gt;DISPATCHER_ADD2(ParticleParameters,LeapFrogPositionIntegrator);
+	positionIntegrator-&gt;add(new LeapFrogPositionIntegrator);
 	rootBody-&gt;engines.push_back(positionIntegrator);
 
 	shared_ptr&lt;PhysicalParametersMetaEngine&gt; orientationIntegrator(new PhysicalParametersMetaEngine);
-	orientationIntegrator-&gt;DISPATCHER_ADD2(RigidBodyParameters,LeapFrogOrientationIntegrator);
+	orientationIntegrator-&gt;add(new LeapFrogOrientationIntegrator);
 	rootBody-&gt;engines.push_back(orientationIntegrator);
 #if 0
 	#ifdef EMBED_PYTHON

Modified: trunk/extra/clump/Shop.hpp
===================================================================
--- trunk/extra/clump/Shop.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/extra/clump/Shop.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -30,6 +30,11 @@
 using boost::shared_ptr;
 
 class Shop{
+	/* the only non-static thing to make class factory happy */
+	//public: Shop(){};
+	//REGISTER_CLASS_NAME(Shop);
+	//REGISTER_BASE_CLASS_NAME();
+		
 	private:
 		DECLARE_LOGGER;
 	public:
@@ -61,5 +66,5 @@
 		// (true || boost::lambda::_1) means that true is the default
 		static int createCohesion(Real limitNormalForce, Real limitShearForce, int groupMask=0,
 			boost::function&lt;bool(body_id_t,body_id_t)&gt; linkOK = (true || boost::lambda::_1) );
+
 };
-

Modified: trunk/extra/tetra/Tetra.hpp
===================================================================
--- trunk/extra/tetra/Tetra.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/extra/tetra/Tetra.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -67,6 +67,7 @@
 			REGISTER_ATTRIBUTE(equivalentPenetrationDepth);
 			REGISTER_ATTRIBUTE(maxPenetrationDepthA); REGISTER_ATTRIBUTE(maxPenetrationDepthB);
 		}
+		FUNCTOR2D(TetraMold,TetraMold);
 		REGISTER_CLASS_NAME(TetraBang);
 		REGISTER_BASE_CLASS_NAME(InteractionGeometry);
 };
@@ -109,6 +110,7 @@
 			aabb-&gt;center=(aabb-&gt;min+aabb-&gt;max)*0.5;
 			aabb-&gt;halfSize=(aabb-&gt;max-aabb-&gt;min)*0.5;
 		}
+		FUNCTOR2D(TetraMold,AABB);
 		REGISTER_CLASS_NAME(TetraAABB);
 		REGISTER_BASE_CLASS_NAME(BoundingVolumeEngineUnit);
 };

Modified: trunk/extra/usct/UniaxialStrainControlledTest.cpp
===================================================================
--- trunk/extra/usct/UniaxialStrainControlledTest.cpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/extra/usct/UniaxialStrainControlledTest.cpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -44,9 +44,10 @@
 	// reverse if we're over the limit strain
 	// if(notYetReversed &amp;&amp; limitStrain!=0 &amp;&amp; ((currentStrainRate&gt;0 &amp;&amp; strain&gt;limitStrain) || (currentStrainRate&lt;0 &amp;&amp; strain&lt;limitStrain))) { currentStrainRate*=-1; notYetReversed=false; LOG_INFO(&quot;Reversed strain rate to &quot;&lt;&lt;currentStrainRate); }
 	MetaBody* rootBody=static_cast&lt;MetaBody*&gt;(_rootBody);
-	if(Omega::instance().getCurrentIteration()%40==0 &amp;&amp; recStream.good()) {
+	if(Omega::instance().getCurrentIteration()%50==0 &amp;&amp; recStream.good()) {
 		computeAxialForce(rootBody);
-		recStream&lt;&lt;Omega::instance().getCurrentIteration()&lt;&lt;&quot; &quot;&lt;&lt;strain&lt;&lt;&quot; &quot;&lt;&lt;sumPosForces&lt;&lt;&quot; &quot;&lt;&lt;sumNegForces&lt;&lt;&quot; &quot;&lt;&lt;negCoords[0]&lt;&lt;&quot; &quot;&lt;&lt;posCoords[0]&lt;&lt;endl;
+		Real midPos=Body::byId(1)-&gt;physicalParameters-&gt;se3.position[axis];
+		recStream&lt;&lt;Omega::instance().getCurrentIteration()&lt;&lt;&quot; &quot;&lt;&lt;strain&lt;&lt;&quot; &quot;&lt;&lt;sumPosForces&lt;&lt;&quot; &quot;&lt;&lt;sumNegForces&lt;&lt;&quot; &quot;&lt;&lt;posCoords[0]&lt;&lt;&quot; &quot;&lt;&lt;negCoords[0]&lt;&lt;&quot; &quot;&lt;&lt;midPos&lt;&lt;endl;
 	}
 }
 
@@ -81,10 +82,10 @@
 	#else
 		shared_ptr&lt;Force&gt; f(new Force);
 		for(size_t i=0; i&lt;negIds.size(); i++){
-			sumNegForces-=static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(negIds[i],f-&gt;getClassIndex()))-&gt;force[axis];
+			sumNegForces+=static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(negIds[i],f-&gt;getClassIndex()))-&gt;force[axis];
 		}
 		for(size_t i=0; i&lt;posIds.size(); i++){
-			sumPosForces+=static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(posIds[i],f-&gt;getClassIndex()))-&gt;force[axis];
+			sumPosForces-=static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(posIds[i],f-&gt;getClassIndex()))-&gt;force[axis];
 		}
 	#endif
 	//TRVAR2(sumPosForces,sumNegForces);
@@ -212,9 +213,9 @@
 	rootBody-&gt;initializers.push_back(physicalActionInitializer);
 	
 	shared_ptr&lt;BoundingVolumeMetaEngine&gt; boundingVolumeDispatcher	= shared_ptr&lt;BoundingVolumeMetaEngine&gt;(new BoundingVolumeMetaEngine);
-	boundingVolumeDispatcher-&gt;DISPATCHER_ADD3(InteractingSphere,AABB,InteractingSphere2AABB);
-	boundingVolumeDispatcher-&gt;DISPATCHER_ADD3(MetaInteractingGeometry,AABB,MetaInteractingGeometry2AABB);
-	rootBody-&gt;initializers.push_back(boundingVolumeDispatcher);
+		boundingVolumeDispatcher-&gt;add(new InteractingSphere2AABB);
+		boundingVolumeDispatcher-&gt;add(new MetaInteractingGeometry2AABB);
+		rootBody-&gt;initializers.push_back(boundingVolumeDispatcher);
 
 	rootBody-&gt;engines.clear();
 
@@ -222,43 +223,44 @@
 	rootBody-&gt;engines.push_back(boundingVolumeDispatcher);
 
 	shared_ptr&lt;PersistentSAPCollider&gt; collider(new PersistentSAPCollider);
-	collider-&gt;haveDistantTransient=true;
-	rootBody-&gt;engines.push_back(collider);
+		collider-&gt;haveDistantTransient=true;
+		rootBody-&gt;engines.push_back(collider);
 
 	shared_ptr&lt;InteractionGeometryMetaEngine&gt; igeomDispatcher(new InteractionGeometryMetaEngine);
-	igeomDispatcher-&gt;DISPATCHER_ADD3(InteractingSphere,InteractingSphere,InteractingSphere2InteractingSphere4DistantSpheresContactGeometry);
-	rootBody-&gt;engines.push_back(igeomDispatcher);
+		igeomDispatcher-&gt;add(new InteractingSphere2InteractingSphere4DistantSpheresContactGeometry);
+		rootBody-&gt;engines.push_back(igeomDispatcher);
 
 	shared_ptr&lt;InteractionPhysicsMetaEngine&gt; iphysDispatcher(new InteractionPhysicsMetaEngine);
-	iphysDispatcher-&gt;DISPATCHER_ADD3(BodyMacroParameters,BodyMacroParameters,BrefcomMakeContact);
-	rootBody-&gt;engines.push_back(iphysDispatcher);
+		iphysDispatcher-&gt;add(new BrefcomMakeContact);
+		rootBody-&gt;engines.push_back(iphysDispatcher);
 
 	shared_ptr&lt;BrefcomLaw&gt; bLaw(new BrefcomLaw);
 	rootBody-&gt;engines.push_back(bLaw);
 
-	shared_ptr&lt;CundallNonViscousForceDamping&gt; actionForceDamping(new CundallNonViscousForceDamping);
-	actionForceDamping-&gt;damping = .5;
-	shared_ptr&lt;CundallNonViscousMomentumDamping&gt; actionMomentumDamping(new CundallNonViscousMomentumDamping);
-	actionMomentumDamping-&gt;damping = .5;
-	shared_ptr&lt;PhysicalActionDamper&gt; actionDampingDispatcher(new PhysicalActionDamper);
-	actionDampingDispatcher-&gt;add(&quot;Force&quot;,&quot;ParticleParameters&quot;,&quot;CundallNonViscousForceDamping&quot;,actionForceDamping);
-	actionDampingDispatcher-&gt;add(&quot;Momentum&quot;,&quot;RigidBodyParameters&quot;,&quot;CundallNonViscousMomentumDamping&quot;,actionMomentumDamping);
-	rootBody-&gt;engines.push_back(actionDampingDispatcher);
+	shared_ptr&lt;PhysicalActionDamper&gt; dampingDispatcher(new PhysicalActionDamper);
+		shared_ptr&lt;CundallNonViscousForceDamping&gt; forceDamper(new CundallNonViscousForceDamping);
+		forceDamper-&gt;damping = damping;
+		dampingDispatcher-&gt;add(forceDamper); //&quot;Force&quot;,&quot;ParticleParameters&quot;,&quot;CundallNonViscousForceDamping&quot;,actionForceDamping);
+		shared_ptr&lt;CundallNonViscousMomentumDamping&gt; momentumDamper(new CundallNonViscousMomentumDamping);
+		momentumDamper-&gt;damping = damping;
+		dampingDispatcher-&gt;add(momentumDamper); // &quot;Momentum&quot;,&quot;RigidBodyParameters&quot;,&quot;CundallNonViscousMomentumDamping&quot;,actionMomentumDamping);
+		rootBody-&gt;engines.push_back(dampingDispatcher);
 
 
 
 	shared_ptr&lt;PhysicalActionApplier&gt; applyActionDispatcher(new PhysicalActionApplier);
-	applyActionDispatcher-&gt;DISPATCHER_ADD3(Force,ParticleParameters,NewtonsForceLaw);
-	applyActionDispatcher-&gt;DISPATCHER_ADD3(Momentum,RigidBodyParameters,NewtonsMomentumLaw);
-	rootBody-&gt;engines.push_back(applyActionDispatcher);
+		//applyActionDispatcher-&gt;add(new NewtonsForceLaw); //DISPATCHER_ADD3(Force,ParticleParameters,NewtonsForceLaw);
+		applyActionDispatcher-&gt;add(&quot;Force&quot;,&quot;ParticleParameters&quot;,&quot;NewtonsForceLaw&quot;);
+		applyActionDispatcher-&gt;add(new NewtonsMomentumLaw); //DISPATCHER_ADD3(Momentum,RigidBodyParameters,NewtonsMomentumLaw);
+		rootBody-&gt;engines.push_back(applyActionDispatcher);
 	
 	shared_ptr&lt;PhysicalParametersMetaEngine&gt; positionIntegrator(new PhysicalParametersMetaEngine);
-	positionIntegrator-&gt;DISPATCHER_ADD2(ParticleParameters,LeapFrogPositionIntegrator);
-	rootBody-&gt;engines.push_back(positionIntegrator);
+		positionIntegrator-&gt;add(new LeapFrogPositionIntegrator); //DISPATCHER_ADD2(ParticleParameters,LeapFrogPositionIntegrator);
+		rootBody-&gt;engines.push_back(positionIntegrator);
 
 	shared_ptr&lt;PhysicalParametersMetaEngine&gt; orientationIntegrator(new PhysicalParametersMetaEngine);
-	orientationIntegrator-&gt;DISPATCHER_ADD2(RigidBodyParameters,LeapFrogOrientationIntegrator);
-	rootBody-&gt;engines.push_back(orientationIntegrator);
+		orientationIntegrator-&gt;add(new LeapFrogOrientationIntegrator);
+		rootBody-&gt;engines.push_back(orientationIntegrator);
 
 	shared_ptr&lt;GlobalStiffnessTimeStepper&gt; globalStiffnessTimeStepper(new GlobalStiffnessTimeStepper);
 	globalStiffnessTimeStepper-&gt;sdecGroupMask=1023; // BIN 111111111, should always match

Modified: trunk/extra/usct/UniaxialStrainControlledTest.hpp
===================================================================
--- trunk/extra/usct/UniaxialStrainControlledTest.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/extra/usct/UniaxialStrainControlledTest.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -13,7 +13,7 @@
 		~USCTGen (){};
 		bool generate();
 		string spheresFile;
-		Real strainRate, limitStrain;
+		Real strainRate, limitStrain, damping;
 		int axis;
 	protected :
 		void registerAttributes(){
@@ -22,6 +22,7 @@
 			REGISTER_ATTRIBUTE(axis);
 			REGISTER_ATTRIBUTE(strainRate);
 			REGISTER_ATTRIBUTE(limitStrain);
+			REGISTER_ATTRIBUTE(damping);
 		}
 	REGISTER_CLASS_NAME(USCTGen);
 	REGISTER_BASE_CLASS_NAME(FileGenerator);

Modified: trunk/gui/cmd/cmdGui.cpp
===================================================================
--- trunk/gui/cmd/cmdGui.cpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/gui/cmd/cmdGui.cpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -45,8 +45,11 @@
 	}
 
 	XInitThreads();
+	PyEval_InitThreads();
 
 	PyGILState_STATE pyState = PyGILState_Ensure();
+
+
 		// wrap those in python::handle&lt;&gt; ??
 		PyRun_SimpleString(&quot;import sys, readline&quot;);
 		PyRun_SimpleString(&quot;sys.path.insert(0,'&quot; PREFIX &quot;/lib/yade&quot; SUFFIX &quot;/extra');&quot;);

Modified: trunk/gui/cmd/yadeControl.cpp
===================================================================
--- trunk/gui/cmd/yadeControl.cpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/gui/cmd/yadeControl.cpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -13,6 +13,7 @@
 #include&lt;boost/any.hpp&gt;
 #include&lt;boost/shared_ptr.hpp&gt;
 #include&lt;boost/python.hpp&gt;
+#include&lt;boost/python/stl_iterator.hpp&gt;
 
 #include&lt;yade/lib-base/Logging.hpp&gt;
 #include&lt;yade/lib-serialization-xml/XMLFormatManager.hpp&gt;
@@ -46,12 +47,15 @@
 		void ensureEng(void){ if(!eng) throw runtime_error(&quot;No proxied EngineUnit.&quot;); if(!accessor) accessor=shared_ptr&lt;AttrAccess&gt;(new AttrAccess(eng));  }
 		shared_ptr&lt;EngineUnit&gt; eng;
 		vector&lt;string&gt; bases; // names of classes for which we dispatch
+		void bases_set(python::object o){ python::stl_input_iterator&lt;string&gt; oBeg(o), oEnd; bases.assign(oBeg,oEnd); }
+		python::list bases_get(void){ python::list ret; for(size_t i=0; i&lt;bases.size();i++) ret.append(bases[i]); return ret; }
 		pyEngineUnit(const shared_ptr&lt;EngineUnit&gt;&amp; _eng, const vector&lt;string&gt;&amp; _bases): eng(_eng), bases(_bases) {}
 		pyEngineUnit(string clss, string base1=&quot;&quot;, string base2=&quot;&quot;){
 			eng=dynamic_pointer_cast&lt;EngineUnit&gt;(ClassFactory::instance().createShared(clss)); if(!eng) throw runtime_error(&quot;Invalid engine class `&quot;+clss+&quot;': either nonexistent, or not unable to cast to `EngineUnit'&quot;);
 			if(!base1.empty()){ bases.push_back(base1); if(!base2.empty()) bases.push_back(base2); }
 		}
 		std::string pyStr(void){ ensureEng(); string ret(&quot;&lt;&quot;+eng-&gt;getClassName()+&quot; EngineUnit {&quot;); for(size_t i=0; i&lt;bases.size(); i++) ret+=bases[i]+(i&lt;bases.size()-1?&quot;,&quot;:&quot;&quot;); return ret+&quot;}&gt;&quot;; }
+		string className(void){ ensureEng(); return eng-&gt;getClassName(); }
 		ATTR_ACCESS_CXX(accessor,ensureEng);
 };
 
@@ -64,7 +68,8 @@
 		//pyEngine(void){throw;}
 		pyEngine(const shared_ptr&lt;Engine&gt;&amp; _eng): eng(_eng) {}
 		pyEngine(string clss){ eng=dynamic_pointer_cast&lt;Engine&gt;(ClassFactory::instance().createShared(clss)); if(!eng) throw runtime_error(&quot;Invalid engine class `&quot;+clss+&quot;': either nonexistent, or not unable to cast to `Engine'&quot;); }
-		virtual std::string pyStr(void){ throw; } 
+		virtual std::string pyStr(void){ throw; }
+		string className(void){ ensureEng(); return eng-&gt;getClassName(); }
 		ATTR_ACCESS_CXX(accessor,ensureEng);
 };
 
@@ -242,9 +247,9 @@
 	QApplication* app;
 	void redrawAlarm(void){
 		while(true){
-			Omega::instance().stopSimulationLoop();
+			//Omega::instance().stopSimulationLoop();
 			viewer-&gt;updateGL();
-			Omega::instance().startSimulationLoop();
+			//Omega::instance().startSimulationLoop();
 			usleep(10000000);
 		}
 	}
@@ -254,7 +259,7 @@
 	DECLARE_LOGGER;
 	ATTR_ACCESS_CXX(accessor,ensureAcc);	
 	pyGLViewer(){
-		throw std::runtime_error(&quot;Programming error: Threading in pyGLViewer is broken and crashes; ignored.&quot;);
+		//throw std::runtime_error(&quot;Programming error: Threading in pyGLViewer is broken and crashes; ignored.&quot;);
 		// LOG_WARN(&quot;Thread locking not correctly implemented, will pause Omega for redraw every 10s instead!&quot;);
 		shared_ptr&lt;Factorable&gt; _renderer=ClassFactory::instance().createShared(&quot;OpenGLRenderingEngine&quot;);
 		renderer=static_pointer_cast&lt;RenderingEngine&gt;(_renderer);
@@ -347,27 +352,27 @@
 	python::class_&lt;pyStandAloneEngine&gt;(&quot;StandAloneEngine&quot;,python::init&lt;string&gt;())
 	.ATTR_ACCESS_PY(pyStandAloneEngine)
 	.def(&quot;__str__&quot;,&amp;pyStandAloneEngine::pyStr).def(&quot;__repr__&quot;,&amp;pyStandAloneEngine::pyStr)
-	//.def(&quot;clss&quot;,&amp;pyStandAloneEngine::pyInit);
+	.add_property(&quot;name&quot;,&amp;pyEngine::className)
 	;
 
 	python::class_&lt;pyMetaEngine&gt;(&quot;MetaEngine&quot;,python::init&lt;string&gt;())
 	.ATTR_ACCESS_PY(pyMetaEngine)
 	.def(&quot;__str__&quot;,&amp;pyMetaEngine::pyStr).def(&quot;__repr__&quot;,&amp;pyMetaEngine::pyStr)
-	//.def(&quot;clss&quot;,&amp;pyMetaEngine::pyInit)
+	.add_property(&quot;name&quot;,&amp;pyEngine::className)
 	.add_property(&quot;functors&quot;,&amp;pyMetaEngine::functors_get,&amp;pyMetaEngine::functors_set)
 	;
 
 	boost::python::class_&lt;pyDeusExMachina&gt;(&quot;DeusExMachina&quot;,python::init&lt;string&gt;())
 	.ATTR_ACCESS_PY(pyDeusExMachina)
 	.def(&quot;__str__&quot;,&amp;pyDeusExMachina::pyStr).def(&quot;__repr__&quot;,&amp;pyDeusExMachina::pyStr)
-	//.def(&quot;clss&quot;,&amp;pyStandAloneEngine::pyInit);
+	.add_property(&quot;name&quot;,&amp;pyEngine::className)
 	;
 
 	boost::python::class_&lt;pyEngineUnit&gt;(&quot;EngineUnit&quot;,python::init&lt;string, python::optional&lt;string,string&gt; &gt;())
 	.ATTR_ACCESS_PY(pyEngineUnit)
 	.def(&quot;__str__&quot;,&amp;pyEngineUnit::pyStr).def(&quot;__repr__&quot;,&amp;pyEngineUnit::pyStr)
-	// .def(&quot;clss&quot;,&amp;pyEngineUnit::pyInit)
-	.add_property(&quot;bases&quot;,&amp;pyEngineUnit::bases,&amp;pyEngineUnit::bases) // not yet functional
+	.add_property(&quot;name&quot;,&amp;pyEngineUnit::className)
+	.add_property(&quot;bases&quot;,&amp;pyEngineUnit::bases_get,&amp;pyEngineUnit::bases_set)
 	;
 	
 

Modified: trunk/lib/base/Logging.hpp
===================================================================
--- trunk/lib/base/Logging.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/lib/base/Logging.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -73,6 +73,7 @@
 #define TRVAR3(a,b,c) LOG_TRACE( _TRV(a) &lt;&lt; _TRV(b) &lt;&lt; _TRV(c) );
 #define TRVAR4(a,b,c,d) LOG_TRACE( _TRV(a) &lt;&lt; _TRV(b) &lt;&lt; _TRV(c) &lt;&lt; _TRV(d) );
 #define TRVAR5(a,b,c,d,e) LOG_TRACE( _TRV(a) &lt;&lt; _TRV(b) &lt;&lt; _TRV(c) &lt;&lt; _TRV(d) &lt;&lt; _TRV(e) );
+#define TRVAR6(a,b,c,d,e,f) LOG_TRACE( _TRV(a) &lt;&lt; _TRV(b) &lt;&lt; _TRV(c) &lt;&lt; _TRV(d) &lt;&lt; _TRV(e) &lt;&lt; _TRV(f));
 // prints boost matrix
 #define TRMAT(MAT) _TRVHEAD&lt;&lt; #MAT &quot;=(&quot;;for(unsigned i=0; i&lt;MAT.size1(); i++){cerr&lt;&lt;&quot;(&quot;;for(unsigned j=0; j&lt;MAT.size2(); j++){ cerr&lt;&lt;MAT(i,j)&lt;&lt;&quot; &quot;; } cerr&lt;&lt;&quot;)&quot;; } cerr&lt;&lt;&quot;)&quot;; cerr&lt;&lt;_TRVTAIL
 // dtto, but for matrix of vectors; maybe the previos macro could handle that also.

Modified: trunk/pkg/common/Engine/EngineUnit/CundallNonViscousForceDamping.hpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/CundallNonViscousForceDamping.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/pkg/common/Engine/EngineUnit/CundallNonViscousForceDamping.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -25,6 +25,8 @@
 	protected :
 		virtual void registerAttributes();
 
+	FUNCTOR2D(Force,ParticleParameters);
+
 	REGISTER_CLASS_NAME(CundallNonViscousForceDamping);
 	REGISTER_BASE_CLASS_NAME(PhysicalActionDamperUnit);
 };

Modified: trunk/pkg/common/Engine/EngineUnit/CundallNonViscousMomentumDamping.hpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/CundallNonViscousMomentumDamping.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/pkg/common/Engine/EngineUnit/CundallNonViscousMomentumDamping.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -24,6 +24,8 @@
 	
 	protected :
 		 virtual void registerAttributes();
+
+	FUNCTOR2D(Force,RigidBodyParameters);
 	REGISTER_CLASS_NAME(CundallNonViscousMomentumDamping);
 	REGISTER_BASE_CLASS_NAME(PhysicalActionDamperUnit);
 };

Modified: trunk/pkg/common/Engine/EngineUnit/InteractingBox2AABB.hpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/InteractingBox2AABB.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/pkg/common/Engine/EngineUnit/InteractingBox2AABB.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -20,7 +20,7 @@
 				, shared_ptr&lt;BoundingVolume&gt;&amp; bv
 				, const Se3r&amp; se3
 				, const Body*	);
-
+	FUNCTOR2D(InteractingBox,AABB);
 	REGISTER_CLASS_NAME(InteractingBox2AABB);
 	REGISTER_BASE_CLASS_NAME(BoundingVolumeEngineUnit);
 };

Modified: trunk/pkg/common/Engine/EngineUnit/InteractingSphere2AABB.hpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/InteractingSphere2AABB.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/pkg/common/Engine/EngineUnit/InteractingSphere2AABB.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -18,6 +18,7 @@
 				, shared_ptr&lt;BoundingVolume&gt;&amp; bv
 				, const Se3r&amp; se3
 				, const Body*	);
+	FUNCTOR2D(InteractingSphere,AABB);
 	REGISTER_CLASS_NAME(InteractingSphere2AABB);
 	REGISTER_BASE_CLASS_NAME(BoundingVolumeEngineUnit);
 };

Modified: trunk/pkg/common/Engine/EngineUnit/LeapFrogOrientationIntegrator.hpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/LeapFrogOrientationIntegrator.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/pkg/common/Engine/EngineUnit/LeapFrogOrientationIntegrator.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -20,7 +20,8 @@
 	public :
 		virtual void go( 	  const shared_ptr&lt;PhysicalParameters&gt;&amp;
 					, Body*);
-	
+
+	FUNCTOR1D(RigidBodyParameters);	
 	REGISTER_CLASS_NAME(LeapFrogOrientationIntegrator);
 	REGISTER_BASE_CLASS_NAME(PhysicalParametersEngineUnit);
 };

Modified: trunk/pkg/common/Engine/EngineUnit/LeapFrogPositionIntegrator.hpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/LeapFrogPositionIntegrator.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/pkg/common/Engine/EngineUnit/LeapFrogPositionIntegrator.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -20,7 +20,8 @@
 	public :
 		virtual void go(	  const shared_ptr&lt;PhysicalParameters&gt;&amp;
 					, Body*);
-	
+
+	FUNCTOR1D(ParticleParameters);	
 	REGISTER_CLASS_NAME(LeapFrogPositionIntegrator);
 	REGISTER_BASE_CLASS_NAME(PhysicalParametersEngineUnit);
 };

Modified: trunk/pkg/common/Engine/EngineUnit/MetaInteractingGeometry2AABB.hpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/MetaInteractingGeometry2AABB.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/pkg/common/Engine/EngineUnit/MetaInteractingGeometry2AABB.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -18,7 +18,7 @@
 				, shared_ptr&lt;BoundingVolume&gt;&amp; bv
 				, const Se3r&amp; se3
 				, const Body* );
-
+	FUNCTOR2D(MetaInteractingGeometry,AABB);
 	REGISTER_CLASS_NAME(MetaInteractingGeometry2AABB);
 	REGISTER_BASE_CLASS_NAME(BoundingVolumeEngineUnit);
 };

Modified: trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.hpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -18,6 +18,7 @@
 					, const shared_ptr&lt;PhysicalParameters&gt;&amp;
 					, const Body*);
 
+	FUNCTOR2D(Force,ParticleParameters);
 	REGISTER_CLASS_NAME(NewtonsForceLaw);
 	REGISTER_BASE_CLASS_NAME(PhysicalActionApplierUnit);
 };

Modified: trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.hpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -18,6 +18,7 @@
 					, const shared_ptr&lt;PhysicalParameters&gt;&amp;
 					, const Body*);
 
+	FUNCTOR2D(Momentum,RigidBodyParameters);
 	REGISTER_CLASS_NAME(NewtonsMomentumLaw);
 	REGISTER_BASE_CLASS_NAME(PhysicalActionApplierUnit);
 };

Modified: trunk/pkg/dem/Engine/DeusExMachina/TriaxialCompressionEngine.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/TriaxialCompressionEngine.cpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/pkg/dem/Engine/DeusExMachina/TriaxialCompressionEngine.cpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -124,8 +124,12 @@
 
 	UnbalancedForce=ComputeUnbalancedForce(body); // calculated at every iteration
 	MetaBody * ncb = static_cast&lt;MetaBody*&gt;(body);
-	if (Omega::instance().getCurrentIteration() % 100 == 0) { /* TRVAR1(meanStress);*/ /* TRVAR2(stateName(currentState),sigma_iso); */ }
 
+	if (Omega::instance().getCurrentIteration() % 100 == 0) {
+		LOG_INFO(&quot;UnbalancedForce=&quot;&lt;&lt;UnbalancedForce);
+		/* TRVAR1(meanStress);*/ /* TRVAR2(stateName(currentState),sigma_iso); */
+	}
+
 	if(currentState==STATE_ISO_COMPACTION || currentState==STATE_ISO_UNLOADING){
 		// FIXME: do we need this?? it makes sense to activate compression only during compaction!: || autoCompressionActivation)
 		if ((Omega::instance().getCurrentIteration() % computeStressStrainInterval) == 0){

Modified: trunk/pkg/dem/Engine/EngineUnit/InteractingBox2InteractingSphere4SpheresContactGeometry.hpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/InteractingBox2InteractingSphere4SpheresContactGeometry.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/pkg/dem/Engine/EngineUnit/InteractingBox2InteractingSphere4SpheresContactGeometry.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -31,6 +31,8 @@
 	REGISTER_CLASS_NAME(InteractingBox2InteractingSphere4SpheresContactGeometry);
 	REGISTER_BASE_CLASS_NAME(InteractionGeometryEngineUnit);
 
+	FUNCTOR2D(InteractingBox,InteractingSphere);
+
 	DEFINE_FUNCTOR_ORDER_2D(InteractingBox,InteractingSphere);
 };
 

Modified: trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4DistantSpheresContactGeometry.hpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4DistantSpheresContactGeometry.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4DistantSpheresContactGeometry.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -33,6 +33,7 @@
 					
 		double InteractionDetectionFactor;// InteractionGeometry will be computed when InteractionDetectionFactor*(rad1+rad2) &gt; distance 		
 	
+	FUNCTOR2D(InteractingSphere,InteractingSphere);
 
 	REGISTER_CLASS_NAME(InteractingSphere2InteractingSphere4DistantSpheresContactGeometry);
 	REGISTER_BASE_CLASS_NAME(InteractionGeometryEngineUnit);

Modified: trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4SpheresContactGeometry.hpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4SpheresContactGeometry.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/pkg/dem/Engine/EngineUnit/InteractingSphere2InteractingSphere4SpheresContactGeometry.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -33,6 +33,9 @@
 	REGISTER_CLASS_NAME(InteractingSphere2InteractingSphere4SpheresContactGeometry);
 	REGISTER_BASE_CLASS_NAME(InteractionGeometryEngineUnit);
 
+	FUNCTOR2D(InteractingSphere,InteractingSphere);
+	
+	//FIXME: what is this good for?!
 	DEFINE_FUNCTOR_ORDER_2D(InteractingSphere,InteractingSphere);
 	
 	protected :

Modified: trunk/pkg/dem/Engine/EngineUnit/MacroMicroElasticRelationships.hpp
===================================================================
--- trunk/pkg/dem/Engine/EngineUnit/MacroMicroElasticRelationships.hpp	2008-02-04 10:36:31 UTC (rev 1242)
+++ trunk/pkg/dem/Engine/EngineUnit/MacroMicroElasticRelationships.hpp	2008-02-09 15:21:41 UTC (rev 1243)
@@ -26,6 +26,8 @@
 
 	protected :
 		virtual void registerAttributes();
+
+	FUNCTOR2D(BodyMacroParameters,BodyMacroParameters);
 	REGISTER_CLASS_NAME(MacroMicroElasticRelationships);
 	REGISTER_BASE_CLASS_NAME(InteractionPhysicsEngineUnit);
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000207.html">[Yade-commits] r1242 - in trunk: . core extra extra/clump extra/screw extra/tetra extra/usct gui gui/cmd lib/factory pkg/common pkg/common/Container pkg/common/DataClass/BoundingVolume pkg/common/DataClass/GeometricalModel pkg/common/DataClass/InteractingGeometry pkg/common/DataClass/InteractionGeometry pkg/common/DataClass/InteractionPhysics pkg/common/DataClass/PhysicalAction pkg/common/DataClass/PhysicalParameters pkg/common/Engine/DeusExMachina pkg/common/Engine/EngineUnit pkg/common/Engine/MetaEngine pkg/common/Engine/StandAloneEngine pkg/common/RenderingEngine/GLDrawBoundingVolume pkg/common/RenderingEngine/GLDrawGeometricalModel pkg/common/RenderingEngine/GLDrawInteractingGeometry pkg/common/RenderingEngine/GLDrawInteractionGeometry pkg/common/RenderingEngine/GLDrawInteractionPhysics pkg/common/RenderingEngine/GLDrawShadowVolume pkg/common/RenderingEngine/GLDrawState pkg/common/RenderingEngine/OpenGLRenderingEngine pkg/dem pkg/dem/DataClass/InteractingGeometry pkg/dem/DataC! lass/InteractionGeometry pkg/dem/DataClass/InteractionPhysics pkg/dem/DataClass/PhysicalAction pkg/dem/DataClass/PhysicalParameters pkg/dem/Engine/DeusExMachina pkg/dem/Engine/EngineUnit pkg/dem/Engine/StandAloneEngine pkg/dem/PreProcessor pkg/dem/RenderingEngine/GLDrawInteractingMyTetrahedron pkg/dem/RenderingEngine/GLDrawSDECLinkGeometry pkg/dem/RenderingEngine/GLDrawSpheresContactGeometry pkg/fem/DataClass/GeometricalModel pkg/fem/DataClass/PhysicalParameters pkg/fem/Engine/EngineUnit pkg/fem/Engine/StandAloneEngine pkg/fem/PreProcessor pkg/lattice/DataClass/GeometricalModel pkg/lattice/DataClass/InteractingGeometry pkg/lattice/DataClass/InteractionPhysics pkg/lattice/DataClass/PhysicalParameters pkg/lattice/Engine/EngineUnit pkg/lattice/Engine/StandAloneEngine pkg/lattice/PreProcessor pkg/lattice/RenderingEngine/GLDrawLatticeBeamState pkg/lattice/RenderingEngine/GLDrawLatticeInteractingGeometry pkg/lattice/RenderingEngine/GLDrawLatticeSetGeometry pkg/lattice/RenderingEn! gine/GLDrawLineSegment pkg/mass-spring/DataClass/InteractionGe! ometry p
</A></li>
	<LI>Next message: <A HREF="000209.html">[Yade-commits] r1244 - in trunk: core extra extra/clump extra/tetra	extra/usct pkg/common/Engine/EngineUnit	pkg/dem/Engine/EngineUnit pkg/dem/PreProcessor	pkg/fem/Engine/EngineUnit pkg/fem/PreProcessor	pkg/lattice/Engine/EngineUnit pkg/lattice/PreProcessor	pkg/mass-spring/Engine/EngineUnit pkg/mass-spring/PreProcessor	pkg/realtime-rigidbody/Engine/EngineUnit	pkg/realtime-rigidbody/PreProcessor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#208">[ date ]</a>
              <a href="thread.html#208">[ thread ]</a>
              <a href="subject.html#208">[ subject ]</a>
              <a href="author.html#208">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/yade-commits">More information about the Yade-commits
mailing list</a><br>
</body></html>
